# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

**StudySpark** は、中学受験を目指す小学6年生向けの学習支援Webアプリです。AIコーチング、学習記録、応援機能を通じて、生徒・保護者・指導者をサポートします。

## 開発コマンド

### 主要コマンド
- `npm run dev` - 開発サーバー起動
- `npm run build` - 本番ビルド
- `npm run start` - 本番サーバー起動
- `npm run lint` - ESLint実行

### パッケージマネージャー
このプロジェクトは `pnpm` を使用（pnpm-lock.yaml参照）。依存関係のインストールは `pnpm install`。

## 技術スタック（要件定義より）

| レイヤー | 技術 | 実際のバージョン |
|---------|------|-----------|
| フロントエンド | Next.js (App Router) | 14.2.18 |
| | React | 18.3.1 |
| | TypeScript | 5.5.4 |
| バックエンド | Supabase | 最新 |
| 認証 | Supabase Auth | - |
| UI/UX | Tailwind CSS | 4.1.9 |
| AI | ChatGPT API | GPT-5-mini |

### 追加ライブラリ
- **フォーム**: react-hook-form + zod バリデーション
- **UIコンポーネント**: Radix UI
- **チャート**: Recharts
- **フォント**: Noto Sans JP（日本語）

## アプリケーション構造

アプリには**4つのユーザーロール**があり、それぞれ異なるUIを持つ：
1. **生徒 (student)** - メイン学習インターフェース（ログインID/パスワード認証）
2. **保護者 (parent)** - モニタリングと応援（メール/パスワード認証）
3. **指導者 (coach)** - 指導サポートと分析（メール/パスワード認証、招待必須）
4. **管理者 (admin)** - システム管理（招待のみ、内部発行）

### 主要ルート

**認証・セットアップ:**
- `/app/page.tsx` - ログイン/新規登録ページ
- `/app/setup/*` - 初期設定フロー（アバター、プロフィール、名前）

**生徒機能 (`/app/student/*`):**
- `page.tsx` - ダッシュボード
- `spark/page.tsx` - 学習記録入力（スパーク）
- `goal/page.tsx` - 目標管理（ゴールナビ）
- `reflect/page.tsx` - 週次振り返り（AIコーチング付き）

**保護者機能 (`/app/parent/*`):**
- `page.tsx` - ダッシュボード
- `goal-navi/page.tsx` - 生徒の目標閲覧
- `reflect/page.tsx` - 応援メッセージ送信

**指導者機能 (`/app/coach/*`):**
- `page.tsx` - ダッシュボード
- `students/page.tsx` - 生徒一覧
- `student/[id]/page.tsx` - 個別生徒詳細
- `analysis/page.tsx` - 分析ツール
- `encouragement/page.tsx` - 応援メッセージ送信

## コア設計原則

`docs/01-Concept.md` に基づき、以下を実装：

1. **GROWモデルコーチング**（Goal → Reality → Options → Will）
2. **SMART目標**（Specific, Measurable, Achievable, Relevant, Time-bound）
3. **セルフコンパッション** - 結果より努力に焦点、プレッシャーを避ける
4. **成長マインドセット** - 能力は努力と学習で成長する

## コースシステム

生徒は学力レベルに応じてA/B/C/Sコースに分類：
- **Aコース** → "Spark（楽しくスタート）" - 初心者向け
- **Bコース** → "Flame（成長ステップ）" - 成長段階
- **C/Sコース** → "Blaze（最高にチャレンジ）" - 上級挑戦

各コースで異なる学習内容範囲を表示（詳細は `docs/03-Requirements-Student.md` 参照）。

## 学習記録システム

### 学習回
週単位（第1回、第2回など）で管理：
- **小学5年生**: 19回（9/1 - 1/25）
- **小学6年生**: 15回（8/25 - 1/18）

### 科目
算数、国語、理科、社会

### 学習内容（学年別）
- **小学5年生**: 類題、基本問題、練習問題、演習問題集など
- **小学6年生**: １行問題、基本演習、実戦演習など

## 重要なUIパターン

### ナビゲーション
各ロールに専用ボトムナビゲーション（4タブ構成）：
- 生徒：`components/bottom-navigation.tsx`
- 保護者：`components/parent-bottom-navigation.tsx`
- 指導者：`components/coach-bottom-navigation.tsx`

### ダッシュボードレイアウト
タブレット/PC：2列、スマホ：1列

**表示要素（上から順に）:**
1. AIコーチからのメッセージ（毎日個別最適化）
2. 今日のミッション（月〜土は科目ローテーション、日曜は振り返り）
3. 学習カレンダー（GitHub風ヒートマップ）
4. 今週の科目別進捗バー
5. 直近の応援メッセージ
6. 直近の学習履歴

### カレンダーの色ロジック
- 1日の入力数または正答率に基づく色の濃淡
- 一般表示はブルー系、振り返りビューは科目別色（算数=青、国語=赤、理科=オレンジ、社会=緑）
- 3段階：薄、中、濃 + 白（データなし）

## AIコーチング実装

### モデル
ChatGPT API（GPT-5-mini）

### 週次振り返り（リフレクト）
- **利用可能時間**: 土曜12:00 〜 水曜23:59
- **対話ターン数**: 3〜6往復
- **UI**: LINEライクなチャット形式

**週のタイプ別の対話適応:**
- **成長週**（正答率+10%以上）→ 成功要因を深掘り
- **安定週**（正答率±10%以内）→ 新しい挑戦を提案
- **挑戦週**（正答率-10%以上）→ セルフコンパッション重視
- **特別週**（大きなテスト直前）→ 具体的な対策立案

### 目標設定（ゴールナビ）
- 「今回の思い」生成にAI対話を使用
- 6ステップフロー：感情探索 → 共同体感覚 → 自己認識 → 予祝 → まとめ生成

## データ表示パターン

### 進捗追跡
- **正答率** = 正答数 / 問題数
- **習得基準**: 80%を閾値とする
- **色分け**: 
  - 0-50%（薄）
  - 50-80%（中）
  - 80-100%（濃）

### テスト管理
- **小学5年生**: 組分けテスト（第5回〜新6年）
- **小学6年生**: 合不合判定テスト（第3回〜第6回）
- 表示期間制御により、UIに表示されるテストを制限

## 重要な実装詳細

### パスエイリアス
```typescript
"@/*" → プロジェクトルート
```
例: `import { Button } from "@/components/ui/button"`

### タイムゾーンとスケジュール
- **タイムゾーン**: Asia/Tokyo
- **週の定義**: 月曜開始、日曜終了
- **ミッションローテーション**: 
  - 月火（ブロックA）: 算数/国語/社会
  - 水木（ブロックB）: 算数/国語/理科
  - 金土（ブロックC）: 算数/理科/社会

### デモログイン情報
- 生徒: `student1` で始まるID
- 保護者: `parent1` で始まるID
- 指導者: `coach1` で始まるID

### ユーザーフロー
- 初回ユーザー → セットアップフロー（アバター・名前決定、スキップ可能）
- リピーターユーザー → ロール別ダッシュボード
- `localStorage.registrationComplete` でセットアップ状態を管理

### コンポーネント構成
- **UIコンポーネント**: `components/ui/*`（Radix UI使用）
- **共有コンポーネント**: `components/ai-coach-chat.tsx`（AI対話用）
- **フォーム**: react-hook-form + zod でバリデーション

## 主要ドキュメント

`docs/` ディレクトリに詳細な要件定義があります：

- **`01-Concept.md`** - ビジョン、ステークホルダーニーズ、コーチングフレームワーク
- **`02-Requirements-Auth.md`** - 認証仕様、技術スタック
- **`03-Requirements-Student.md`** - 生徒機能（ダッシ���ボード、スパーク、ゴール、リフレクト）
- **`04-Requirements-Parent.md`** - 保護者機能
- **`05-Requirements-Coach.md`** - 指導者機能

**機能実装時は必ずこれらのドキュメントを参照してください。** 正確なUI仕様、データ構造、ビジネスロジック、曜日別のロジックなどが詳細に記載されています。

## TODO: `next/font/google` 依存の解消（Noto Sans JP のローカル化）

App Router のビルド時に Google Fonts への外部アクセスが禁止されている環境では、`app/layout.tsx` で利用している `next/font/google`（`Noto_Sans_JP`）のフェッチが失敗し、`/_next/static/*` の生成が中断される。恒久対応としてフォントをローカル配布に切り替えること。

### ゴール
- `app/layout.tsx` で `next/font/local` を用いて Noto Sans JP を読み込む。
- フォントファイルはレポジトリ内に配置し、ビルド時に外部ネットワークへ依存しない。

### 実装方針
1. **フォントファイルの準備**
   - Google Fonts から Noto Sans JP の `Regular (400)` と `Bold (700)` の WOFF2（必要なら互換用に WOFF）をダウンロード。
   - `app/fonts/noto-sans-jp/` を作成し、以下のように配置する。
     - `app/fonts/noto-sans-jp/NotoSansJP-Regular.woff2`
     - `app/fonts/noto-sans-jp/NotoSansJP-Bold.woff2`
     - （WOFF が必要な場合）`app/fonts/noto-sans-jp/NotoSansJP-Regular.woff`／`...-Bold.woff`

2. **フォントの定義**
   - `app/layout.tsx:3` 付近で `next/font/local` をインポートし、既存の `Noto_Sans_JP` 呼び出しを差し替える。
   - 例：
     ```ts
     import localFont from "next/font/local"

     const notoSansJP = localFont({
       src: [
         {
           path: "./fonts/noto-sans-jp/NotoSansJP-Regular.woff2",
           weight: "400",
           style: "normal",
         },
         {
           path: "./fonts/noto-sans-jp/NotoSansJP-Bold.woff2",
           weight: "700",
           style: "normal",
         },
       ],
       variable: "--font-noto-sans-jp",
       display: "swap",
       preload: true,
     })
     ```
   - 既存の `subsets` オプションは不要になるので削除。

3. **スタイルの確認**
   - `app/globals.css` で `font-sans` が `--font-noto-sans-jp` を参照していることを確認（既存設定のままで可）。
   - `npm run dev` / `npm run build` を実行し、`fonts.googleapis.com` へのリクエストが行われないことと、`/_next/static/chunks/*` が生成されることを確認。

4. **補足**
   - 将来的に追加ウェイトが必要になった場合は同じフォルダへ追加し、`src` 配列にエントリを増やす。
   - フォントのライセンス表記が必要な場合は `public/fonts/LICENSE.txt` などに同梱する。

## データベース変更前確認ルール（必須）

**目的**: Supabase や DB へのマイグレーション・スキーマ変更に伴う事故を防ぐための行動規範。

### 必須ルール

#### 1. 事前確認の徹底
- DB スキーマやマイグレーションに関わる変更は、**実装前に必ずユーザーへ確認事項を提示し、合意を得てから着手する**
- 既存データや環境（本番/ローカル）が影響を受ける可能性がある場合は、**手を付ける前に明確に共有する**
- `npx supabase db reset` などデータを削除するコマンドは、**必ずユーザーの明示的な承認を得てから実行する**

#### 2. 影響範囲の洗い出し
- 追加・更新・削除されるテーブル、制約、ポリシー、トリガーなどを列挙する
- アプリ側の利用箇所（API・UI 等）への影響を説明する
- 既存データが削除・初期化される可能性がある場合は、**その可否を必ずユーザーと相談する**

#### 3. バックアップとロールバック計画
- 実行予定のマイグレーションに対して、失敗時のロールバックや再適用手順を用意する
- 本番環境に適用する場合は、直前のバックアップ取得方法を確認し、必要があれば承認を得てから進める

### 作業前の確認事項テンプレート

DB 変更を提案・実施する前に、以下の内容をユーザーに提示して了承を得ること：

1. **変更の目的・概要**
2. **影響を受けるテーブル／制約／トリガー**
3. **既存データ削除や初期化の有無**（特に重要）
4. **ローカル／本番どちらの環境に適用するか**
5. **所要時間の見込み**
6. **ロールバック手順の有無**
7. **ユーザーが準備すべきもの**（バックアップ取得、ログイン情報など）

### 実行例

```
ユーザー様

データベースの変更を提案させてください。

【目的】
theme_color カラムで "default" 値を許可するため、CHECK 制約を修正します。

【影響範囲】
- テーブル: profiles
- 変更内容: theme_color_format_check 制約の修正
- 既存データへの影響: なし（既存の HEX 値はそのまま）

【環境】
ローカル環境のみ（本番環境には影響しません）

【データ削除】
なし（制約の変更のみ）

【ロールバック】
マイグレーションファイルを削除して `npx supabase db reset` で戻せます

この変更を実施してよろしいでしょうか？
```

### 作業後の報告

- 実施結果をまとめ、成功/失敗・発生した問題・実行したコマンドなどを報告する
- 予想外の挙動があればすぐに共有し、ユーザーと今後の対応を協議する

### 重要な注意事項

**このルールを常に守り、DB への変更は十分な事前確認とユーザーの合意を得てから実施すること。**

特に以下のコマンドは実行前に必ずユーザーへ確認：
- `npx supabase db reset`
- `npx supabase db push`
- `DROP TABLE` / `DROP CONSTRAINT` などの削除系 SQL
- 既存マイグレーションファイルの修正
