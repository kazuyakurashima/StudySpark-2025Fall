# Phase 4: 指導者分析機能

**期間:** 2週間
**進捗:** 0% (0/13タスク完了)
**状態:** ⏳ 未着手

---

## 概要

週次AI分析による高度な学習支援 (将来価値)

**成果物:**
- 生徒一覧機能
- 週次AI分析
- バッチ処理基盤

---

## タスク一覧

### P4-1: 生徒一覧機能実装 ⏳ 未着手

- [ ] `/app/coach/students/page.tsx` 実装
  - 対応要件: `05-Requirements-Coach.md` - 生徒一覧
  - 検証: 担当生徒一覧表示、検索・フィルター機能

- [ ] 生徒検索・フィルター実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: 名前検索、学年・コースフィルター、ソート機能

- [ ] 生徒詳細画面実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: `/app/coach/student/[id]/page.tsx` 学習状況サマリー表示

---

### P4-2: 週次AI分析実装 ⏳ 未着手

- [ ] 週次分析データ取得ロジック実装
  - 対応要件: `05-Requirements-Coach.md` - 週次分析
  - 検証: 過去4週間の学習ログ集計、科目別正答率計算

- [ ] AI分析プロンプト設計
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: 強み・課題・具体的アドバイス生成、指導者向けトーン

- [ ] 分析結果表示UI実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: カード形式、科目別タブ、印刷機能

- [ ] 分析履歴保存機能実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: `weekly_analysis` テーブルへ保存、過去分析閲覧

---

### P4-3: バッチ処理基盤実装 ⏳ 未着手

- [ ] 週次バッチ処理実装 (Vercel Cron - 月曜速報版)
  - 対応要件: 運用要件
  - 実行日時: 毎週月曜 0:00（Asia/Tokyo）
  - 分析対象: 前週月曜 0:00 〜 日曜 23:59
  - 検証: 全生徒分析生成、`weekly_analysis` テーブル保存
  - 備考:
    - **速報版**: 土曜〜日曜のリフレクトが未完了の可能性あり
    - 木曜の最終分析で同週データを再分析・上書き
    - 例: 9/29(月) 0:00 実行 → 9/22(月) 0:00 〜 9/28(日) 23:59 を分析

- [ ] 最終分析バッチ処理実装 (Vercel Cron - 木曜確定版)
  - 対応要件: `05-Requirements-Coach.md`
  - 実行日時: 毎週木曜 0:00（Asia/Tokyo）
  - 分析対象: 前週月曜 0:00 〜 日曜 23:59（月曜分析と同じ週）
  - 検証: 月曜以降の追加データ反映、月曜速報版を上書き
  - 備考:
    - **確定版**: 月曜〜水曜の追加学習ログ、応援メッセージ、完了したリフレクトを反映
    - 同週の月曜速報版を木曜確定版で上書き（`weekly_analysis` テーブル UPDATE）
    - 過去週の分析結果は保持
    - 例: 10/2(木) 0:00 実行 → 9/22(月) 0:00 〜 9/28(日) 23:59 を再分析

- [ ] バッチエラーハンドリング実装
  - 対応要件: 運用要件
  - 検証: 失敗時リトライ、Sentry通知

---

### P4-4: Phase 4 総合テスト ⏳ 未着手

- [ ] 生徒一覧・詳細E2Eテスト
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: 検索・フィルター動作、詳細画面表示

- [ ] 週次分析E2Eテスト
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: 月曜速報版 → 木曜確定版の差分確認
  - テスト項目:
    1. **月曜速報版**: 月〜日の基本データのみで分析生成
    2. **木曜確定版**: 火〜水の追加データ（学習ログ・応援・リフレクト）を反映
    3. **上書き処理**: 同週の月曜速報版が木曜確定版で UPDATE される
    4. **履歴保持**: 過去週の分析結果は保持される（DELETE されない）
    5. **データ差分例**:
       - 月曜時点: 土曜リフレクト未完了（土12:00〜水23:59のため）
       - 木曜時点: 月曜〜水曜の追加ログ、完了したリフレクトを含む

- [ ] バッチ処理動作確認
  - 対応要件: 運用要件
  - 検証: 手動実行・自動実行成功、エラー通知
  - テスト項目:
    1. **Cron 設定**: 月曜 0:00 と木曜 0:00 の2本が正常稼働
    2. **失敗時リトライ**: OpenAI API エラー時のリトライロジック動作
    3. **Sentry 通知**: バッチ失敗時に Sentry にエラー送信
    4. **タイムゾーン**: Asia/Tokyo 基準で実行タイミング確認

---

## DoD (Definition of Done)

Phase 4完了の条件:

- [ ] 指導者が担当生徒一覧を閲覧・検索できる
- [ ] 指導者が各生徒の週次AI分析を閲覧できる
- [ ] AI分析が強み・課題・具体的アドバイスを生成できる
- [ ] 週次バッチ処理で中間・最終分析が自動生成される
- [ ] 分析履歴が保存され、過去分析を閲覧できる

---

## リスク要因

| リスク | 発生確率 | 影響度 | 対策 | 状態 |
|--------|---------|--------|------|------|
| バッチ処理のタイムアウト | 中 | 高 | 並列処理、チャンク分割 | ⏳ 未対応 |
| AI分析の品質 | 中 | 中 | プロンプトチューニング、指導者フィードバック | ⏳ 未対応 |
| コスト超過 (OpenAI API) | 低 | 中 | 使用量監視、上限設定 | ⏳ 未対応 |

---

## 次のマイルストーン

**現在:** ⏳ Phase 3完了待ち
**次:** P4-1 生徒一覧機能実装開始

---

**最終更新:** 2025年10月6日 10:55
**更新者:** Claude Code / Codex
