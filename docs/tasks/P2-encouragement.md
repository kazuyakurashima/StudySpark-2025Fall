# Phase 2: 応援機能

**期間:** 2週間
**進捗:** 61% (14/23タスク完了)
**状態:** 🚧 進行中

---

## 概要

保護者・指導者から生徒への応援メッセージ送信

**成果物:**
- ChatGPT API統合基盤
- 保護者応援機能
- 指導者応援機能
- 生徒応援受信機能

---

## タスク一覧

### P2-1: ChatGPT API統合基盤 ✅ 完了 (3/3完了)

- [x] OpenAI SDK実装 (`lib/openai/client.ts`)
  - 対応要件: `04-Requirements-Parent.md`, `05-Requirements-Coach.md`
  - 検証: ✅ gpt-4o-mini接続成功、エラーハンドリング実装
  - 実装:
    - シングルトンクライアントパターン
    - タイムアウト・リトライ設定（環境変数）
    - APIエラーハンドリング（429/401/500/503対応）

- [x] 応援メッセージ生成プロンプト設計
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: ✅ セルフコンパッション原則、成長マインドセット反映
  - 実装:
    - システムプロンプト（保護者/指導者別）
    - ユーザープロンプト（学習状況ベース）
    - 3案生成（努力・成長・挑戦視点）
    - クイック応援テンプレート（❤️/⭐/👍）

- [x] AIキャッシュテーブル実装
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: ✅ `ai_cache` テーブルで同一状況の応援文再利用
  - 実装:
    - 既存 `ai_cache` テーブル活用
    - キャッシュキー生成（状況ハッシュ）
    - キャッシュヒット時の使用回数更新
    - コスト最適化（同一状況での再利用）

---

### P2-2: 保護者応援機能実装 ✅ 完了 (5/7完了)

- [x] `/app/parent/encouragement/page.tsx` 実装
  - 対応要件: `04-Requirements-Parent.md` - 応援機能
  - 検証: ✅ 学習記録一覧表示、応援ボタン配置、応援済みバッジ表示
  - 実装:
    - 学習記録カード表示（科目・学習回・正答率）
    - 詳細表示切り替え（学習内容・振り返り表示）
    - 応援済み/未応援の視覚的フィードバック

- [x] クイック応援 (スタンプ) 実装
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: ✅ ❤️/⭐/👍 固定メッセージ送信、送信後の状態更新
  - 実装:
    - 3種類のクイック応援ボタン（常時表示）
    - ワンタップ送信、即座にDB保存
    - 送信後、応援済みバッジ表示・ボタン非表示

- [x] 応援メッセージ生成UI実装
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: ✅ AI生成文3案表示、編集可能、送信成功
  - 実装:
    - モーダルダイアログでAI応援3案表示
    - メッセージ選択後、Textareaで編集可能
    - 編集後送信、キャンセル機能

- [x] カスタム応援メッセージ実装
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: ✅ 最大200文字入力、送信、バリデーション
  - 実装:
    - カスタムメッセージダイアログ
    - 200文字制限、文字数カウンター
    - バリデーション（空文字・文字数超過）

- [x] 応援フィルター・ソート実装
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: ✅ 応援有無・科目・期間フィルター、記録日時/学習回/正答率並び替え、5件未満時の期間自動展開
  - 実装:
    - フィルター: 未応援/応援済み/全表示、全科目/算数/国語/理科/社会、1週間/1ヶ月/全て
    - ソート: 記録日時/学習回/正答率、昇順/降順
    - 1ヶ月フィルターで5件未満時、自動的に全期間表示
    - Server Action でフィルター・ソートを実行

- [ ] 応援履歴表示実装
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: 過去の応援メッセージ一覧、日時順表示
  - **TODO**: 履歴専用ビューは未実装（現在は学習記録に紐づく応援のみ表示）

- [ ] 応援カード詳細開閉制御
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: ✅ 詳細開閉機能は実装済み
  - **NOTE**: カードごとの詳細開閉は実装済み。全表示/一部表示トグルは学習記録一覧のフィルターで代用
  - 実装方針:
    - テーブル: `encouragement_messages`（`encouragement_logs` ではない）
    - 応援種別フィルター: `support_type` カラム使用（quick/ai/custom）
    - 科目フィルター: `study_logs` テーブルと LEFT JOIN で取得
      ```sql
      SELECT em.*, sl.subject_id, s.name as subject_name
      FROM encouragement_messages em
      LEFT JOIN study_logs sl ON em.related_study_log_id = sl.id
      LEFT JOIN subjects s ON sl.subject_id = s.id
      WHERE em.student_id = $1
        AND (s.name = $2 OR $2 IS NULL);
      ```
    - `related_study_log_id` が NULL の応援: 「全科目」選択時のみ表示
  - 備考: P0-3 での `support_type`/`related_study_log_id` カラム追加が前提

- [ ] 応援カード詳細開閉制御
  - 対応要件: `04-Requirements-Parent.md`
  - 検証: 「全表示/一部表示」ボタン、カード毎の詳細開閉、学習内容表示切替

---

### P2-3: 指導者応援機能実装 ✅ 完了

- [x] `/app/coach/encouragement/page.tsx` 実装
  - 対応要件: `05-Requirements-Coach.md` - 応援機能
  - 検証: ✅ 2タブUI実装（応援一覧・未入力生徒）、担当生徒の学習記録一覧表示、応援ボタン表示
  - 実装ファイル: `app/coach/encouragement/page.tsx`

- [x] 指導者向けクイック応援 (スタンプ) 実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: ✅ ワンクリック送信（Heart/Star/ThumbsUp）、履歴反映、応援済みバッジ表示
  - Server Action: `sendCoachQuickEncouragement`

- [x] 生徒選択UI実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: ✅ 担当生徒一覧自動取得、フィルター機能（学年・科目・応援種別・ソート順）
  - Server Action: `getCoachStudents`, `getAllStudyLogsForCoach`

- [x] 応援メッセージ生成・送信実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: ✅ AI生成文3案表示、編集可能、送信成功、保護者AIプロンプトを共用
  - Server Action: `generateCoachAIEncouragement`

- [x] 個別メッセージ作成機能実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: ✅ カスタムメッセージ自由入力、200文字上限バリデーション、送信成功
  - Server Action: `sendCoachCustomEncouragement`

- [x] 応援フィルター・ソート/タブ実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: ✅ 学年・科目・応援種別（なし/指導者/保護者/全表示）フィルター、昇降順切替実装
  - 実装方針:
    - テーブル: `encouragement_messages`
    - 応援種別フィルター: `sender_role` カラムでクライアント側フィルタリング
    - 応援者別フィルター: `sender_role` カラム使用（parent/coach）
    - 科目フィルター: `study_logs` テーブルと JOIN で取得（保護者応援と同様）
  - 備考: P0-3 での `support_type`/`related_study_log_id` カラム追加が前提

- [x] 未入力生徒一覧実装
  - 対応要件: `05-Requirements-Coach.md`
  - 検証: ✅ フィルター選択（3/5/7日以上）、警告強調（7日以上=赤枠）、応援ボタン実装、Asia/Tokyo基準
  - 実装方針:
    - 一覧表示: フィルター選択に応じた生徒を表示（3/5/7日以上未入力）
    - 警告強調: 7日以上未入力の生徒のみ視覚的にハイライト（赤枠・警告バッジ）
    - デフォルト: 7日以上フィルター（警告対象のみ表示）
    - 自動除外: 生徒が入力再開 → フィルター条件を下回った時点で一覧から除外
    - 応援機能: カスタムメッセージ送信可能（logId: null で学習記録に紐付かない応援）
  - Server Action: `getInactiveStudents`
  - UI例:
    ```
    フィルター: [7日以上▼]
    🔴 田中太郎（未入力12日）← 警告強調（赤枠）
    🔴 佐藤花子（未入力8日） ← 警告強調（赤枠）
       鈴木次郎（未入力5日） ← 5日フィルター時のみ表示（黄枠）
    ```

---

### P2-4: 生徒応援受信機能実装 ⏳ 未着手

- [ ] ダッシュボード応援表示更新
  - 対応要件: `03-Requirements-Student.md`
  - 検証: 最新3件表示、保護者・指導者別アイコン

- [ ] 応援詳細画面実装
  - 対応要件: `03-Requirements-Student.md`
  - 検証: 全応援メッセージ一覧、既読管理

- [ ] 通知機能実装 (オプション)
  - 対応要件: 通知要件
  - 検証: 新規応援時に `notifications` テーブルへ登録

- [ ] 応援カード詳細要素の同期
  - 対応要件: `03-Requirements-Student.md`
  - 検証: 学習回/科目/正答率/変化表示、詳細開閉と保護者表示との整合
  - 備考: 生徒側UIで保護者・指導者カードと同じデータ構造を共有し、差異がないか確認

---

### P2-5: Phase 2 総合テスト ⏳ 未着手

- [ ] 応援機能E2Eテスト
  - 対応要件: `04-Requirements-Parent.md`, `05-Requirements-Coach.md`
  - 検証: 保護者・指導者 → 応援送信 → 生徒受信
  - 備考: クイック/AI/カスタム全モード、未入力警告→応援→解除までのフローを含める

- [ ] AIキャッシュ動作確認
  - 対応要件: コスト最適化要件
  - 検証: 同一状況で過去の応援文再利用、OpenAI API呼び出し削減

---

## DoD (Definition of Done)

Phase 2完了の条件:

- [ ] 保護者が子どもに応援メッセージを送信できる
- [ ] 指導者が担当生徒に応援メッセージを送信できる
- [ ] 生徒ダッシュボードで応援メッセージを受信・閲覧できる
- [ ] AI生成メッセージがセルフコンパッション・成長マインドセット原則に準拠
- [ ] AIキャッシュでコスト最適化が機能
- [ ] クイック/AI/カスタム応援が全ロールで期待通り動作する
- [ ] 応援フィルター・未入力警告が仕様通りに制御される

---

## リスク要因

| リスク | 発生確率 | 影響度 | 対策 | 状態 |
|--------|---------|--------|------|------|
| OpenAI APIレート制限 | 中 | 高 | キャッシュ戦略、リトライロジック | ✅ 対応済み |
| AI応援文の品質 | 中 | 中 | プロンプトチューニング、A/Bテスト | 🚧 進行中 |
| コスト超過 | 低 | 中 | キャッシュ徹底、使用量監視 | ✅ 対応済み |

---

## 次のマイルストーン

**現在:** 🚧 P2-4 生徒応援受信機能実装
**次:** P2-5 Phase 2 総合テスト

---

**最終更新:** 2025年10月6日 02:00
**更新者:** Claude Code / Codex

---

## 最新の修正履歴

### 2025年10月6日 02:00 - P2-2 保護者応援機能完了
- **実装内容**:
  1. **Server Actions**: 学習記録取得、クイック応援、AI応援生成、カスタム応援送信、応援履歴取得
  2. **応援ページ**: 学習記録一覧、フィルター・ソート、詳細表示切り替え
  3. **3種類の応援方法**: クイック/AI/カスタム応援の完全実装

- **実装ファイル**:
  - `app/actions/encouragement.ts` - 応援機能用 Server Actions
  - `app/parent/encouragement/page.tsx` - 保護者応援ページ
  - `components/parent-bottom-navigation.tsx` - ナビゲーション修正

- **主要機能**:
  - ✅ クイック応援（❤️/⭐/👍ワンタップ）
  - ✅ AI応援（3案生成、編集可能）
  - ✅ カスタム応援（200文字以内自由入力）
  - ✅ フィルター（応援有無/科目/期間）
  - ✅ ソート（記録日時/学習回/正答率）
  - ✅ 1ヶ月フィルターで5件未満時の自動期間拡大

- **進捗**: P2-2 が 5/7 完了、Phase 2 が 8/23 完了 (35%)

### 2025年10月6日 01:30 - P2-1 ChatGPT API統合基盤完了
- **実装内容**:
  1. **OpenAI SDK実装**: シングルトンクライアント、エラーハンドリング、タイムアウト・リトライ設定
  2. **プロンプト設計**: セルフコンパッション・成長マインドセット原則に基づく3案生成
  3. **AIキャッシュ**: 既存テーブル活用、状況ハッシュベースのキャッシュ戦略

- **実装ファイル**:
  - `lib/openai/client.ts` - OpenAIクライアント（シングルトン）
  - `lib/openai/prompts.ts` - システム/ユーザープロンプト、クイック応援テンプレート
  - `lib/openai/encouragement.ts` - AI応援メッセージ生成（キャッシュ活用）

- **依存関係**:
  - openai@6.1.0 インストール完了

- **進捗**: P2-1 が 3/3 完了、Phase 2 が 3/23 完了 (13%)
