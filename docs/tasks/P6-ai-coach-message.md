# Phase 6: AIコーチメッセージ実装

**期間:** 1週間
**進捗:** 0% (0/8タスク完了)
**状態:** 🔄 進行中

---

## 概要

生徒ダッシュボードのAIコーチメッセージをテンプレートからAI生成に移行

**成果物:**
- AIコーチメッセージ生成機能
- キャッシュ機構
- バックグラウンド生成（Vercel Cron）
- フォールバック処理

**背景:**
- Phase 1でテンプレート版を実装（時間帯別メッセージ）
- Phase 3完了によりGROWデータが利用可能に
- 要件定義: GROWログ + 直近3日の学習ログに基づく個別最適化メッセージ

**UX分析:**
- 想定レスポンスタイム: 1-2.5秒（同期生成）
- キャッシュ+バックグラウンド生成: 0.05秒（20-50倍高速化）
- 詳細: `docs/AI_COACH_MESSAGE_UX_ANALYSIS.md`

---

## タスク一覧

### P6-1: AIコーチメッセージ生成ロジック実装 ⏳ 未着手 (0/4)

- [ ] `lib/openai/coach-message.ts` 作成
  - 対応要件: `03-Requirements-Student.md` - AIコーチからのメッセージ
  - 検証: GROWデータ + 直近3日学習ログから個別最適化メッセージ生成
  - 実装内容:
    - `generateCoachMessage(context)` - AI生成メイン関数
    - システムプロンプト: GROWモデル + セルフコンパッション原則
    - ユーザープロンプト: 生徒情報 + GROWログ + 学習ログ
    - 出力: 60-100文字、3要素構成（承認・現状・Will）
  - 参考実装: `lib/openai/daily-status.ts` (保護者「今日の様子」)

- [ ] データ取得関数実装
  - `getLatestGROW(studentId)` - 直近のWill/Goal取得
  - `getRecentStudyLogs(studentId, days=3)` - 直近3日の学習ログ取得
  - `getUpcomingTest(studentId)` - 近日のテスト情報取得
  - 実装場所: `app/actions/dashboard.ts` または新規ファイル

- [ ] システムプロンプト設計
  - GROWモデル準拠
  - セルフコンパッション原則（責めない、小さな達成承認）
  - 成長マインドセット原則
  - トーン: 小学生向け、温かく具体的
  - 季節・時期による表現変化

- [ ] ユーザープロンプト設計
  - 生徒基本情報（名前、学年、コース）
  - 直近のWill/Goal（週次振り返りから）
  - 直近3日の学習ログ（科目、内容、正答率）
  - 近日のテスト情報（あれば）
  - プロンプトバージョン管理（v1.0〜）

---

### P6-2: キャッシュ機構実装 ⏳ 未着手 (0/4)

- [ ] キャッシュキー生成ロジック
  - フォーマット: `daily_coach_{studentId}_{YYYY-MM-DD}`
  - 日付はAsia/Tokyoタイムゾーン
  - SHA256ハッシュ化（オプション）

- [ ] キャッシュ取得関数
  - `getCachedCoachMessage(cacheKey)` 実装
  - `ai_cache` テーブルから取得（cache_type='coach_message'）
  - ヒットカウント更新 (`hit_count`, `last_accessed_at`)
  - 参考: `lib/openai/daily-status.ts:54-78`

- [ ] キャッシュ保存関数
  - `cacheCoachMessage(cacheKey, message)` 実装
  - `ai_cache` テーブルにINSERT
  - 有効期限: 7日間（自動削除はP5-2で実装済み）

- [ ] `app/actions/dashboard.ts:getAICoachMessage()` 改修
  - キャッシュチェック追加
  - キャッシュヒット → 即座に返却
  - キャッシュミス → AI生成 + キャッシュ保存
  - フォールバック: テンプレートメッセージ（エラー時）

---

### P6-3: バックグラウンド生成実装 ⏳ 未着手 (0/5)

- [ ] Cron API Route作成
  - ファイル: `app/api/cron/generate-coach-messages/route.ts`
  - CRON_SECRET認証（既存パターン踏襲）
  - 全アクティブ生徒取得
  - 翌日分メッセージ生成 + キャッシュ保存
  - 参考: `app/api/cron/data-retention/route.ts`

- [ ] 全アクティブ生徒取得ロジック
  - 条件: last_login_at が7日以内
  - 対象: students テーブル
  - JOIN: profiles テーブル（display_name取得）

- [ ] バッチ生成ロジック
  - 各生徒ごとにループ処理
  - GROWデータ + 学習ログ取得
  - AI生成実行
  - キャッシュ保存（翌日の日付で保存）
  - エラーハンドリング（1生徒失敗しても継続）

- [ ] Vercel Cron設定
  - `vercel.json` に追加
  - スケジュール: `0 18 * * *` (毎日UTC 18:00 = JST 03:00)
  - パス: `/api/cron/generate-coach-messages`

- [ ] Cron実行ログ記録
  - 処理件数（成功/失敗）記録
  - エラー詳細記録
  - Sentry連携（エラー通知）

---

### P6-4: フォールバック処理実装 ⏳ 未着手 (0/3)

- [ ] AI生成失敗時のテンプレート表示
  - 時間帯別テンプレート維持（既存ロジック）
  - フォールバック条件:
    - OpenAI APIエラー（タイムアウト、レート制限）
    - GROW/学習ログデータ不足
    - キャッシュミス + 生成失敗

- [ ] エラーハンドリング強化
  - タイムアウト: 30秒（`OPENAI_TIMEOUT`）
  - リトライ: 2回（`OPENAI_MAX_RETRIES`）
  - エラー分類: 429(レート制限), 500(サーバーエラー), 401(認証)
  - ユーザー向けメッセージ: エラーを見せない

- [ ] Sentry連携
  - AI生成エラーをSentryに送信
  - タグ: `ai_feature: coach_message`
  - コンテキスト: studentId, cacheKey, errorType

---

### P6-5: テストスクリプト作成 ⏳ 未着手 (0/3)

- [ ] AIコーチメッセージ生成テスト
  - ファイル: `scripts/test-coach-message-generation.ts`
  - テストケース:
    1. GROWデータあり + 学習ログあり
    2. GROWデータなし（新規生徒）
    3. 学習ログ不足（データ少ない）
    4. テスト直前シナリオ
  - 検証: メッセージ生成成功、文字数、3要素構成

- [ ] キャッシュ機構テスト
  - ファイル: `scripts/test-coach-message-cache.ts`
  - テストケース:
    1. キャッシュミス → AI生成 → キャッシュ保存
    2. キャッシュヒット → 即座に返却
    3. ヒットカウント更新確認
  - 検証: レスポンスタイム計測（0.1秒未満）

- [ ] バックグラウンド生成テスト
  - ファイル: `scripts/test-coach-message-cron.ts`
  - Cron APIエンドポイント手動実行
  - 検証:
    - 全生徒の翌日分メッセージ生成
    - キャッシュ保存確認
    - エラーハンドリング確認

---

### P6-6: UI改善（オプション） ⏳ 未着手 (0/2)

- [ ] スケルトンローディング追加
  - キャッシュミス時の表示
  - アニメーション付きプレースホルダー
  - グラデーション: cyan → teal → emerald
  - 3行構成（メッセージ構造に合わせる）

- [ ] エラー時のUI改善
  - AI生成失敗を見せない
  - テンプレートメッセージをシームレスに表示
  - リトライボタン（オプション）

---

### P6-7: モニタリング実装 ⏳ 未着手 (0/3)

- [ ] キャッシュヒット率計測
  - `ai_cache` テーブルの統計クエリ
  - 管理者ダッシュボードに表示
  - 目標: 95%以上

- [ ] レスポンスタイム計測
  - Vercel Analytics連携
  - `getAICoachMessage()` の実行時間記録
  - 目標: P95 < 0.2秒

- [ ] AI生成成功率計測
  - 成功/失敗カウント
  - エラー種別集計
  - Sentryダッシュボードで確認

---

### P6-8: Phase 6 総合テスト ⏳ 未着手 (0/4)

- [ ] E2Eテスト: 生徒ダッシュボード
  - 初回ログイン: AI生成メッセージ表示
  - 2回目ログイン: キャッシュヒット（高速表示）
  - 翌日ログイン: 新しいメッセージ表示

- [ ] E2Eテスト: バックグラウンド生成
  - Cron実行確認（手動トリガー）
  - 全生徒の翌日分生成確認
  - エラーハンドリング確認

- [ ] パフォーマンステスト
  - 100ユーザー同時アクセスシミュレーション
  - レスポンスタイム計測
  - キャッシュヒット率確認

- [ ] テスト結果ドキュメント作成
  - ファイル: `docs/tasks/P6-test-results.md`
  - 生成品質評価（5ケース×評価）
  - パフォーマンス評価（レスポンスタイム、ヒット率）
  - UX評価（ユーザー体験改善度）

---

## DoD (Definition of Done)

Phase 6完了の条件:

- [ ] AIコーチメッセージがGROW+学習ログに基づき生成される
- [ ] キャッシュ機構が動作し、2回目以降0.1秒未満で返却される
- [ ] バックグラウンド生成が毎日午前3時に自動実行される
- [ ] AI生成失敗時もテンプレートで最低限の体験を提供する
- [ ] テストスクリプトが100%成功する
- [ ] キャッシュヒット率が95%以上
- [ ] P95レスポンスタイムが0.2秒未満

---

## 実装ファイル一覧

### 新規作成ファイル
- `lib/openai/coach-message.ts` - AI生成ロジック
- `app/api/cron/generate-coach-messages/route.ts` - バックグラウンド生成
- `scripts/test-coach-message-generation.ts` - 生成テスト
- `scripts/test-coach-message-cache.ts` - キャッシュテスト
- `scripts/test-coach-message-cron.ts` - Cronテスト
- `docs/tasks/P6-test-results.md` - テスト結果

### 修正ファイル
- `app/actions/dashboard.ts:getAICoachMessage()` - キャッシュ統合
- `vercel.json` - Cron設定追加

### 既存活用
- `ai_cache` テーブル（Phase 0で作成済み）
- `lib/openai/client.ts` - OpenAIクライアント
- Vercel Cron（Phase 5で設定済み）
- Sentry（Phase 5で統合済み）

---

## リスク要因

| リスク | 発生確率 | 影響度 | 対策 | 状態 |
|--------|---------|--------|------|------|
| AI生成品質が低い | 中 | 高 | プロンプト最適化、テストケース充実 | ⏳ 未対応 |
| レスポンスタイム悪化 | 低 | 高 | キャッシュ+バックグラウンド生成で解決済み | ✅ 対策済み |
| Cron実行失敗 | 低 | 中 | フォールバック（テンプレート）、Sentry通知 | ⏳ 未対応 |
| キャッシュヒット率低下 | 低 | 中 | モニタリング、原因分析 | ⏳ 未対応 |
| OpenAI APIコスト増加 | 低 | 低 | バックグラウンド生成で1日1回のみ | ✅ 対策済み |

---

## 次のマイルストーン

**現在:** 🔄 Phase 6 開始
**次:** P6-1 AIコーチメッセージ生成ロジック実装（最大のタスク）

**推奨実装順:**
1. **P6-1 AI生成ロジック** - 基盤実装（4-6時間）
2. **P6-2 キャッシュ機構** - パフォーマンス改善（2-3時間）
3. **P6-5 テストスクリプト** - 品質検証（2-3時間）
4. **P6-3 バックグラウンド生成** - UX最適化（3-4時間）
5. **P6-4 フォールバック処理** - 信頼性向上（2-3時間）
6. **P6-7 モニタリング** - 運用準備（1-2時間）
7. **P6-8 総合テスト** - 最終検証（2-3時間）

**残り工数見積もり**: 8タスク、約16-24時間

---

## 参考ドキュメント

- **要件定義**: `docs/03-Requirements-Student.md` - AIコーチからのメッセージ
- **UX分析**: `docs/AI_COACH_MESSAGE_UX_ANALYSIS.md`
- **既存実装**: `lib/openai/daily-status.ts` (保護者「今日の様子」)
- **バックログ**: `docs/tasks/BACKLOG.md:36-58`
- **Phase 1実装**: `docs/tasks/P1-learning-logs.md:63-71`

---

**最終更新:** 2025年10月11日
**作成者:** Claude Code
