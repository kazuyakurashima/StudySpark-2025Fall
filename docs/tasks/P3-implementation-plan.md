# Phase 3: 目標管理・週次振り返り - 実装計画

**作成日:** 2025年10月6日 03:30
**作成者:** Claude Code
**期間:** 3週間
**状態:** 📋 計画中

---

## 概要

Phase 3は、StudySparkの差別化要素となるAIコーチング機能の実装フェーズです。
GROWモデルに基づく目標設定と週次振り返りを通じて、生徒の主体的な学習を支援します。

**主要機能:**
1. **ゴールナビ** - テスト目標設定とAI対話
2. **リフレクト** - 週次振り返りとAIコーチング
3. **達成マップ** - 科目別進捗可視化
4. **コーチング履歴** - 成長の軌跡記録

---

## 前提知識・重要概念

### GROWモデル
**Goal → Reality → Options → Will** の対話フレームワーク

### SMART目標
- **S**pecific（具体的）
- **M**easurable（測定可能）
- **A**chievable（達成可能）
- **R**elevant（関連性）
- **T**ime-bound（期限付き）

### セルフコンパッション
- 結果より努力に焦点
- 小さな成功の発見
- 自分との比較（他者比較を避ける）

### 成長マインドセット
- 能力は固定的ではない
- 努力・工夫・学習で成長できる
- 失敗は学びの機会

---

## 実装タスク詳細

### P3-1: ゴールナビ実装（目標設定）

**対象ファイル:**
- `app/student/goal/page.tsx` - メイン画面
- `app/actions/goal.ts` - Server Actions
- `lib/openai/goal-coaching.ts` - AI対話ロジック
- `lib/openai/prompts.ts` - ゴールナビ用プロンプト追加

#### タスク内訳

##### 1.1 テスト日程表示
**要件:**
- 学年別テスト一覧（組分けテスト/合不合判定テスト）
- 表示期間制御（test_schedulesテーブル）
- プルダウン選択UI

**小学5年生:**
| テスト名 | 実施日 | 表示期間 |
|---------|--------|---------|
| 第5回公開組分けテスト | 8/31（日） | 8/31〜10/31 |
| 第6回公開組分けテスト | 10/5（日） | 10/5〜11/30 |
| 第7回公開組分けテスト | 11/9（日） | 11/9〜12/31 |
| 第8回公開組分けテスト | 12/14（日） | 12/14〜1/31 |
| 新6年公開組分けテスト | 1/25（日） | 1/25〜2/28 |

**小学6年生:**
| テスト名 | 実施日 | 表示期間 |
|---------|--------|---------|
| 第3回合不合判定テスト | 9/7（日） | 9/7〜10/31 |
| 第4回合不合判定テスト | 10/5（日） | 10/5〜11/30 |
| 第5回合不合判定テスト | 11/16（日） | 11/16〜12/31 |
| 第6回合不合判定テスト | 12/7（日） | 12/7〜2/28 |

##### 1.2 目標入力フォーム
**入力項目:**
- コース選択（S/C/B/A）- ラジオボタン
- 組選択（1〜40）- スライダー + 数値入力
- バリデーション: 必須、整数、範囲内

##### 1.3 AI対話フロー（6ステップ）
**フロー仕様:**
```yaml
Step1_目標確認:
  AI: "○○さん、次回は[コース][組]を目指すんだね！"

Step2_感情探索:
  AI: "それが達成できたら、どんな気持ちになる？"
  生徒: 自由記述（最大100字）

Step3_共同体感覚:
  AI: "誰が一番喜んでくれると思う？"
  生徒: 選択肢 + その他

Step4_自己認識:
  AI: "そのとき、自分は何を感じる？"
  生徒: 自由記述（最大100字）

Step5_予祝:
  AI: "達成した自分から今の自分へメッセージを送るとしたら？"
  生徒: 自由記述（最大150字）

Step6_まとめ生成:
  AI: 対話内容を統合して「今回の思い」を生成
  生徒: 確認 → OK/修正
```

**UI仕様:**
- LINEライクなチャット形式
- ターン数表示
- Step2以降で「今回の思いを決定」ボタン表示（早期終了可能）
- 再生成回数: 3回まで

##### 1.4 「今回の思い」生成
**AI生成仕様:**
- 対話内容を統合した自然な文章
- SMART原則準拠
- 最大300字
- 編集可能（自動保存5秒後）

##### 1.5 目標保存
**データ保存:**
- `test_goals` テーブルに保存
- 重複防止（同一テスト・生徒）
- 編集履歴保持（最大5件）

---

### P3-2: リフレクト実装（週次振り返り）

**対象ファイル:**
- `app/student/reflect/page.tsx` - メイン画面
- `app/actions/reflect.ts` - Server Actions
- `lib/openai/reflect-coaching.ts` - AI週次コーチングロジック
- `lib/openai/prompts.ts` - リフレクト用プロンプト追加

#### タスク内訳

##### 2.1 週次振り返りUI
**画面構成:**
| セクション | 内容 | 備考 |
|----------|------|------|
| AIコーチング | 土曜12時〜水曜23:59限定表示 | 「週間振り返りを始める」ボタン |
| 達成マップ | 科目ごとの達成度表示 | デフォルト表示 |
| 学習履歴 | 記録一覧 | タブ表示 |
| 応援履歴 | 保護者・指導者からの応援 | タブ表示 |
| コーチング履歴 | 過去の対話記録 | タブ表示 |

**タブ順:** 達成マップ → 学習履歴 → 応援履歴 → コーチング履歴

##### 2.2 AI週次コーチング（3-6往復）
**週タイプ別対話適応:**
| 週タイプ | 判定基準 | 対話の特徴 | ターン数 |
|---------|---------|-----------|---------|
| 成長週 | 先週より正答率10%以上UP | 成功要因の深掘り中心 | 3-4往復 |
| 安定週 | 正答率変化±10%以内 | 新しい挑戦の提案 | 4-5往復 |
| 挑戦週 | 正答率10%以上DOWN | セルフコンパッション重視 | 5-6往復 |
| 特別週 | テスト直前 | 具体的な対策立案 | 4往復 |

**対話フェーズ:**
```yaml
Phase1_オープニング（1往復目）:
  パターンA（データ承認型）- 60%の確率:
    "今週は算数を5回も取り組んだね！特に水曜の正答率85%はすごい。どんな工夫をした？"

  パターンB（感情確認型）- 30%の確率:
    "今週お疲れさま！率直に、今週の調子はどうだった？"

  パターンC（目標確認型）- 10%の確率:
    "先週立てた『国語の読解強化』、やってみてどうだった？"

Phase2_深掘り（2-3往復目）:
  生徒の回答傾向で分岐:
    - ポジティブ → 成功要因の言語化
    - ネガティブ → 小さな成功の発見
    - 中立的 → 具体的な振り返り

Phase3_目標設定（ラスト2往復）:
  結果目標と行動目標の分離設定:
    - 結果目標: "偏差値50超えたい"
    - 行動目標: AIが3つの選択肢を提示
    - Will: 生徒が自ら選択
```

**マンネリ防止:**
- 質問バリエーションプール（10種類以上）
- ランダム使用
- 生徒の回答履歴を参照

##### 2.3 GROW/Willデータ参照
**データ収集:**
- Goal: test_goals テーブル
- Reality: study_logs テーブル（先週分集計）
- Options: AIが提示
- Will: 生徒選択を coaching_sessions に保存

##### 2.4 コーチングセッション保存
**データ保存:**
- `coaching_sessions` テーブル
- `coaching_messages` テーブル（会話履歴）
- セッション単位で保存
- 週次サマリー生成

---

### P3-3: 達成マップ・履歴表示

**対象ファイル:**
- `app/student/reflect/page.tsx` - タブコンポーネント
- `app/actions/reflect.ts` - データ取得

#### タスク内訳

##### 3.1 達成マップ（GitHub風ヒートマップ）
**表示仕様:**
- 科目別タブ（算数/国語/理科/社会）
- 学年・コース別表示制御
- 正答率による色分け:
  - 0%（未修）: 白
  - 0-50%: 薄い
  - 50-80%: 中位
  - 80-100%: 濃い
- 科目別カラー:
  - 算数: 青
  - 国語: 赤
  - 理科: オレンジ
  - 社会: 緑

**コース別表示:**
- Aコース: Aコース学習内容のみ
- Bコース: A+Bコース学習内容
- C/Sコース: すべて（A+B+C）

##### 3.2 学習履歴表示
**表示項目:**
- 生徒記録日時
- 学習回
- 科目
- 学習内容
- 正答率
- 今日の振り返り
- 変化（2回以上記録時）

**フィルター:**
- 科目（全科目/算数/国語/理科/社会）
- 期間（1週間/1ヶ月/全て）
- 並び替え（記録日時/学習回/正答率）

##### 3.3 応援履歴表示
**表示項目:**
- 記録日時
- アバター・ニックネーム
- 応援メッセージ
- デフォルト非表示: 学習回/科目/学習内容/正答率/振り返り/変化

**操作:**
- クリックで詳細展開
- フィルター（科目/期間/並び替え/表示）

##### 3.4 コーチング履歴表示
**表示項目:**
- 記録日時
- コーチングサマリー（GROW視点）
- 応援メッセージ（あれば）

**フィルター:**
- 期間（1週間/1ヶ月/全て）

---

### P3-4: 保護者・指導者画面実装

**対象ファイル:**
- `app/parent/goal-navi/page.tsx` - 保護者目標閲覧
- `app/parent/reflect/page.tsx` - 保護者振り返り閲覧
- `app/coach/student/[id]/goal-navi/page.tsx` - 指導者目標閲覧
- `app/coach/student/[id]/reflect/page.tsx` - 指導者振り返り閲覧

#### タスク内訳

##### 4.1 保護者目標閲覧画面
**機能:**
- 子どもの目標一覧表示
- テスト別詳細表示
- 「今回の思い」閲覧
- コメント機能（将来実装）

**権限:**
- 閲覧: ⭕
- 編集: ❌
- コメント: ⭕（将来実装）

##### 4.2 保護者振り返り閲覧画面
**機能:**
- 達成マップ閲覧
- 学習履歴閲覧
- コーチングサマリー閲覧

**権限:**
- 閲覧: ⭕
- 編集: ❌

##### 4.3 指導者目標閲覧画面
**機能:**
- 担当生徒一覧
- 生徒別目標詳細
- 「今回の思い」閲覧
- コメント機能（将来実装）

##### 4.4 指導者振り返り閲覧画面
**機能:**
- 生徒別達成マップ
- 学習履歴閲覧
- コーチングサマリー閲覧
- 生徒間比較（将来実装）

---

### P3-5: 結果入力機能

**対象ファイル:**
- `app/student/goal/result/page.tsx` - 結果入力画面
- `app/actions/goal.ts` - Server Actions追加

#### タスク内訳

##### 5.1 結果入力フォーム
**入力項目:**
- テスト日選択（プルダウン）
- 実際のコース（S/C/B/A）
- 実際の組（1〜40）
- テストの振り返り（最大300字）

##### 5.2 達成判定ロジック
**判定基準:**
- コース・組が目標を上回った → 達成
- コース同じ、組が上回った → 達成
- それ以外 → 未達成

##### 5.3 結果保存
**データ保存:**
- `test_results` テーブルに保存
- 目標との紐付け（test_goal_id）
- 達成判定フラグ

---

### P3-6: 組分け一覧機能

**対象ファイル:**
- `app/student/goal/history/page.tsx` - 履歴一覧画面

#### タスク内訳

##### 6.1 時系列表示
**表示仕様:**
- 並び順: 新しい順（降順）
- 初期表示: 最新5件のみ展開
- 6件目以降: 「もっと見る」で5件ずつ展開
- 件数サマリー表示

##### 6.2 テストカード
**表示内容:**
- ヘッダ:
  - テスト名
  - 実施日
  - タイプチップ（合不合/組分け）
  - コース・組チップ
- 目標 vs 実績対比
- 達成判定表示

##### 6.3 詳細開閉
**機能:**
- デフォルト: コンパクト表示
- 「詳細を見る」: コース/組/今回の思い表示
- ソート切替: 新しい順/古い順

---

### P3-7: Phase 3 総合テスト

**対象ファイル:**
- `scripts/test/test-goal-flow.ts` - ゴールナビE2Eテスト
- `scripts/test/test-reflect-flow.ts` - リフレクトE2Eテスト
- `docs/tasks/P3-test-results.md` - テスト結果ドキュメント

#### テスト項目

##### 7.1 ゴールナビE2Eテスト
1. テスト日程表示確認
2. 目標入力フォーム動作確認
3. AI対話フロー（6ステップ）実行
4. 「今回の思い」生成確認
5. 目標保存確認

##### 7.2 リフレクトE2Eテスト
1. 週次振り返りUI表示確認
2. AI週次コーチング実行（週タイプ別）
3. GROW/Willデータ参照確認
4. セッション保存確認
5. 達成マップ表示確認

##### 7.3 統合テスト
1. ゴールナビ → 結果入力 → 組分け一覧フロー
2. リフレクト → コーチング履歴フロー
3. 保護者・指導者閲覧権限確認
4. パフォーマンステスト

---

## AIプロンプト設計方針

### ゴールナビ用プロンプト
**システムプロンプト:**
- 生徒の目標設定をサポートするコーチの役割
- セルフコンパッション重視
- 6ステップフローの進行役

**ユーザープロンプト:**
- 各ステップの質問生成
- 生徒の回答を受けた次のステップへの誘導
- 「今回の思い」の文章生成

### リフレクト用プロンプト
**システムプロンプト:**
- GROWモデルに基づく週次コーチ
- 週タイプ別の対話適応
- セルフコンパッション + 成長マインドセット

**ユーザープロンプト:**
- 先週の学習データ要約
- 週タイプ判定
- フェーズ別質問生成
- SMART目標選択肢生成

**マンネリ防止:**
- 質問バリエーション10種類以上をプール
- ランダム使用
- 過去のコーチング履歴参照で重複回避

---

## データモデル

### test_goals テーブル
```sql
id (uuid)
student_id (uuid)
test_schedule_id (uuid) - test_schedulesテーブルと紐付け
target_course (text) - S/C/B/A
target_class (integer) - 1-40
goal_reflection (text) - 今回の思い
ai_dialogue_log (jsonb) - AI対話ログ
edit_history (jsonb) - 編集履歴
created_at (timestamptz)
updated_at (timestamptz)
```

### test_results テーブル
```sql
id (uuid)
test_goal_id (uuid) - test_goalsテーブルと紐付け
student_id (uuid)
test_schedule_id (uuid)
actual_course (text) - S/C/B/A
actual_class (integer) - 1-40
test_reflection (text) - テストの振り返り
achieved (boolean) - 達成判定
created_at (timestamptz)
```

### coaching_sessions テーブル
```sql
id (uuid)
student_id (uuid)
week_start_date (date) - 週の開始日（月曜）
week_type (text) - growth/stable/challenge/special
session_summary (text) - GROWサマリー
created_at (timestamptz)
```

### coaching_messages テーブル
```sql
id (uuid)
session_id (uuid) - coaching_sessionsテーブルと紐付け
sender (text) - ai/student
message (text)
message_type (text) - question/answer/option
turn_number (integer) - ターン番号
created_at (timestamptz)
```

---

## UI/UXポイント

### 特別感の演出
| 要素 | 実装 |
|------|------|
| 限定感 | 「土曜日限定」のラベル表示 |
| 視覚効果 | ボタンの光るアニメーション |
| 音効果 | 完了時の達成音 |
| 報酬 | 振り返り完了バッジ |

### チャットUI
- LINEライクなチャット形式
- AIコーチのアバター表示
- 選択肢ボタン（タップしやすく）
- 入力中の「...」アニメーション
- ターン数表示

### レスポンシブ対応
- スマホ: 1カラム
- タブレット/PC: 2カラム
- チャットエリアは常に全幅

---

## パフォーマンス最適化

### AIキャッシュ戦略
- ゴールナビ:
  - 同一目標（コース・組）の「今回の思い」を再利用
  - キャッシュキー: 目標+対話内容ハッシュ
- リフレクト:
  - 週タイプ + 学習データ範囲でキャッシュ
  - キャッシュキー: 週タイプ+正答率範囲+科目構成

### データ取得最適化
- 達成マップ: 6週間分のみ取得
- コーチング履歴: ページネーション（5件ずつ）
- 学習履歴: フィルター適用後に取得

---

## セキュリティ・バリデーション

### 入力検証
- 文字数制限（100字/150字/300字）
- 必須フィールドチェック
- 数値範囲チェック（1-40）

### 権限制御
- 生徒: 自分の目標・実績のみ編集可
- 保護者: 自分の子どものみ閲覧可
- 指導者: 担当生徒のみ閲覧可

### RLS確認
- test_goals, test_results, coaching_sessions, coaching_messages
- ロール別アクセス制御

---

## DoD (Definition of Done)

Phase 3完了の条件:

- [ ] 生徒がテスト目標を設定できる
- [ ] AI対話を通じて「今回の思い」を生成できる
- [ ] 週次振り返りでAIコーチングを受けられる
- [ ] GROWモデルに基づく対話が動的に適応する
- [ ] 週タイプ別に対話パターンが変化する
- [ ] 達成マップで科目別進捗を可視化できる
- [ ] 保護者・指導者が生徒の目標・振り返りを閲覧できる
- [ ] テスト結果を入力し、達成判定が行われる
- [ ] 組分け一覧で目標と実績を対比表示できる
- [ ] セルフコンパッション・成長マインドセットが対話に反映される

---

## リスク要因

| リスク | 発生確率 | 影響度 | 対策 |
|-------|---------|--------|------|
| AI対話の品質・一貫性 | 高 | 高 | プロンプト設計の徹底、テストケース充実 |
| 週タイプ判定の精度 | 中 | 中 | 判定ロジックの調整、閾値の見直し |
| 対話ターン制御の複雑性 | 中 | 中 | ステートマシン設計、フロー図作成 |
| リフレクト利用時間の制御 | 低 | 中 | Asia/Tokyo基準の厳密な実装 |
| AIキャッシュのヒット率 | 中 | 低 | キャッシュキー設計の最適化 |

---

## 次のステップ

1. **P3-1: ゴールナビ実装開始**
   - テスト日程表示から着手
   - 目標入力フォーム実装
   - AI対話フロー基盤構築

2. **並行作業:**
   - AIプロンプト設計
   - データベーススキーマ確認（追加マイグレーション不要）
   - UIコンポーネント準備

3. **順次実装:**
   - P3-1完了 → P3-2リフレクト実装
   - P3-2完了 → P3-3達成マップ実装
   - P3-3完了 → P3-4保護者・指導者画面
   - P3-4完了 → P3-5結果入力
   - P3-5完了 → P3-6組分け一覧
   - P3-6完了 → P3-7総合テスト

---

**推定開始日:** 2025年10月6日
**推定完了日:** 2025年10月27日（3週間）

**最終更新:** 2025年10月6日 03:30
**更新者:** Claude Code
