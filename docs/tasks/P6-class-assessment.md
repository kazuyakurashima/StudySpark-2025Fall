# Phase 6: クラス内テスト機能（算数プリント・漢字テスト）

**期間:** 4-6週間（Phase 1-3）
**進捗:** 0% (0/47タスク完了)
**状態:** ⏳ 未着手
**ブランチ:** `feature/class-assessment`

---

## 概要

塾の算数プリントと漢字テストの結果をStudySparkに取り込み、生徒・保護者・指導者が閲覧・応援できる機能を実装する。

**主な目的:**
1. 日々の学習成果をより包括的に可視化
2. プリント・漢字テストへの応援メッセージ送信を可能に
3. 指導者の分析機能強化

**設計ドキュメント:** `docs/CLASS-ASSESSMENT-DESIGN.md`（別途作成予定）

---

## 依存関係

```
P6-1 (DB設計) ← P6-2 (Server Actions) ← P6-3 (生徒UI)
                                       ← P6-4 (保護者UI)
                                       ← P6-5 (指導者UI)
P6-3, P6-4, P6-5 ← P6-6 (応援機能統合)
```

---

## タスク一覧

### P6-1: データベース設計・マイグレーション ⏳ 未着手 (0/8完了)

**目標:** クラス内テストを管理するテーブルを設計・作成

- [ ] 設計ドキュメント作成 (`docs/CLASS-ASSESSMENT-DESIGN.md`)
  - 対応要件: 新規機能設計
  - 内容: テーブル設計、型定義、API設計、UX設計
  - 検証: 関係者レビュー完了

- [ ] `class_assessments` テーブル設計
  - 対応要件: データモデル
  - カラム:
    - `id` (UUID, PK)
    - `student_id` (INT, FK → students.id)
    - `assessment_type` ('math_print' | 'kanji_test')
    - `grade` (VARCHAR) - 学年
    - `session_number` (INT) - 学習回番号
    - `score` (NUMERIC) - 得点
    - `max_score` (NUMERIC) - 満点
    - `assessment_date` (DATE) - テスト実施日
    - `created_at`, `updated_at` (TIMESTAMP)
  - 検証: ER図更新、既存テーブルとの整合性確認

- [ ] `assessment_instances` テーブル設計（オプション）
  - 対応要件: マスターデータ管理
  - 内容: テスト回ごとのメタ情報（実施日、満点など）
  - 検証: 必要性の判断、シンプル設計の場合はスキップ

- [ ] マイグレーションファイル作成
  - ファイル: `supabase/migrations/YYYYMMDD000001_create_class_assessments.sql`
  - 内容: テーブル作成、インデックス、制約
  - 検証: ローカル環境でマイグレーション成功

- [ ] RLSポリシー実装
  - 対応要件: セキュリティ
  - ポリシー:
    - 生徒: 自分のデータのみCRUD
    - 保護者: 子どものデータ閲覧のみ
    - 指導者: 担当生徒のデータ閲覧のみ
  - 検証: 権限テスト実施

- [ ] 型定義作成 (`lib/types/class-assessment.ts`)
  - 内容: TypeScript型定義、Zod スキーマ
  - 検証: 型チェック通過

- [ ] シードデータ作成（開発用）
  - ファイル: `supabase/seed-class-assessments.sql`
  - 内容: デモユーザー用のサンプルデータ
  - 検証: ローカル環境でデータ確認

- [ ] P6-1 総合テスト
  - 検証項目:
    - マイグレーション適用成功
    - RLSポリシー動作確認
    - シードデータ投入成功
  - テストスクリプト: `scripts/test/test-class-assessment-db.ts`

---

### P6-2: Server Actions実装 ⏳ 未着手 (0/9完了)

**目標:** クラス内テストのCRUD操作を実装

- [ ] `app/actions/class-assessment.ts` 作成
  - 対応要件: データアクセス層
  - 検証: ファイル作成、基本構造実装

- [ ] `saveClassAssessment()` 実装
  - 内容: テスト結果の保存（新規/更新）
  - パラメータ: `{ studentId, type, sessionNumber, score, maxScore, date }`
  - 検証: 保存成功、重複チェック

- [ ] `getClassAssessments()` 実装
  - 内容: 生徒のテスト結果一覧取得
  - パラメータ: `{ studentId, type?, sessionNumber?, limit?, offset? }`
  - 検証: フィルタ動作確認

- [ ] `getClassAssessmentSummary()` 実装
  - 内容: 集計データ取得（平均点、推移など）
  - パラメータ: `{ studentId, type, period? }`
  - 検証: 集計ロジック確認

- [ ] `deleteClassAssessment()` 実装
  - 内容: テスト結果の削除
  - パラメータ: `{ assessmentId }`
  - 検証: 削除成功、権限チェック

- [ ] `getRecentAssessments()` 実装
  - 内容: 直近のテスト結果取得（ダッシュボード用）
  - パラメータ: `{ studentId, limit? }`
  - 検証: 最新順ソート確認

- [ ] `getAssessmentsForEncouragement()` 実装
  - 内容: 応援機能用のテスト結果取得（応援状況付き）
  - パラメータ: `{ studentId, hasEncouragement?, limit? }`
  - 検証: 応援フィルタ動作確認

- [ ] API Route作成 (`app/api/class-assessment/route.ts`)
  - 内容: SWR用エンドポイント
  - 検証: GET/POSTレスポンス確認

- [ ] P6-2 総合テスト
  - 検証項目:
    - 全Server Actions動作確認
    - エラーハンドリング確認
    - 権限チェック確認
  - テストスクリプト: `scripts/test/test-class-assessment-actions.ts`

---

### P6-3: 生徒向けUI実装 ⏳ 未着手 (0/8完了)

**目標:** 生徒がテスト結果を入力・閲覧できる画面を実装

- [ ] 入力画面デザイン検討
  - 対応要件: UX設計
  - オプション:
    - A案: スパーク画面に統合（タブ追加）
    - B案: 独立ページ `/student/assessment`
    - C案: ダッシュボードにクイック入力
  - 検証: ユーザーフィードバック

- [ ] テスト結果入力フォーム実装
  - ファイル: `app/student/assessment/page.tsx` または統合先
  - UI要素:
    - テストタイプ選択（算数プリント/漢字テスト）
    - 学習回選択
    - 得点入力
    - 日付入力（デフォルト今日）
  - 検証: フォームバリデーション動作

- [ ] SWRフック作成 (`lib/hooks/use-class-assessments.ts`)
  - 内容: テスト結果のフェッチ・キャッシュ管理
  - 検証: データ取得・更新動作確認

- [ ] 入力完了フィードバック実装
  - 内容: 成功メッセージ、アニメーション
  - 検証: UX確認

- [ ] ダッシュボードへの表示追加
  - ファイル: `app/student/page.tsx` (dashboard-client)
  - 内容: 直近のテスト結果カード表示
  - 検証: レイアウト確認

- [ ] テスト結果履歴画面実装
  - 内容: 過去のテスト結果一覧・グラフ表示
  - ファイル: `app/student/assessment/history/page.tsx`
  - 検証: ページネーション・フィルタ動作

- [ ] 進捗グラフ実装（Recharts）
  - 内容: 得点推移の折れ線グラフ
  - 検証: グラフ表示確認

- [ ] P6-3 総合テスト
  - 検証項目:
    - 入力フロー動作確認
    - ダッシュボード表示確認
    - 履歴・グラフ表示確認
  - テスト環境: デモユーザーで実施

---

### P6-4: 保護者向けUI実装 ⏳ 未着手 (0/6完了)

**目標:** 保護者が子どものテスト結果を閲覧できる画面を実装

- [ ] ダッシュボードへの表示追加
  - ファイル: `app/parent/page.tsx` (dashboard-client)
  - 内容: 子どもの直近テスト結果表示
  - 検証: レイアウト確認

- [ ] 詳細閲覧画面実装
  - ファイル: `app/parent/assessment/page.tsx`
  - 内容: テスト結果一覧・グラフ表示
  - 検証: データ表示確認

- [ ] フィルタ機能実装
  - 内容: テストタイプ、期間でフィルタ
  - 検証: フィルタ動作確認

- [ ] 子ども選択機能（複数子どもの場合）
  - 内容: 子どもの切り替えUI
  - 検証: 複数子どもがいる保護者で確認

- [ ] 進捗グラフ表示
  - 内容: 生徒画面と同様のグラフ
  - 検証: グラフ表示確認

- [ ] P6-4 総合テスト
  - 検証項目:
    - データ閲覧動作確認
    - 複数子どもの切り替え確認
    - グラフ表示確認

---

### P6-5: 指導者向けUI実装 ⏳ 未着手 (0/7完了)

**目標:** 指導者が担当生徒のテスト結果を閲覧・分析できる画面を実装

- [ ] 生徒詳細タブへの追加
  - ファイル: `app/coach/student/[id]/tabs/assessment-tab.tsx`
  - 内容: 個別生徒のテスト結果タブ
  - 検証: タブ切り替え動作確認

- [ ] 生徒一覧でのサマリー表示
  - ファイル: `app/coach/components/coach-home-client.tsx`
  - 内容: 直近のテスト結果サマリー
  - 検証: カード表示確認

- [ ] 分析ページへの統合
  - ファイル: `app/coach/analysis/page.tsx`
  - 内容: クラス全体のテスト結果分析
  - 検証: 集計データ表示確認

- [ ] バッチ入力機能検討
  - 対応要件: 運用効率化
  - 内容: 複数生徒のテスト結果を一括入力
  - 検証: 必要性の判断、Phase 2以降でも可

- [ ] 比較グラフ実装
  - 内容: 生徒間比較、クラス平均との比較
  - 検証: グラフ表示確認

- [ ] エクスポート機能（オプション）
  - 内容: CSVダウンロード
  - 検証: ファイル出力確認

- [ ] P6-5 総合テスト
  - 検証項目:
    - 個別生徒データ表示確認
    - 分析機能動作確認
    - 比較グラフ表示確認

---

### P6-6: 応援機能統合 ⏳ 未着手 (0/9完了)

**目標:** テスト結果への応援メッセージ送信を可能にする

- [ ] `encouragement_messages` テーブル拡張検討
  - 対応要件: データモデル
  - 内容: `related_assessment_id` カラム追加 or 既存構造活用
  - 検証: 設計レビュー

- [ ] マイグレーション作成（必要な場合）
  - ファイル: `supabase/migrations/YYYYMMDD_add_assessment_encouragement.sql`
  - 検証: マイグレーション成功

- [ ] Server Actions拡張
  - ファイル: `app/actions/encouragement.ts`
  - 内容: テスト結果への応援送信機能追加
  - 検証: 送信成功

- [ ] 保護者応援画面でテスト結果表示
  - ファイル: `app/parent/encouragement/page.tsx`
  - 内容: テスト結果カード追加、応援送信UI
  - 検証: UI表示・送信動作確認

- [ ] 指導者応援画面でテスト結果表示
  - ファイル: `app/coach/encouragement/page.tsx`
  - 内容: テスト結果カード追加、応援送信UI
  - 検証: UI表示・送信動作確認

- [ ] 生徒画面で応援受信表示
  - ファイル: `app/student/encouragement/page.tsx`
  - 内容: テスト結果への応援を表示
  - 検証: 応援表示確認

- [ ] AI応援プロンプト調整
  - ファイル: `lib/openai/prompts.ts`
  - 内容: テスト結果コンテキストを考慮したプロンプト
  - 検証: AI生成文の品質確認

- [ ] フィルタ機能拡張
  - 内容: 応援フィルタに「テスト結果」追加
  - 検証: フィルタ動作確認

- [ ] P6-6 総合テスト
  - 検証項目:
    - 保護者からの応援送信確認
    - 指導者からの応援送信確認
    - 生徒での応援受信確認
    - AI応援生成品質確認

---

## DoD (Definition of Done)

Phase 6完了の条件:

### Phase 6.1 (MVP)
- [ ] 生徒がテスト結果を入力できる
- [ ] 生徒ダッシュボードにテスト結果が表示される
- [ ] 保護者が子どものテスト結果を閲覧できる
- [ ] RLSポリシーで適切なアクセス制御が機能

### Phase 6.2 (応援統合)
- [ ] 保護者がテスト結果に応援メッセージを送信できる
- [ ] 指導者がテスト結果に応援メッセージを送信できる
- [ ] 生徒がテスト結果への応援を受信・閲覧できる

### Phase 6.3 (分析強化)
- [ ] 指導者分析画面でテスト結果を確認できる
- [ ] 進捗グラフが正しく表示される
- [ ] エクスポート機能が動作する（オプション）

---

## フェーズ分け計画

### Phase 6.1: MVP（2週間）
- P6-1: データベース設計・マイグレーション
- P6-2: Server Actions実装
- P6-3: 生徒向けUI実装（入力・閲覧）

### Phase 6.2: 応援統合（1-2週間）
- P6-4: 保護者向けUI実装
- P6-6: 応援機能統合

### Phase 6.3: 分析強化（1-2週間）
- P6-5: 指導者向けUI実装
- グラフ・エクスポート機能

---

## リスク要因

| リスク | 発生確率 | 影響度 | 対策 | 状態 |
|--------|---------|--------|------|------|
| 入力UIの複雑化によるUX低下 | 中 | 高 | シンプルな入力フローを優先、段階的機能追加 | ⏳ 監視中 |
| 既存応援機能との統合複雑性 | 中 | 中 | 既存パターンを活用、batch_id構造の踏襲 | ⏳ 監視中 |
| データ量増加によるパフォーマンス | 低 | 中 | インデックス最適化、ページネーション | ⏳ 監視中 |
| 学年別ロールアウトの複雑性 | 低 | 低 | feature flagで制御 | ⏳ 監視中 |

---

## 将来拡張（Phase 7以降）

- [ ] PDF OCR自動取り込み機能
- [ ] 6年生向け機能（2025年2月〜）
- [ ] 塾システムとのAPI連携
- [ ] 目標設定機能（テスト目標点数）

---

## 参照ドキュメント

- `docs/03-Requirements-Student.md` - 生徒機能仕様
- `docs/04-Requirements-Parent.md` - 保護者機能仕様
- `docs/05-Requirements-Coach.md` - 指導者機能仕様
- `docs/tasks/P2-encouragement.md` - 応援機能タスク（参考）
- `docs/COACH-UI-REDESIGN.md` - 指導者UI改善（参考）

---

**最終更新:** 2025年12月9日
**更新者:** Claude Code
