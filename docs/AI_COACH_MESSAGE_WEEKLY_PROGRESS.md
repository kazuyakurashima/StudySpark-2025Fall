# AIコーチメッセージ週次進捗対応仕様書

**作成日:** 2025年11月2日
**最終更新:** 2025年11月2日
**目的:** AIコーチメッセージに今週の累積進捗データを追加し、直近ログと週次進捗を明確に区別する

---

## 📋 背景・課題

### 現状の問題

AIコーチメッセージは**直近3日間のログのみ**を参照しており、以下の問題が発生していた：

1. **今週の累積進捗が見えない**
   - 例: 今週の社会は14/22（64%）なのに、昨日の7/15（47%）だけを見てコメント

2. **週次目標（80%達成）との距離が分からない**
   - 「あと何問で80%達成」という具体的な情報が提示できない

3. **データの混同**
   - 直近の正答率と週次の正答率を区別せず、混乱を招く

### ユーザー要件

生徒には**2つの目標**がある：
1. **今日のミッション:** その日の3科目を入力完了
2. **週次目標:** 各科目で80%正答率を達成

AIメッセージでは以下のように区別して伝える：

✅ **良い例:**
> 「今日は社会を20問解いたね！今週の社会は30/60問（50%）で、目標の80%まであと18問だよ。」

❌ **悪い例:**
> 「社会が47%で...」← どちらのデータか不明確

---

## 🎯 実装方針

### 1. データの使い分け

| データ種別 | 用途 | 表現例 |
|-----------|------|--------|
| **直近ログ** | 最近の努力を承認 | 「今日は〜を20問解いたね」 |
| **週次進捗** | 目標との距離を提示 | 「今週の〜は30/60問（50%）で、あと18問」 |

### 2. 週次進捗の定義

**集計期間:** 今週の学習回（`study_sessions`の`start_date`〜`end_date`）

**集計方法:** 該当期間の**全ログを累積合算**（最新ログのみではない）

**科目順序:** 算数 → 国語 → 理科 → 社会（固定順）

### 3. 目標達成までの残り問題数の計算

**前提:** 分母を増やさず、既存問題の中で80%正解を目指す

**計算式:**
```
targetCorrect = Math.ceil(0.8 * weekTotal)
remainingToTarget = Math.max(0, targetCorrect - weekCorrect)
```

**例:**
```
現状: 30/60問（50%）
目標: 0.8 * 60 = 48問正解
残り: 48 - 30 = 18問
```

---

## 📐 技術仕様

### 1. 新規関数: `getWeeklyCumulativeProgress()`

**ファイル:** `app/actions/dashboard.ts`

**シグネチャ:**
```typescript
async function getWeeklyCumulativeProgress(
  studentId: number
): Promise<{
  progress: {
    subject: string
    weekCorrect: number
    weekTotal: number
    weekAccuracy: number
    remainingToTarget: number
  }[]
}>
```

**処理フロー:**
1. `students`テーブルから`grade`取得
2. `study_sessions`から今週のセッション取得
3. `study_logs`から今週の**全ログ**を取得（`session_id`で絞り込み）
4. 科目別に累積集計
5. `weekTotal < 10`の科目は除外（データ不足）
6. 科目順でソート（算→国→理→社）

**エラーハンドリング:**
- セッション取得失敗 → ログ出力、空配列返却
- ログ取得失敗 → ログ出力、空配列返却

### 2. 型定義の拡張: `CoachMessageContext`

**ファイル:** `lib/openai/coach-message.ts`

**追加プロパティ:**
```typescript
export interface CoachMessageContext {
  // ... 既存フィールド

  weeklyProgress?: {  // オプショナル
    subject: string
    weekCorrect: number
    weekTotal: number
    weekAccuracy: number
    remainingToTarget: number
  }[]
}
```

### 3. `getAICoachMessage()`の修正

**変更内容:**
- `Promise.all`に`getWeeklyCumulativeProgress()`を追加
- `context.weeklyProgress`にデータを設定

### 4. システムプロンプトの更新

**追加内容:**
- データの使い分けルール
- 良い例・悪い例のFew-shot
- 目標達成済み科目の扱い

---

## 🧪 テストケース

### ケース1: 通常ケース（週途中）
```
入力:
- 今週の社会: 30/60問（50%）
- 今日の社会: 20問正解

期待される出力:
「今日は社会を20問解いたね！今週の社会は30/60問（50%）で、目標の80%まであと18問だよ。」
```

### ケース2: 目標達成済み
```
入力:
- 今週の算数: 48/60問（80%）
- 今日の算数: 15問正解

期待される出力:
「今日も算数に取り組んだね！今週の算数は目標達成！素晴らしい！」
```

### ケース3: データ不足（週初め）
```
入力:
- 今週の国語: 5/8問（weekTotal < 10）

期待される動作:
- weeklyProgressから国語を除外
- 直近ログと今日のミッションのみ言及
```

### ケース4: 全科目データなし
```
入力:
- weeklyProgress: []

期待される出力:
「今週の学習を始めよう！今日はまず算数に取り組んでみよう。」
```

---

## 🚨 注意事項

### 1. 週の境界定義
- `study_sessions`の`start_date`〜`end_date`を使用
- 月曜〜日曜ではなく、学習回の期間に従う
- 理由: 既存の週次進捗表示と整合性を保つため

### 2. パフォーマンス
- AIコーチメッセージは1日1回キャッシュされる
- 追加クエリ1本（study_logs集計）は許容範囲
- 初回生成時のみ実行されるため影響は限定的

### 3. データ整合性
- `subject_id`も取得して科目判定を安定化
- ソート順を固定して配列の順序を保証

---

## 📝 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-11-02 | 初版作成 |

---

## 🔗 関連ドキュメント

- [03-Requirements-Student.md](./03-Requirements-Student.md) - 生徒機能要件（今日のミッション）
- [P6-ai-coach-message.md](./tasks/P6-ai-coach-message.md) - AIコーチメッセージタスク
