# StudySpark 開発計画書 (Phase Plan)

## プロジェクト概要

**StudySpark** は、中学受験を目指す小学6年生向けの学習支援Webアプリケーションです。AIコーチング、学習記録、応援機能を通じて、生徒・保護者・指導者をサポートします。

---

## フェーズ分割と優先順位

### Phase 0: 基盤整備 (P0) - 2週間
**目的**: すべての機能の前提となるインフラ・認証・DB基盤の構築

#### 成果物
1. **Supabase環境構築**
   - 本番環境: `zlipaeanhcslhintxpej.supabase.co`
   - 開発環境: 新規プロジェクト作成
   - ローカル環境: Supabase Local (Docker)

2. **認証システム実装**
   - Supabase Auth統合
   - ロール別認証フロー (student/parent/coach/admin)
   - 初期セットアップフロー (アバター・プロフィール)

3. **データベース設計・構築**
   - スキーマ定義 (全テーブル)
   - RLS (Row Level Security) ポリシー
   - マスターデータ投入 (学習回・科目・問題数・テスト日程)

4. **開発環境整備**
   - Supabase クライアントヘルパー (Server/Client/Middleware)
   - 環境変数設定 (.env.local)
   - Sentry統合 (エラートラッキング)

#### DoD (Definition of Done)
- [ ] 本番・開発・ローカル環境でSupabase接続成功
- [ ] 4ロール全てで認証フロー動作確認 (ログイン・ログアウト)
- [ ] RLSポリシーでロール別アクセス制御が機能
- [ ] テストユーザー (各ロール1名以上) で全機能アクセス可能
- [ ] Sentryでエラーログ収集確認

#### 依存関係
- なし (最優先フェーズ)

#### リスク要因
- **高**: Supabase RLSポリシーの複雑性 → 親子関係・指導者-生徒関係の権限設計
- **中**: 生徒ログインID自動生成ロジックの衝突回避
- **低**: Docker環境構築 (M1/M2 Macでの互換性問題)

---

### Phase 1: 学習記録機能 (P1) - 3週間
**目的**: 生徒の学習記録とダッシュボード表示 (MVP核心機能)

#### 成果物
1. **生徒: スパーク機能 (学習記録入力)**
   - 科目別学習内容入力 (正答数/問題数)
   - コース別範囲表示 (A/B/C・S)
   - 振り返り機能 (自由記述 or AI生成3択)
   - 再入力時の差分表示

2. **生徒: ダッシュボード**
   - 学習カレンダー (GitHub風ヒートマップ、3段階色分け)
   - 今週の科目別進捗バー
   - 直近の学習履歴 (24-48時間)
   - 今日のミッション (曜日別ローテーション)

3. **保護者: ダッシュボード**
   - 子ども切り替えタブ
   - 学習カレンダー・進捗バー (生徒と同一)
   - 直近の学習履歴閲覧

4. **データ永続化**
   - 学習ログテーブル (study_logs)
   - 正答率計算ロジック
   - カレンダー色分けロジック (2判定基準の実装)

#### DoD (Definition of Done)
- [ ] 生徒が学習記録を入力し、即座にダッシュボードに反映
- [ ] カレンダーの色分けが正答率・入力科目数で正しく動作
- [ ] 今日のミッションが曜日・モード (入力/復習/特別) で正しく表示
- [ ] 保護者が子どもの学習状況を閲覧可能
- [ ] コース (A/B/C・S) 別に表示範囲が適切にフィルタリング

#### 依存関係
- Phase 0 完了 (認証・DB基盤)

#### リスク要因
- **高**: カレンダー色分けロジックの複雑性 (2判定基準 × 3段階)
- **中**: 今日のミッションの曜日別ロジック (入力促進/復習促進/特別モード)
- **中**: コース別表示の学年・科目依存ロジック

---

### Phase 2: 応援機能 (P2) - 2週間
**目的**: 保護者・指導者から生徒への応援メッセージ送信

#### 成果物
1. **保護者: 応援機能**
   - クイック応援 (スタンプ3種)
   - AI応援メッセージ (ChatGPT生成3択、編集可能)
   - カスタムメッセージ (最大200字)
   - 応援済み/未応援フィルター

2. **指導者: ホーム (応援)**
   - 学習記録への応援 (保護者と同様の3方式)
   - 未入力生徒一覧 (警告表示)
   - 対応ボタン・対応メモ機能

3. **生徒: 応援受信**
   - ダッシュボードに直近の応援メッセージ表示
   - アプリ内通知 (未読バッジ・カウンタ)

4. **ChatGPT API統合 (第1弾)**
   - AI応援メッセージ生成 (3パターン: 励まし/共感/次への期待)
   - キャッシュ機能 (1記録につき1回のみ生成)
   - タイムアウト・エラーハンドリング

#### DoD (Definition of Done)
- [ ] 保護者・指導者が3方式で応援メッセージ送信可能
- [ ] 生徒ダッシュボードに応援メッセージが即座に反映
- [ ] AI応援メッセージが3秒以内に生成・表示
- [ ] 未入力生徒一覧が正しく警告表示 (7日/5日/3日基準)
- [ ] アプリ内通知が機能 (未読カウンタ表示)

#### 依存関係
- Phase 1 完了 (学習記録データが存在)

#### リスク要因
- **高**: ChatGPT APIレート制限 (無料Tier: 20k TPM) → バッチ処理・キャッシュで対応
- **中**: AI生成メッセージの品質 (プロンプト調整必要)
- **低**: 通知テーブルのRLS設計

---

### Phase 3: 目標管理・週次振り返り (P3) - 4週間
**目的**: AIコーチングによる目標設定と週次振り返り (差別化要素)

#### 成果物
1. **生徒: ゴールナビ (目標管理)**
   - テスト目標設定 (コース・組)
   - AI対話による「今回の思い」生成 (6ステップフロー)
   - テスト結果入力・振り返り
   - 組分け一覧 (目標 vs 実績)

2. **生徒: リフレクト (週次振り返り)**
   - AI週次コーチング (GROW モデル、土曜12:00〜水曜23:59限定)
   - 週タイプ別対話 (成長週/安定週/挑戦週/特別週)
   - 達成マップ (科目別ヒートマップ、正答率ベース)
   - 学習履歴・応援履歴・コーチング履歴表示

3. **保護者・指導者: 閲覧機能**
   - ゴールナビ閲覧 (目標・結果確認)
   - リフレクト閲覧 (達成マップ・履歴)

4. **ChatGPT API統合 (第2弾)**
   - 「今回の思い」生成 (6ステップ対話)
   - 週次コーチング (GROW フロー、3-6往復)
   - セルフコンパッション実装 (否定的発言への応答)

#### DoD (Definition of Done)
- [ ] 生徒が目標設定し、AI対話で「今回の思い」を生成
- [ ] 週次コーチングが週タイプ別に適切な対話を実行
- [ ] 達成マップが科目別・正答率ベースで色分け表示
- [ ] 保護者・指導者が生徒の目標・振り返りを閲覧可能
- [ ] AI対話が6往復以内に完了し、自然な会話フロー

#### 依存関係
- Phase 1 完了 (学習データ蓄積)
- Phase 2 完了 (応援データ連携)

#### リスク要因
- **最高**: AI対話の複雑性 (週タイプ判定、動的フロー生成、マンネリ防止)
- **高**: ChatGPT APIコスト (週次コーチング × 生徒数 × 4週)
- **中**: 時間制限ロジック (土曜12:00〜水曜23:59、Asia/Tokyo基準)

---

### Phase 4: 指導者分析機能 (P4) - 3週間
**目的**: 週次AI分析による高度な学習支援 (将来価値)

#### 成果物
1. **指導者: 生徒一覧**
   - 個別生徒詳細閲覧 (ホーム/ゴールナビ/達成マップ/学習履歴等)

2. **指導者: 週次AI分析**
   - 5項目分析 (ゴールナビ/達成マップ/学習履歴/応援履歴/コーチング履歴)
   - 中間分析 (月曜0:00実行)
   - 最終分析 (木曜0:00実行)
   - 共通分析軸 (学年別/生徒別/科目別/前週比較)
   - 履歴閲覧機能

3. **ChatGPT API統合 (第3弾)**
   - 週次分析レポート生成
   - SMART度判定 (Willの品質評価)
   - 行動変容分析

4. **バッチ処理基盤**
   - Supabase Edge Functions (Cron Job)
   - 月曜0:00・木曜0:00自動実行

#### DoD (Definition of Done)
- [ ] 指導者が生徒一覧から個別詳細を閲覧可能
- [ ] 週次分析が月曜・木曜に自動実行
- [ ] 分析結果が5項目×共通分析軸で表示
- [ ] 過去の分析履歴を時系列で閲覧可能
- [ ] Will品質評価 (SMART度) が機能

#### 依存関係
- Phase 3 完了 (コーチングデータ蓄積)

#### リスク要因
- **高**: Supabase Edge Functions の Cron Job設定
- **高**: ChatGPT API大量実行 (生徒数 × 5項目)
- **中**: 分析結果の保存・履歴管理

---

### Phase 5: 監査・運用機能 (P5) - 2週間
**目的**: システムログ・監視・データ削除ポリシーの実装

#### 成果物
1. **監査ログ**
   - ユーザー操作ログ (認証・データ変更)
   - API実行ログ (ChatGPT呼び出し)
   - 3年間保持

2. **データ削除ポリシー**
   - 卒業後1年で学習ログ削除 (自動)
   - 退会時の個人情報保持 (1年間)
   - 通知データ90日自動削除

3. **管理者機能**
   - 招待コード生成 (admin/coach向け)
   - ユーザー管理 (無効化・削除)
   - マスターデータ更新 (テスト日程等)

4. **エラー追跡強化**
   - Sentry詳細設定
   - Vercel Analytics統合

#### DoD (Definition of Done)
- [ ] 監査ログがすべての重要操作で記録
- [ ] データ削除ポリシーが自動実行
- [ ] 管理者が招待コード生成・ユーザー管理可能
- [ ] Sentryでエラーの詳細トレース可能
- [ ] Vercel Analyticsでパフォーマンス監視

#### 依存関係
- Phase 0-4 完了 (全機能実装済み)

#### リスク要因
- **中**: データ削除の自動化 (Supabase Functions)
- **低**: 監査ログのストレージ容量

---

## 各フェーズの時間配分

| フェーズ | 期間 | 工数 (人日) | 主要マイルストーン |
|---------|------|------------|------------------|
| **P0: 基盤整備** | 2週間 | 10日 | 認証・DB・RLS完了 |
| **P1: 学習記録** | 3週間 | 15日 | MVP核心機能完了 |
| **P2: 応援機能** | 2週間 | 10日 | ChatGPT統合第1弾 |
| **P3: AI週次振り返り** | 4週間 | 20日 | 差別化要素完了 |
| **P4: 指導者分析** | 3週間 | 15日 | 高度分析完了 |
| **P5: 監査・運用** | 2週間 | 10日 | 本番リリース準備完了 |
| **合計** | **16週間** | **80日** | - |

---

## 技術スタック確定

### フロントエンド
- Next.js 14.2.18 (App Router)
- React 18.3.1
- TypeScript 5.5.4
- Tailwind CSS 4.1.9
- Radix UI (既存コンポーネント流用)

### バックエンド
- Supabase (PostgreSQL + Auth + Realtime + Edge Functions)
- Server Actions (Next.js)
- ChatGPT API (gpt-5-mini ※要確認: 現在は`gpt-5-mini`推奨)

### 開発環境
- **本番**: Supabase Project `zlipaeanhcslhintxpej`
- **開発**: 新規Supabaseプロジェクト作成予定
- **ローカル**: Supabase Local (Docker)

### 監視・エラー追跡
- Sentry (エラートラッキング)
- Vercel Analytics (パフォーマンス)
- Supabase Logs + Vercel Logs (ログ集約)

### デプロイ
- Vercel (ホスティング)
- カスタムドメイン: なし (Vercelデフォルト)

---

## リスク管理マトリクス

| リスク | 発生確率 | 影響度 | 対策 | 担当フェーズ |
|--------|---------|--------|------|------------|
| RLSポリシーの複雑性 | 高 | 高 | 段階的実装・テストケース充実 | P0 |
| ChatGPT APIレート制限 | 中 | 高 | キャッシュ・バッチ処理・エラーハンドリング | P2-P4 |
| カレンダー色分けロジック | 中 | 中 | 単体テスト・視覚的検証 | P1 |
| AI対話の品質 | 高 | 中 | プロンプト反復改善・ユーザーフィードバック | P3 |
| 週次分析コスト | 中 | 中 | 実行頻度調整・必要最小限の分析項目 | P4 |

---

## 次のステップ

1. **Phase 0の詳細タスク分解** → `TASKS.md` 作成
2. **DB設計の詳細化** → `docs/db/Schema-Proposal.md` 作成
3. **環境変数テンプレート** → `.env.example` 作成
4. **Phase 0実装開始** (承認後)

---

**このフェーズ計画で進めてよろしいですか？(OK / 修正希望 でお答えください)**
