# 2026年度切替 タスク一覧

## 凡例

- **ステータス**: `[ ]` Not started / `[~]` In progress / `[!]` Blocked / `[x]` Done / `[x] SKIPPED` 条件不要で省略 / `[x] CANCELLED` 中止
- **優先度**: P0 (最優先) / P1 (優先) / P2 (通常)
- **週目安**: 1月第1週〜第4週、切替当日

---

## Epic 1: 環境分離

### 目的
本番環境（DB2025）とステージング環境（DB2026）を完全に分離し、安全な開発・検証環境を構築する。

### タスク

#### E1-T1: DB2026 Supabase プロジェクト作成
- [x] **ステータス**: Done
- **優先度**: P0
- **週目安**: 第1週
- **作業内容**:
  - Supabase ダッシュボードで新規プロジェクト作成
  - リージョン: Northeast Asia (Tokyo)
  - Database Password の安全な保管
  - Project URL, anon key, service_role key の取得・記録
- **完了条件**:
  - DB2026 プロジェクトが作成され、アクセス可能
  - 環境変数が記録されている
- **依存関係**: なし
- **リスク**: R-006（環境変数設定ミス）

#### E1-T2: DB2026 スキーマ適用
- [x] **ステータス**: Done (Supabase ダッシュボード経由で適用済み)
- **優先度**: P0
- **週目安**: 第1週
- **作業内容**:
  - 既存マイグレーションファイルの適用
  - `supabase db push` または手動適用
  - スキーマの確認
- **完了条件**:
  - 全テーブル・制約・トリガーが作成されている
  - RLSポリシーが適用されている
- **依存関係**: E1-T1
- **リスク**: なし

#### E1-T3: Vercel ステージング環境設定
- [x] **ステータス**: SKIPPED (即日切替で本番直接切替、ステージング別環境は不要)
- **優先度**: P0
- **週目安**: 第1週
- **作業内容**:
  - Preview 環境の環境変数設定（DB2026接続）
  - main ブランチのデプロイ確認
- **完了条件**:
  - main ブランチが Preview 環境にデプロイされる
  - DB2026 に正しく接続される
- **依存関係**: E1-T1, E1-T2
- **リスク**: R-001（DB混線）

#### E1-T4: 環境識別バナー実装
- [x] **ステータス**: CANCELLED (2026-02-07)
- **優先度**: P1（当初）
- **週目安**: 第1週
- **作業内容**:
  - ステージング環境でのみ表示されるバナーを実装
  - 本番/ステージングの識別が容易になる
- **中止理由**:
  - 2026-02-07 にDB2025→DB2026の即日切替が完了し、二重運用期間が発生しなかった
  - 本番がDB2026に一本化されたため、DB混線リスク（R-001）自体が解消
  - 一時実装した `components/environment-banner.tsx` は不要となり削除済み
- **依存関係**: E1-T3
- **リスク**: R-001（DB混線）対策 → リスク解消済み

#### E1-T5: メンテナンスモード実装
- [x] **ステータス**: Done (commit af99f09)
- **優先度**: P0
- **週目安**: 第2週
- **作業内容**:
  - メンテナンスページコンポーネント作成（app/maintenance/page.tsx）
  - 環境変数による切り替えロジック実装（middleware.ts または app/layout.tsx）
  - NEXT_PUBLIC_MAINTENANCE_MODE 環境変数での制御
  - ローカルでのテスト
- **完了条件**:
  - NEXT_PUBLIC_MAINTENANCE_MODE=true でメンテナンスページが表示される
  - 環境変数を false にすると通常ページに戻る
  - ステージング環境でのテスト完了
- **依存関係**: なし
- **リスク**: R-004（切替手順の属人化）対策

---

## Epic 2: ブランチ運用

### 目的
release/2025 ブランチを作成し、1月中の二重運用体制を確立する。

### タスク

#### E2-T1: release/2025 ブランチ作成
- [x] **ステータス**: Done (2026-02-07、ロールバック用安全ネットとして作成)
- **優先度**: P0
- **週目安**: 第1週
- **作業内容**:
  - main から release/2025 を分岐
  - ブランチ保護ルールの設定（直接push禁止）
  - チームへの周知
- **完了条件**:
  - release/2025 ブランチが存在する
  - 保護ルールが適用されている
- **依存関係**: なし
- **リスク**: なし

#### E2-T2: Vercel 本番環境のブランチ設定
- [x] **ステータス**: SKIPPED (即日切替で二重運用不要、main直接デプロイを継続)
- **優先度**: P0
- **週目安**: 第1週
- **作業内容**:
  - Production 環境を release/2025 ブランチに紐付け
  - デプロイ設定の確認
- **完了条件**:
  - release/2025 のマージで本番環境が更新される
- **依存関係**: E2-T1
- **リスク**: R-006（環境変数設定ミス）

#### E2-T3: cherry-pick 運用ルールの周知
- [x] **ステータス**: SKIPPED (二重ブランチ運用なし、cherry-pick不要)
- **優先度**: P1
- **週目安**: 第1週
- **作業内容**:
  - 運用ルールのドキュメント化（完了済み: 01_branching_strategy.md）
  - チームミーティングでの説明
  - PRテンプレートへのチェック項目追加
- **完了条件**:
  - チーム全員がルールを理解している
- **依存関係**: E2-T1
- **リスク**: R-007（cherry-pick漏れ）

---

## Epic 3: マスタデータ準備

### 目的
2026年度版のマスタデータを準備し、DB2026に投入する。

### タスク

#### E3-T1: 2026年度マスタデータ仕様確定
- [x] **ステータス**: Done (seed.sql, マイグレーション作成済み)
- **優先度**: P0
- **週目安**: 第1週
- **作業内容**:
  - study_sessions（学習回）の期間確定
  - units, contents の変更有無確認
  - assessment_masters の変更有無確認
- **完了条件**:
  - 2026年度マスタデータの仕様書が完成
- **依存関係**: なし
- **リスク**: R-005（マスタデータ不整合）

#### E3-T2: マスタデータCSV/JSON作成
- [x] **ステータス**: Done (2026年四谷大塚DB.xlsx から生成済み)
- **優先度**: P0
- **週目安**: 第2週
- **作業内容**:
  - study_sessions データ作成
  - 必要に応じて units, contents, assessment_masters データ作成
- **完了条件**:
  - 投入用データファイルが作成されている
  - レビュー完了
- **依存関係**: E3-T1
- **リスク**: R-005（マスタデータ不整合）

#### E3-T3: マスタデータ投入スクリプト作成
- [x] **ステータス**: Done (deploy-seed-to-db2026.sh, generate-problem-counts-sql.py)
- **優先度**: P1
- **週目安**: 第2週
- **作業内容**:
  - シードスクリプト（scripts/seed-2026-masters.ts 等）の作成
  - 冪等性の確保
- **完了条件**:
  - スクリプトが正常に動作する
  - 複数回実行してもエラーにならない
- **依存関係**: E3-T2
- **リスク**: なし

#### E3-T4: DB2026 へのマスタデータ投入
- [x] **ステータス**: Done (study_content_types 109件 + problem_counts 1,408件 投入済み、2026-02-07 切替完了)
- **優先度**: P0
- **週目安**: 第2週
- **作業内容**:
  - スクリプト実行
  - データ確認
- **完了条件**:
  - 全マスタデータが正しく投入されている
  - ステージング環境で確認可能
- **依存関係**: E1-T2, E3-T3
- **リスク**: R-005（マスタデータ不整合）

#### E3-T5: ステージング環境での検証
- [x] **ステータス**: SKIPPED (即日切替のためステージング環境を経由せず、本番で直接確認)
- **優先度**: P0
- **週目安**: 第3週
- **作業内容**:
  - 学習回が正しく表示されるか
  - Spark機能が動作するか
  - 科目・単元が正しいか
- **完了条件**:
  - 主要機能がステージング環境で正常動作
- **依存関係**: E1-T3, E3-T4
- **リスク**: R-005（マスタデータ不整合）

#### E3-T6: 卒業生 BAN スクリプト作成
- [x] **ステータス**: Done (commit 73b20c7, scripts/ban-graduated-users.ts)
- **優先度**: P1
- **週目安**: 第3週
- **作業内容**:
  - scripts/ban-graduated-users.ts を作成
  - CSV ファイルから user_id を読み取り、Supabase Admin API で BAN 実行
  - **BAN API 仕様**: `ban_duration: "100y"` (100年、公式ドキュメント例に準拠)
    - 公式ドキュメント例に従う
    - `"none"` は BAN解除の可能性が高いため使用しない
  - 依存関係追加: `pnpm add csv-parse` と `pnpm add -D tsx`
  - エラーハンドリング、進捗表示、ログ出力
  - テスト CSV でのテスト実行
- **完了条件**:
  - 必要な依存関係がインストール済み
  - スクリプトがテスト CSV で正常動作する
  - BAN 実行時に `ban_duration: "100y"` を使用
  - エラー時のログが適切に出力される
  - ドライラン機能がある（実際に BAN せずに動作確認可能）
- **依存関係**: なし
- **リスク**: R-002（権限紐づけ崩れ）

---

## Epic 4: Identity 移行準備

### 目的
切替当日のIdentity移行を安全かつ確実に実施するための準備を行う。

### タスク

#### E4-T1: 移行スクリプト作成
- [x] **ステータス**: Done (scripts/cutover/01〜03)
- **優先度**: P0
- **週目安**: 第2週
- **作業内容**:
  - **事前確認**: DB2026 にテストユーザーが存在する場合、クリーンアップ SQL を準備
  - auth.users エクスポート/インポートスクリプト（supabase CLI 使用）
  - **重要**: auth.users を先にインポート → 自動作成された profiles を削除 → DB2025 の profiles をインポート（FK 制約対応）
  - profiles 系テーブル移行スクリプト（COPY TO STDOUT/FROM STDIN）
    - **テーブル名注意**: `parent_child_relations` (parent_student_relations ではない)
  - admins, invitation_codes テーブル移行を含む
  - BIGSERIAL シーケンス更新スクリプト（COALESCE で空テーブル対応）
  - 卒業対象 CSV 出力スクリプト（auth.users と JOIN して email 取得、display_name 使用）
  - 学年繰り上げ SQL
- **完了条件**:
  - 全スクリプトが作成されている
  - DB2026 クリーンアップ手順が含まれている
  - FK 制約を考慮した正しいインポート順序
  - 空テーブルでもエラーにならない setval 実装
  - エラーハンドリングが実装されている
  - テスト環境での動作確認完了
- **依存関係**: なし
- **リスク**: R-002（権限紐づけ崩れ）, R-003（移行漏れ）

#### E4-T2: 整合性チェックスクリプト作成
- [x] **ステータス**: Done (scripts/cutover/04-verify-integrity.sh)
- **優先度**: P0
- **週目安**: 第2週
- **作業内容**:
  - ユーザー数一致チェック
  - 学年分布チェック
  - 外部キー制約チェック
  - 関連テーブル整合性チェック
- **完了条件**:
  - チェックスクリプトが正常動作
  - 全チェック項目をカバー
- **依存関係**: E4-T1
- **リスク**: R-002（権限紐づけ崩れ）対策

#### E4-T3: 移行リハーサル（1回目）
- [x] **ステータス**: SKIPPED (Codexフィードバック8ラウンドでスクリプトを反復改善、正式リハーサルは省略)
- **優先度**: P0
- **週目安**: 第3週
- **作業内容**:
  - テストデータでの移行実行
  - 問題点の洗い出し
  - スクリプト修正
- **完了条件**:
  - リハーサルが完了
  - 発見された問題が記録されている
- **依存関係**: E4-T1, E4-T2
- **リスク**: R-008（ロールバック失敗）対策

#### E4-T4: 移行リハーサル（2回目）
- [x] **ステータス**: SKIPPED (即日切替完了、2回目リハーサル不要)
- **優先度**: P1
- **週目安**: 第4週
- **作業内容**:
  - 本番に近い条件でのリハーサル
  - 所要時間の計測
  - 最終確認
- **完了条件**:
  - 問題なく完了
  - 所要時間が把握できている
- **依存関係**: E4-T3
- **リスク**: R-008（ロールバック失敗）対策

---

## Epic 5: 切替手順準備

### 目的
切替当日の手順を確定し、ロールバック計画を含めて準備を完了する。

### タスク

#### E5-T1: 切替手順書のレビュー
- [x] **ステータス**: Done (04_cutover_runbook.md 作成・レビュー済み、migrate-identity-https.ts で実行)
- **優先度**: P0
- **週目安**: 第3週
- **作業内容**:
  - 04_cutover_runbook.md のレビュー
  - 不明点の解消
  - 手順の修正・追記
- **完了条件**:
  - チーム全員がレビュー完了
  - 不明点がない
- **依存関係**: なし
- **リスク**: R-004（属人化）対策

#### E5-T2: ロールバック手順のリハーサル
- [x] **ステータス**: SKIPPED (release/2025ブランチをロールバック安全ネットとして作成済み、正式リハーサルは省略)
- **優先度**: P0
- **週目安**: 第4週
- **作業内容**:
  - ロールバック手順の実行
  - 所要時間の計測
  - 手順の確認・修正
- **完了条件**:
  - ロールバックが問題なく完了できる
- **依存関係**: E5-T1
- **リスク**: R-008（ロールバック失敗）

#### E5-T3: クロストレーニング
- [x] **ステータス**: SKIPPED (個人運用のため対象外)
- **優先度**: P1
- **週目安**: 第4週
- **作業内容**:
  - 運用担当以外のメンバーが手順を実行
  - 質問・疑問点の解消
- **完了条件**:
  - 複数名が手順を実行できる
- **依存関係**: E5-T1
- **リスク**: R-004（属人化）対策

#### E5-T4: 連絡体制の確定
- [x] **ステータス**: SKIPPED (個人運用のため対象外)
- **優先度**: P1
- **週目安**: 第4週
- **作業内容**:
  - 当日参加者の確定
  - 緊急連絡先の記入
  - コミュニケーションチャネルの準備
- **完了条件**:
  - 連絡体制が確定している
- **依存関係**: なし
- **リスク**: R-004（属人化）対策

---

## Epic 6: 最終確認・切替実施

### 目的
切替前日の最終確認と、当日の切替を実施する。

### タスク

#### E6-T1: ブランチ差分の最終確認
- [x] **ステータス**: SKIPPED (二重ブランチ運用なし、main直接デプロイのため差分確認不要)
- **優先度**: P0
- **週目安**: 切替前日
- **作業内容**:
  - release/2025 と main の差分確認
  - 未cherry-pickの修正がないことを確認
- **完了条件**:
  - 差分がすべて把握され、問題なし
- **依存関係**: E2-T3
- **リスク**: R-007（cherry-pick漏れ）

#### E6-T2: DB2025 バックアップ取得
- [x] **ステータス**: Done (Supabase自動バックアップ有効、DB2025プロジェクト維持中)
- **優先度**: P0
- **週目安**: 切替前日
- **作業内容**:
  - Supabase のバックアップ確認
  - 必要に応じて手動バックアップ
- **完了条件**:
  - バックアップが取得されている
- **依存関係**: なし
- **リスク**: R-008（ロールバック失敗）対策

#### E6-T3: メンテナンス告知
- [x] **ステータス**: SKIPPED (即日切替で短時間停止のみ、事前告知不要と判断)
- **優先度**: P1
- **週目安**: 切替前日
- **作業内容**:
  - ユーザーへのメンテナンス告知
  - 関係者への最終連絡
- **完了条件**:
  - 告知が完了している
- **依存関係**: なし
- **リスク**: なし

#### E6-T4: 切替実施
- [x] **ステータス**: Done (2026-02-07 完了、migrate-identity-https.ts による HTTPS API 方式で実施)
- **優先度**: P0
- **週目安**: 切替当日
- **作業内容**:
  - 04_cutover_runbook.md に従って実施
- **完了条件**:
  - 切替が完了し、サービスが正常稼働
- **依存関係**: E6-T1, E6-T2, E6-T3
- **リスク**: 全リスク

#### E6-T5: 切替後監視
- [x] **ステータス**: Done (2026-02-07 切替完了、問題なし確認済み)
- **優先度**: P0
- **週目安**: 切替当日〜翌日
- **作業内容**:
  - Sentry エラー監視
  - Vercel ログ確認
  - ユーザー問い合わせ対応
- **完了条件**:
  - 24時間問題なし
- **依存関係**: E6-T4
- **リスク**: なし

---

## Epic 7: アーカイブ・振り返り

### 目的
切替完了後の後処理と振り返りを行う。

### タスク

#### E7-T1: release/2025 ブランチのアーカイブ
- [x] **ステータス**: Done (2026-02-07 タグ v2025-final 作成、ブランチ削除済み)
- **優先度**: P2
- **週目安**: 切替後
- **作業内容**:
  - タグ作成: v2025-final
  - ブランチ削除
- **完了条件**:
  - タグが作成され、ブランチが削除されている
- **依存関係**: E6-T4
- **リスク**: なし

#### E7-T2: DB2025 のアーカイブ設定
- [x] **ステータス**: Done (2026-02-07 方針決定: 一時停止 (Pause)、Supabaseダッシュボードにて Pause 操作完了済み)
- **優先度**: P2
- **週目安**: 切替後
- **作業内容**:
  - ~~[Decision Needed] 過年度参照の要否に応じて対応~~
  - ~~参照専用設定 or~~ プロジェクト一時停止
- **完了条件**:
  - DB2025 の扱いが確定し、設定完了
- **依存関係**: E6-T4
- **リスク**: なし

#### E7-T3: 振り返りミーティング
- [x] **ステータス**: Done (2026-02-07 振り返り記録作成: 06_retrospective.md)
- **優先度**: P1
- **週目安**: 切替後1週間以内
- **作業内容**:
  - 良かった点・改善点の洗い出し
  - 次回（2027年度）への教訓
- **完了条件**:
  - 振り返り記録が作成されている
- **依存関係**: E6-T4
- **リスク**: なし

---

## 週別スケジュール目安

| 週 | Epic | 主要タスク |
|----|------|-----------|
| 第1週 (1/6-12) | E1, E2 | 環境分離、ブランチ運用開始 |
| 第2週 (1/13-19) | E3, E4 | マスタデータ準備、移行スクリプト作成 |
| 第3週 (1/20-26) | E3, E4, E5 | ステージング検証、リハーサル1回目、手順書レビュー |
| 第4週 (1/27-31) | E4, E5, E6 | リハーサル2回目、最終確認 |
| 切替当日 (2/1) | E6 | 切替実施、監視 |
| 切替後 | E7 | アーカイブ、振り返り |

---

## 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2026-01-02 | Claude Code | 初版作成 |
| 2026-02-06 | Claude Code | ステータス更新: E1-T1/T5, E3-T1/T2/T3/T6 を Done、E1-T2, E2-T3, E3-T4 を In progress に反映 |
| 2026-02-06 | Claude Code | E1-T4 環境識別バナー実装、E4-T1/T2 移行・整合性チェックスクリプト作成 |
| 2026-02-07 | Claude Code | E1-T4 を CANCELLED に変更（即日切替完了により二重運用不要）、バナーコンポーネント削除 |
| 2026-02-07 | Claude Code | 一括ステータス更新: E1-T2/T3, E2-T1/T2/T3, E3-T4/T5, E4-T3/T4, E5-T1〜T4, E6-T1〜T5 を切替完了実績に反映 |
| 2026-02-07 | Claude Code | E6-T5 Done、E7-T1/T2/T3 完了（ブランチアーカイブ・DB2025 Pause・振り返り記録）→ 全30タスク完了 |
| 2026-02-07 | Claude Code | Codexフィードバック: 凡例にSKIPPED/CANCELLED追加、タスク件数30件に修正、E7-T2ステータス文言明確化 |
| 2026-02-07 | Claude Code | Codexフィードバック: Phase-Plan.md/README.md を「小学5・6年生向け」に統一。注: commit 9670c78 メッセージに「migrate-identity-https.ts 追加」とあるが、同ファイルは c4051d2 で既にトラッキング済みのため実差分はメタデータ更新のみ |
| 2026-02-08 | Claude Code | Next.js 14.2.18→14.2.35 セキュリティ更新（`pnpm audit` local実行）。audit結果: critical 0, high 5(全て推移的依存/メジャー更新要), moderate 6, low 2。解消済み: GHSA-f82v(認証バイパス), GHSA-mwv6(SC DoS), GHSA-5j59(SC DoS follow-up)。残存highは glob(eslint推移的), tar×3(@tailwindcss/oxide推移的), next DoS(15.x要) |
