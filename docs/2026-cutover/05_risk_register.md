# リスク台帳

## 1. 概要

本ドキュメントは、2026年度切替に伴う想定リスクを洗い出し、対策を定義するリスク台帳である。

## 2. リスク評価基準

### 2.1 影響度

| レベル | 定義 |
|--------|------|
| **致命的** | サービス全停止、データ喪失、復旧困難 |
| **重大** | 主要機能停止、一部データ喪失、復旧に数時間 |
| **中程度** | 一部機能停止、データ不整合（修復可能） |
| **軽微** | UI不具合、パフォーマンス低下 |

### 2.2 発生確率

| レベル | 定義 |
|--------|------|
| **高** | 50%以上、過去に発生経験あり |
| **中** | 10-50%、類似事例あり |
| **低** | 10%未満、稀なケース |

### 2.3 リスクスコア

```
リスクスコア = 影響度 × 発生確率

致命的 × 高 = 最優先対応
重大 × 高 / 致命的 × 中 = 優先対応
その他 = 通常対応
```

## 3. リスク一覧

### 3.1 最重要リスク（最優先対応）

#### R-001: DB混線（本番DBへの誤操作）

| 項目 | 内容 |
|------|------|
| **リスクID** | R-001 |
| **カテゴリ** | データ |
| **影響度** | 致命的 |
| **発生確率** | 中 |
| **リスクスコア** | 最優先 |
| **説明** | 開発作業中に誤って本番DB（DB2025）に接続し、データを破壊する |
| **兆候** | 環境変数の設定ミス、接続先確認の省略 |
| **回避策** | - 環境変数の厳格管理<br>- 接続先ログ出力<br>- ~~環境識別バナー~~（中止: 即日切替完了により二重運用なし）<br>- 本番DBへの直接アクセス禁止 |
| **検知策** | - 起動時の接続先ログ確認<br>- DBクエリ監視 |
| **対応策** | - 即時作業停止<br>- バックアップからの復旧<br>- 影響範囲の調査 |
| **担当** | 開発チーム全員 |

#### R-002: 権限紐づけ崩れ

| 項目 | 内容 |
|------|------|
| **リスクID** | R-002 |
| **カテゴリ** | データ |
| **影響度** | 致命的 |
| **発生確率** | 中 |
| **リスクスコア** | 最優先 |
| **説明** | Identity移行時にuser_id, student_id等の紐づけが崩れ、他人のデータが見える |
| **兆候** | 移行スクリプトのバグ、外部キー制約違反 |
| **回避策** | - 移行前後の件数チェック<br>- 整合性チェックスクリプト<br>- リハーサル実施 |
| **検知策** | - 外部キー制約エラー<br>- 件数不一致<br>- テストログインでの確認 |
| **対応策** | - ロールバック<br>- 原因調査<br>- 再移行 |
| **担当** | 運用担当 |

#### R-003: 移行漏れ（一部ユーザーが移行されない）

| 項目 | 内容 |
|------|------|
| **リスクID** | R-003 |
| **カテゴリ** | データ |
| **影響度** | 重大 |
| **発生確率** | 中 |
| **リスクスコア** | 優先 |
| **説明** | 一部ユーザーがDB2026に移行されず、ログインできない |
| **兆候** | 移行スクリプトのWHERE条件ミス、タイムアウト |
| **回避策** | - 移行前後の件数チェック<br>- 全ユーザーリストとの照合<br>- リハーサル |
| **検知策** | - 件数不一致<br>- ユーザーからの問い合わせ |
| **対応策** | - 漏れたユーザーの追加移行<br>- 必要に応じてロールバック |
| **担当** | 運用担当 |

#### R-004: 当日手順の属人化

| 項目 | 内容 |
|------|------|
| **リスクID** | R-004 |
| **カテゴリ** | プロセス |
| **影響度** | 重大 |
| **発生確率** | 高 |
| **リスクスコア** | 最優先 |
| **説明** | 切替手順が特定の人しかわからず、その人が対応できない場合に停止 |
| **兆候** | 手順書の未整備、レビュー不足、リハーサル未実施 |
| **回避策** | - 詳細な手順書作成<br>- 複数人でのリハーサル<br>- クロストレーニング |
| **検知策** | - 他メンバーが手順を説明できるか確認 |
| **対応策** | - バックアップ担当者の確保<br>- 手順の簡素化 |
| **担当** | 責任者 |

### 3.2 重要リスク（優先対応）

#### R-005: マスタデータ不整合

| 項目 | 内容 |
|------|------|
| **リスクID** | R-005 |
| **カテゴリ** | データ |
| **影響度** | 重大 |
| **発生確率** | 中 |
| **リスクスコア** | 優先 |
| **説明** | 2026年度マスタデータに誤り（期間、配点、単元名等）があり、機能が正しく動作しない |
| **兆候** | マスタデータ作成時のヒューマンエラー |
| **回避策** | - マスタデータのレビュー<br>- ステージングでの検証<br>- チェックリスト |
| **検知策** | - ステージング環境での動作確認<br>- ユーザーからの指摘 |
| **対応策** | - マスタデータの修正<br>- 再デプロイ |
| **担当** | 開発担当 |

#### R-006: 環境変数の設定ミス

| 項目 | 内容 |
|------|------|
| **リスクID** | R-006 |
| **カテゴリ** | インフラ |
| **影響度** | 致命的 |
| **発生確率** | 低 |
| **リスクスコア** | 優先 |
| **説明** | Vercelの環境変数を誤って設定し、間違ったDBに接続 |
| **兆候** | コピペミス、変数名の間違い |
| **回避策** | - 変更前後のスクリーンショット<br>- ダブルチェック<br>- 変更値リストの事前準備 |
| **検知策** | - デプロイ後の接続先ログ確認<br>- 動作確認での異常検知 |
| **対応策** | - 正しい値に修正<br>- 再デプロイ |
| **担当** | 運用担当 |

#### R-007: cherry-pick 漏れ

| 項目 | 内容 |
|------|------|
| **リスクID** | R-007 |
| **カテゴリ** | 開発 |
| **影響度** | 中程度 |
| **発生確率** | 高 |
| **リスクスコア** | 優先 |
| **説明** | release/2025での修正がmainにcherry-pickされず、切替後に同じバグが再発 |
| **兆候** | cherry-pick運用の徹底不足 |
| **回避策** | - cherry-pickチェックリスト<br>- PRテンプレートでの確認項目<br>- 週次での差分チェック |
| **検知策** | - 切替前の差分確認 |
| **対応策** | - 発見次第cherry-pick<br>- 切替後に修正 |
| **担当** | 開発チーム |

#### R-008: ロールバック失敗

| 項目 | 内容 |
|------|------|
| **リスクID** | R-008 |
| **カテゴリ** | プロセス |
| **影響度** | 致命的 |
| **発生確率** | 低 |
| **リスクスコア** | 優先 |
| **説明** | 切替に失敗しロールバックを試みるも、それも失敗してサービス停止が長期化 |
| **兆候** | ロールバック手順の未整備、リハーサル未実施 |
| **回避策** | - ロールバック手順の文書化<br>- ロールバックリハーサル<br>- DB2025のバックアップ保持 |
| **検知策** | - ロールバック手順の実行可能性確認 |
| **対応策** | - バックアップからの復旧<br>- 手動での復旧作業 |
| **担当** | 運用担当 |

### 3.3 通常リスク

#### R-009: パフォーマンス低下

| 項目 | 内容 |
|------|------|
| **リスクID** | R-009 |
| **カテゴリ** | インフラ |
| **影響度** | 軽微 |
| **発生確率** | 中 |
| **リスクスコア** | 通常 |
| **説明** | 切替後にレスポンスタイムが悪化 |
| **回避策** | - ステージングでの負荷テスト<br>- インデックスの確認 |
| **対応策** | - クエリ最適化<br>- インデックス追加 |

#### R-010: Cron Job の失敗

| 項目 | 内容 |
|------|------|
| **リスクID** | R-010 |
| **カテゴリ** | 機能 |
| **影響度** | 中程度 |
| **発生確率** | 中 |
| **リスクスコア** | 通常 |
| **説明** | AIコーチメッセージ生成等のCron Jobが切替後に動作しない |
| **回避策** | - 切替後に手動トリガーで確認<br>- CRON_SECRETの確認 |
| **対応策** | - 環境変数の確認・修正<br>- 手動実行 |

#### R-011: サードパーティサービス障害

| 項目 | 内容 |
|------|------|
| **リスクID** | R-011 |
| **カテゴリ** | 外部依存 |
| **影響度** | 重大 |
| **発生確率** | 低 |
| **リスクスコア** | 通常 |
| **説明** | 切替当日にSupabase, Vercel, OpenAI等が障害 |
| **回避策** | - 事前のステータスページ確認<br>- 予備日の設定 |
| **対応策** | - 切替延期<br>- 障害復旧を待つ |

## 4. リスク対応サマリー

### 4.1 最優先対応（切替前に必ず実施）

| リスクID | 対策 | 実施期限 | 担当 |
|---------|------|---------|------|
| R-001 | 環境変数管理ルールの周知、~~識別バナー~~（中止: 即日切替で二重運用なし） | 2/7 実施済み | 開発チーム |
| R-002 | 整合性チェックスクリプト作成、リハーサル | 1/25 | 運用担当 |
| R-004 | 手順書レビュー、クロストレーニング | 1/29 | 全員 |

### 4.2 優先対応

| リスクID | 対策 | 実施期限 | 担当 |
|---------|------|---------|------|
| R-003 | 件数チェックスクリプト、リハーサル | 1/25 | 運用担当 |
| R-005 | マスタデータレビュー、ステージング検証 | 1/20 | 開発担当 |
| R-006 | 変更値リスト作成、ダブルチェック体制 | 1/30 | 運用担当 |
| R-007 | 差分チェック、cherry-pickリスト確認 | 1/30 | 開発チーム |
| R-008 | ロールバックリハーサル | 1/29 | 運用担当 |

## 5. リスクモニタリング

### 5.1 定期レビュー

| タイミング | 内容 |
|-----------|------|
| 週次 | リスク一覧の更新、新規リスクの追加 |
| 切替前日 | 全リスクの最終確認 |
| 切替後1週間 | 顕在化したリスクの振り返り |

### 5.2 エスカレーション基準

```
リスクが顕在化した場合:
  影響度「致命的」→ 即座に責任者へ報告
  影響度「重大」  → 30分以内に責任者へ報告
  影響度「中程度」→ 日次報告で共有
  影響度「軽微」  → 週次報告で共有
```

## 6. 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2026-01-02 | Claude Code | 初版作成 |
