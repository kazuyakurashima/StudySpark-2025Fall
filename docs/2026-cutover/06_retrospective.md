# 2026年度切替 振り返り

## 基本情報

| 項目 | 内容 |
|------|------|
| 切替日 | 2026-02-07 |
| 所要時間 | 即日完了 |
| 方式 | HTTPS API (migrate-identity-https.ts) |
| 結果 | 成功（ロールバック不要） |

---

## 計画 vs 実績

### スケジュール

| 項目 | 計画 | 実績 |
|------|------|------|
| 環境分離 (E1) | 1月第1週 | 2/6-7 に集中実施 |
| ブランチ運用 (E2) | 1月第1週〜継続 | 即日切替のため大部分 SKIPPED |
| マスタデータ (E3) | 1月第2週 | 2/6 完了 |
| 移行準備 (E4) | 1月第2-3週 | 2/6-7 完了、リハーサルは省略 |
| 手順準備 (E5) | 1月第3-4週 | Runbook 作成済み、他は個人運用のため SKIPPED |
| 切替実施 (E6) | 2/1 | 2/7 |
| アーカイブ (E7) | 切替後 | 2/7 即日完了 |

### タスク消化率

| ステータス | 件数 | 割合 |
|-----------|------|------|
| Done | 18 | 60% |
| SKIPPED | 11 | 37% |
| CANCELLED | 1 | 3% |
| **合計** | **30** | **100%** |

---

## 良かった点

1. **即日切替の判断**
   - 二重運用期間を設けず即日切替したことで、ブランチ運用・cherry-pick・環境バナーなど多くの複雑さを回避
   - SKIPPED 11件のうち大半はこの判断により不要になったタスク

2. **HTTPS API 方式への切り替え**
   - 当初の psql COPY 方式から Supabase Admin API (HTTPS) 方式に変更
   - psql 直接接続の制約（Supabase の接続制限）を回避
   - TypeScript 単一ファイルで全ステップを統合

3. **Codex フィードバックによる品質向上**
   - 8ラウンドの反復レビューでスクリプトの安全性を段階的に強化
   - fail-fast パターン（auth 失敗→即中断、整合性チェック失敗→学年繰り上げスキップ）
   - CSV エスケープ、エラー収集、プロセス終了コードの改善

4. **マスタデータ投入の自動化**
   - `generate-problem-counts-sql.py` で 1,408件の problem_counts を自動生成
   - `deploy-seed-to-db2026.sh` で冪等な投入パイプラインを構築

---

## 改善点・教訓

1. **計画の粒度が過大だった**
   - 30タスク中 11件が SKIPPED（37%）。個人運用プロジェクトにはチーム向けタスク（クロストレーニング、連絡体制）が不要だった
   - **教訓**: 計画時にプロジェクト規模・体制に合わせたタスク選定を行う

2. **リハーサルを省略した**
   - E4-T3/T4（移行リハーサル）を正式には実施せず、Codex レビューで代替
   - 今回は成功したが、データ量が多い場合やチーム運用では正式リハーサルが必要
   - **教訓**: 本番データ規模でのリハーサルは可能な限り実施する

3. **`createUser` API の制限**
   - Supabase Admin API の `createUser` は `encrypted_password` を保持できない
   - 切替後にユーザーのパスワードリセットが必要になる可能性がある
   - **教訓**: 認証移行では API の制約を事前に確認し、パスワード移行戦略を明確にする

4. **スケジュールのずれ**
   - 計画では 1月中に段階的に進める想定だったが、実際は 2/6-7 に集中実施
   - **教訓**: 小規模プロジェクトでは「集中実施」のほうが効率的な場合がある。計画段階で柔軟性を持たせる

---

## 次回（2027年度）への申し送り

1. **migrate-identity-https.ts を再利用可能**
   - 環境変数を差し替えるだけで同じスクリプトで移行可能
   - fail-fast パターンが組み込み済み

2. **マスタデータ投入パイプライン**
   - Excel → Python (generate-problem-counts-sql.py) → SQL → deploy-seed-to-db2026.sh
   - 年度ごとのデータ差し替えで再利用可能

3. **DB Pause の復元**
   - DB2025 は Supabase で Pause 済み
   - 過年度データの参照が必要になれば Resume で復元可能

4. **タスク計画の簡素化**
   - 個人運用なら E5（手順準備）の大半は不要
   - E1〜E4 + E6-T4（切替実施）に集中すれば十分
