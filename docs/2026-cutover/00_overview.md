# StudySpark 2026年度切替 概要設計書

## 1. 目的

2026年2月1日（日本時間 Asia/Tokyo）に、StudySpark の年度切替を実施する。
本ドキュメント群は、切替に必要な計画・手順・リスク管理を文書化し、安全かつ確実な移行を実現することを目的とする。

## 2. スコープ

### 2.1 スコープ内

| カテゴリ | 内容 |
|---------|------|
| ブランチ戦略 | main / release/2025 の二重運用ルール策定 |
| 環境分離 | 本番/ステージングの環境変数・デプロイ先分離 |
| DB分離 | DB2025（現行本番）/ DB2026（新年度用）の分離運用 |
| マスタデータ刷新 | 科目・単元・問題・学習回・マスタープリント（算数）・漢字テストの2026年度版投入 |
| 生徒学年繰り上げ | 5年生→6年生、6年生→卒業の移行処理 |
| 切替手順書 | 2/1当日の作業手順とロールバック計画 |
| リスク管理 | 想定リスクの洗い出しと対策 |

### 2.2 スコープ外（非スコープ）

| カテゴリ | 理由 |
|---------|------|
| 新機能開発 | 年度切替と独立して実施 |
| UI/UXの大規模改修 | 別プロジェクトとして管理 |
| 料金体系・契約変更 | ビジネス側の意思決定事項 |
| パフォーマンスチューニング | 切替後の運用フェーズで対応 |

## 3. 前提条件

| 項目 | 内容 |
|------|------|
| 切替日時 | 2026年2月1日（日本時間） |
| タイムゾーン | Asia/Tokyo |
| 1月の運用 | 2025年度本番を継続運用（テスト期間として現場利用＋微修正） |
| 本番修正頻度 | 週0〜2回程度（軽微なバグ修正のみ） |
| リポジトリ | 単一リポジトリ維持（コピー・分岐しない） |

## 4. 用語定義

| 用語 | 定義 |
|------|------|
| **年度 (Academic Year)** | 学習カリキュラムの単位。2025年度＝2025年9月〜2026年1月、2026年度＝2026年9月〜2027年1月 |
| **学習回 (Session)** | 週単位の学習進捗管理単位。5年生: 19回、6年生: 15回 |
| **マスタープリント** | 算数のプリント教材（assessment_masters で assessment_type='math_print'）。週2回分 |
| **漢字テスト** | 漢字のテスト教材（assessment_masters で assessment_type='kanji_test'）。週1回分 |
| **Identity データ** | ユーザー認証・プロフィール・関連付け（profiles, students, parents, coaches, *_relations） |
| **Master データ** | 学習コンテンツの定義（subjects, units, contents, study_sessions, assessment_masters） |
| **Log データ** | 学習履歴・応援メッセージ等の蓄積データ（study_logs, encouragement_messages, coaching_sessions） |
| **DB2025** | 現行本番データベース（Supabase プロジェクト: zlipaeanhcslhintxpej） |
| **DB2026** | 新年度用データベース（1月中に新規作成） |
| **release/2025** | 2025年度本番の保守用ブランチ |
| **main** | 2026年度開発の本線ブランチ（将来の本番） |

## 5. 全体アーキテクチャ

### 5.1 1月中の構成（二重運用期間）

```
┌─────────────────────────────────────────────────────────────────────┐
│                         リポジトリ: StudySpark-2025Fall             │
│                                                                     │
│   ┌─────────────────┐              ┌─────────────────┐             │
│   │ release/2025    │              │ main            │             │
│   │ (2025本番保守)   │  ←cherry-pick→ │ (2026開発本線)  │             │
│   └────────┬────────┘              └────────┬────────┘             │
│            │                                │                       │
└────────────┼────────────────────────────────┼───────────────────────┘
             │                                │
             ▼                                ▼
┌────────────────────────┐      ┌────────────────────────┐
│   Vercel 本番環境       │      │   Vercel ステージング    │
│   (Production)         │      │   (Preview/Staging)    │
│   URL: 本番ドメイン      │      │   URL: ステージングURL   │
└────────────┬───────────┘      └────────────┬───────────┘
             │                                │
             ▼                                ▼
┌────────────────────────┐      ┌────────────────────────┐
│   DB2025 (Supabase)    │      │   DB2026 (Supabase)    │
│   現行本番DB            │      │   新年度用DB           │
│   ・Identityデータ維持   │      │   ・Masterデータ刷新    │
│   ・Logデータ蓄積中      │      │   ・1月中は工事現場     │
│   ・触らない/保護する    │      │   ・Identity空の状態    │
└────────────────────────┘      └────────────────────────┘
```

### 5.2 2/1切替後の構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                         リポジトリ: StudySpark-2025Fall             │
│                                                                     │
│   ┌─────────────────┐              ┌─────────────────┐             │
│   │ release/2025    │              │ main            │             │
│   │ (凍結/アーカイブ) │              │ (本番)          │             │
│   └─────────────────┘              └────────┬────────┘             │
│                                             │                       │
└─────────────────────────────────────────────┼───────────────────────┘
                                              │
                                              ▼
                                ┌────────────────────────┐
                                │   Vercel 本番環境       │
                                │   (Production)         │
                                │   URL: 本番ドメイン      │
                                └────────────┬───────────┘
                                             │
                                             ▼
                                ┌────────────────────────┐
                                │   DB2026 (Supabase)    │
                                │   本番DB               │
                                │   ・Identityデータ移行済│
                                │   ・2026 Masterデータ  │
                                │   ・新規Logデータ蓄積   │
                                └────────────────────────┘

                                ┌────────────────────────┐
                                │   DB2025 (Supabase)    │
                                │   アーカイブ/参照専用   │
                                │   [Decision Needed]    │
                                │   過年度参照が必要か？  │
                                └────────────────────────┘
```

## 6. 技術スタック確認

本プロジェクトの技術スタックは以下の通り（切替計画の前提情報）：

| レイヤー | 技術 | バージョン |
|---------|------|-----------|
| フレームワーク | Next.js (App Router) | 14.2.18 |
| UI | React | 18.3.1 |
| 言語 | TypeScript | 5.5.4 |
| スタイリング | Tailwind CSS | 4.1.9 |
| データベース | Supabase (PostgreSQL) | 最新 |
| 認証 | Supabase Auth | - |
| AI | OpenAI API | gpt-4o-mini |
| 監視 | Langfuse (LLM) / Sentry (Error) | - |
| デプロイ | Vercel | - |
| パッケージ管理 | pnpm | 10.19.0 |

## 7. 主要な意思決定ポイント

以下の項目は、本計画を進める上で意思決定が必要な事項である。
各ドキュメント内で `[Decision Needed]` ラベルを付与して明示する。

| # | 意思決定項目 | 選択肢 | 関連ドキュメント |
|---|-------------|--------|-----------------|
| 1 | 過年度データ（2025）の参照可否 | A: 参照不要（完全分離）/ B: 参照必要（archive/read-only DB） | 03_data_strategy.md |
| 2 | 1月中のDB2025→DB2026 日次同期の要否 | A: 同期不要（切替直前のみ移行）/ B: 日次同期が必要 | 03_data_strategy.md |
| 3 | 学年繰り上げの実行方式 | A: 自動バッチ / B: 手動SQL / C: 管理画面から実行 | 03_data_strategy.md |
| 4 | 切替当日のダウンタイム許容 | A: 0分（ホットスワップ）/ B: 〜30分許容 / C: 深夜メンテナンス | 04_cutover_runbook.md |
| 5 | 6年生卒業後のアカウント扱い | A: 削除 / B: 無効化 / C: 保持（ログイン不可） | 03_data_strategy.md |
| 6 | release/2025ブランチの最終処遇 | A: 削除 / B: タグ化してアーカイブ | 01_branching_strategy.md |
| 7 | ~~Supabase BAN API の仕様確認~~ | ~~"none" の意味確認~~ → **解決**: `"100y"` (公式例) を使用 | 03_data_strategy.md, TASKS.md |
| 8 | DB2026 の事前クリーンアップ要否 | 切替時点で DB2026 にテストユーザーが存在する場合、public テーブル + auth.users の事前削除が必要 | 03_data_strategy.md, 04_cutover_runbook.md |
| 9 | 本番DB2025の親子関係テーブル名確認 | parent_child_relations または parent_student_relationships のどちらが実際に使われているか確認 | 03_data_strategy.md, 04_cutover_runbook.md |

## 8. ドキュメント構成

| ファイル | 内容 |
|---------|------|
| `00_overview.md` | 本ドキュメント（概要・スコープ・用語定義） |
| `01_branching_strategy.md` | ブランチ運用ルール |
| `02_environment_strategy.md` | 環境分離方針・環境変数管理 |
| `03_data_strategy.md` | データ分類・移行・繰り上げ設計 |
| `04_cutover_runbook.md` | 2/1切替手順書 |
| `05_risk_register.md` | リスク台帳 |
| `TASKS.md` | タスク一覧・進捗管理 |

## 9. 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2026-01-02 | Claude Code | 初版作成 |
