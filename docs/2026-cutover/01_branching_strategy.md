# ブランチ運用戦略

## 1. 概要

1月の二重運用期間中、単一リポジトリ内で2つのブランチを並行運用する。
本ドキュメントでは、ブランチの役割・運用ルール・修正フローを定義する。

## 2. ブランチ構成

```
main                    ← 2026年度開発の本線（将来の本番）
│
├── release/2025        ← 2025年度本番の保守専用（1月限定）
│
└── feature/*           ← 機能開発ブランチ（mainから派生）
```

| ブランチ | 役割 | デプロイ先 | 期間 |
|---------|------|-----------|------|
| `main` | 2026年度開発本線 | ステージング環境 | 恒久 |
| `release/2025` | 2025年度本番保守 | 本番環境 | 1月のみ（〜2/1切替） |
| `feature/*` | 機能開発 | プレビュー環境 | 開発期間中 |

## 3. 運用ルール

### 3.1 main ブランチ

| 項目 | ルール |
|------|--------|
| 用途 | 2026年度向けの新機能開発・マスタデータ対応 |
| マージ元 | feature/* ブランチ、release/2025 からの cherry-pick |
| 保護設定 | プルリクエスト必須、レビュー1名以上 |
| デプロイ | ステージング環境（DB2026接続）へ自動デプロイ |

### 3.2 release/2025 ブランチ

| 項目 | ルール |
|------|--------|
| 用途 | 2025年度本番の軽微なバグ修正のみ |
| マージ元 | release/2025 から派生した hotfix/* ブランチ |
| 制限事項 | **新機能追加禁止**、**大規模リファクタ禁止** |
| デプロイ | 本番環境（DB2025接続）へ手動デプロイ |
| 修正頻度 | 週0〜2回程度を想定 |

### 3.3 feature/* ブランチ

| 項目 | ルール |
|------|--------|
| 用途 | 新機能・改善の開発 |
| 派生元 | main |
| マージ先 | main（プルリクエスト経由） |
| 命名規則 | `feature/<機能名>` 例: `feature/2026-master-data` |

## 4. 修正フロー

### 4.1 2026年度向け開発（通常フロー）

```
main ─────────────────────────────────────────────────────→
       │                                     ▲
       ▼                                     │ PR & Merge
   feature/xxx ────────────────────────────→ │
```

1. `main` から `feature/xxx` を作成
2. 開発・コミット
3. プルリクエスト作成 → レビュー → `main` へマージ
4. ステージング環境（DB2026）で検証

### 4.2 2025年度本番の緊急修正フロー

```
main ──────────────────────────────────────────────────────→
       ▲
       │ cherry-pick
release/2025 ─────────────────────────────────────────────→
       │
       ▼ PR & Merge
   hotfix/xxx
       │
       ▼ Deploy
   本番環境 (DB2025)
```

#### 手順

1. **起票**: 本番で発生した問題をIssue化
2. **ブランチ作成**: `release/2025` から `hotfix/xxx` を作成
3. **修正**: hotfix ブランチで修正を実施
4. **release/2025 へマージ**: プルリクエスト → レビュー → マージ
5. **本番デプロイ**: Vercel で release/2025 を本番環境へデプロイ
6. **main へ cherry-pick**: 同一コミットを main に取り込む

```bash
# cherry-pick の実行例
git checkout main
git cherry-pick <commit-hash>
git push origin main
```

### 4.3 cherry-pick 運用ルール

| ルール | 説明 |
|--------|------|
| **必須** | release/2025 へのマージ後、**必ず** main へ cherry-pick |
| タイミング | release/2025 マージ後、同日中に実施 |
| コンフリクト時 | 手動解決 → 両ブランチで動作確認 |
| 記録 | cherry-pick 完了をプルリクエストにコメント |

#### なぜ cherry-pick が必要か

- **反映漏れ防止**: 2/1 切替時に main が本番になるため、修正が入っていないと再発する
- **履歴の一貫性**: 両ブランチで同一の修正履歴を維持
- **週0〜2回の修正頻度**: 少量のため cherry-pick 運用が現実的

## 5. コンフリクト対応方針

### 5.1 コンフリクト発生時の対応

```
┌─────────────────────────────────────────────────────────────┐
│ コンフリクト発生                                             │
├─────────────────────────────────────────────────────────────┤
│ 1. コンフリクトの原因を特定                                   │
│    - 同一ファイルの同一箇所を両ブランチで変更した場合         │
│                                                             │
│ 2. 優先順位の判断                                            │
│    - 本番修正（release/2025）: 安定性優先                    │
│    - 開発修正（main）: 新仕様優先                            │
│                                                             │
│ 3. 手動解決                                                  │
│    - 両方の意図を理解した上でマージ                          │
│    - 必要に応じて両ブランチで動作確認                        │
│                                                             │
│ 4. 記録                                                      │
│    - コンフリクト解決内容をコミットメッセージに記載          │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 コンフリクト最小化の工夫

| 工夫 | 説明 |
|------|------|
| 修正範囲の限定 | release/2025 では最小限の修正のみ |
| 早期 cherry-pick | マージ後すぐに cherry-pick して乖離を防ぐ |
| 大規模変更の分離 | main での大規模リファクタは 2026 専用ファイル/ディレクトリで実施 |

## 6. ブランチ凍結計画

### 6.1 タイムライン

| 日付 | イベント | 対象ブランチ |
|------|---------|-------------|
| 1月27日 | release/2025 ソフトフリーズ | release/2025 |
| 1月30日 | release/2025 ハードフリーズ | release/2025 |
| 1月31日 | main フリーズ（切替準備） | main |
| 2月1日 | 切替実施 | - |
| 2月1日以降 | release/2025 アーカイブ | release/2025 |

### 6.2 フリーズ定義

| フリーズ種別 | 許可される変更 |
|-------------|---------------|
| **ソフトフリーズ** | クリティカルなバグ修正のみ |
| **ハードフリーズ** | 本番障害対応のみ（承認必須） |

## 7. 切替後のブランチ処理

### 7.1 [Decision Needed] release/2025 の最終処遇

切替完了後の release/2025 ブランチの扱い：

| 選択肢 | メリット | デメリット |
|--------|---------|-----------|
| **A: 削除** | リポジトリがクリーン | 履歴参照が困難 |
| **B: タグ化してアーカイブ** | 履歴を保持、必要時に参照可能 | ブランチ一覧が増える |

#### 推奨: **B: タグ化してアーカイブ**

```bash
# 切替完了後の操作
git tag -a v2025-final -m "2025年度最終版" release/2025
git push origin v2025-final
git branch -d release/2025
git push origin --delete release/2025
```

## 8. チェックリスト

### 8.1 release/2025 ブランチ作成時

- [ ] main の最新状態から分岐
- [ ] Vercel で release/2025 を本番環境に紐付け
- [ ] 保護ルール設定（直接 push 禁止）
- [ ] チームへの周知

### 8.2 cherry-pick 実施時

- [ ] release/2025 へのマージ完了確認
- [ ] 本番環境での動作確認完了
- [ ] main への cherry-pick 実施
- [ ] main での動作確認（ステージング）
- [ ] プルリクエストに cherry-pick 完了をコメント

### 8.3 切替前日（1/31）

- [ ] release/2025 ハードフリーズ確認
- [ ] main フリーズ確認
- [ ] 未マージの cherry-pick がないことを確認
- [ ] 両ブランチの差分確認

## 9. 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2026-01-02 | Claude Code | 初版作成 |
