# T-003: 認証システム実装

**Based on:** REQ-001 ユーザー認証  
**Priority:** Must Have  
**User Story:** 基本的な認証とロール管理  
**Assignee:** -  
**Status:** In Progress

## 概要

三者（学生/保護者/指導者）向けの認証システムとロール管理機能を実装する。

## 要件

### AC基準
- **AC-001:** WHEN ユーザーがメール・パスワードでログイン THEN ロール別にリダイレクト
- **AC-002:** WHEN 新規登録 THEN ロール選択とプロフィール作成
- **AC-003:** WHEN 指導者登録 THEN 指導者コード検証必須
- **AC-004:** WHEN セッション管理 THEN 30分無操作でタイムアウト

### Non-Functional Requirements
- パスワード: 8文字以上必須
- HTTPS通信必須
- セキュアなセッション管理

## 技術仕様

### API Endpoints
- `POST /api/auth/login` - ログイン
- `POST /api/auth/signup` - 新規登録  
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/me` - ユーザー情報取得

### Database Tables
- `profiles` - ユーザープロフィール
- `auth.users` - Supabase認証テーブル

### UI Routes
- `/` - ログイン/新規登録画面
- `/student` - 学生ダッシュボード
- `/parent` - 保護者ダッシュボード  
- `/coach` - 指導者ダッシュボード

## ToDo

### 認証基盤
- [x] Supabaseクライアント設定
- [x] 認証コンテキスト・フック作成
- [x] ミドルウェア設定
- [x] プロテクトルートコンポーネント

### データベース
- [x] profilesテーブル作成
- [x] RLSポリシー設定
- [x] ユーザー登録用トリガー・ファンクション
- [ ] 指導者コード管理テーブル

### UI実装
- [x] ログインページの基本構造
- [x] 新規登録フォーム
- [x] ロール選択機能
- [x] 指導者コード入力欄
- [ ] パスワード強度バリデーション
- [ ] エラーメッセージ改善

### ロール別リダイレクト
- [x] 学生用ルーティング
- [x] 保護者用ルーティング
- [x] 指導者用ルーティング
- [ ] 新規ユーザーのオンボーディング

### セキュリティ
- [x] Row Level Security (RLS)
- [ ] レート制限
- [ ] パスワードポリシー強化
- [ ] セッション管理改善

## 受入テスト

### テストケース
1. **新規登録テスト**
   - [ ] 学生として正常登録
   - [ ] 保護者として正常登録
   - [ ] 有効な指導者コードでの指導者登録
   - [ ] 無効な指導者コードでの登録失敗
   
2. **ログインテスト**
   - [ ] 正しい認証情報でログイン成功
   - [ ] 間違った認証情報でログイン失敗
   - [ ] ロール別リダイレクト確認

3. **セッション管理テスト**
   - [ ] 30分無操作でタイムアウト
   - [ ] ログアウト機能
   - [ ] セッション復旧

## 定義完了（DoD）

- [ ] 全受入テスト通過
- [ ] セキュリティレビュー完了
- [ ] パフォーマンステスト実施（ログイン < 3秒）
- [ ] モバイル対応確認
- [ ] ドキュメント更新

## 関連チケット

- T-004: 学生ダッシュボード実装
- T-005: 保護者ダッシュボード実装  
- T-006: 指導者ダッシュボード実装
- T-007: ユーザープロフィール管理

## 備考

- 現在はSupabase Authを使用した実装が完了
- Database Functions/Triggersによる自動プロフィール作成実装済み
- 指導者コードは現在ハードコード（COACH123等）、本番では動的管理が必要