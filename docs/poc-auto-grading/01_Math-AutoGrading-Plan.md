# ç®—æ•° è‡ªå‹•æ¡ç‚¹ å®Ÿè£…è¨ˆç”»

## 0. æ¦‚è¦

### ç›®çš„

ç®—æ•°ã®å•é¡Œãƒ—ãƒªãƒ³ãƒˆï¼ˆç´™é…å¸ƒæ¸ˆã¿ï¼‰ã«å¯¾ã—ã€ç”Ÿå¾’ãŒWebã§**è§£ç­”ã®ã¿**ã‚’å…¥åŠ›ã—ã€è‡ªå‹•æ¡ç‚¹ â†’ çµæœè¡¨ç¤ºã‚’è¡Œã†ã€‚

### å‰ææ¡ä»¶

- **å•é¡Œã¯ç´™ã§é…å¸ƒæ¸ˆã¿** â€” ã‚·ã‚¹ãƒ†ãƒ ã«ã¯å•é¡Œæ–‡ã‚’è¡¨ç¤ºã—ãªã„ã€‚å•é¡Œç•ªå·ã®ã¿è¡¨ç¤º
- **è§£ç­”ã®ã¿å…¥åŠ›** â€” æ•°å€¤ãƒ»åˆ†æ•°ãƒ»è¤‡æ•°ã‚¹ãƒ­ãƒƒãƒˆãƒ»é¸æŠå¼ã®4ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³1å‚ç…§ï¼‰
- **å˜ä½ã¯Webå´ã«è¡¨ç¤º** â€” ç”Ÿå¾’ã¯æ•°å­—ã®ã¿å…¥åŠ›ï¼ˆä¾‹: `( ) cmÂ²` ã« `42` ã¨å…¥åŠ›ï¼‰
- **é€”ä¸­ä¿å­˜å¯¾å¿œ** â€” ç”Ÿå¾’ã¯2ã€œ3æ—¥ã«åˆ†ã‘ã¦è§£ç­”ã‚’å…¥åŠ›
- **éƒ¨åˆ†æå‡ºå¯¾å¿œ** â€” å…¨å•å…¥åŠ›ã—ã¦ã„ãªãã¦ã‚‚å³æ™‚æ¡ç‚¹å¯èƒ½ï¼ˆå…¥åŠ›æ¸ˆã¿ã®å•é¡Œã®ã¿æ¡ç‚¹ï¼‰
- **ãƒªãƒˆãƒ©ã‚¤å¯¾å¿œ** â€” æ¡ç‚¹å¾Œã€ä¸æ­£è§£ãƒ»æœªå›ç­”ã®å•é¡Œã®ã¿å†å…¥åŠ›ã—ã¦å†æ¡ç‚¹ã§ãã‚‹ã€‚æ­£è§£æ¸ˆã¿å•é¡Œã¯ãƒ­ãƒƒã‚¯ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
- **æ­£ç­”éè¡¨ç¤º** â€” å…¨å•æ­£è§£ or ã€Œè§£ç­”ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã¾ã§æ­£ç­”ã¯éé–‹ç¤ºã€‚æ¡ç‚¹çµæœã¯ âœ…æ­£è§£ / âŒä¸æ­£è§£ / â¬œæœªå›ç­” ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿è¡¨ç¤º
- **æ—¢å­˜ `study_logs` ã¨ã¯å®Œå…¨åˆ†é›¢** â€” ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»é€²æ—ãƒãƒ¼ç­‰ã®æ—¢å­˜UIã«å½±éŸ¿ã—ãªã„

### åˆæœŸã‚¹ã‚³ãƒ¼ãƒ—

| é …ç›® | å€¤ |
|------|-----|
| ç§‘ç›® | ç®—æ•°ã®ã¿ï¼ˆsubject_id = 1ï¼‰ |
| å­¦å¹´ | å°å­¦5å¹´ç”Ÿã€å°å­¦6å¹´ç”Ÿ |
| å¯¾è±¡å› | ç¬¬1ã€œ4å›ï¼ˆå„å›â‘ â‘¡ã®2ãƒ—ãƒªãƒ³ãƒˆã€è¨ˆ16ã‚»ãƒƒãƒˆï¼‰ |
| ã‚³ãƒ¼ã‚¹ | å…¨ã‚³ãƒ¼ã‚¹ï¼ˆA/B/C/Sï¼‰â€” å•é¡Œãƒ—ãƒªãƒ³ãƒˆã¯ã‚³ãƒ¼ã‚¹å…±é€š |
| question_setç²’åº¦ | **ãƒ—ãƒªãƒ³ãƒˆå˜ä½**ï¼ˆâ‘ /â‘¡ = 1ã‚»ãƒƒãƒˆã€6ã€œ41å•/ã‚»ãƒƒãƒˆï¼‰ |

### åˆæœŸã‚¹ã‚³ãƒ¼ãƒ—ã®å—ã‘å…¥ã‚Œæ¡ä»¶

| æ¡ä»¶ | åŸºæº– |
|------|------|
| æ¨¡ç¯„è§£ç­”ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ | å°5 8ã‚»ãƒƒãƒˆ + å°6 8ã‚»ãƒƒãƒˆï¼ˆè¨ˆ16ã‚»ãƒƒãƒˆï¼‰ã® question_sets / questions ãŒ `approved` çŠ¶æ…‹ã§å­˜åœ¨ |
| å•é¡Œæ•° | å°5: 281å•ã€å°6: 177å•ã€åˆè¨ˆ458å•ãŒç™»éŒ²æ¸ˆã¿ |
| answer_type ã‚«ãƒãƒ¬ãƒƒã‚¸ | numeric(389å•) + multi_part(52å•) + selection(17å•) ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹ |
| E2Eå‹•ä½œ | è§£ç­”å…¥åŠ› â†’ é€”ä¸­ä¿å­˜ â†’ å¾©å…ƒ â†’ éƒ¨åˆ†æå‡º â†’ æ¡ç‚¹ â†’ çµæœè¡¨ç¤º â†’ ãƒªãƒˆãƒ©ã‚¤ â†’ å†æ¡ç‚¹ã®å…¨ãƒ•ãƒ­ãƒ¼ãŒå®Œèµ° |
| ãƒªãƒˆãƒ©ã‚¤å‹•ä½œ | æ­£è§£æ¸ˆã¿å•é¡ŒãŒãƒ­ãƒƒã‚¯è¡¨ç¤ºã•ã‚Œã€ä¸æ­£è§£ãƒ»æœªå›ç­”ã®ã¿å†å…¥åŠ› â†’ å†æ¡ç‚¹ã§ã‚¹ã‚³ã‚¢æ›´æ–° |
| ãƒ“ãƒ«ãƒ‰ | `pnpm run build` æˆåŠŸ |

> **æ³¨**: fraction å‹ã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã«è©²å½“ãªã—ã€‚ã‚³ãƒ¼ãƒ‰ä¸Šã¯å¯¾å¿œæ¸ˆã¿ã®çŠ¶æ…‹ã§ç´å“ã—ã€æ‰‹å‹•ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼ã€‚
> selection å‹ã¯å°5: 15å•ï¼ˆç´„æ•°ãƒ»æ•°åˆ—å•é¡Œï¼‰+ å°6: 2å•ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå›ç­”ï¼‰= è¨ˆ17å•ã€‚

### ãƒ•ãƒ«PoCè¨ˆç”»ã¨ã®é–¢ä¿‚

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ `00_Implementation-Plan.md` ã® Phase 2ï¼ˆç®—æ•°æ•°å€¤å…¥åŠ›è‡ªå‹•æ¡ç‚¹ï¼‰ã‚’
**ç®—æ•°ã®ã¿ã«ç‰¹åŒ–ã—ã¦å…ˆè¡Œå®Ÿè£…**ã™ã‚‹ãŸã‚ã®ç‹¬ç«‹è¨ˆç”»æ›¸ã€‚

å…±é€šåŸºç›¤ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆãƒ»RLSãƒ»çŠ¶æ…‹é·ç§»ï¼‰ã¯ãƒ•ãƒ«PoCè¨ˆç”»ã‚’è¸è¥²ã—ã¤ã¤ã€
ç®—æ•°å›ºæœ‰ã®è§£ç­”ã‚¿ã‚¤ãƒ—ï¼ˆmulti_part, selectionï¼‰ã¨UIè¦ä»¶ã‚’è¿½åŠ å®šç¾©ã™ã‚‹ã€‚

---

## 1. è§£ç­”ã‚¿ã‚¤ãƒ—å®šç¾©

ç®—æ•°ã®è§£ç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãã€4ç¨®é¡ã®è§£ç­”ã‚¿ã‚¤ãƒ—ã‚’å®šç¾©ã™ã‚‹ã€‚

### 1-1. ä¸€è¦§

| answer_type | èª¬æ˜ | UIè¡¨ç¾ | ä¾‹ |
|-------------|------|--------|----|
| `numeric` | å˜ä¸€æ•°å€¤ï¼ˆæ•´æ•°ãƒ»å°æ•°ï¼‰ | ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› + å˜ä½è¡¨ç¤º | `( ) cmÂ²` â†’ å…¥åŠ›: `42` |
| `fraction` | åˆ†æ•° | åˆ†å­/åˆ†æ¯ 2æ¬„å…¥åŠ› | `â–¡/â–¡` â†’ å…¥åŠ›: `3`, `4` |
| `multi_part` | è¤‡æ•°ã®æ•°å€¤ã‚’å€‹åˆ¥å…¥åŠ› | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + å„ã‚¹ãƒ­ãƒƒãƒˆå…¥åŠ› | `Aã¯( )å€‹ã€Bã¯( )å€‹` |
| `selection` | æ•°å€¤ã‚’é¸æŠè‚¢ã‹ã‚‰é¸ã¶ | ã‚¿ãƒƒãƒ—ã§é¸æŠ/è§£é™¤ | æ­£è§£`[3,7]` + ãƒ€ãƒŸãƒ¼`[5,9]` |

### 1-2. ä½¿ã„åˆ†ã‘ã®åˆ¤æ–­åŸºæº–

```
è§£ç­”ãŒ1ã¤ã®æ•°å€¤ï¼Ÿ
  â”œâ”€ Yes â†’ åˆ†æ•°ï¼Ÿ â†’ Yes â†’ fraction
  â”‚                â†’ No  â†’ numeric
  â””â”€ No  â†’ å„æ•°å€¤ã«ãƒ©ãƒ™ãƒ«/å½¹å‰²ãŒã‚ã‚‹ï¼Ÿ
              â”œâ”€ Yes â†’ multi_part
              â”‚   ä¾‹: "Aã¯14å€‹ã€Bã¯11å€‹"
              â”‚   ä¾‹: "50å††åˆ‡æ‰‹5æšã€80å††åˆ‡æ‰‹8æš"
              â””â”€ No  â†’ selection
                  ä¾‹: "3ã¨7ã¨11ã‚’é¸ã³ãªã•ã„"
```

### 1-3. å„ã‚¿ã‚¤ãƒ—ã®è©³ç´°

#### numericï¼ˆå˜ä¸€æ•°å€¤ï¼‰

æœ€ã‚‚åŸºæœ¬çš„ãªè§£ç­”ã‚¿ã‚¤ãƒ—ã€‚æ•´æ•°ãƒ»å°æ•°ãƒ»è² æ•°ã«å¯¾å¿œã€‚

- **å…¥åŠ›**: æ•°å€¤1ã¤ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
- **å˜ä½è¡¨ç¤º**: `unit_label` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°å…¥åŠ›æ¬„ã®å³ã«è¡¨ç¤º
- **æ­£è¦åŒ–**: å…ˆé ­ã‚¼ãƒ­é™¤å»ã€æœ«å°¾ã‚¼ãƒ­é™¤å»ï¼ˆ`"042"` â†’ `"42"`, `"3.50"` â†’ `"3.5"`ï¼‰
- **åˆ¤å®š**: æ­£è¦åŒ–å¾Œã®æ–‡å­—åˆ—å®Œå…¨ä¸€è‡´

```
UIä¾‹:
  (1) [________] cmÂ²
  (2) [________] é€šã‚Š
  (3) [________]        â† å˜ä½ãªã—
```

#### fractionï¼ˆåˆ†æ•°ï¼‰

åˆ†å­ã¨åˆ†æ¯ã‚’åˆ¥ã€…ã«å…¥åŠ›ã€‚

- **å…¥åŠ›**: åˆ†å­ãƒ»åˆ†æ¯ã®2ã¤ã®æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
- **å‡ºåŠ›å½¢å¼**: `"åˆ†å­/åˆ†æ¯"` æ–‡å­—åˆ—ï¼ˆä¾‹: `"3/4"`, `"7/3"`ï¼‰
- **åˆ¤å®š**: trimå¾Œã®å®Œå…¨ä¸€è‡´ï¼ˆé€šåˆ†ãƒ»ç´„åˆ†ã®åŒå€¤åˆ¤å®šã¯ã—ãªã„ï¼‰
- **åˆ¶ç´„**: åˆ†æ¯ â‰  0

```
UIä¾‹:
  (3)  â”Œâ”€â”€â”€â”
       â”‚ 3 â”‚  â† åˆ†å­
       â”œâ”€â”€â”€â”¤
       â”‚ 4 â”‚  â† åˆ†æ¯
       â””â”€â”€â”€â”˜
```

> **é‹ç”¨ä¸Šã®æ³¨æ„**: æ¨¡ç¯„è§£ç­”ã®å½¢å¼ï¼ˆæ—¢ç´„åˆ†æ•° or ä»®åˆ†æ•°ï¼‰ã§è§£ç­”ã™ã‚‹æ—¨ã‚’ç”Ÿå¾’ã«å‘¨çŸ¥ã€‚
> ä¾‹: æ­£ç­”ãŒ `3/4` ã®å ´åˆã€`6/8` ã¯ä¸æ­£è§£ã¨ãªã‚‹ã€‚

#### multi_partï¼ˆè¤‡æ•°ã‚¹ãƒ­ãƒƒãƒˆå…¥åŠ›ï¼‰

1ã¤ã®å•é¡Œã«å¯¾ã—ã€è¤‡æ•°ã®æ•°å€¤ã‚’ãƒ©ãƒ™ãƒ«ä»˜ãã§å…¥åŠ›ã™ã‚‹ã€‚

- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: `answer_config.slots` ã§å®šç¾©
- **å„ã‚¹ãƒ­ãƒƒãƒˆ**: ãƒ©ãƒ™ãƒ« + å…¥åŠ›æ¬„ + å˜ä½ã®çµ„ã¿åˆã‚ã›
- **åˆ¤å®š**: å…¨ã‚¹ãƒ­ãƒƒãƒˆãŒæ­£è§£ã§åˆã‚ã¦æ­£è§£ï¼ˆall-or-nothingï¼‰

```
UIä¾‹:
  (1) Aã¯ [____] å€‹ã€Bã¯ [____] å€‹

  (4) 50å††åˆ‡æ‰‹ [____] æšã€80å††åˆ‡æ‰‹ [____] æš
```

**answer_config å½¢å¼**:
```json
{
  "slots": [
    { "label": "A", "unit": "å€‹" },
    { "label": "B", "unit": "å€‹" }
  ],
  "correct_values": { "A": "14", "B": "11" },
  "template": "Aã¯{A}å€‹ã€Bã¯{B}å€‹"
}
```

- `correct_values` ã¯ãƒ©ãƒ™ãƒ«ã‚’ã‚­ãƒ¼ã¨ã™ã‚‹ãƒãƒƒãƒ—å½¢å¼ï¼ˆé †åºä¾å­˜ãƒã‚°ã‚’é˜²æ­¢ï¼‰
- `template` ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯ `{ãƒ©ãƒ™ãƒ«å}` ã§å‚ç…§ï¼ˆ`slots[].label` ã¨ä¸€è‡´ï¼‰

#### selectionï¼ˆé¸æŠå¼ï¼‰

è¤‡æ•°ã®æ•°å€¤ãŒè§£ç­”ã¨ãªã‚‹å•é¡Œã§ã€æ­£è§£ã®æ•°å€¤ã‚’ã‚¿ãƒƒãƒ—ã§é¸ã¶ã€‚
ãƒ€ãƒŸãƒ¼ã®æ•°å€¤ã‚‚æ··åœ¨ã•ã›ã€æ­£ã—ã„ã‚‚ã®ã ã‘ã‚’é¸æŠã™ã‚‹ã€‚

- **é¸æŠè‚¢**: æ­£è§£ã®æ•°å€¤ + ãƒ€ãƒŸãƒ¼ã®æ•°å€¤ã‚’ seed ä»˜ãã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§å›ºå®šé †åºè¡¨ç¤º
- **åˆ¤å®š**: é¸æŠã•ã‚ŒãŸã‚»ãƒƒãƒˆãŒæ­£è§£ã‚»ãƒƒãƒˆã¨å®Œå…¨ä¸€è‡´ï¼ˆé †åºä¸å•ã€éä¸è¶³ä¸å¯ï¼‰
- **æ“ä½œ**: ã‚¿ãƒƒãƒ—ã§é¸æŠ/è§£é™¤ï¼ˆãƒˆã‚°ãƒ«ï¼‰
- **ã‚·ãƒ£ãƒƒãƒ•ãƒ«å®‰å®šæ€§**: `question_id` ã‚’ seed ã¨ã—ã¦ä½¿ç”¨ã—ã€åŒã˜å•é¡Œã¯å¸¸ã«åŒã˜é †åºã§é¸æŠè‚¢ã‚’è¡¨ç¤ºï¼ˆUXå®‰å®šåŒ–ï¼‰

```
UIä¾‹:
  (5) æ­£ã—ã„æ•°ã‚’é¸ã‚“ã§ãã ã•ã„:

  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
  â”‚  3  â”‚ â”‚  5  â”‚ â”‚  7  â”‚ â”‚  9  â”‚ â”‚ 11  â”‚ â”‚ 13  â”‚
  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
           â† é¸æŠæ¸ˆã¿ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º â†’
```

**answer_config å½¢å¼**:
```json
{
  "correct_values": ["3", "7", "11"],
  "dummy_values": ["5", "9", "13"],
  "unit": null
}
```

- `correct_values` + `dummy_values` ã‚’ `question_id` ã‚’ seed ã¨ã—ãŸã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§è¡¨ç¤º
- ãƒ€ãƒŸãƒ¼ã®æ•°ã¯æ­£è§£æ•°ã¨åŒç¨‹åº¦ï¼ˆæ­£è§£3å€‹ãªã‚‰ãƒ€ãƒŸãƒ¼3ã€œ4å€‹ï¼‰
- åŒã˜ `question_id` ã§ã¯å¸¸ã«åŒã˜é †åºã§é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**ãƒ€ãƒŸãƒ¼å€¤ã®ç”Ÿæˆæ–¹é‡**ï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰:
- ç´„æ•°å•é¡Œ: å¯¾è±¡ã®æ•°ã®ç´„æ•°ã§ãªã„è¿‘ã„æ•°å€¤ã‚’ãƒ€ãƒŸãƒ¼ã«
- æ•°åˆ—å•é¡Œ: æ­£è§£æ•°åˆ—ã¨è¿‘ã„ç­‰å·®ã§ç´›ã‚‰ã‚ã—ã„æ•°å€¤ã‚’ãƒ€ãƒŸãƒ¼ã«
- ãƒ€ãƒŸãƒ¼å€¤ã¯ seed SQL ä½œæˆæ™‚ã«å•é¡Œã®æ•°å­¦çš„æ€§è³ªã«åŸºã¥ã„ã¦ç”Ÿæˆ

**ãƒ†ã‚­ã‚¹ãƒˆå›ç­”ã® selection å¯¾å¿œ**:
ä¸€éƒ¨ã®å•é¡Œï¼ˆæ›œæ—¥ãƒ»å›³å½¢åç­‰ï¼‰ã¯æ•°å€¤ã§ã¯ãªããƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠè‚¢ã¨ã—ã¦æ‰±ã†:

```json
// å°6 ç¬¬2å›â‘  å‘¨æœŸç®—(2): æ­£è§£ã€Œé‡‘æ›œæ—¥ã€
{ "correct_values": ["é‡‘æ›œæ—¥"], "dummy_values": ["æœˆæ›œæ—¥","ç«æ›œæ—¥","æ°´æ›œæ—¥","æœ¨æ›œæ—¥","åœŸæ›œæ—¥","æ—¥æ›œæ—¥"], "unit": null }

// å°6 ç¬¬3å›â‘¡ å¤šè§’å½¢(4): æ­£è§£ã€Œåå››è§’å½¢ã€
{ "correct_values": ["åå››è§’å½¢"], "dummy_values": ["åè§’å½¢","åäºŒè§’å½¢","åå…­è§’å½¢","åå…«è§’å½¢"], "unit": null }
```

**seed ä»˜ãã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°**:
```typescript
function shuffleWithSeed(arr: string[], seed: number): string[] {
  const shuffled = [...arr]
  let s = seed
  for (let i = shuffled.length - 1; i > 0; i--) {
    s = (s * 1103515245 + 12345) & 0x7fffffff  // LCG
    const j = s % (i + 1)
    ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
  }
  return shuffled
}
// question_id ã‚’ã‚·ãƒ¼ãƒ‰ã«ä½¿ç”¨ â†’ åŒã˜å•é¡Œã¯å¸¸ã«åŒã˜é †åº
```

---

## 2. DBè¨­è¨ˆ

### 2-1. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ

ãƒ•ãƒ«PoCè¨ˆç”»ï¼ˆ`00_Implementation-Plan.md` ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼‰ã®5ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¸è¥²ã—ã€
ç®—æ•°å›ºæœ‰ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹ã€‚

```
question_sets â”€â”€â†’ questions
                      â”‚
answer_sessions â”€â”€â†’ student_answers
```

> **åˆæœŸã‚¹ã‚³ãƒ¼ãƒ—å¤–ã®ãƒ†ãƒ¼ãƒ–ãƒ«**: `question_options`ï¼ˆç†ç§‘ã®é¸æŠè‚¢ç”¨ï¼‰ã¯æœ¬è¨ˆç”»ã§ã¯ä½œæˆã—ãªã„ã€‚
> ãƒ•ãƒ«PoCè¨ˆç”»ã§ç†ç§‘ã‚’å®Ÿè£…ã™ã‚‹éš›ã«è¿½åŠ ã™ã‚‹ã€‚

### 2-2. questions ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ‹¡å¼µç®‡æ‰€ï¼‰

ãƒ•ãƒ«PoCè¨ˆç”»ã® `questions` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ :

```sql
CREATE TABLE questions (
  id              BIGSERIAL PRIMARY KEY,
  question_set_id BIGINT NOT NULL REFERENCES question_sets(id) ON DELETE CASCADE,
  question_number VARCHAR(20) NOT NULL,   -- "(1)", "(2)" ç­‰ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ç•ªå·ï¼‰
  section_name    VARCHAR(50) NOT NULL,   -- "é¡é¡Œ1", "è¨ˆç®—ç·´ç¿’", "è§’åº¦" ç­‰ï¼ˆUIåŒºåˆ‡ã‚Šè¡¨ç¤ºç”¨ï¼‰
  answer_type     VARCHAR(20) NOT NULL
                  CHECK (answer_type IN (
                    'numeric',      -- ç®—æ•°: å˜ä¸€æ•°å€¤
                    'fraction',     -- ç®—æ•°: åˆ†æ•°
                    'multi_part',   -- ç®—æ•°: è¤‡æ•°ã‚¹ãƒ­ãƒƒãƒˆ
                    'selection'     -- ç®—æ•°: é¸æŠå¼
                    -- 'choice' ã¯ç†ç§‘å®Ÿè£…æ™‚ã« ALTER TABLE ã§è¿½åŠ 
                  )),
  correct_answer  VARCHAR(255),           -- numeric/fractionç”¨ã®æ­£ç­”å€¤
                                          -- multi_part/selection ã¯ NULLï¼ˆanswer_config ã«æ ¼ç´ï¼‰
  unit_label      VARCHAR(50),            -- è¡¨ç¤ºå˜ä½ ("cmÂ²", "å€‹", "æš" ç­‰)ã€‚NULL=å˜ä½ãªã—
  answer_config   JSONB,                  -- multi_part/selection ç”¨ã®è¨­å®šã€‚ä»–ã‚¿ã‚¤ãƒ—ã¯NULL
  points          SMALLINT NOT NULL DEFAULT 1 CHECK (points > 0),
  display_order   SMALLINT NOT NULL,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE (question_set_id, display_order),

  -- æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯: ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  CHECK (
    (answer_type IN ('numeric', 'fraction') AND correct_answer IS NOT NULL)
    OR
    (answer_type IN ('multi_part', 'selection') AND answer_config IS NOT NULL)
  ),

  -- answer_config ã®æœ€ä½é™ã®æ§‹é€ æ¤œè¨¼
  CHECK (
    answer_config IS NULL
    OR (
      jsonb_typeof(answer_config) = 'object'
      AND (
        -- multi_part: slots é…åˆ— + correct_values ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ + template æ–‡å­—åˆ—ãŒå¿…é ˆ
        (answer_type = 'multi_part'
          AND answer_config ? 'slots'
          AND answer_config ? 'correct_values'
          AND answer_config ? 'template'
          AND jsonb_typeof(answer_config -> 'slots') = 'array'
          AND jsonb_typeof(answer_config -> 'correct_values') = 'object'
          AND jsonb_typeof(answer_config -> 'template') = 'string')
        OR
        -- selection: correct_values é…åˆ— + dummy_values é…åˆ—ãŒå¿…é ˆ
        -- é‡è¤‡æ’é™¤ã¯ã‚¢ãƒ—ãƒªå±¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¿è¨¼ï¼ˆä¸‹è¨˜å‚ç…§ï¼‰
        (answer_type = 'selection'
          AND answer_config ? 'correct_values'
          AND answer_config ? 'dummy_values'
          AND jsonb_typeof(answer_config -> 'correct_values') = 'array'
          AND jsonb_typeof(answer_config -> 'dummy_values') = 'array')
        OR
        -- ãã®ä»–ã® answer_type ã§ã¯ answer_config ã®æ§‹é€ ã‚’å•ã‚ãªã„
        (answer_type NOT IN ('multi_part', 'selection'))
      )
    )
  )
);
```

**ãƒ•ãƒ«PoCè¨ˆç”»ã‹ã‚‰ã®å¤‰æ›´ç‚¹**:
- `answer_type` ã« `'multi_part'`, `'selection'` ã‚’è¿½åŠ 
- `section_name VARCHAR(50)` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ï¼ˆUIåŒºåˆ‡ã‚Šè¡¨ç¤ºç”¨ï¼‰
- `unit_label VARCHAR(50)` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
- `answer_config JSONB` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
- `correct_answer` ã‚’ NULLable ã«å¤‰æ›´ï¼ˆmulti_part/selection ã§ã¯ answer_config ã‚’ä½¿ç”¨ï¼‰
- CHECKåˆ¶ç´„ã§ã‚¿ã‚¤ãƒ—åˆ¥ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿è¨¼

**ã‚¢ãƒ—ãƒªå±¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç™»éŒ²æ™‚ã«æ¤œè¨¼ï¼‰**:

DB CHECK åˆ¶ç´„ã§ã¯è¡¨ç¾ã§ããªã„æ•´åˆæ€§ãƒ«ãƒ¼ãƒ«ã‚’ã€å•é¡Œç™»éŒ²ï¼ˆseed SQL æŠ•å…¥ or å°†æ¥ã®ç®¡ç†ç”»é¢ï¼‰æ™‚ã«ã‚¢ãƒ—ãƒªå±¤ã§æ¤œè¨¼ã™ã‚‹:

| answer_type | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹ |
|-------------|--------------|-------------------|
| `multi_part` | `slots[].label` ã®é›†åˆ === `correct_values` ã®ã‚­ãƒ¼é›†åˆï¼ˆéä¸è¶³ãªã—ï¼‰ | `"slots ã« label 'A' ãŒã‚ã‚‹ãŒ correct_values ã« 'A' ã‚­ãƒ¼ãŒãªã„"` |
| `multi_part` | `template` å†…ã® `{ãƒ©ãƒ™ãƒ«å}` ãŒ `slots[].label` ã¨å®Œå…¨ä¸€è‡´ | `"template ã« {C} ãŒã‚ã‚‹ãŒ slots ã« label 'C' ãŒå­˜åœ¨ã—ãªã„"` |
| `selection` | `correct_values` ã¨ `dummy_values` ã«é‡è¤‡ã™ã‚‹å€¤ãŒãªã„ã“ã¨ | `"å€¤ '7' ãŒ correct_values ã¨ dummy_values ã®ä¸¡æ–¹ã«å«ã¾ã‚Œã¦ã„ã‚‹"` |
| `selection` | `correct_values` å†…ã«é‡è¤‡ãŒãªã„ã“ã¨ / `dummy_values` å†…ã«é‡è¤‡ãŒãªã„ã“ã¨ | `"dummy_values ã« '5' ãŒé‡è¤‡ã—ã¦ã„ã‚‹"` |

```typescript
// ç™»éŒ²æ™‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆseed SQL ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ or ç®¡ç†ç”»é¢ã§ä½¿ç”¨ï¼‰
function validateAnswerConfig(answerType: string, config: unknown): string[] {
  const errors: string[] = []
  if (answerType === 'multi_part') {
    const { slots, correct_values, template } = config as any
    const slotLabels = new Set(slots.map((s: any) => s.label))
    const cvKeys = new Set(Object.keys(correct_values))
    // slots.label âŠ† correct_values keys && correct_values keys âŠ† slots.label
    for (const label of slotLabels) {
      if (!cvKeys.has(label)) errors.push(`correct_values ã«ã‚­ãƒ¼ '${label}' ãŒãªã„`)
    }
    for (const key of cvKeys) {
      if (!slotLabels.has(key)) errors.push(`slots ã« label '${key}' ãŒãªã„`)
    }
    // template ã® {ãƒ©ãƒ™ãƒ«å} ãŒ slots.label ã«å«ã¾ã‚Œã‚‹ã‹
    const placeholders = (template as string).match(/\{(\w+)\}/g) || []
    for (const ph of placeholders) {
      const label = ph.slice(1, -1)
      if (!slotLabels.has(label)) errors.push(`template ã« {${label}} ãŒã‚ã‚‹ãŒ slots ã«ãªã„`)
    }
  }
  if (answerType === 'selection') {
    const { correct_values, dummy_values } = config as any
    const cvSet = new Set(correct_values)
    const dvSet = new Set(dummy_values)
    if (cvSet.size !== correct_values.length) errors.push('correct_values ã«é‡è¤‡ã‚ã‚Š')
    if (dvSet.size !== dummy_values.length) errors.push('dummy_values ã«é‡è¤‡ã‚ã‚Š')
    const overlap = correct_values.filter((v: string) => dvSet.has(v))
    if (overlap.length > 0) errors.push(`correct/dummy é‡è¤‡: ${overlap.join(', ')}`)
  }
  return errors
}
```

### 2-3. student_answers ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ‹¡å¼µç®‡æ‰€ï¼‰

```sql
CREATE TABLE student_answers (
  id                BIGSERIAL PRIMARY KEY,
  answer_session_id BIGINT NOT NULL REFERENCES answer_sessions(id) ON DELETE CASCADE,
  question_id       BIGINT NOT NULL REFERENCES questions(id),
  raw_input         VARCHAR(500),         -- ç”Ÿå¾’ã®å…¥åŠ›å€¤ãã®ã¾ã¾ï¼ˆæ‹¡å¼µ: 255â†’500ï¼‰
  answer_value      VARCHAR(500),         -- æ­£è¦åŒ–æ¸ˆã¿å€¤ï¼ˆæ‹¡å¼µ: 255â†’500ï¼‰
  is_correct        BOOLEAN,
  scored_at         TIMESTAMPTZ,
  answered_at       TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE (answer_session_id, question_id)
);
```

**raw_input / answer_value ã®å½¢å¼ï¼ˆanswer_typeåˆ¥ï¼‰**:

| answer_type | raw_input ä¾‹ | answer_value ä¾‹ | å‚™è€ƒ |
|-------------|-------------|----------------|------|
| `numeric` | `"042"` | `"42"` | normalizeNumeric() é©ç”¨ |
| `fraction` | `"3/4"` | `"3/4"` | trim ã®ã¿ |
| `multi_part` | `'{"A":"14","B":"11"}'` | `'{"A":"14","B":"11"}'` | JSON: ãƒ©ãƒ™ãƒ«â†’å€¤ |
| `selection` | `'["3","7","11"]'` | `'["3","7","11"]'` | JSONé…åˆ—ï¼ˆã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰ |

### 2-4. question_sets ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰

ãƒ•ãƒ«PoCè¨ˆç”»ã®ã¾ã¾ã€‚ç®—æ•°ã§ã¯:
- `subject_id = 1`ï¼ˆç®—æ•°ï¼‰å›ºå®š
- `study_content_type_id` = å¯¾å¿œã™ã‚‹å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆä¾‹: "é¡é¡Œ", "åŸºæœ¬å•é¡Œ"ï¼‰
- `status`: `'draft'` â†’ `'approved'` ã§ç”Ÿå¾’ã«å…¬é–‹

### 2-5. answer_sessions ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ‹¡å¼µï¼‰

ãƒ•ãƒ«PoCè¨ˆç”»ã‚’æ‹¡å¼µã€‚**ãƒãƒ«ãƒã‚¢ãƒ†ãƒ³ãƒ—ãƒˆæ–¹å¼**ï¼ˆ00è¨ˆç”»ã® `is_latest` + æ–° `attempt` è¿½åŠ ï¼‰ã§
éƒ¨åˆ†æå‡ºãƒ»ãƒªãƒˆãƒ©ã‚¤å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹ã€‚

**è¿½åŠ ã‚«ãƒ©ãƒ ï¼ˆanswer_sessionsï¼‰**:
```sql
  attempt_number   SMALLINT NOT NULL DEFAULT 1,     -- æŒ‘æˆ¦å›æ•°ï¼ˆ1, 2, 3, ...ï¼‰
  answers_revealed BOOLEAN NOT NULL DEFAULT false,   -- æ­£ç­”é–‹ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°
  -- is_latest ã¯ 00è¨ˆç”»ã§å®šç¾©æ¸ˆã¿
```

**å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹é·ç§»ï¼ˆå˜æ–¹å‘ï¼‰**:
```
[åˆå›ã‚¢ã‚¯ã‚»ã‚¹] â†’ in_progressï¼ˆattempt_number=1, is_latest=trueï¼‰
     â†“ [é€”ä¸­ä¿å­˜]
   in_progressï¼ˆä¸‹æ›¸ãä¿å­˜ã€æœªæ¡ç‚¹ï¼‰
     â†“ [æ¡ç‚¹ã™ã‚‹]ï¼ˆéƒ¨åˆ†å›ç­”OK â€” å…¥åŠ›æ¸ˆã¿ã®å•é¡Œã®ã¿æ¡ç‚¹ï¼‰
   gradedï¼ˆâœ…æ­£è§£ / âŒä¸æ­£è§£ / â¬œæœªå›ç­” ã®çµæœè¡¨ç¤ºï¼‰
   â€» å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹é·ç§»ã¯ in_progress â†’ graded ã®å˜æ–¹å‘
```

**ãƒªãƒˆãƒ©ã‚¤ï¼ˆæ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰**:
```
Session 1: in_progress â†’ gradedï¼ˆattempt_number=1ï¼‰
     â†“ [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦]
  Session 1: is_latest = false ã«æ›´æ–°
  Session 2: æ–°è¦ä½œæˆï¼ˆattempt_number=2, is_latest=trueï¼‰
     - Session 1 ã® is_correct=true ã®è§£ç­”ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ­ãƒƒã‚¯æ¸ˆã¿ã¨ã—ã¦ï¼‰
     - ä¸æ­£è§£/æœªå›ç­”ã®å•é¡Œã¯ç©ºæ¬„
     â†“ [æ¡ç‚¹ã™ã‚‹]
  Session 2: graded
     â†“ ... ç¹°ã‚Šè¿”ã— ...

[å…¨å•æ­£è§£] or [è§£ç­”ã‚’è¦‹ã‚‹]
  â†’ æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® answers_revealed = true
  â†’ ä»¥é™ã€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¸å¯
```

**è¨­è¨ˆã®æ ¹æ‹ ï¼ˆ00è¨ˆç”»ã¨ã®æ•´åˆæ€§ï¼‰**:
- 00è¨ˆç”»ã® `is_latest` æ–¹å¼ã‚’è¸è¥²ï¼ˆå†å—é¨“æ™‚ã«æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰
- å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã¯ `in_progress â†’ graded` ã®å˜æ–¹å‘ã®ã¿ï¼ˆåŒæ–¹å‘ã®çŠ¶æ…‹é·ç§»ã‚’å›é¿ï¼‰
- `attempt_number` ã«ã‚ˆã‚ŠæŒ‘æˆ¦å±¥æ­´ã‚’ä¿æŒ â†’ å›æ•°æ¨ç§»ã®åˆ†æãŒå¯èƒ½

**answers_revealed ã®å‹•ä½œ**:
- `false`: æ¡ç‚¹çµæœã¯ âœ…/âŒ/â¬œ ã®ã¿è¡¨ç¤ºï¼ˆæ­£ç­”éè¡¨ç¤ºï¼‰
- `true`: å…¨å•ã®æ­£ç­”ã‚’è¡¨ç¤ºï¼ˆå…¨å•æ­£è§£é”æˆ or ã€Œè§£ç­”ã‚’è¦‹ã‚‹ã€æŠ¼ä¸‹ï¼‰
- ä¸€åº¦ `true` ã«ã—ãŸå¾Œã¯æˆ»ã›ãªã„ï¼ˆæ­£ç­”ã‚’è¦‹ãŸå¾Œã®æ–°ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆä½œæˆä¸å¯ï¼‰

**æŒ‘æˆ¦å±¥æ­´ã‚¯ã‚¨ãƒªä¾‹**:
```sql
SELECT attempt_number, status,
  COUNT(*) FILTER (WHERE sa.is_correct = true) AS correct_count
FROM answer_sessions AS ase
JOIN student_answers AS sa ON sa.answer_session_id = ase.id
WHERE ase.question_set_id = $1 AND ase.student_id = $2
GROUP BY ase.id
ORDER BY ase.attempt_number;
-- â†’ attempt 1: 15/40, attempt 2: 28/40, attempt 3: 38/40
```

### 2-6. RLSãƒãƒªã‚·ãƒ¼

00è¨ˆç”»ã®æ–¹é‡ã‚’è¸è¥²ã—ã¤ã¤ã€**SELECT ã¨ UPDATE ã‚’åˆ†é›¢**ã—ã€æ›´æ–°ã¯ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµŒç”±ã«é™å®šã€‚

> **é‡è¦: `auth.uid()` ã¨å†…éƒ¨ID ã®å¤‰æ›**
>
> æ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒã§ã¯ `auth.uid()` (UUID) â†’ `profiles.id` â†’ `students.user_id` â†’ `students.id` (BIGINT) ã®
> é–“æ¥å‚ç…§ãŒå¿…è¦ã€‚`answer_sessions.student_id` ã¯ `students.id` (BIGINT) ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã€
> `student_id = auth.uid()` ã¯**å‹ä¸ä¸€è‡´**ï¼ˆBIGINT â‰  UUIDï¼‰ã§å¸¸ã« false ã«ãªã‚‹ã€‚
>
> ã“ã‚Œã‚’ä¸€æœ¬åŒ–ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼SQLé–¢æ•°ã‚’å®šç¾©ã™ã‚‹ã€‚

**UUID â†’ å†…éƒ¨ID å¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°**:
```sql
-- ç”Ÿå¾’: auth.uid() â†’ students.id
CREATE FUNCTION current_student_id() RETURNS BIGINT AS $$
  SELECT id FROM students WHERE user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER STABLE;

-- ä¿è­·è€…: auth.uid() â†’ parents.id
CREATE FUNCTION current_parent_id() RETURNS BIGINT AS $$
  SELECT id FROM parents WHERE user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER STABLE;

-- æŒ‡å°è€…: auth.uid() â†’ coaches.id
CREATE FUNCTION current_coach_id() RETURNS BIGINT AS $$
  SELECT id FROM coaches WHERE user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER STABLE;
```

> **`SECURITY DEFINER` + `STABLE`**: RLS å†…ã§ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§ãŒå¿…è¦ãªãŸã‚ `SECURITY DEFINER` ã‚’ä½¿ç”¨ã€‚
> åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãŸã‚ `STABLE` ã‚’æŒ‡å®šã€‚
> Server Actions å†…ã§ã‚‚åŒã˜é–¢æ•°ã‚’ `supabase.rpc('current_student_id')` ã§å‘¼ã³å‡ºã—å¯èƒ½ã€‚

**question_sets / questionsï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ + ç®¡ç†è€…ãƒ•ãƒ«ï¼‰**:
```sql
-- å…¨èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼: approved ã®ã¿ SELECT
CREATE POLICY "read_approved_question_sets" ON question_sets
  FOR SELECT TO authenticated USING (status = 'approved');

CREATE POLICY "read_approved_questions" ON questions
  FOR SELECT TO authenticated USING (
    EXISTS (SELECT 1 FROM question_sets qs
            WHERE qs.id = question_set_id AND qs.status = 'approved')
  );
-- correct_answer ã¯ RLS ã§ã¯åˆ¶å¾¡ä¸å¯ â†’ Server Action ã§ SELECT ã‚«ãƒ©ãƒ ã‚’åˆ¶é™

-- ç®¡ç†è€…: å…¨æ“ä½œï¼ˆå•é¡Œç®¡ç†UIç”¨ï¼‰
CREATE POLICY "admins_manage_question_sets" ON question_sets
  FOR ALL TO authenticated USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
  );

CREATE POLICY "admins_manage_questions" ON questions
  FOR ALL TO authenticated USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
  );
```

**answer_sessionsï¼ˆSELECT ã®ã¿ RLSã€INSERT/UPDATE ã¯ admin client çµŒç”±ï¼‰**:
```sql
-- ç”Ÿå¾’: è‡ªåˆ†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ SELECTï¼ˆ00è¨ˆç”» line 249 æº–æ‹ ï¼‰
CREATE POLICY "students_read_own_sessions" ON answer_sessions
  FOR SELECT USING (student_id = current_student_id());

-- ä¿è­·è€…: ç´ã¥ã‘ã‚‰ã‚ŒãŸå­ã©ã‚‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ SELECT
CREATE POLICY "parents_read_child_sessions" ON answer_sessions
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM parent_child_relations pcr
      WHERE pcr.parent_id = current_parent_id()
        AND pcr.student_id = answer_sessions.student_id
    )
  );

-- æŒ‡å°è€…: æ‹…å½“ç”Ÿå¾’ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ SELECT
CREATE POLICY "coaches_read_student_sessions" ON answer_sessions
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM coach_student_relations csr
      WHERE csr.coach_id = current_coach_id()
        AND csr.student_id = answer_sessions.student_id
    )
  );

-- INSERT/UPDATE ã¯ Server Actions å†…ã§ createAdminClient() ã‚’ä½¿ç”¨
-- â†’ RLS ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã€ã‚µãƒ¼ãƒãƒ¼å´ã§èªè¨¼ãƒ»èªå¯ã‚’æ¤œè¨¼
```

**student_answersï¼ˆåŒä¸Šï¼‰**:
```sql
-- ç”Ÿå¾’: è‡ªåˆ†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç´ã¥ãè§£ç­”ã®ã¿ SELECT
CREATE POLICY "students_read_own_answers" ON student_answers
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM answer_sessions ase
            WHERE ase.id = answer_session_id
              AND ase.student_id = current_student_id())
  );

-- ä¿è­·è€…: ç´ã¥ã‘ã‚‰ã‚ŒãŸå­ã©ã‚‚ã®è§£ç­”ã‚’ SELECT
CREATE POLICY "parents_read_child_answers" ON student_answers
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM answer_sessions ase
      JOIN parent_child_relations pcr ON pcr.student_id = ase.student_id
      WHERE ase.id = student_answers.answer_session_id
        AND pcr.parent_id = current_parent_id()
    )
  );

-- æŒ‡å°è€…: æ‹…å½“ç”Ÿå¾’ã®è§£ç­”ã‚’ SELECT
CREATE POLICY "coaches_read_student_answers" ON student_answers
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM answer_sessions ase
      JOIN coach_student_relations csr ON csr.student_id = ase.student_id
      WHERE ase.id = student_answers.answer_session_id
        AND csr.coach_id = current_coach_id()
    )
  );

-- INSERT/UPDATE ã¯ admin client çµŒç”±
```

**è¨­è¨ˆåˆ¤æ–­**: INSERT/UPDATE ã‚’ admin client ã«é›†ç´„ã™ã‚‹ç†ç”±:
- `status`, `answers_revealed`, `is_correct` ç­‰ã®æ”¹å¤‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰é˜²æ­¢
- Server Actions å†…ã§èªè¨¼ï¼ˆ`current_student_id()` RPCï¼‰+ çŠ¶æ…‹é·ç§»ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ã‚’è¡Œã†
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ + è¡Œãƒ­ãƒƒã‚¯ã®åˆ¶å¾¡ãŒå®¹æ˜“

### 2-6b. åŒæ™‚å®Ÿè¡Œå¯¾ç­–

å¤šé‡ã‚¿ãƒƒãƒ—ãƒ»è¤‡æ•°ç«¯æœ«ã‹ã‚‰ã®åŒæ™‚æ“ä½œã‚’æƒ³å®šã—ãŸæ’ä»–åˆ¶å¾¡:

| Server Action | æ’ä»–åˆ¶å¾¡ | æ ¹æ‹  |
|---------------|---------|------|
| `submitAndGradeMathAnswers()` | `lock_answer_session` RPC (`SELECT ... FOR UPDATE`) | æ¡ç‚¹ä¸­ã«ãƒªãƒˆãƒ©ã‚¤é–‹å§‹ã‚’é˜²æ­¢ |
| `startMathRetry()` | `begin_math_retry` RPCï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯ `UPDATE`ï¼‰ | æ¡ä»¶ãƒã‚§ãƒƒã‚¯+is_latestæ›´æ–°ã‚’1æ–‡ã§å®Œçµã€‚reveal ã¨ã®ç›¸äº’æ’ä»–ã‚’è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ã§ä¿è¨¼ |
| `revealMathAnswers()` | `reveal_math_answers` RPCï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯ `UPDATE`ï¼‰ | æ¡ä»¶ãƒã‚§ãƒƒã‚¯+answers_revealedæ›´æ–°ã‚’1æ–‡ã§å®Œçµã€‚retry ã¨ã®ç›¸äº’æ’ä»–ã‚’è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ã§ä¿è¨¼ |
| `saveMathDraftAnswers()` | UPSERT ã® ON CONFLICT ã§è‡ªå‹•æ’ä»– | åŒä¸€å•é¡Œã®åŒæ™‚ä¿å­˜ã¯æœ€å¾Œã®æ›¸ãè¾¼ã¿ãŒå‹ã¤ |

```typescript
// æ’ä»–åˆ¶å¾¡ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

const admin = createAdminClient()
const studentId = await resolveStudentId(admin, user.id)

// ãƒ‘ã‚¿ãƒ¼ãƒ³ A: submitAndGradeMathAnswers â€” lock_answer_session (SELECT ... FOR UPDATE)
//   å¾Œç¶šå‡¦ç†ï¼ˆæ¡ç‚¹ãƒ«ãƒ¼ãƒ—ï¼‰ã¯å†ªç­‰ãªãŸã‚ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†æ–­ã®å½±éŸ¿ãŒå°ã•ã„
const { data: session } = await admin.rpc('lock_answer_session', {
  p_session_id: input.answerSessionId,
  p_student_id: studentId,
})

// ãƒ‘ã‚¿ãƒ¼ãƒ³ B: startMathRetry / revealMathAnswers â€” ã‚¢ãƒˆãƒŸãƒƒã‚¯ UPDATE RPC
//   reveal â†” retry ã®ç›¸äº’æ’ä»–ã‚’å˜ä¸€ UPDATE æ–‡ã§ä¿è¨¼ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†æ–­ãªã—ï¼‰
const { data: session } = await admin.rpc('begin_math_retry', {
  p_session_id: input.answerSessionId,
  p_student_id: studentId,
})
// â†’ WHERE status='graded' AND answers_revealed=false AND is_latest=true
//   ãŒä¸ä¸€è‡´ãªã‚‰ 0è¡Œæ›´æ–° â†’ data ã® id ãŒ null â†’ ã‚¨ãƒ©ãƒ¼è¿”å´
```

**è£œå„Ÿå¤±æ•—æ™‚ã®é‹ç”¨æ‰‹é †ï¼ˆstartMathRetryï¼‰**:

`startMathRetry()` ã§æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ INSERT å¤±æ•—å¾Œã®è£œå„Ÿæ›´æ–°ï¼ˆ`is_latest=true` å¾©å…ƒï¼‰ã‚‚å¤±æ•—ã—ãŸå ´åˆã€
`CRITICAL: Compensation update also failed` ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚ã“ã®çŠ¶æ…‹ã§ã¯ `is_latest=true` ã®
ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

å¾©æ—§SQL:
```sql
-- è©²å½“ç”Ÿå¾’ + å•é¡Œã‚»ãƒƒãƒˆã®æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šã— is_latest=true ã«ä¿®æ­£
UPDATE answer_sessions
SET is_latest = true
WHERE id = (
  SELECT id FROM answer_sessions
  WHERE student_id = <student_id> AND question_set_id = <question_set_id>
  ORDER BY attempt_number DESC
  LIMIT 1
);
```

æœ¬ç•ªåŒ–æ™‚ã«ã¯ã€ã“ã®è£œå„Ÿãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³å†å–å¾—ã«ã‚ˆã‚‹ retry-safe è¨­è¨ˆã«ç§»è¡Œã—ã€
è£œå„Ÿæ›´æ–°è‡ªä½“ã‚’ä¸è¦ã«ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã™ã‚‹ã€‚ã¾ãŸã€`CRITICAL` ãƒ­ã‚°ç™ºç”Ÿæ™‚ã«
Sentry/ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆã§å³æ™‚é€šçŸ¥ã™ã‚‹ä»•çµ„ã¿ã‚’å°å…¥ã™ã‚‹ã“ã¨ã€‚

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç›´æ¥RPCç¦æ­¢ãƒ«ãƒ¼ãƒ«**:

`get_math_grading_history`, `reveal_math_answers`, `begin_math_retry` ã®3é–¢æ•°ã¯
`REVOKE EXECUTE FROM PUBLIC` + `GRANT TO service_role` ã«ã‚ˆã‚Šã€
`createAdminClient()`ï¼ˆservice_role ã‚­ãƒ¼ï¼‰çµŒç”±ã§ã®ã¿å‘¼ã³å‡ºã—å¯èƒ½ã€‚
`createClient()`ï¼ˆanon ã‚­ãƒ¼ / authenticated ãƒ­ãƒ¼ãƒ«ï¼‰ã‹ã‚‰ã®ç›´æ¥å‘¼ã³å‡ºã—ã¯æ¨©é™ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã€‚
æ–°è¦ RPC ã‚’è¿½åŠ ã™ã‚‹éš›ã‚‚åŒæ§˜ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã€‚

**Server Action å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼**:
```typescript
// lib/auth-helpers.ts
async function resolveStudentId(
  supabase: SupabaseClient,
  authUid: string
): Promise<number> {
  const { data } = await supabase
    .from('students')
    .select('id')
    .eq('user_id', authUid)
    .single()
  if (!data) throw new Error('Student not found for current user')
  return data.id
}
// åŒæ§˜ã« resolveParentId(), resolveCoachId() ã‚’å®šç¾©
```

### 2-7. æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢ä¿‚å›³

```
auth.users (UUID)
  â””â”€â†’ profiles (id=UUID, role)
        â”œâ”€â†’ students (user_id=UUID, id=BIGSERIAL)
        â”‚     â””â”€â†’ answer_sessions (student_id=BIGINT)
        â”‚           â””â”€â†’ student_answers
        â”œâ”€â†’ parents (user_id=UUID, id=BIGSERIAL)
        â”‚     â””â”€â†’ parent_child_relations (parent_id, student_id)
        â””â”€â†’ coaches (user_id=UUID, id=BIGSERIAL)
              â””â”€â†’ coach_student_relations (coach_id, student_id)

study_sessions â”€â”€â”€â”€â”€â”
subjects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
study_content_types â”¤
                    â”œâ”€â†’ question_sets â”€â”€â†’ questions
                    â”‚                        â†‘ answer_config (JSONB)
students â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚ unit_label
                    â””â”€â†’ answer_sessions â”€â”€â†’ student_answers
                                              â†‘ raw_input/answer_value (JSONå¯¾å¿œ)

â€» study_logsï¼ˆæ—¢å­˜ï¼‰ã¨ã¯ç‹¬ç«‹ã€‚ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãæˆ»ã—ãªã—
â€» RLS/Server Actions ã¯ current_student_id() / resolveStudentId() ã§ UUIDâ†’BIGINTå¤‰æ›
```

---

## 3. æ­£ç­”ç™»éŒ²ï¼ˆæ¨¡ç¯„è§£ç­”ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼‰

### 3-1. é‹ç”¨ãƒ•ãƒ­ãƒ¼

```
[è¬›å¸«/ç®¡ç†è€…] æ¨¡ç¯„è§£ç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›
       â†“
  ãƒ‘ãƒ¼ã‚µãƒ¼ã§ answer_type ã‚’è‡ªå‹•åˆ¤å®š
       â†“
  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆç¢ºèªï¼‰
       â†“
  question_set + questions ã‚’ DB ã«ç™»éŒ²
       â†“
  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ 'approved' ã«å¤‰æ›´ â†’ ç”Ÿå¾’ã«å…¬é–‹
```

### 3-2. æ¨¡ç¯„è§£ç­”ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼

è¬›å¸«ãŒå…¥åŠ›ã™ã‚‹æ¨¡ç¯„è§£ç­”ã¯ä»¥ä¸‹ã®å½¢å¼ã‚’æƒ³å®š:

```
ç¬¬1å› ç®—æ•° é¡é¡Œ
(1) 42 [cmÂ²]
(2) 3.5
(3) 3/4
(4) A=14å€‹, B=11å€‹
(5) {50å††åˆ‡æ‰‹=5æš, 80å††åˆ‡æ‰‹=8æš}
(6) é¸æŠ: 3, 7, 11 / ãƒ€ãƒŸãƒ¼: 5, 9, 13
```

### 3-3. ãƒ‘ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ«

```typescript
function parseMathAnswerLine(line: string): ParsedQuestion {
  // (ç•ªå·) ã®æŠ½å‡º
  // [å˜ä½] ã®æŠ½å‡º â†’ unit_label
  // "/" ã‚’å«ã¿ "æ•°å€¤/æ•°å€¤" ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ fraction
  // "A=å€¤, B=å€¤" or "{ãƒ©ãƒ™ãƒ«=å€¤}" ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ multi_part
  // "é¸æŠ:" + "ãƒ€ãƒŸãƒ¼:" ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ selection
  // ãã‚Œä»¥å¤–ã®æ•°å€¤ â†’ numeric
}
```

> **åˆæœŸå®Ÿè£…ã®ç°¡ç´ åŒ–**: æ¨¡ç¯„è§£ç­”ã¯æœ€åˆã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆseed SQL or Server Actionï¼‰ã§ç›´æ¥æŠ•å…¥ã™ã‚‹ã€‚
> è¬›å¸«å‘ã‘ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒ¼ã‚µãƒ¼UIã¯ã€é‹ç”¨è² è·ã«å¿œã˜ã¦å¾Œã‹ã‚‰è¿½åŠ ã€‚

### 3-4. å—é ˜æ¸ˆã¿æ¨¡ç¯„è§£ç­”ãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦

æ¨¡ç¯„è§£ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å—é ˜æ¸ˆã¿ã€‚ä»¥ä¸‹ã¯16ã‚»ãƒƒãƒˆï¼ˆå°5: 8ã‚»ãƒƒãƒˆã€å°6: 8ã‚»ãƒƒãƒˆï¼‰ã®å†…è¨³:

**å°å­¦5å¹´ç”Ÿï¼ˆ281å•ï¼‰**:

| ã‚»ãƒƒãƒˆ | ãƒ—ãƒªãƒ³ãƒˆå | å•æ•° | numeric | multi_part | selection |
|--------|-----------|------|---------|------------|-----------|
| 1 | ç¬¬1å›â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨ | 40 | 30 | 5 | 5 |
| 2 | ç¬¬1å›â‘¡ å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨ | 35 | 25 | 0 | 10 |
| 3 | ç¬¬2å›â‘  ã„ã‚ã„ã‚ãªå›³å½¢ã®é¢ç© | 38 | 38 | 0 | 0 |
| 4 | ç¬¬2å›â‘¡ ã„ã‚ã„ã‚ãªå›³å½¢ã®é¢ç© | 38 | 38 | 0 | 0 |
| 5 | ç¬¬3å›â‘  å‰²åˆã®åˆ©ç”¨ | 38 | 38 | 0 | 0 |
| 6 | ç¬¬3å›â‘¡ ç›¸å½“ç®— | 28 | 28 | 0 | 0 |
| 7 | ç¬¬4å›â‘  å·®é›†ã‚ç®— | 32 | 32 | 0 | 0 |
| 8 | ç¬¬4å›â‘¡ å·®é›†ã‚ç®— | 32 | 24 | 8 | 0 |
|  | **å°è¨ˆ** | **281** | **253** | **13** | **15** |

**å°å­¦6å¹´ç”Ÿï¼ˆ177å•ï¼‰**:

| ã‚»ãƒƒãƒˆ | ãƒ—ãƒªãƒ³ãƒˆå | å•æ•° | numeric | multi_part | selection |
|--------|-----------|------|---------|------------|-----------|
| 1 | ç¬¬1å›â‘  æ–‡ç« é¡Œ | 41 | 40 | 1 | 0 |
| 2 | ç¬¬1å›â‘¡ æ–‡ç« é¡Œ | 41 | 32 | 9 | 0 |
| 3 | ç¬¬2å›â‘  è¦å‰‡æ€§ | 15 | 7 | 7 | 1 |
| 4 | ç¬¬2å›â‘¡ è¦å‰‡æ€§ | 6 | 3 | 3 | 0 |
| 5 | ç¬¬3å›â‘  å¹³é¢å›³å½¢(1) | 32 | 27 | 5 | 0 |
| 6 | ç¬¬3å›â‘¡ å¹³é¢å›³å½¢(1) | 21 | 18 | 2 | 1 |
| 7 | ç¬¬4å›â‘  å®¹å™¨ã¨æ°´é‡ | 9 | 4 | 5 | 0 |
| 8 | ç¬¬4å›â‘¡ å®¹å™¨ã¨æ°´é‡ | 12 | 5 | 7 | 0 |
|  | **å°è¨ˆ** | **177** | **136** | **39** | **2** |

**å…¨ä½“ã‚µãƒãƒª**: åˆè¨ˆ458å•ï¼ˆnumeric: 389ã€multi_part: 52ã€selection: 17ã€fraction: 0ï¼‰

**ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ§‹æˆä¾‹**ï¼ˆå„ãƒ—ãƒªãƒ³ãƒˆå†…ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰:
- å°5 ç¬¬1å›â‘ : é¡é¡Œ1(10å•), é¡é¡Œ2(5å•), é¡é¡Œ3(5å•), è¨ˆç®—ç·´ç¿’(20å•)
- å°6 ç¬¬1å›â‘¡: å¹³å‡ç®—ãƒ»åˆè¨ˆ(12å•), å¹³å‡ç®—ãƒ»é¢ç©å›³(6å•), å·®é›†ã‚ç®—(12å•), å¹´é½¢ç®—(6å•), é›†åˆ(5å•)

**DBæ ¼ç´ã¨è¡¨ç¤ºã®å¯¾å¿œ**:
- `section_name` = `"é¡é¡Œ1"`, `"è¨ˆç®—ç·´ç¿’"`, `"å·®é›†ã‚ç®—"` ç­‰
- `question_number` = `"(1)"`, `"(2)"` ç­‰ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ç•ªå·ï¼‰
- ç”»é¢è¡¨ç¤ºæ™‚ã¯ `section_name` ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ã€å„å•ã« `question_number` ã‚’è¡¨ç¤º

**multi_part ã®ä»£è¡¨ãƒ‘ã‚¿ãƒ¼ãƒ³**:
- `â‘  180 â‘¡ 1020` â†’ slots: â‘ , â‘¡ï¼ˆå°5 é¡é¡Œ3ï¼‰
- `A14å€‹ï¼ŒB11å€‹` â†’ slots: A, B / unit: å€‹ï¼ˆå°5 é¡é¡Œ3ï¼‰
- `60å††åˆ‡æ‰‹11æšï¼Œ90å††åˆ‡æ‰‹4æš` â†’ template: `60å††åˆ‡æ‰‹{A}æšï¼Œ90å††åˆ‡æ‰‹{B}æš`ï¼ˆå°5 é¡é¡Œ6ï¼‰
- `ã‚¢ï¼111Â°ï¼Œã‚¤ï¼94Â°` â†’ slots: ã‚¢, ã‚¤ / unit: Â°ï¼ˆå°6 è§’åº¦ï¼‰
- `å††å‘¨50.24ãï¼Œé¢ç©200.96ã ` â†’ slots: å††å‘¨, é¢ç© / units: ã, ã ï¼ˆå°6 å††ã¨ãŠã†ãå½¢ï¼‰
- `â‘  27äºº â‘¡ 23äºº ... â‘¦ 4äºº` â†’ 7ã‚¹ãƒ­ãƒƒãƒˆï¼ˆå°6 é›†åˆ(4)ï¼‰
- `â‘  4 â‘¡ 8 ... â‘¨ 36` â†’ 9ã‚¹ãƒ­ãƒƒãƒˆï¼ˆå°6 é¡é¡Œ7(5)ï¼‰

**selection ã®ãƒ†ã‚­ã‚¹ãƒˆå›ç­”ï¼ˆ2å•ï¼‰**:
- å°6 ç¬¬2å›â‘  å‘¨æœŸç®—(2): æ­£è§£ã€Œé‡‘æ›œæ—¥ã€â€” 7æ›œæ—¥ã‚’é¸æŠè‚¢ã«
- å°6 ç¬¬3å›â‘¡ å¤šè§’å½¢(4): æ­£è§£ã€Œåå››è§’å½¢ã€â€” å¤šè§’å½¢åã‚’é¸æŠè‚¢ã«

---

## 4. UIè¨­è¨ˆ

### 4-1. ç”»é¢é·ç§»

```
[ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰]
  â”œâ”€ ã€Œç®—æ•° è§£ç­”å…¥åŠ›ã€ã‚«ãƒ¼ãƒ‰
  â”‚    â””â”€â†’ [å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§] /student/math-answer
  â”‚          â””â”€â†’ [è§£ç­”å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ] /student/math-answer/[questionSetId]
  â”‚                â”œâ”€ [é€”ä¸­ä¿å­˜] â†’ ä¸€è¦§ã«æˆ»ã‚‹
  â”‚                â””â”€ [æå‡ºã—ã¦æ¡ç‚¹] â†’ [çµæœè¡¨ç¤º] /student/math-answer/[questionSetId]/result
  â”‚                      â”œâ”€ [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦] â†’ æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ â†’ è§£ç­”å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
  â”‚                      â”œâ”€ [è§£ç­”ã‚’è¦‹ã‚‹] â†’ æ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰
  â”‚                      â””â”€ [ä¸€è¦§ã«æˆ»ã‚‹]
  â””â”€ ã€Œç®—æ•°ãƒ—ãƒªãƒ³ãƒˆè‡ªå‹•æ¡ç‚¹ã€çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæœ€æ–°3ä»¶ï¼‰
       â””â”€â†’ [å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§] /student/math-answer

[ç”Ÿå¾’ãƒªãƒ•ãƒ¬ã‚¯ãƒˆ] â†’ ãƒ†ã‚¹ãƒˆçµæœã‚¿ãƒ– â†’ ç®—æ•°è‡ªå‹•æ¡ç‚¹ãƒ•ã‚£ãƒ«ã‚¿
[ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰] â†’ å­ã©ã‚‚ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³
[æŒ‡å°è€… ç”Ÿå¾’è©³ç´°] â†’ ãƒ†ã‚¹ãƒˆçµæœã‚¿ãƒ– â†’ ç®—æ•°è‡ªå‹•æ¡ç‚¹ãƒ•ã‚£ãƒ«ã‚¿
```

### 4-2. å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ ç®—æ•° è§£ç­”å…¥åŠ›                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ â”€â”€ ç¬¬1å› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨               40å•   â”‚ â”‚
â”‚ â”‚                          [è§£ç­”ã™ã‚‹ â†’]   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â‘¡ å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨       é€”ä¸­ä¿å­˜ âœ“     â”‚ â”‚
â”‚ â”‚ 10/35å• å…¥åŠ›æ¸ˆã¿         [ç¶šãã‚’å…¥åŠ› â†’] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ â”€â”€ ç¬¬2å› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â‘  ã„ã‚ã„ã‚ãªå›³å½¢ã®é¢ç©   28/38 (73%) ğŸ”„ â”‚ â”‚
â”‚ â”‚ 10å• æ®‹ã‚Š               [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ â†’] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â‘¡ ã„ã‚ã„ã‚ãªå›³å½¢ã®é¢ç©  38/38 (100%) âœ… â”‚ â”‚
â”‚ â”‚ å…¨å•æ­£è§£ï¼               [çµæœã‚’è¦‹ã‚‹ â†’] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¡¨ç¤ºè¦ç´ **:
- å›ã”ã¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š
- ãƒ—ãƒªãƒ³ãƒˆç•ªå·ï¼ˆâ‘ /â‘¡ï¼‰+ ãƒ†ãƒ¼ãƒå
- å•é¡Œæ•°
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
  - æœªç€æ‰‹ â†’ [è§£ç­”ã™ã‚‹ â†’]
  - é€”ä¸­ä¿å­˜ã‚ã‚Š â†’ å…¥åŠ›æ¸ˆã¿å•æ•° + [ç¶šãã‚’å…¥åŠ› â†’]
  - æ¡ç‚¹æ¸ˆã¿ï¼ˆæœªå®Œäº†ï¼‰â†’ ã‚¹ã‚³ã‚¢ + æ®‹ã‚Šå•æ•° + ğŸ”„ + [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ â†’]
  - å…¨å•æ­£è§£ â†’ ã‚¹ã‚³ã‚¢ + âœ… + [çµæœã‚’è¦‹ã‚‹ â†’]
  - æ­£ç­”é–‹ç¤ºæ¸ˆã¿ â†’ ã‚¹ã‚³ã‚¢ + [çµæœã‚’è¦‹ã‚‹ â†’]

### 4-3. è§£ç­”å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆå›ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å›â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨     5/40å• å…¥åŠ›æ¸ˆã¿  â”‚
â”‚                              [é€”ä¸­ä¿å­˜æ¸ˆã¿ âœ“] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                             â”‚
â”‚ (1)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  å€‹                   â”‚
â”‚      â”‚  11           â”‚  â† numeric           â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                             â”‚
â”‚ (2)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  å€‹                   â”‚
â”‚      â”‚               â”‚  â† æœªå…¥åŠ›            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                             â”‚
â”‚ (1)  é¸ã‚“ã§ãã ã•ã„:                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”‚
â”‚  â”‚ 3  â”‚ â”‚ 5  â”‚ â”‚ 6  â”‚ â”‚ 10 â”‚ â”‚ 15 â”‚ â”‚ 30 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â”‚
â”‚  â† selectionï¼ˆæ­£è§£+ãƒ€ãƒŸãƒ¼ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¡¨ç¤ºï¼‰   â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                             â”‚
â”‚ (1)  â‘  â”Œâ”€â”€â”€â”€â”€â”  â‘¡ â”Œâ”€â”€â”€â”€â”€â”                  â”‚
â”‚         â”‚ 180 â”‚     â”‚1020 â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â† multi_partï¼ˆ2ã‚¹ãƒ­ãƒƒãƒˆï¼‰            â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€ è¨ˆç®—ç·´ç¿’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                             â”‚
â”‚ (1)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚      â”‚  72           â”‚  â† numeric(å˜ä½ãªã—)  â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚ [é€”ä¸­ä¿å­˜]              [æ¡ç‚¹ã™ã‚‹]           â”‚
â”‚                                             â”‚
â”‚ â€» å…¥åŠ›é€”ä¸­ã§ã‚‚æ¡ç‚¹å¯èƒ½ã€‚                     â”‚
â”‚   æœªå…¥åŠ›ã®å•é¡Œã¯ã€Œæœªå›ç­”ã€ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š**: 1ãƒ—ãƒªãƒ³ãƒˆå†…ã®è¤‡æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé¡é¡Œ1, é¡é¡Œ2, è¨ˆç®—ç·´ç¿’ ç­‰ï¼‰ã¯
è¦‹å‡ºã—ä»˜ãã®åŒºåˆ‡ã‚Šç·šã§è¦–è¦šçš„ã«åˆ†é›¢ã€‚question_number ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ç•ªå·ã‚’è¡¨ç¤ºã€‚

### 4-3b. è§£ç­”å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒªãƒˆãƒ©ã‚¤æ™‚ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å›â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨      2å›ç›®ã®æŒ‘æˆ¦    â”‚
â”‚ å‰å›: 28/40å•æ­£è§£             12å• æ®‹ã‚Š      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                             â”‚
â”‚ (1)  âœ… 11 å€‹                 â† ãƒ­ãƒƒã‚¯æ¸ˆã¿   â”‚
â”‚ (2)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  å€‹    â† å†å…¥åŠ›å¯     â”‚
â”‚      â”‚  8            â”‚  å‰å›ä¸æ­£è§£           â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚ (3)  âœ… 12 å€‹                 â† ãƒ­ãƒƒã‚¯æ¸ˆã¿   â”‚
â”‚ ...                                         â”‚
â”‚ (9)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  å€‹    â† å†å…¥åŠ›å¯     â”‚
â”‚      â”‚               â”‚  å‰å›æœªå›ç­”           â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚ [é€”ä¸­ä¿å­˜]              [æ¡ç‚¹ã™ã‚‹]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãƒªãƒˆãƒ©ã‚¤æ™‚ã®ãƒ«ãƒ¼ãƒ«**:
- âœ… æ­£è§£æ¸ˆã¿å•é¡Œ: å€¤ã‚’è¡¨ç¤ºã€å…¥åŠ›æ¬„ãªã—ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
- âŒ ä¸æ­£è§£ã®å•é¡Œ: å‰å›ã®å…¥åŠ›å€¤ã‚’ãƒ—ãƒªãƒ•ã‚£ãƒ«ã—ã€ç·¨é›†å¯èƒ½
- â¬œ æœªå›ç­”ã®å•é¡Œ: ç©ºæ¬„ã§ç·¨é›†å¯èƒ½
- ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã€ŒNå›ç›®ã®æŒ‘æˆ¦ã€ã¨æ®‹ã‚Šå•é¡Œæ•°ã‚’è¡¨ç¤º

### 4-4. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»•æ§˜

#### NumericInputï¼ˆæ•°å€¤å…¥åŠ›ï¼‰

```typescript
interface NumericInputProps {
  questionNumber: string   // "(1)"
  unitLabel?: string       // "cmÂ²", "é€šã‚Š" etc.
  value: string
  onChange: (value: string) => void
}
```

- `<input type="text" inputMode="decimal">` â€” iPad ãƒ†ãƒ³ã‚­ãƒ¼è¡¨ç¤º
- å˜ä½ã¯å…¥åŠ›æ¬„ã®å³å´ã«è¡¨ç¤º
- ãƒã‚¤ãƒŠã‚¹å€¤ãƒ»å°æ•°å¯¾å¿œ
- æœ€å°é«˜ã• 48pxï¼ˆApple HIGæº–æ‹ ï¼‰
- **å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆonChange æ™‚ï¼‰**:
  - å…¨è§’æ•°å­—â†’åŠè§’æ•°å­—ã«è‡ªå‹•å¤‰æ›ï¼ˆ`"ï¼”ï¼’"` â†’ `"42"`ï¼‰
  - å…¨è§’ãƒã‚¤ãƒŠã‚¹â†’åŠè§’ï¼ˆ`"âˆ’"` â†’ `"-"`ï¼‰
  - å…¨è§’ãƒ”ãƒªã‚ªãƒ‰â†’åŠè§’ï¼ˆ`"ï¼"` â†’ `"."`ï¼‰
  - è¨±å¯æ–‡å­—: åŠè§’æ•°å­— `0-9`ã€ãƒã‚¤ãƒŠã‚¹ `-`ã€ãƒ”ãƒªã‚ªãƒ‰ `.` ã®ã¿
  - ãã‚Œä»¥å¤–ã®æ–‡å­—ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã€è¨˜å·ã€ç©ºç™½ï¼‰ã¯é™¤å»
  - å…ˆé ­ä»¥å¤–ã® `-` ã¯é™¤å»
  - `.` ã¯1ã¤ã¾ã§ï¼ˆ2ã¤ç›®ä»¥é™ã¯é™¤å»ï¼‰

```typescript
function sanitizeNumericInput(raw: string): string {
  return raw
    .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
    .replace(/[âˆ’ãƒ¼]/g, '-')
    .replace(/[ï¼ã€‚]/g, '.')
    .replace(/[^0-9.\-]/g, '')
    .replace(/(?!^)-/g, '')           // å…ˆé ­ä»¥å¤–ã® - ã‚’é™¤å»
    .replace(/(\..*)\./g, '$1')       // 2ã¤ç›®ä»¥é™ã® . ã‚’é™¤å»
}
```

#### FractionInputï¼ˆåˆ†æ•°å…¥åŠ›ï¼‰

```typescript
interface FractionInputProps {
  questionNumber: string
  numerator: string
  denominator: string
  onNumeratorChange: (value: string) => void
  onDenominatorChange: (value: string) => void
}
```

- åˆ†å­/åˆ†æ¯ã®2æ¬„ + è¦–è¦šçš„ãªåˆ†æ•°ç·š
- åˆ†å­å…¥åŠ›å¾Œã€Enter or Tab ã§åˆ†æ¯ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è‡ªå‹•ç§»å‹•
- åˆ†æ¯ = 0 ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
- å‡ºåŠ›: `"åˆ†å­/åˆ†æ¯"` å½¢å¼ã®æ–‡å­—åˆ—

#### MultiPartInputï¼ˆè¤‡æ•°ã‚¹ãƒ­ãƒƒãƒˆå…¥åŠ›ï¼‰

```typescript
interface MultiPartInputProps {
  questionNumber: string
  template: string                       // "Aã¯{A}å€‹ã€Bã¯{B}å€‹"
  slots: { label: string; unit: string }[]
  values: Record<string, string>         // { "A": "14", "B": "11" }
  onChange: (label: string, value: string) => void
}
```

- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—ã® `{ãƒ©ãƒ™ãƒ«å}` ã‚’å…¥åŠ›æ¬„ã«ç½®æ›ã—ã¦è¡¨ç¤ºï¼ˆä¾‹: `{A}` â†’ å…¥åŠ›æ¬„ï¼‰
- å„ã‚¹ãƒ­ãƒƒãƒˆã¯ç‹¬ç«‹ã—ãŸãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼ˆ`sanitizeNumericInput()` ã‚’å…±æœ‰ï¼‰
- Tab ã§ `slots` é…åˆ—é †ã«æ¬¡ã®ã‚¹ãƒ­ãƒƒãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•

#### SelectionInputï¼ˆé¸æŠå¼å…¥åŠ›ï¼‰

```typescript
interface SelectionInputProps {
  questionNumber: string
  options: string[]          // æ­£è§£+ãƒ€ãƒŸãƒ¼ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«æ¸ˆã¿ï¼‰
  selectedValues: string[]
  unitLabel?: string
  onToggle: (value: string) => void
}
```

- æ•°å€¤ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºï¼ˆ2ã€œ3åˆ—ï¼‰
- ã‚¿ãƒƒãƒ—ã§ãƒˆã‚°ãƒ«ï¼ˆé¸æŠ/è§£é™¤ï¼‰
- é¸æŠæ¸ˆã¿ãƒœã‚¿ãƒ³ã¯èƒŒæ™¯è‰²ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆblue-500ï¼‰
- ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º: æœ€ä½ 48px Ã— 48px
- é¸æŠæ•°ã®åˆ¶é™ãªã—ï¼ˆç”Ÿå¾’ãŒè‡ªç”±ã«é¸ã¶ï¼‰

### 4-5. çµæœè¡¨ç¤ºç”»é¢ï¼ˆæ­£ç­”éè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰

å…¨å•æ­£è§£ã«é”ã™ã‚‹ã¾ã§ã€ã¾ãŸã¯ã€Œè§£ç­”ã‚’è¦‹ã‚‹ã€ã‚’æŠ¼ã™ã¾ã§æ­£ç­”ã¯éè¡¨ç¤ºã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å›â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨  çµæœ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚            ğŸ¯ 28 / 40 å•æ­£è§£                â”‚
â”‚               70%                           â”‚
â”‚                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ (1)  âœ… æ­£è§£                                â”‚
â”‚ (2)  âŒ ä¸æ­£è§£                              â”‚
â”‚ (3)  âœ… æ­£è§£                                â”‚
â”‚ ...                                         â”‚
â”‚ (9)  â¬œ æœªå›ç­”                              â”‚
â”‚ (10) âœ… æ­£è§£                                â”‚
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ (1)  âŒ ä¸æ­£è§£                              â”‚
â”‚ (2)  âœ… æ­£è§£                                â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€ è¨ˆç®—ç·´ç¿’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ (1)  âœ… æ­£è§£                                â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚ [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦]    [è§£ç­”ã‚’è¦‹ã‚‹]   [ä¸€è¦§ã«æˆ»ã‚‹] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4-5b. çµæœè¡¨ç¤ºç”»é¢ï¼ˆæ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰

å…¨å•æ­£è§£é”æˆ or ã€Œè§£ç­”ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å›â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨  çµæœ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚            ğŸ¯ 28 / 40 å•æ­£è§£  70%           â”‚
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ (1)  âœ…  ã‚ãªãŸ: 11å€‹                       â”‚
â”‚ (2)  âŒ  ã‚ãªãŸ: 8å€‹  â†’ æ­£è§£: 10å€‹          â”‚
â”‚ (3)  âœ…  ã‚ãªãŸ: 12å€‹                       â”‚
â”‚ ...                                         â”‚
â”‚ (9)  â¬œ  æœªå›ç­”  æ­£è§£: 16å€‹                  â”‚
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ (1)  âŒ  ã‚ãªãŸ: 5,6,10,15                  â”‚
â”‚         æ­£è§£: 5,6,10,15,30                  â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚ â”€â”€ é¡é¡Œ3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ (4)  âŒ                                     â”‚
â”‚   ã‚ãªãŸ: â‘ =800, â‘¡=1980                    â”‚
â”‚   æ­£è§£:   â‘ =900, â‘¡=1980                    â”‚
â”‚ ...                                         â”‚
â”‚                                             â”‚
â”‚           [ä¸€è¦§ã«æˆ»ã‚‹]                       â”‚
â”‚                                             â”‚
â”‚ â€» è§£ç­”ã‚’è¦‹ãŸå¾Œã¯ã“ã®ã‚»ãƒƒãƒˆã®å†æŒ‘æˆ¦ã¯ã§ãã¾ã›ã‚“ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¡¨ç¤ºãƒ«ãƒ¼ãƒ«**:

| çŠ¶æ…‹ | æ­£ç­”éè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ | æ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ |
|------|-----------------|---------------|
| âœ… æ­£è§£ | âœ… ãƒãƒ¼ã‚¯ã®ã¿ | âœ… + ç”Ÿå¾’ã®è§£ç­” |
| âŒ ä¸æ­£è§£ | âŒ ãƒãƒ¼ã‚¯ã®ã¿ | âŒ + ç”Ÿå¾’ã®è§£ç­” + æ­£ç­” |
| â¬œ æœªå›ç­” | â¬œã€Œæœªå›ç­”ã€ | â¬œã€Œæœªå›ç­”ã€+ æ­£ç­” |

**ãƒœã‚¿ãƒ³è¡¨ç¤ºãƒ«ãƒ¼ãƒ«**:
- `answers_revealed = false` ã‹ã¤ä¸æ­£è§£/æœªå›ç­”ã‚ã‚Š â†’ [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦] + [è§£ç­”ã‚’è¦‹ã‚‹] + [ä¸€è¦§ã«æˆ»ã‚‹]
- `answers_revealed = false` ã‹ã¤å…¨å•æ­£è§£ â†’ è‡ªå‹•çš„ã«æ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸é·ç§»
- `answers_revealed = true` â†’ [ä¸€è¦§ã«æˆ»ã‚‹] ã®ã¿ï¼ˆãƒªãƒˆãƒ©ã‚¤ä¸å¯ï¼‰

---

## 5. Server Actions

### 5-1. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
app/actions/math-answer.ts    # ç®—æ•°è§£ç­”ã®å…¨Server Actions
lib/math-grading.ts            # æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç´”ç²‹é–¢æ•°ã€DBã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰
```

### 5-2. math-answer.ts

```typescript
// ================================================================
// å•é¡Œã‚»ãƒƒãƒˆå–å¾—ç³»
// ================================================================

/**
 * ç”Ÿå¾’ã®å­¦å¹´ã«å¯¾å¿œã™ã‚‹ç®—æ•°ã®å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—
 * - approved ã®ã¿
 * - å„ã‚»ãƒƒãƒˆã® answer_session ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚ä»˜ä¸
 */
export async function getMathQuestionSets(): Promise<{
  questionSets: MathQuestionSetSummary[]
  error?: string
}>

/**
 * æŒ‡å®šã®å•é¡Œã‚»ãƒƒãƒˆã®å…¨å•é¡Œã‚’å–å¾—ï¼ˆè§£ç­”å…¥åŠ›ç”¨ï¼‰
 * - questions + answer_config + unit_label
 * - æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã¯å«ã‚ãªã„ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ­£ç­”ã‚’é€ã‚‰ãªã„ï¼‰
 */
export async function getMathQuestionsForAnswering(
  questionSetId: number
): Promise<{
  questions: MathQuestionForUI[]
  questionSet: { title: string; questionCount: number }
  error?: string
}>

// ================================================================
// è§£ç­”ä¿å­˜ãƒ»æ¡ç‚¹ç³»
// ================================================================

/**
 * é€”ä¸­ä¿å­˜ï¼ˆUPSERTï¼‰
 * - answer_session ãŒç„¡ã‘ã‚Œã° in_progress ã§ä½œæˆ
 * - æ—¢å­˜ã® in_progress ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°ãã®è§£ç­”ã‚’æ›´æ–°
 * - is_correct/scored_at ã¯ NULL ã®ã¾ã¾ï¼ˆæœªæ¡ç‚¹ï¼‰
 */
export async function saveMathDraftAnswers(input: {
  questionSetId: number
  answers: { questionId: number; rawInput: string | null }[]
}): Promise<{
  answerSessionId: number
  savedCount: number
  error?: string
}>

/**
 * æ¡ç‚¹ï¼ˆéƒ¨åˆ†æå‡ºOKï¼‰
 * - å…¥åŠ›æ¸ˆã¿ã®å•é¡Œã®ã¿æ¡ç‚¹ï¼ˆæœªå…¥åŠ›ã¯ is_correct=NULL ã®ã¾ã¾ï¼‰
 * - æ­£è§£æ¸ˆã¿å•é¡Œï¼ˆis_correct=trueï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒªãƒˆãƒ©ã‚¤æ™‚ï¼‰
 * - answer_session ã‚’ 'graded' ã«æ›´æ–°
 * - å†ªç­‰: æ—¢ã« graded ã‹ã¤å¤‰æ›´ãªã—ãªã‚‰æ—¢å­˜çµæœã‚’è¿”ã™
 * - å…¨å•æ­£è§£æ™‚ã¯ answersRevealed=true + MathGradeResultWithAnswers ã‚’è¿”å´
 * - æœªå®Œäº†æ™‚ã¯ answersRevealed=false + MathGradeResultWithoutAnswers ã‚’è¿”å´
 */
export async function submitAndGradeMathAnswers(input: {
  answerSessionId: number
}): Promise<{
  result: MathGradeResult    // åˆ¤åˆ¥å…±ç”¨ä½“ï¼ˆanswersRevealed ã§å‹åˆ†å²ï¼‰
  error?: string
}>

/**
 * ãƒªãƒˆãƒ©ã‚¤é–‹å§‹ï¼ˆæ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‰
 * - ç¾ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ graded ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
 * - answers_revealed=true ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤ä¸å¯ï¼ˆã‚¨ãƒ©ãƒ¼è¿”å´ï¼‰
 * - æ–°ã—ã„ answer_session ã‚’ä½œæˆï¼ˆattempt_number = prev + 1, is_latest=trueï¼‰
 * - ç¾ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® is_latest ã‚’ false ã«æ›´æ–°
 * - æ­£è§£æ¸ˆã¿ï¼ˆis_correct=trueï¼‰ã® student_answers ã‚’æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚³ãƒ”ãƒ¼
 * - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ + è¡Œãƒ­ãƒƒã‚¯ã§æ’ä»–åˆ¶å¾¡
 */
export async function startMathRetry(input: {
  answerSessionId: number
}): Promise<{
  newAnswerSessionId: number
  error?: string
}>

/**
 * æ­£ç­”é–‹ç¤º
 * - answers_revealed ã‚’ true ã«è¨­å®š
 * - å…¨å•ã®æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€çµæœã‚’è¿”å´
 * - ä»¥é™ãƒªãƒˆãƒ©ã‚¤ä¸å¯
 */
export async function revealMathAnswers(input: {
  answerSessionId: number
}): Promise<{
  result: MathGradeResultWithAnswers
  error?: string
}>

/**
 * é€”ä¸­ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒï¼ˆãƒªãƒˆãƒ©ã‚¤æ™‚ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚‚å«ã‚€ï¼‰
 * - in_progress ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
 * - å„å•é¡Œã® is_correct ã‚’å«ã‚ã€ãƒ­ãƒƒã‚¯åˆ¤å®šã«ä½¿ç”¨
 */
export async function getMathDraftAnswers(
  questionSetId: number
): Promise<{
  answerSessionId: number
  answers: { questionId: number; rawInput: string; isCorrect: boolean | null }[]
} | null>

/**
 * æ¡ç‚¹çµæœã®å–å¾—
 * - graded ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çµæœã‚’è¿”ã™
 * - answers_revealed=false: æ­£ç­”ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆâœ…/âŒ/â¬œ ã®ã¿ï¼‰
 * - answers_revealed=true: æ­£ç­”ãƒ‡ãƒ¼ã‚¿å«ã‚€
 */
export async function getMathGradeResult(
  questionSetId: number
): Promise<{
  result: MathGradeResult
  error?: string
} | null>

// ================================================================
// ä»–ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºç³»ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ãƒªãƒ•ãƒ¬ã‚¯ãƒˆé€£æºï¼‰
// ================================================================

/**
 * ç®—æ•°è‡ªå‹•æ¡ç‚¹ã®å…¨å±¥æ­´ã‚’å–å¾—
 * - is_latest=true ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ï¼ˆæœ€æ–°ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆï¼‰
 * - attempt_history ã‚‚å«ã‚€ï¼ˆæ¨ç§»ã‚°ãƒ©ãƒ•ç”¨ï¼‰
 * - studentId çœç•¥æ™‚ã¯è‡ªåˆ†ï¼ˆç”Ÿå¾’ï¼‰ã€æŒ‡å®šæ™‚ã¯ä¿è­·è€…/æŒ‡å°è€…ãŒå¯¾è±¡ç”Ÿå¾’ã‚’å‚ç…§
 * - èªå¯ãƒã‚§ãƒƒã‚¯: ä¿è­·è€…ã¯ç´ã¥ã‘æ¸ˆã¿å­ã©ã‚‚ã€æŒ‡å°è€…ã¯æ‹…å½“ç”Ÿå¾’ã®ã¿
 */
export async function getMathGradingHistory(input?: {
  studentId?: number  // students.id ã¯ SERIAL (integer)
}): Promise<{
  results: MathGradingHistoryItem[]
  summary: {
    latestScore: number | null
    averagePercentage: number | null
    completedSets: number
    inProgressSets: number
  }
  error?: string
}>
```

### 5-3. å‹å®šç¾©

```typescript
// å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§ç”¨
interface MathQuestionSetSummary {
  id: number
  title: string                // "ç¬¬1å›â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨"
  sessionNumber: number
  printNumber: 'â‘ ' | 'â‘¡'
  questionCount: number
  status: 'not_started' | 'in_progress' | 'graded'
  answersRevealed: boolean     // æ­£ç­”é–‹ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°
  score?: { total: number; max: number; percentage: number }
  remainingCount?: number      // ä¸æ­£è§£+æœªå›ç­”ã®å•é¡Œæ•°ï¼ˆgradedæ™‚ï¼‰
}

// è§£ç­”å…¥åŠ›UIç”¨ï¼ˆæ­£ç­”ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰
interface MathQuestionForUI {
  id: number
  questionNumber: string       // "(1)", "(2)" ç­‰ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ç•ªå·ã€DBå€¤ãã®ã¾ã¾ï¼‰
  sectionName: string          // "é¡é¡Œ1", "è¨ˆç®—ç·´ç¿’" ç­‰ï¼ˆåŒºåˆ‡ã‚Šè¡¨ç¤ºç”¨ã€DBå€¤ãã®ã¾ã¾ï¼‰
  answerType: 'numeric' | 'fraction' | 'multi_part' | 'selection'
  unitLabel: string | null
  answerConfig: MultiPartConfig | SelectionConfig | null
  points: number
}

interface MultiPartConfig {
  template: string
  slots: { label: string; unit: string }[]
  // correct_values ã¯å«ã‚ãªã„ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ã‚‰ãªã„ï¼‰
}

interface SelectionConfig {
  options: string[]           // correct + dummy ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ¸ˆã¿
  // correct_values ã¯å«ã‚ãªã„
  unit: string | null
}

// æ¡ç‚¹çµæœè©³ç´°ï¼ˆæ­£ç­”éè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰
interface MathGradeDetail {
  questionId: number
  questionNumber: string
  sectionName: string          // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åï¼ˆ"é¡é¡Œ1", "è¨ˆç®—ç·´ç¿’" ç­‰ï¼‰
  answerType: string
  isCorrect: boolean | null    // true=æ­£è§£, false=ä¸æ­£è§£, null=æœªå›ç­”
  rawInput: string | null      // ç”Ÿå¾’ã®å…¥åŠ›å€¤ï¼ˆæ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
  unitLabel: string | null
  points: number
  earnedPoints: number
  // correctAnswer ã¯å«ã‚ãªã„ï¼ˆæ­£ç­”éè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰
}

// æ¡ç‚¹çµæœè©³ç´°ï¼ˆæ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰
interface MathGradeDetailWithAnswer extends MathGradeDetail {
  rawInput: string | null      // ç”Ÿå¾’ã®å…¥åŠ›å€¤
  correctAnswer: string        // è¡¨ç¤ºç”¨æ­£ç­”
}

// æ¡ç‚¹çµæœï¼ˆæ­£ç­”éè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰
interface MathGradeResultWithoutAnswers {
  totalScore: number
  maxScore: number
  percentage: number
  attemptNumber: number          // æŒ‘æˆ¦å›æ•°
  attemptHistory: { attempt: number; score: number; maxScore: number }[]
  details: MathGradeDetail[]
  answersRevealed: false
}

// æ¡ç‚¹çµæœï¼ˆæ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰
interface MathGradeResultWithAnswers {
  totalScore: number
  maxScore: number
  percentage: number
  attemptNumber: number
  attemptHistory: { attempt: number; score: number; maxScore: number }[]
  details: MathGradeDetailWithAnswer[]
  answersRevealed: true
}

// åˆ¤åˆ¥å…±ç”¨ä½“ï¼ˆanswersRevealed ã§å‹ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰
type MathGradeResult = MathGradeResultWithoutAnswers | MathGradeResultWithAnswers

// ä»–ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºç”¨ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12 å‚ç…§ï¼‰
interface MathGradingHistoryItem {
  questionSetId: number
  title: string                 // "ç¬¬1å›â‘  å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨"
  sessionNumber: number
  printNumber: 'â‘ ' | 'â‘¡'
  questionCount: number
  latestAttempt: {
    attemptNumber: number
    status: 'in_progress' | 'graded'
    score: number
    maxScore: number
    percentage: number
    answersRevealed: boolean
    gradedAt: string | null     // ISO 8601
  }
  attemptHistory: {
    attempt: number
    score: number
    maxScore: number
    percentage: number
    gradedAt: string
  }[]
}
```

> **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é™¤å»**
>
> `getMathQuestionsForAnswering()` ã¯æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ã‚‰ãªã„ã€‚
> DBã‹ã‚‰å–å¾—ã—ãŸ `answer_config` ã‚’ä»¥ä¸‹ã®æ‰‹é †ã§ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¦ã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã‚‹:
>
> ```typescript
> function sanitizeAnswerConfig(
>   answerType: string,
>   config: Record<string, unknown> | null,
>   questionId: number               // selection ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ« seed ã«ä½¿ç”¨
> ): MultiPartConfig | SelectionConfig | null {
>   if (!config || typeof config !== 'object') return null
>
>   try {
>     if (answerType === 'multi_part') {
>       const { slots, template } = config as any
>       // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å‹ãƒã‚§ãƒƒã‚¯: å£Šã‚ŒãŸ JSON æ§‹é€ ã§ã‚‚å®‰å…¨ã« null ã‚’è¿”ã™
>       if (!Array.isArray(slots) || typeof template !== 'string') return null
>       // correct_values ã‚’é™¤å»ã—ã€slots ã¨ template ã®ã¿è¿”ã™
>       return { template, slots }
>     }
>
>     if (answerType === 'selection') {
>       const { correct_values, dummy_values } = config as any
>       // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å‹ãƒã‚§ãƒƒã‚¯
>       if (!Array.isArray(correct_values) || !Array.isArray(dummy_values)) return null
>       const allValues = [...correct_values, ...dummy_values]
>       return { options: shuffleWithSeed(allValues, questionId), unit: (config as any).unit ?? null }
>     }
>   } catch {
>     // JSON æ§‹é€ ãŒæƒ³å®šå¤–ã®å ´åˆã¯å®‰å…¨ã« null ã‚’è¿”ã™
>     return null
>   }
>
>   return null
> }
> ```
>
> **å‘¼ã³å‡ºã—ä»•æ§˜** (`getMathQuestionsForAnswering()` å†…éƒ¨):
> ```typescript
> // DB ã‹ã‚‰ correct_answer ã‚’é™¤å¤–ã—ã¦å–å¾—
> const { data } = await supabase
>   .from("questions")
>   .select("id, question_number, section_name, answer_type, unit_label, answer_config, points, display_order")
>   .eq("question_set_id", questionSetId)
>   .order("display_order")
>
> // å„å•é¡Œã® answer_config ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™
> const questions: MathQuestionForUI[] = (data || []).map(q => ({
>   id: q.id,
>   questionNumber: q.question_number,
>   sectionName: q.section_name,
>   answerType: q.answer_type,
>   unitLabel: q.unit_label,
>   answerConfig: sanitizeAnswerConfig(q.answer_type, q.answer_config, q.id),
>   points: q.points,
> }))
> ```

---

## 6. æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯

### 6-1. å…±é€šé–¢æ•° (`lib/math-grading.ts`)

```typescript
/**
 * æ•°å€¤å…¥åŠ›ã®æ­£è¦åŒ–
 * - å…ˆé ­ã‚¼ãƒ­é™¤å»: "042" â†’ "42"
 * - æœ«å°¾ã‚¼ãƒ­é™¤å»: "3.50" â†’ "3.5"
 * - ç§‘å­¦è¨˜æ•°æ³•æ‹’å¦: "1e2" â†’ null
 */
const NUMERIC_FORMAT = /^-?(\d+\.?\d*|\d*\.?\d+)$/

export function normalizeNumeric(raw: string): string | null {
  const trimmed = raw.trim()
  if (!NUMERIC_FORMAT.test(trimmed)) return null
  const num = Number(trimmed)
  if (!Number.isFinite(num)) return null
  return String(num)
}

/**
 * å•é¡Œå˜ä½ã®æ¡ç‚¹
 *
 * å‰ææ¡ä»¶ï¼ˆå‘¼ã³å‡ºã—å´ã§ä¿è¨¼ã™ã‚‹ã“ã¨ï¼‰:
 * - rawInput ã¯énullãƒ»éç©ºæ–‡å­—ï¼ˆæœªå›ç­”ã¯å‘¼ã³å‡ºã—å‰ã«é™¤å¤–ã— is_correct=NULL ã§å‡¦ç†ï¼‰
 * - is_correct=true ã®å•é¡Œã¯å‘¼ã³å‡ºã•ãªã„ï¼ˆãƒªãƒˆãƒ©ã‚¤æ™‚ã®ã‚¹ã‚­ãƒƒãƒ—ï¼‰
 *
 * æˆ»ã‚Šå€¤:
 * - answerValue: æ­£è¦åŒ–æ¸ˆã¿ã®å€¤ï¼ˆDBä¿å­˜ç”¨ï¼‰
 * - isCorrect: true=æ­£è§£, false=ä¸æ­£è§£
 */
export function gradeAnswer(
  answerType: 'numeric' | 'fraction' | 'multi_part' | 'selection',
  rawInput: string,                    // énullãƒ»éç©ºæ–‡å­—ï¼ˆå‘¼ã³å‡ºã—å´ã§ä¿è¨¼ï¼‰
  correctAnswer: string | null,        // numeric/fractionç”¨
  answerConfig: Record<string, unknown> | null  // multi_part/selectionç”¨
): { answerValue: string; isCorrect: boolean } {

  switch (answerType) {
    case 'numeric': {
      const normalized = normalizeNumeric(rawInput)
      if (normalized === null) return { answerValue: rawInput.trim(), isCorrect: false }
      return { answerValue: normalized, isCorrect: normalized === correctAnswer }
    }

    case 'fraction': {
      const normalized = rawInput.trim()
      const parts = normalized.split('/')
      if (parts.length === 2 && Number(parts[1]) === 0) {
        return { answerValue: normalized, isCorrect: false }
      }
      return { answerValue: normalized, isCorrect: normalized === correctAnswer?.trim() }
    }

    case 'multi_part': {
      // rawInput: '{"A":"14","B":"11"}' (JSONæ–‡å­—åˆ—)
      // answerConfig.correct_values: { "A": "14", "B": "11" } (ãƒ©ãƒ™ãƒ«â†’æ­£ç­”ãƒãƒƒãƒ—)
      // answerConfig.slots: [{ label: "A" }, { label: "B" }]
      const config = answerConfig as {
        correct_values: Record<string, string>
        slots: { label: string }[]
      }
      let parsed: Record<string, string>
      try {
        parsed = JSON.parse(rawInput)
      } catch {
        return { answerValue: rawInput, isCorrect: false }
      }

      const allCorrect = config.slots.every(slot => {
        const studentValue = normalizeNumeric(parsed[slot.label] || '')
        const correctValue = config.correct_values[slot.label]
        return studentValue !== null && studentValue === correctValue
      })

      // answer_value ã¯æ­£è¦åŒ–æ¸ˆã¿JSONã«å¤‰æ›
      const normalizedObj: Record<string, string> = {}
      config.slots.forEach(slot => {
        normalizedObj[slot.label] = normalizeNumeric(parsed[slot.label] || '') || parsed[slot.label] || ''
      })

      return { answerValue: JSON.stringify(normalizedObj), isCorrect: allCorrect }
    }

    case 'selection': {
      // rawInput: '["3","7","11"]' (JSONé…åˆ—æ–‡å­—åˆ—)
      // answerConfig.correct_values: ["3", "7", "11"]
      const config = answerConfig as { correct_values: string[] }
      let parsed: string[]
      try {
        parsed = JSON.parse(rawInput)
        if (!Array.isArray(parsed)) return { answerValue: rawInput, isCorrect: false }
      } catch {
        return { answerValue: rawInput, isCorrect: false }
      }

      // trim + é‡è¤‡é™¤å»ã§æ­£è¦åŒ–ï¼ˆãƒ€ãƒŸãƒ¼å€¤é‡è¤‡ãƒ»ä¸æ­£å…¥åŠ›ã¸ã®é˜²å¾¡ï¼‰
      const normalizedStudent = [...new Set(parsed.map(v => String(v).trim()))].sort()
      const normalizedCorrect = [...new Set(config.correct_values.map(v => v.trim()))].sort()
      const isCorrect = JSON.stringify(normalizedStudent) === JSON.stringify(normalizedCorrect)

      return { answerValue: JSON.stringify(normalizedStudent), isCorrect }
    }
  }
}
```

### 6-2. æ¡ç‚¹ãƒ•ãƒ­ãƒ¼ï¼ˆsubmitAndGradeMathAnswers å†…éƒ¨ï¼‰

```
1. answer_session ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
   - graded â†’ æ—¢å­˜çµæœã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆå†ªç­‰ï¼‰
   - in_progress â†’ æ¡ç‚¹ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ

2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ + è¡Œãƒ­ãƒƒã‚¯
   SELECT ... FROM answer_sessions WHERE id=$1 FOR UPDATE

3. questions ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ correct_answer / answer_config ã‚’ä¸€æ‹¬å–å¾—

4. student_answers ã‹ã‚‰ raw_input / is_correct ã‚’ä¸€æ‹¬å–å¾—

5. å„å•ã‚’å‡¦ç†ï¼ˆå‘¼ã³å‡ºã—å´ã§æœªå›ç­”ã‚’é™¤å¤–ï¼‰:
   - is_correct = trueï¼ˆå‰ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼æ¸ˆã¿ï¼‰â†’ ã‚¹ã‚­ãƒƒãƒ—
   - raw_input ãŒ NULL or ç©ºæ–‡å­—ï¼ˆstudent_answersã«è¡Œãªã— or ç©ºï¼‰
     â†’ is_correct = NULL ã®ã¾ã¾ï¼ˆæœªå›ç­”ï¼‰
   - raw_input ã‚ã‚Š â†’ gradeAnswer() ã‚’å‘¼ã³å‡ºã—
     â†’ æˆ»ã‚Šå€¤ã® answerValue, isCorrect ã§ student_answers ã‚’æ›´æ–°
     â†’ scored_at = now()

6. total_score = SUM(is_correct=true ã®å•é¡Œã® points)
   max_score = SUM(å…¨å•é¡Œã® points)

7. answer_session ã‚’ 'graded' ã«æ›´æ–°

8. å…¨å•æ­£è§£ã®å ´åˆ:
   - answers_revealed ã‚’è‡ªå‹•çš„ã« true ã«è¨­å®š
   - æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€çµæœã‚’è¿”å´ï¼ˆMathGradeResultWithAnswersï¼‰

9. å…¨å•æ­£è§£ã§ãªã„å ´åˆ:
   - æ­£ç­”ãƒ‡ãƒ¼ã‚¿ãªã—ã®çµæœã‚’è¿”å´ï¼ˆMathGradeResultWithoutAnswersï¼‰

10. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆ
```

### 6-3. is_correct ã®3çŠ¶æ…‹

| is_correct | æ„å‘³ | çµæœç”»é¢è¡¨ç¤º | ãƒªãƒˆãƒ©ã‚¤æ™‚ |
|------------|------|------------|-----------|
| `true` | æ­£è§£ | âœ… | ãƒ­ãƒƒã‚¯ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ |
| `false` | ä¸æ­£è§£ï¼ˆå…¥åŠ›ã‚ã‚Šï¼‰ | âŒ | å‰å›å€¤ãƒ—ãƒªãƒ•ã‚£ãƒ«ã€ç·¨é›†å¯ |
| `NULL` | æœªå›ç­”ï¼ˆå…¥åŠ›ãªã—ï¼‰ | â¬œ | ç©ºæ¬„ã€ç·¨é›†å¯ |

**ã‚¹ã‚³ã‚¢è¨ˆç®—**: `score = count(is_correct = true) / count(å…¨å•é¡Œ)`
- ä¸æ­£è§£ã‚‚æœªå›ç­”ã‚‚ã€Œä¸æ­£è§£ã€ã¨ã—ã¦ã‚¹ã‚³ã‚¢ã«åæ˜ ï¼ˆåˆ†æ¯ã¯å¸¸ã«å…¨å•é¡Œæ•°ï¼‰

---

## 7. é€”ä¸­ä¿å­˜ãƒ»éƒ¨åˆ†æ¡ç‚¹ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒ•ãƒ­ãƒ¼

### 7-1. å…¨ä½“ãƒ•ãƒ­ãƒ¼ï¼ˆãƒãƒ«ãƒã‚¢ãƒ†ãƒ³ãƒ—ãƒˆï¼‰

```
Day 1: å•(1)ã€œ(10) ã‚’å…¥åŠ› â†’ [é€”ä¸­ä¿å­˜]
  â†’ Session 1 (attempt=1, is_latest=true): in_progress
  â†’ student_answers: 10è¡Œ UPSERT (is_correct=NULL)

Day 2: å•(11)ã€œ(20) ã‚’è¿½åŠ å…¥åŠ› â†’ [æ¡ç‚¹ã™ã‚‹]ï¼ˆ20/40å•ã®ã¿å…¥åŠ›ï¼‰
  â†’ Session 1: gradedï¼ˆå…¥åŠ›æ¸ˆã¿20å•ã‚’æ¡ç‚¹ã€æ®‹ã‚Š20å•ã¯ is_correct=NULLï¼‰
  â†’ çµæœç”»é¢: 15/40 æ­£è§£ (37.5%)  âœ…Ã—15  âŒÃ—5  â¬œÃ—20

Day 3: [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦]
  â†’ Session 1: is_latest=false ã«æ›´æ–°
  â†’ Session 2 (attempt=2, is_latest=true): in_progressï¼ˆæ–°è¦ä½œæˆï¼‰
  â†’ Session 1 ã® âœ…Ã—15 ã‚’ Session 2 ã«ã‚³ãƒ”ãƒ¼
  â†’ ä¸æ­£è§£5å•ã‚’ä¿®æ­£ + æœªå›ç­”10å•ã‚’è¿½åŠ å…¥åŠ› â†’ [æ¡ç‚¹ã™ã‚‹]
  â†’ Session 2: graded
  â†’ çµæœç”»é¢: 28/40 æ­£è§£ (70%)  âœ…Ã—28  âŒÃ—2  â¬œÃ—10
  â†’ attempt_history: [1å›ç›® 15/40, 2å›ç›® 28/40]

Day 4: [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦]
  â†’ Session 2: is_latest=false
  â†’ Session 3 (attempt=3, is_latest=true): in_progress
  â†’ Session 2 ã® âœ…Ã—28 ã‚’ Session 3 ã«ã‚³ãƒ”ãƒ¼
  â†’ æ®‹ã‚Š12å•ã‚’å…¥åŠ› â†’ [æ¡ç‚¹ã™ã‚‹]
  â†’ Session 3: graded
  â†’ çµæœç”»é¢: 38/40 æ­£è§£ (95%)  âœ…Ã—38  âŒÃ—2  â¬œÃ—0
  â†’ attempt_history: [1å›ç›® 15/40, 2å›ç›® 28/40, 3å›ç›® 38/40]

Day 5: ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹ã‹ã€[è§£ç­”ã‚’è¦‹ã‚‹] ã§æ­£ç­”ã‚’ç¢ºèª
  â†’ [è§£ç­”ã‚’è¦‹ã‚‹]: Session 3 ã® answers_revealed=true â†’ ä»¥é™ãƒªãƒˆãƒ©ã‚¤ä¸å¯
```

### 7-2. UPSERT å‹•ä½œ

```sql
INSERT INTO student_answers (answer_session_id, question_id, raw_input, answer_value)
VALUES ($1, $2, $3, $4)
ON CONFLICT (answer_session_id, question_id) DO UPDATE SET
  raw_input = EXCLUDED.raw_input,
  answer_value = EXCLUDED.answer_value,
  answered_at = now();
-- is_correct, scored_at ã¯é€”ä¸­ä¿å­˜æ™‚ã¯ NULL ã®ã¾ã¾
```

### 7-3. å¾©å…ƒ

`getMathDraftAnswers()` ã§ `in_progress` ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜æ¸ˆã¿è§£ç­”ã‚’ä¸€æ‹¬å–å¾—ã€‚
ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚ã«å„å…¥åŠ›æ¬„ã«è‡ªå‹•ã‚»ãƒƒãƒˆã™ã‚‹ã€‚

**ãƒªãƒˆãƒ©ã‚¤æ™‚ã®å¾©å…ƒ**:
- å„ `student_answer` ã® `is_correct` ã‚’å«ã‚ã¦è¿”å´
- `is_correct = true` ã®å•é¡Œ â†’ å€¤ã‚’è¡¨ç¤ºã€å…¥åŠ›æ¬„ã‚’éæ´»æ€§ï¼ˆãƒ­ãƒƒã‚¯ï¼‰
- `is_correct = false` ã®å•é¡Œ â†’ å‰å›ã® `raw_input` ã‚’ãƒ—ãƒªãƒ•ã‚£ãƒ«ã€ç·¨é›†å¯
- `is_correct = NULL` ã®å•é¡Œ â†’ ç©ºæ¬„ã€ç·¨é›†å¯

### 7-4. ãƒªãƒˆãƒ©ã‚¤ã‚µã‚¤ã‚¯ãƒ«ï¼ˆãƒãƒ«ãƒã‚¢ãƒ†ãƒ³ãƒ—ãƒˆï¼‰

```
[çµæœç”»é¢ï¼ˆSession N: gradedï¼‰] â†’ [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦]
  â†’ startMathRetry(sessionId):
      1. Session N ã® is_latest ã‚’ false ã«æ›´æ–°
      2. Session N+1 ã‚’æ–°è¦ä½œæˆï¼ˆattempt_number=N+1, is_latest=true, in_progressï¼‰
      3. Session N ã® is_correct=true ã®è§£ç­”ã‚’ Session N+1 ã«ã‚³ãƒ”ãƒ¼
      4. newAnswerSessionId ã‚’è¿”å´
  â†’ getMathDraftAnswers(questionSetId):
      is_latest=true ã‹ã¤ in_progress ã® Session N+1 ã‚’å–å¾—
      å„å•é¡Œã® is_correct ã‚’å«ã‚€ï¼ˆã‚³ãƒ”ãƒ¼æ¸ˆã¿æ­£è§£=true, ä»–=NULLï¼‰
  â†’ ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º: âœ…ãƒ­ãƒƒã‚¯ï¼ˆã‚³ãƒ”ãƒ¼æ¸ˆã¿ï¼‰ + âŒãƒ—ãƒªãƒ•ã‚£ãƒ«ï¼ˆå‰å›å€¤å‚ç…§ï¼‰ + â¬œç©ºæ¬„
  â†’ å…¥åŠ› â†’ [é€”ä¸­ä¿å­˜] or [æ¡ç‚¹ã™ã‚‹]
  â†’ submitAndGradeMathAnswers(sessionId):
      is_correct=true ã‚’ã‚¹ã‚­ãƒƒãƒ—ã€æ–°è¦å…¥åŠ›åˆ†ã®ã¿æ¡ç‚¹
  â†’ [çµæœç”»é¢ï¼ˆSession N+1: gradedï¼‰]

â€» å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é·ç§»ã¯ in_progress â†’ graded ã®å˜æ–¹å‘ã®ã¿
â€» ãƒªãƒˆãƒ©ã‚¤ = å¸¸ã«æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆå±¥æ­´ä¿æŒï¼‰
```

---

## 8. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
app/
  actions/
    math-answer.ts                # ç®—æ•°è§£ç­” Server Actions
  student/
    math-answer/
      page.tsx                    # å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§ï¼ˆServer Componentï¼‰
      [questionSetId]/
        page.tsx                  # è§£ç­”å…¥åŠ›ï¼ˆServer Component: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒï¼‰
        math-answer-form.tsx      # è§£ç­”ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆClient Component: çŠ¶æ…‹ç®¡ç†ï¼‰
        result/
          page.tsx                # çµæœè¡¨ç¤ºï¼ˆServer Componentï¼‰

components/
  math/
    numeric-input.tsx             # æ•°å€¤å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆå˜ä½è¡¨ç¤ºä»˜ãï¼‰
    fraction-input.tsx            # åˆ†æ•°å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    multi-part-input.tsx          # è¤‡æ•°ã‚¹ãƒ­ãƒƒãƒˆå…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    selection-input.tsx           # é¸æŠå¼å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

lib/
  auth-helpers.ts                 # UUIDâ†’å†…éƒ¨IDå¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆresolveStudentId ç­‰ï¼‰
  math-grading.ts                 # æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç´”ç²‹é–¢æ•°ã€ãƒ†ã‚¹ãƒˆå¯èƒ½ï¼‰
  __tests__/
    math-grading.test.ts          # æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯å˜ä½“ãƒ†ã‚¹ãƒˆ

app/
  actions/
    __tests__/
      math-answer.test.ts         # Server Actions ãƒ†ã‚¹ãƒˆï¼ˆæ­£ç­”æ¼ãˆã„é˜²æ­¢å«ã‚€ï¼‰

supabase/
  migrations/
    YYYYMMDD_create_auto_grading_tables.sql  # ãƒ†ãƒ¼ãƒ–ãƒ« + RLSï¼ˆä»–ãƒ­ãƒ¼ãƒ«å«ã‚€ï¼‰+ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  seeds/
    math_answers_g5_s1-4.sql      # å°5 ç¬¬1ã€œ4å› æ¨¡ç¯„è§£ç­”ãƒ‡ãƒ¼ã‚¿
    math_answers_g6_s1-4.sql      # å°6 ç¬¬1ã€œ4å› æ¨¡ç¯„è§£ç­”ãƒ‡ãƒ¼ã‚¿
```

> **æ³¨**: `getMathGradingHistory()` ã¯ `app/actions/math-answer.ts` å†…ã«é…ç½®ï¼ˆä»–ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºç”¨ï¼‰ã€‚
> ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ãƒªãƒ•ãƒ¬ã‚¯ãƒˆãƒ»ä¿è­·è€…ãƒ»æŒ‡å°è€…ã‹ã‚‰åŒä¸€ Server Action ã‚’å‘¼ã³å‡ºã—ã€
> `studentId` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¯¾è±¡ç”Ÿå¾’ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚

---

## 9. å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Step 1: DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿè£…å¿…é ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**:
- [ ] `question_sets` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ00è¨ˆç”»æº–æ‹ ï¼‰
- [ ] `questions` ãƒ†ãƒ¼ãƒ–ãƒ« + ç®—æ•°æ‹¡å¼µã‚«ãƒ©ãƒ :
  - [ ] `section_name VARCHAR(50) NOT NULL`
  - [ ] `unit_label VARCHAR(50)` â€” NULLable
  - [ ] `answer_config JSONB` â€” NULLable
  - [ ] `answer_type` CHECKåˆ¶ç´„ï¼ˆ`'numeric'`, `'fraction'`, `'multi_part'`, `'selection'`ï¼‰
  - [ ] `correct_answer` NULLableåŒ– + ã‚¿ã‚¤ãƒ—åˆ¥ CHECKåˆ¶ç´„ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 2-2ï¼‰
- [ ] `answer_sessions` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ00è¨ˆç”» + ç®—æ•°æ‹¡å¼µï¼‰:
  - [ ] `attempt_number SMALLINT NOT NULL DEFAULT 1 CHECK (attempt_number > 0)`
  - [ ] `answers_revealed BOOLEAN NOT NULL DEFAULT false`
  - [ ] `is_latest BOOLEAN NOT NULL DEFAULT true`ï¼ˆ00è¨ˆç”»ã§å®šç¾©ï¼‰
  - [ ] `UNIQUE (student_id, question_set_id, attempt_number)` â€” åŒä¸€ç”Ÿå¾’Ã—ã‚»ãƒƒãƒˆÃ—å›ã§ä¸€æ„
- [ ] `student_answers` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`raw_input`/`answer_value` ã‚’ VARCHAR(500) ã«æ‹¡å¼µï¼‰
- [ ] `question_options` ã¯**ä½œæˆã—ãªã„**ï¼ˆç†ç§‘å®Ÿè£…æ™‚ã«è¿½åŠ ï¼‰

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- [ ] `idx_answer_sessions_latest` â€” éƒ¨åˆ†ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
  ```sql
  CREATE UNIQUE INDEX idx_answer_sessions_latest
    ON answer_sessions (student_id, question_set_id)
    WHERE is_latest = true;
  ```

**ãƒ˜ãƒ«ãƒ‘ãƒ¼SQLé–¢æ•°**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 2-6ï¼‰:
- [ ] `current_student_id()` â€” `auth.uid()` â†’ `students.id` (BIGINT)
- [ ] `current_parent_id()` â€” `auth.uid()` â†’ `parents.id` (BIGINT)
- [ ] `current_coach_id()` â€” `auth.uid()` â†’ `coaches.id` (BIGINT)

**RPCé–¢æ•°**:
- [ ] `lock_answer_session(p_session_id, p_student_id, p_expected_status)` â€” `SELECT ... FOR UPDATE` + æ‰€æœ‰è€…/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¤œè¨¼ï¼ˆsubmitAndGradeMathAnswers ç”¨ï¼‰
- [ ] `begin_math_retry(p_session_id, p_student_id)` â€” ã‚¢ãƒˆãƒŸãƒƒã‚¯ `UPDATE SET is_latest=false`ã€‚WHERE ã§ graded + æœªé–‹ç¤º + is_latest ã‚’æ¤œè¨¼ã€‚reveal ã¨ã®ç›¸äº’æ’ä»–ã‚’è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ã§ä¿è¨¼ã€‚EXECUTE ã¯ service_role é™å®š
- [ ] `reveal_math_answers(p_session_id, p_student_id)` â€” ã‚¢ãƒˆãƒŸãƒƒã‚¯ `UPDATE SET answers_revealed=true`ã€‚WHERE ã§ graded + is_latest ã‚’æ¤œè¨¼ã€‚retry ã¨ã®ç›¸äº’æ’ä»–ã‚’è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ã§ä¿è¨¼ã€‚EXECUTE ã¯ service_role é™å®š
- [ ] `get_math_grading_history(p_student_id)` â€” CTE é›†ç´„ã‚¯ã‚¨ãƒªã€‚`SECURITY DEFINER` + `SET search_path = public`ã€‚EXECUTE ã¯ service_role é™å®š

**RLSãƒãƒªã‚·ãƒ¼**ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 2-6ï¼‰:
- [ ] `question_sets`: ç”Ÿå¾’ approved SELECT
- [ ] `questions`: question_set çµŒç”± SELECT
- [ ] `answer_sessions`: ç”Ÿå¾’/ä¿è­·è€…/æŒ‡å°è€… SELECTï¼ˆ`current_*_id()` ä½¿ç”¨ï¼‰
- [ ] `student_answers`: ç”Ÿå¾’/ä¿è­·è€…/æŒ‡å°è€… SELECTï¼ˆ`current_*_id()` ä½¿ç”¨ï¼‰
- [ ] INSERT/UPDATE ãƒãƒªã‚·ãƒ¼ã¯**ä½œæˆã—ãªã„**ï¼ˆadmin client çµŒç”±ï¼‰

### Step 2: æ¨¡ç¯„è§£ç­”ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æ¨¡ç¯„è§£ç­”ã‚’å—é ˜
- ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ç¢ºå®šï¼ˆanswer_type ã®åˆ¤å®šï¼‰
- seed SQL ã‚’ä½œæˆã—ã¦ `question_sets` + `questions` ã«æŠ•å…¥
- æŠ•å…¥å¾Œã®æ¤œè¨¼ã‚¯ã‚¨ãƒªå®Ÿè¡Œ

### Step 3: æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£… + å˜ä½“ãƒ†ã‚¹ãƒˆ

- `lib/math-grading.ts` â€” `normalizeNumeric()`, `gradeAnswer()`, `sanitizeNumericInput()`
- å„answer_typeã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’ç¶²ç¾…
- **å¿…é ˆ: å˜ä½“ãƒ†ã‚¹ãƒˆ** (`lib/__tests__/math-grading.test.ts`):
  - `normalizeNumeric()`: æ•´æ•°ã€å°æ•°ã€è² æ•°ã€å…ˆé ­ã‚¼ãƒ­ã€æœ«å°¾ã‚¼ãƒ­ã€ç§‘å­¦è¨˜æ•°æ³•æ‹’å¦ã€ç©ºæ–‡å­—ã€éæ•°å€¤
  - `gradeAnswer('numeric')`: æ­£è§£ã€ä¸æ­£è§£ã€æœªå›ç­”ã€è¡¨è¨˜ã‚†ã‚Œï¼ˆ`"42.0"` vs `"42"`ï¼‰
  - `gradeAnswer('fraction')`: æ­£è§£ã€ä¸æ­£è§£ã€åˆ†æ¯ã‚¼ãƒ­ã€æœªå›ç­”
  - `gradeAnswer('multi_part')`: å…¨æ­£è§£ã€éƒ¨åˆ†æ­£è§£â†’ä¸æ­£è§£ã€JSONä¸æ­£ã€æœªå›ç­”
  - `gradeAnswer('selection')`: å®Œå…¨ä¸€è‡´ã€éä¸è¶³ã€é †åºé•ã„â†’æ­£è§£ã€ç©ºé¸æŠã€é‡è¤‡å€¤
  - `sanitizeNumericInput()`: å…¨è§’â†’åŠè§’å¤‰æ›ã€ä¸æ­£æ–‡å­—é™¤å»ã€è¤‡æ•°ãƒ”ãƒªã‚ªãƒ‰
  - `shuffleWithSeed()`: åŒä¸€seedã§åŒä¸€çµæœã€ç•°ãªã‚‹seedã§ç•°ãªã‚‹çµæœ
- **å¿…é ˆ: æ­£ç­”æ¼ãˆã„é˜²æ­¢ãƒ†ã‚¹ãƒˆ** (`app/actions/__tests__/math-answer.test.ts`):
  - `sanitizeAnswerConfig()`: å…¨4ã‚¿ã‚¤ãƒ—ã®æ­£ç­”é™¤å»æ¤œè¨¼ï¼ˆé–¢æ•°ã¯ `math-answer.ts` ã«å®šç¾©ã€ãƒ†ã‚¹ãƒˆã‚‚åŒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã«é…ç½®ï¼‰
  - `getMathQuestionsForAnswering()` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« `correct_answer` ãŒå«ã¾ã‚Œãªã„ã“ã¨
  - `getMathQuestionsForAnswering()` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® `answerConfig` ã« `correct_values` ãŒå«ã¾ã‚Œãªã„ã“ã¨
  - selection ã‚¿ã‚¤ãƒ—ã§ `dummy_values` ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œãªã„ã“ã¨ï¼ˆ`options` ã«çµ±åˆæ¸ˆã¿ï¼‰
  - `getMathGradeResult()` ã§ `answers_revealed=false` ã®å ´åˆã«æ­£ç­”ãŒå«ã¾ã‚Œãªã„ã“ã¨
  - `revealMathAnswers()` ã§ `answers_revealed=true` è¨­å®šå¾Œã«æ­£ç­”ãŒå«ã¾ã‚Œã‚‹ã“ã¨
- **å¿…é ˆ: ãƒªãƒˆãƒ©ã‚¤é–¢é€£ãƒ†ã‚¹ãƒˆ** (`app/actions/__tests__/math-answer.test.ts`):
  - `submitAndGradeMathAnswers()`: éƒ¨åˆ†æå‡ºæ™‚ã«æœªå…¥åŠ›å•é¡ŒãŒ `is_correct=NULL` ã«ãªã‚‹ã“ã¨
  - `submitAndGradeMathAnswers()`: ãƒªãƒˆãƒ©ã‚¤æ™‚ã« `is_correct=true` ã®å•é¡ŒãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨
  - `startMathRetry()`: `answers_revealed=true` ã®å ´åˆã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã“ã¨
  - `startMathRetry()`: æ­£å¸¸æ™‚ã«æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ`attempt_number` +1, `is_latest=true`, `in_progress`ï¼‰ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨
  - `startMathRetry()`: æ—§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® `is_latest` ãŒ `false` ã«æ›´æ–°ã•ã‚Œã‚‹ã“ã¨
  - `startMathRetry()`: æ­£è§£æ¸ˆã¿è§£ç­”ï¼ˆ`is_correct=true`ï¼‰ãŒæ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã“ã¨
  - `getMathDraftAnswers()`: ãƒªãƒˆãƒ©ã‚¤æ™‚ã«å„å•é¡Œã® `isCorrect` çŠ¶æ…‹ã‚’å«ã‚ã¦è¿”ã™ã“ã¨

> **ãƒ†ã‚¹ãƒˆé…ç½®ã®è²¬å‹™åˆ†æ‹…**:
> - `lib/__tests__/math-grading.test.ts` â€” ç´”ç²‹é–¢æ•°ã®ãƒ†ã‚¹ãƒˆï¼ˆ`normalizeNumeric`, `gradeAnswer`, `sanitizeNumericInput`, `shuffleWithSeed`ï¼‰ã€‚DBã‚¢ã‚¯ã‚»ã‚¹ãªã—
> - `app/actions/__tests__/math-answer.test.ts` â€” Server Actions ã®ãƒ†ã‚¹ãƒˆï¼ˆ`sanitizeAnswerConfig`, ãƒªãƒˆãƒ©ã‚¤, æ­£ç­”æ¼ãˆã„é˜²æ­¢ç­‰ï¼‰ã€‚Supabase ãƒ¢ãƒƒã‚¯ä½¿ç”¨

### Step 4: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

- `components/math/numeric-input.tsx`
- `components/math/fraction-input.tsx`
- `components/math/multi-part-input.tsx`
- `components/math/selection-input.tsx`
- iPadæœ€é©åŒ–ï¼ˆã‚¿ãƒƒãƒ—é ˜åŸŸ 48pxä»¥ä¸Šã€inputMode="decimal"ï¼‰

### Step 5: Server Actions + ç”»é¢å®Ÿè£…

- `app/actions/math-answer.ts` â€” å…¨Server Actions
  - `getMathQuestionSets()`, `getMathQuestionsForAnswering()`
  - `saveMathDraftAnswers()`, `submitAndGradeMathAnswers()`
  - `startMathRetry()`, `revealMathAnswers()`
  - `getMathDraftAnswers()`, `getMathGradeResult()`
  - `getMathGradingHistory()` â€” ä»–ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºç”¨ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12 å‚ç…§ï¼‰
- `app/student/math-answer/page.tsx` â€” å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§
- `app/student/math-answer/[questionSetId]/page.tsx` + `math-answer-form.tsx` â€” è§£ç­”å…¥åŠ›
- `app/student/math-answer/[questionSetId]/result/page.tsx` â€” çµæœè¡¨ç¤ºï¼ˆæ­£ç­”éè¡¨ç¤º/é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰

### Step 6: é€”ä¸­ä¿å­˜ + ãƒªãƒˆãƒ©ã‚¤ãƒ•ãƒ­ãƒ¼å®Ÿè£…

- `saveMathDraftAnswers()` â€” UPSERT
- `getMathDraftAnswers()` â€” å¾©å…ƒï¼ˆãƒªãƒˆãƒ©ã‚¤æ™‚ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹å«ã‚€ï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–æ™‚ã®è‡ªå‹•å¾©å…ƒ
- ãƒªãƒˆãƒ©ã‚¤æ™‚: æ­£è§£æ¸ˆã¿å•é¡Œã®ãƒ­ãƒƒã‚¯è¡¨ç¤ºã€ä¸æ­£è§£ã®ãƒ—ãƒªãƒ•ã‚£ãƒ«
- éƒ¨åˆ†æå‡º: æœªå…¥åŠ›å•é¡Œã‚’ is_correct=NULL ã§å‡¦ç†

### Step 7: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ä»–ãƒ­ãƒ¼ãƒ«é€£æº

- ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã€Œç®—æ•° è§£ç­”å…¥åŠ›ã€ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆå•é¡Œã‚»ãƒƒãƒˆä¸€è¦§ã¸ã®å°ç·šï¼‰
- ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã€Œç®—æ•°ãƒ—ãƒªãƒ³ãƒˆè‡ªå‹•æ¡ç‚¹ã€çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12-2ï¼‰
- ç”Ÿå¾’ãƒªãƒ•ãƒ¬ã‚¯ãƒˆã®ã€Œãƒ†ã‚¹ãƒˆçµæœã€ã‚¿ãƒ–ã«ç®—æ•°è‡ªå‹•æ¡ç‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12-3ï¼‰
- ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«å­ã©ã‚‚ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹çµæœã‚’è¡¨ç¤ºï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12-4ï¼‰
- æŒ‡å°è€…ã®ç”Ÿå¾’è©³ç´°ç”»é¢ã«ç®—æ•°è‡ªå‹•æ¡ç‚¹å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12-5ï¼‰
- `getMathGradingHistory()` Server Action ã‚’å®Ÿè£…
- ä¿è­·è€…ãƒ»æŒ‡å°è€…ç”¨ RLS ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12-6ï¼‰

### Step 8: ãƒ“ãƒ«ãƒ‰ç¢ºèª + å‹•ä½œæ¤œè¨¼

- `pnpm run build` æˆåŠŸ
- å„answer_typeã®å…¥åŠ› â†’ æ¡ç‚¹ â†’ çµæœè¡¨ç¤ºã‚’æ‰‹å‹•æ¤œè¨¼
- éƒ¨åˆ†æå‡º â†’ å†æŒ‘æˆ¦ â†’ å†æ¡ç‚¹ã®ãƒªãƒˆãƒ©ã‚¤ãƒ•ãƒ­ãƒ¼æ¤œè¨¼
- æ­£ç­”éè¡¨ç¤º â†’ ã€Œè§£ç­”ã‚’è¦‹ã‚‹ã€â†’ æ­£ç­”é–‹ç¤ºã®æ¤œè¨¼

---

## 10. æ¤œè¨¼æ–¹æ³•

### æ©Ÿèƒ½æ¤œè¨¼

| æ¤œè¨¼é …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----------|------|----------|
| å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§ | ç”Ÿå¾’ãƒ­ã‚°ã‚¤ãƒ³ â†’ ç®—æ•°è§£ç­”å…¥åŠ› | ç¬¬1ã€œ4å›â‘ â‘¡ï¼ˆ16ã‚»ãƒƒãƒˆï¼‰ãŒè¡¨ç¤º |
| ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º | è§£ç­”å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã | é¡é¡Œ1ã€é¡é¡Œ2ã€è¨ˆç®—ç·´ç¿’ ç­‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚ŠãŒè¡¨ç¤º |
| numericå…¥åŠ› | é¡é¡Œ1(1) ã« `11` ã‚’å…¥åŠ› | å…¥åŠ›æ¬„ã®å³ã«ã€Œå€‹ã€è¡¨ç¤º |
| fractionå…¥åŠ› | åˆ†å­/åˆ†æ¯ã®2æ¬„ã«å…¥åŠ› | åˆ†æ•°ç·šè¡¨ç¤ºã€Tabç§»å‹• |
| multi_partå…¥åŠ› | é¡é¡Œ3(1) ã® â‘ â‘¡ ã«æ•°å€¤å…¥åŠ› | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤ºã€ç‹¬ç«‹å…¥åŠ› |
| selectionå…¥åŠ› | é¡é¡Œ2(1) ã®é¸æŠè‚¢ã‚’ã‚¿ãƒƒãƒ— | ãƒˆã‚°ãƒ«å‹•ä½œã€ãƒã‚¤ãƒ©ã‚¤ãƒˆ |
| å¤šã‚¹ãƒ­ãƒƒãƒˆå…¥åŠ› | å°6 é›†åˆ(4) ã®7ã‚¹ãƒ­ãƒƒãƒˆã«å…¥åŠ› | å…¨ã‚¹ãƒ­ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œå…¥åŠ›å¯èƒ½ |
| é€”ä¸­ä¿å­˜ | 10å•å…¥åŠ› â†’ [é€”ä¸­ä¿å­˜] â†’ é›¢è„± â†’ å†ã‚¢ã‚¯ã‚»ã‚¹ | ä¿å­˜ã—ãŸ10å•ãŒå¾©å…ƒ |
| **éƒ¨åˆ†æå‡º** | 20/40å•ã®ã¿å…¥åŠ› â†’ [æ¡ç‚¹ã™ã‚‹] | å…¥åŠ›æ¸ˆã¿20å•ãŒæ¡ç‚¹ã€æ®‹ã‚Š20å•ã¯ â¬œæœªå›ç­” |
| **çµæœè¡¨ç¤ºï¼ˆéè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰** | éƒ¨åˆ†æå‡ºå¾Œã®çµæœç”»é¢ | âœ…/âŒ/â¬œ ã®ã¿è¡¨ç¤ºã€æ­£ç­”ã¯éè¡¨ç¤º |
| **ãƒªãƒˆãƒ©ã‚¤** | çµæœç”»é¢ â†’ [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦] â†’ ä¸æ­£è§£ã‚’ä¿®æ­£ â†’ [æ¡ç‚¹ã™ã‚‹] | æ­£è§£æ¸ˆã¿å•é¡Œã¯ãƒ­ãƒƒã‚¯ã€ã‚¹ã‚³ã‚¢æ›´æ–° |
| **ãƒªãƒˆãƒ©ã‚¤é€”ä¸­ä¿å­˜** | ãƒªãƒˆãƒ©ã‚¤ä¸­ â†’ [é€”ä¸­ä¿å­˜] â†’ é›¢è„± â†’ å†ã‚¢ã‚¯ã‚»ã‚¹ | ãƒ­ãƒƒã‚¯çŠ¶æ…‹å«ã‚å¾©å…ƒ |
| **ãƒªãƒˆãƒ©ã‚¤éƒ¨åˆ†æ¡ç‚¹** | ãƒªãƒˆãƒ©ã‚¤ä¸­ã€ä¸€éƒ¨ã®ã¿ä¿®æ­£ â†’ [æ¡ç‚¹ã™ã‚‹] | ä¿®æ­£åˆ†ã®ã¿å†æ¡ç‚¹ã€ä»–ã¯ãã®ã¾ã¾ |
| **æ­£ç­”é–‹ç¤º** | çµæœç”»é¢ â†’ [è§£ç­”ã‚’è¦‹ã‚‹] | å…¨å•ã®æ­£ç­”ãŒè¡¨ç¤ºã€ãƒªãƒˆãƒ©ã‚¤ä¸å¯ã« |
| **å…¨å•æ­£è§£** | å…¨40å•æ­£è§£ã‚’é”æˆ | è‡ªå‹•çš„ã«æ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ã«é·ç§» |
| å†ªç­‰æ€§ | æ¡ç‚¹æ¸ˆã¿ã®ã‚»ãƒƒãƒˆã‚’å¤‰æ›´ãªãå†æå‡º | åŒã˜çµæœãŒè¿”ã‚‹ |
| **ãƒªãƒˆãƒ©ã‚¤ç¦æ­¢** | æ­£ç­”é–‹ç¤ºå¾Œã« [ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦] ã‚’è©¦è¡Œ | ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒœã‚¿ãƒ³éè¡¨ç¤º |
| **ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆå±¥æ­´** | 3å›ãƒªãƒˆãƒ©ã‚¤å¾Œã«çµæœç”»é¢ã‚’ç¢ºèª | attempt_history ã«3å›åˆ†ã®ã‚¹ã‚³ã‚¢æ¨ç§»ãŒè¡¨ç¤º |
| **ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥é€£æº** | æ¡ç‚¹å¾Œã«ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèª | ã€Œç®—æ•°ãƒ—ãƒªãƒ³ãƒˆè‡ªå‹•æ¡ç‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æœ€æ–°3ä»¶è¡¨ç¤º |
| **ç”Ÿå¾’ãƒªãƒ•ãƒ¬ã‚¯ãƒˆé€£æº** | ãƒªãƒ•ãƒ¬ã‚¯ãƒˆ â†’ ãƒ†ã‚¹ãƒˆçµæœ â†’ ç®—æ•°è‡ªå‹•æ¡ç‚¹ãƒ•ã‚£ãƒ«ã‚¿ | å…¨å±¥æ­´ + ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆæ¨ç§»ãŒè¡¨ç¤º |
| **ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥é€£æº** | ä¿è­·è€…ã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | å­ã©ã‚‚ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹çµæœã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤º |
| **æŒ‡å°è€…é€£æº** | æŒ‡å°è€… â†’ ç”Ÿå¾’è©³ç´° â†’ ãƒ†ã‚¹ãƒˆçµæœã‚¿ãƒ– | æ‹…å½“ç”Ÿå¾’ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹å±¥æ­´ãŒè¡¨ç¤º |

### ãƒ“ãƒ«ãƒ‰æ¤œè¨¼

```bash
pnpm run build
```

### iPadæ¤œè¨¼

- ã‚¿ãƒƒãƒ—é ˜åŸŸãŒ48pxä»¥ä¸Š
- ãƒ†ãƒ³ã‚­ãƒ¼è¡¨ç¤ºï¼ˆinputMode="decimal"ï¼‰
- åˆ†æ•°å…¥åŠ›ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•

---

## 11. ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å¯¾ç­– |
|--------|------|
| 1ãƒ—ãƒªãƒ³ãƒˆ40å•è¶…ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒé•·ã„ | ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šã§è¦–è¦šçš„ã«åˆ†é›¢ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®è¨˜æ†¶ |
| multi_part ã® all-or-nothing ãŒå³ã—ã„ | æ­£ç­”é–‹ç¤ºãƒ¢ãƒ¼ãƒ‰ã§å„ã‚¹ãƒ­ãƒƒãƒˆã®æ­£èª¤ã‚’å€‹åˆ¥è¡¨ç¤ºã—ã€å­¦ç¿’ã«æ´»ç”¨ |
| åˆ†æ•°ã®å®Œå…¨ä¸€è‡´ãŒå³ã—ã„ | æ¨¡ç¯„è§£ç­”ã®å½¢å¼ï¼ˆæ—¢ç´„/ä»®åˆ†æ•°ï¼‰ã‚’ç”Ÿå¾’ã«å‘¨çŸ¥ã€‚åˆæœŸãƒ‡ãƒ¼ã‚¿ã« fraction å‹ãªã— |
| selection ã®ãƒ€ãƒŸãƒ¼å€¤ãŒä¸é©åˆ‡ | æ•°å­¦çš„æ€§è³ªã«åŸºã¥ã„ã¦ç”Ÿæˆã€é‹ç”¨å¾Œã«è¬›å¸«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§èª¿æ•´ |
| 9ã‚¹ãƒ­ãƒƒãƒˆã® multi_part ãŒiPadã§è¦‹ã¥ã‚‰ã„ | ç¸¦ä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ |
| iPad ã§ã®æ•°å€¤å…¥åŠ›ä½“é¨“ | inputMode="decimal" + å¤§ãã‚ãƒœã‚¿ãƒ³ã§å¯¾å¿œ |
| ãƒªãƒˆãƒ©ã‚¤ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼ˆç‰¹å®šå•é¡ŒãŒè§£ã‘ãªã„ï¼‰ | ã€Œè§£ç­”ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã§æ­£ç­”é–‹ç¤ºå¯èƒ½ã€è‡ªä¸»çš„ã«çµ‚äº†å¯ |
| æ­£ç­”é–‹ç¤ºå¾Œã®ãƒ‡ãƒ¼ã‚¿æ¼æ´© | é–‹ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°ï¼ˆanswers_revealedï¼‰ã§å†ãƒªãƒˆãƒ©ã‚¤ã‚’ç¦æ­¢ |

---

## 12. ä»–ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ãƒªãƒ•ãƒ¬ã‚¯ãƒˆé€£æºï¼‰

ç®—æ•°è‡ªå‹•æ¡ç‚¹ã®çµæœã‚’ã€ç”Ÿå¾’ãƒ»ä¿è­·è€…ãƒ»æŒ‡å°è€…ã®å„ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã€‚
æ—¢å­˜ã®**ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºåŸºç›¤**ï¼ˆ`StudentAssessmentSection`, `AssessmentHistory`ï¼‰ã¨åŒæ§˜ã®UIãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ã™ã‚‹ã€‚

### 12-1. è¡¨ç¤ºç®‡æ‰€ä¸€è¦§

| ãƒ­ãƒ¼ãƒ« | ç”»é¢ | è¡¨ç¤ºå†…å®¹ | æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‚è€ƒ |
|--------|------|----------|----------------------|
| **ç”Ÿå¾’** | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (`/student`) | æœ€æ–°3ä»¶ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹çµæœã‚«ãƒ¼ãƒ‰ | `StudentAssessmentSection` |
| **ç”Ÿå¾’** | ãƒªãƒ•ãƒ¬ã‚¯ãƒˆ (`/student/reflect`) | ç®—æ•°è‡ªå‹•æ¡ç‚¹ã®å…¨å±¥æ­´ + æ¨ç§»ã‚°ãƒ©ãƒ• | `AssessmentHistory` |
| **ä¿è­·è€…** | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (`/parent`) | å­ã©ã‚‚ã®æœ€æ–°3ä»¶ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹çµæœã‚«ãƒ¼ãƒ‰ | `StudentAssessmentSection` (with `studentId`) |
| **æŒ‡å°è€…** | ç”Ÿå¾’è©³ç´° (`/coach/student/[id]`) | æ‹…å½“ç”Ÿå¾’ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹ã®å…¨å±¥æ­´ | `AssessmentHistory` (with `studentId`) |

### 12-2. ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º

ã€Œå…ˆç”Ÿã‹ã‚‰ã®æ¡ç‚¹çµæœã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®**ä¸‹**ã«ã€ã€Œç®—æ•°ãƒ—ãƒªãƒ³ãƒˆè‡ªå‹•æ¡ç‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ ç®—æ•°ãƒ—ãƒªãƒ³ãƒˆ è‡ªå‹•æ¡ç‚¹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç¬¬2å›â‘  ã„ã‚ã„ã‚ãªå›³å½¢ã®é¢ç©     ğŸ”„      â”‚ â”‚
â”‚ â”‚ 3å›ç›®ã®æŒ‘æˆ¦  38/38å•  100%              â”‚ â”‚
â”‚ â”‚ 2025-02-10                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç¬¬1å›â‘¡ å€æ•°ã¨ç´„æ•°ã®åˆ©ç”¨                 â”‚ â”‚
â”‚ â”‚ 1å›ç›®  28/35å•  80%                     â”‚ â”‚
â”‚ â”‚ 2025-02-09                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚              [ã‚‚ã£ã¨è¦‹ã‚‹ â†’]                  â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºè¦ç´ **:
- ãƒ—ãƒªãƒ³ãƒˆåï¼ˆç¬¬Nå›â‘  ãƒ†ãƒ¼ãƒåï¼‰
- ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆå›æ•°ï¼ˆNå›ç›®ã®æŒ‘æˆ¦ / Nå›ç›®ï¼‰
- ã‚¹ã‚³ã‚¢ï¼ˆæ­£è§£æ•°/å…¨å•æ•° + ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆï¼‰
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³: ğŸ”„ ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ / âœ… å…¨å•æ­£è§£ / ğŸ“– æ­£ç­”é–‹ç¤ºæ¸ˆã¿
- æœ€çµ‚æ›´æ–°æ—¥

**ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: `getMathQuestionSets()` ã‚’æ‹¡å¼µã—ã€æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ`is_latest=true`ï¼‰ã®ã‚¹ã‚³ã‚¢ã‚’è¿”ã™ã€‚

### 12-3. ç”Ÿå¾’ãƒªãƒ•ãƒ¬ã‚¯ãƒˆè¡¨ç¤º

ãƒªãƒ•ãƒ¬ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã®ã€Œãƒ†ã‚¹ãƒˆçµæœã€ã‚¿ãƒ–ã«ã€ç®—æ•°è‡ªå‹•æ¡ç‚¹ã®çµæœã‚’çµ±åˆè¡¨ç¤ºã€‚

**çµ±åˆæ–¹å¼**: æ—¢å­˜ã® `AssessmentHistory` ãŒæ‰±ã†ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ã« `math_auto_grading` ã‚’è¿½åŠ ã€‚

| ãƒ•ã‚£ãƒ«ã‚¿ | æ—¢å­˜ | è¿½åŠ  |
|---------|------|------|
| ğŸ“š ã™ã¹ã¦ | âœ… | è‡ªå‹•æ¡ç‚¹ã‚‚å«ã‚€ |
| ğŸ“Š ç®—æ•°ãƒ—ãƒªãƒ³ãƒˆ | âœ… | å¤‰æ›´ãªã—ï¼ˆå…ˆç”Ÿã®æ¡ç‚¹ï¼‰ |
| âœï¸ æ¼¢å­—ãƒ†ã‚¹ãƒˆ | âœ… | å¤‰æ›´ãªã— |
| ğŸ“ ç®—æ•°è‡ªå‹•æ¡ç‚¹ | â€” | **æ–°è¦è¿½åŠ ** |

**è¡¨ç¤ºå†…å®¹**:
- å±¥æ­´ãƒªã‚¹ãƒˆ: ãƒ—ãƒªãƒ³ãƒˆåã€ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆå›æ•°ã€ã‚¹ã‚³ã‚¢ã€æ—¥ä»˜
- ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆæ¨ç§»: åŒä¸€ãƒ—ãƒªãƒ³ãƒˆã®å›ã‚’é‡ã­ãŸã‚¹ã‚³ã‚¢æ¨ç§»ï¼ˆä¾‹: 1å›ç›® 37% â†’ 2å›ç›® 70% â†’ 3å›ç›® 95%ï¼‰
- ã‚µãƒãƒªã‚«ãƒ¼ãƒ‰: æœ€æ–°ã‚¹ã‚³ã‚¢ã€å¹³å‡æ­£ç­”ç‡ã€å®Œäº†ã‚»ãƒƒãƒˆæ•°ã€ãƒªãƒˆãƒ©ã‚¤ä¸­ã‚»ãƒƒãƒˆæ•°

**Server Action**: `getMathGradingHistory()` ã‚’æ–°è¦è¿½åŠ ï¼ˆ`math-answer.ts` ã«é…ç½®ï¼‰ã€‚

```typescript
/**
 * ç®—æ•°è‡ªå‹•æ¡ç‚¹ã®å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆãƒªãƒ•ãƒ¬ã‚¯ãƒˆãƒ»ä»–ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºç”¨ï¼‰
 * - is_latest=true ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ï¼ˆæœ€æ–°ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆï¼‰
 * - attempt_history ã‚‚å«ã‚€ï¼ˆæ¨ç§»ã‚°ãƒ©ãƒ•ç”¨ï¼‰
 */
export async function getMathGradingHistory(input?: {
  studentId?: number  // students.id ã¯ SERIAL (integer)  // ä¿è­·è€…ãƒ»æŒ‡å°è€…ç”¨ï¼ˆçœç•¥æ™‚ã¯è‡ªåˆ†ï¼‰
}): Promise<{
  results: MathGradingHistoryItem[]
  summary: {
    latestScore: number | null
    averagePercentage: number | null
    completedSets: number
    inProgressSets: number
  }
  error?: string
}>
```

> å‹å®šç¾© `MathGradingHistoryItem` ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 5-3 ã‚’å‚ç…§ã€‚

**ã‚¯ã‚¨ãƒªæ–¹é‡: CTE + json_agg ã«ã‚ˆã‚‹1ã‚¯ã‚¨ãƒªé›†ç´„**

N+1 å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã€å…¨ã‚»ãƒƒãƒˆã®ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆå±¥æ­´ã‚’**1ã‚¯ã‚¨ãƒª**ã§å–å¾—ã™ã‚‹ã€‚
è¨±å®¹ã‚¯ã‚¨ãƒªæ•°: `getMathGradingHistory()` ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã¯ **æœ€å¤§2ã‚¯ã‚¨ãƒª**
ï¼ˆ1: `resolveStudentId()` UUIDâ†’BIGINTå¤‰æ›ã€2: ãƒ¡ã‚¤ãƒ³CTEã‚¯ã‚¨ãƒª `get_math_grading_history` RPCï¼‰ã€‚
ä¿è­·è€…ãƒ»æŒ‡å°è€…ãƒ‘ã‚¹ã§ã¯èªå¯ãƒã‚§ãƒƒã‚¯ï¼ˆprofile + resolve + relationç¢ºèªï¼‰ã§è¿½åŠ 2-3ã‚¯ã‚¨ãƒªãŒç™ºç”Ÿã™ã‚‹ãŒã€
ã“ã‚Œã‚‰ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šä¸å¯é¿ã§ã‚ã‚Šã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã®N+1å•é¡Œã¨ã¯åˆ¥æ ã¨ã™ã‚‹ã€‚

```sql
-- ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¨ãƒª: ã‚»ãƒƒãƒˆä¸€è¦§ + æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ + ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆå±¥æ­´ã‚’1ã‚¯ã‚¨ãƒªã§å–å¾—
WITH target_student AS (
  -- Server Action å´ã§ resolveStudentId() æ¸ˆã¿ã® student_id ã‚’ $1 ã«ãƒã‚¤ãƒ³ãƒ‰
  SELECT $1::BIGINT AS id
),
latest_sessions AS (
  SELECT ase.*
  FROM answer_sessions ase, target_student ts
  WHERE ase.student_id = ts.id AND ase.is_latest = true
),
attempt_history AS (
  SELECT
    ase.question_set_id,
    json_agg(
      json_build_object(
        'attempt', ase.attempt_number,
        'score', ase.total_score,
        'maxScore', ase.max_score,
        'percentage', ROUND(ase.total_score::NUMERIC / NULLIF(ase.max_score, 0) * 100, 1),
        'gradedAt', ase.completed_at
      ) ORDER BY ase.attempt_number
    ) AS history
  FROM answer_sessions ase, target_student ts
  WHERE ase.student_id = ts.id AND ase.status = 'graded'
  GROUP BY ase.question_set_id
)
SELECT
  qs.id AS question_set_id,
  qs.title,
  qs.session_number,
  (SELECT COUNT(*) FROM questions q WHERE q.question_set_id = qs.id) AS question_count,
  -- æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³
  ls.attempt_number, ls.status, ls.total_score, ls.max_score,
  ls.answers_revealed, ls.completed_at,
  -- ã‚¢ãƒ†ãƒ³ãƒ—ãƒˆå±¥æ­´ï¼ˆJSONé…åˆ—ï¼‰
  COALESCE(ah.history, '[]'::json) AS attempt_history
FROM question_sets qs
LEFT JOIN latest_sessions ls ON ls.question_set_id = qs.id
LEFT JOIN attempt_history ah ON ah.question_set_id = qs.id
WHERE qs.subject_id = 1  -- ç®—æ•°
  AND qs.status = 'approved'
  AND qs.grade = (SELECT s.grade FROM students s, target_student ts WHERE s.id = ts.id)
ORDER BY qs.session_number, qs.display_order;
```

> **summary é›†ç´„**: ä¸Šè¨˜ã‚¯ã‚¨ãƒªã®çµæœã‚’ TypeScript å´ã§ `reduce()` ã—ã¦ç®—å‡ºã€‚
> è¿½åŠ ã‚¯ã‚¨ãƒªã¯ä¸è¦ï¼ˆ1ã‚¯ã‚¨ãƒªã§å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—å¯èƒ½ï¼‰ã€‚

### 12-4. ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º

> **ã‚¹ã‚³ãƒ¼ãƒ—å¤‰æ›´ï¼ˆ2026-02-11ï¼‰**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã¯å»¶æœŸã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆServer Action ã®ä¿è­·è€…èªå¯ãƒã‚§ãƒƒã‚¯ï¼‰ã¯å®Ÿè£…æ¸ˆã¿ã€‚åˆ¥ãƒã‚±ãƒƒãƒˆã§å¯¾å¿œäºˆå®šã€‚

ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã€å­ã©ã‚‚ã®ç®—æ•°è‡ªå‹•æ¡ç‚¹çµæœã‚’è¡¨ç¤ºã€‚
ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨åŒä¸€ã®ã‚«ãƒ¼ãƒ‰å½¢å¼ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12-2ï¼‰ã‚’ä½¿ç”¨ã€‚

**ãƒ‡ãƒ¼ã‚¿å–å¾—**: `getMathGradingHistory({ studentId: childId })` ã§å­ã©ã‚‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚
ä¿è­·è€…-å­ã©ã‚‚ç´ã¥ã‘ã®èªå¯ãƒã‚§ãƒƒã‚¯ã¯ Server Action å†…ã§å®Ÿæ–½ã€‚

### 12-5. æŒ‡å°è€…ï¼ˆç”Ÿå¾’è©³ç´°ç”»é¢ï¼‰è¡¨ç¤º

> **å®Ÿè£…æ¸ˆã¿ï¼ˆ2026-02-11ï¼‰**: `AssessmentHistory` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`studentId` propsï¼‰ãŒ `/coach/student/[id]` ã§æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€ç®—æ•°è‡ªå‹•æ¡ç‚¹ãƒ‡ãƒ¼ã‚¿ã¯ `getMathGradingHistory` ä¸¦è¡Œå–å¾—ã«ã‚ˆã‚Šè‡ªå‹•çš„ã«çµ±åˆã•ã‚Œã‚‹ã€‚è¿½åŠ ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä½œæ¥­ã¯ä¸è¦ã€‚

æŒ‡å°è€…ã®ç”Ÿå¾’è©³ç´°ãƒšãƒ¼ã‚¸ (`/coach/student/[id]`) ã®ã€Œãƒ†ã‚¹ãƒˆçµæœã€ã‚¿ãƒ–ã«çµ±åˆã€‚
ç”Ÿå¾’ãƒªãƒ•ãƒ¬ã‚¯ãƒˆã¨åŒä¸€ã®å±¥æ­´è¡¨ç¤ºï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12-3ï¼‰ã‚’ `studentId` æŒ‡å®šã§è¡¨ç¤ºã€‚

**ãƒ‡ãƒ¼ã‚¿å–å¾—**: `getMathGradingHistory({ studentId })` ã§æ‹…å½“ç”Ÿå¾’ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚
æŒ‡å°è€…-ç”Ÿå¾’ç´ã¥ã‘ã®èªå¯ãƒã‚§ãƒƒã‚¯ã¯ Server Action å†…ã§å®Ÿæ–½ã€‚

### 12-6. RLSãƒãƒªã‚·ãƒ¼ï¼ˆä»–ãƒ­ãƒ¼ãƒ«ç”¨ï¼‰

ä¿è­·è€…ãƒ»æŒ‡å°è€…ã® RLS ãƒãƒªã‚·ãƒ¼ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 2-6 ã«çµ±åˆæ¸ˆã¿ã€‚

**ä½¿ç”¨ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»é–¢æ•°ï¼ˆæ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒï¼‰**:

| é …ç›® | åå‰ | å‚™è€ƒ |
|------|------|------|
| ä¿è­·è€…-ç”Ÿå¾’é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ« | `parent_child_relations` | `parent_id BIGINT`, `student_id BIGINT` |
| æŒ‡å°è€…-ç”Ÿå¾’é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ« | `coach_student_relations` | `coach_id BIGINT`, `student_id BIGINT` |
| UUIDâ†’BIGINTå¤‰æ›ï¼ˆä¿è­·è€…ï¼‰ | `current_parent_id()` | `auth.uid()` â†’ `parents.id` |
| UUIDâ†’BIGINTå¤‰æ›ï¼ˆæŒ‡å°è€…ï¼‰ | `current_coach_id()` | `auth.uid()` â†’ `coaches.id` |

> å…¨ãƒãƒªã‚·ãƒ¼ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 2-6 ã® `answer_sessions` / `student_answers` ãƒ–ãƒ­ãƒƒã‚¯ã«è¨˜è¼‰ã€‚
> Server Action å†…ã®èªå¯ãƒã‚§ãƒƒã‚¯ã¯ `resolveParentId()` / `resolveCoachId()` ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ 2-6bï¼‰ã‚’ä½¿ç”¨ã€‚

---

## 13. æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 13-1. å‰ææ¡ä»¶

- `feat/math-auto-grading` ãƒ–ãƒ©ãƒ³ãƒãŒæœ€æ–°ã§ã€å…¨ãƒ†ã‚¹ãƒˆé€šéæ¸ˆã¿ï¼ˆ104 tests passï¼‰
- `pnpm run build` æˆåŠŸ

### 13-2. ãƒãƒ¼ã‚¸

```bash
git checkout main
git merge --no-ff feat/math-auto-grading
git push origin main
```

### 13-3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨

**Migration 5 äº‹å‰ãƒã‚§ãƒƒã‚¯**ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„å¯¾è±¡ã®é‡è¤‡ç¢ºèªï¼‰:

```sql
-- question_sets ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ–°è¦ä½œæˆã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—å¯
-- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
SELECT session_id, subject_id, display_order, COUNT(*)
FROM question_sets
GROUP BY session_id, subject_id, display_order
HAVING COUNT(*) > 1;
-- çµæœãŒ0è¡Œã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ Migration 5 ã‚’é©ç”¨
```

**é©ç”¨é †åº**ï¼ˆä¾å­˜é–¢ä¿‚ã‚ã‚Šã€ä¸Šã‹ã‚‰é †ã«ï¼‰:

| # | ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|---|---------|------|
| 1 | `20260211000001_create_auto_grading_tables.sql` | 4ãƒ†ãƒ¼ãƒ–ãƒ« + RLS + ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° |
| 2 | `20260211000002_update_lock_answer_session.sql` | locké–¢æ•°ã®3å¼•æ•°ç‰ˆã«ç½®æ› |
| 3 | `20260211000003_create_get_math_grading_history_rpc.sql` | å±¥æ­´å–å¾—RPC |
| 4 | `20260211000004_create_atomic_session_rpcs.sql` | æ­£ç­”é–‹ç¤º/ãƒªãƒˆãƒ©ã‚¤ã®æ’ä»–åˆ¶å¾¡RPC |
| 5 | `20260211000005_add_question_sets_unique_constraint.sql` | ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„è¿½åŠ  |

### 13-4. Seed ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```sql
-- supabase/seeds/math_questions_2026.sql ã‚’ SQL Editor ã§å®Ÿè¡Œ
-- å†ªç­‰æ€§ã‚ã‚Šï¼ˆæ—¢å­˜ approved ã‚»ãƒƒãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
```

### 13-5. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œæ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

| # | æ¤œè¨¼é …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|---|---------|------|---------|
| 1 | ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª | `SELECT count(*) FROM question_sets;` | 16 |
| 2 | å•é¡Œãƒ‡ãƒ¼ã‚¿ç¢ºèª | `SELECT count(*) FROM questions;` | 458 |
| 3 | ç”Ÿå¾’: å•é¡Œä¸€è¦§ | ç”Ÿå¾’ãƒ­ã‚°ã‚¤ãƒ³ â†’ `/student/math-answer` | 16ã‚»ãƒƒãƒˆè¡¨ç¤º |
| 4 | ç”Ÿå¾’: è§£ç­”â†’æ¡ç‚¹ | 1ã‚»ãƒƒãƒˆé€šã—ã¦å…¥åŠ›â†’æ¡ç‚¹ | ã‚¹ã‚³ã‚¢è¡¨ç¤º |
| 5 | ç”Ÿå¾’: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | æ¡ç‚¹å¾Œâ†’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | ç®—æ•°è‡ªå‹•æ¡ç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º |
| 6 | ç”Ÿå¾’: ãƒªãƒ•ãƒ¬ã‚¯ãƒˆ | ãƒ†ã‚¹ãƒˆçµæœã‚¿ãƒ– â†’ ã€Œç®—æ•°è‡ªå‹•æ¡ç‚¹ã€ãƒ•ã‚£ãƒ«ã‚¿ | å±¥æ­´è¡¨ç¤º |
| 7 | ç”Ÿå¾’: ãƒªãƒˆãƒ©ã‚¤/æ­£ç­”é–‹ç¤º | ä¸æ­£è§£ã‚ã‚Šâ†’ãƒªãƒˆãƒ©ã‚¤ or æ­£ç­”é–‹ç¤º | æ’ä»–åˆ¶å¾¡å‹•ä½œ |
| 8 | **èªå¯: ä¿è­·è€…ã‚¢ã‚¯ã‚»ã‚¹** | ä¿è­·è€…ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒªãƒ•ãƒ¬ã‚¯ãƒˆ â†’ ãƒ†ã‚¹ãƒˆçµæœ | ç´ã¥ã‘å­ã©ã‚‚ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º |
| 9 | **èªå¯: æŒ‡å°è€…ã‚¢ã‚¯ã‚»ã‚¹** | æŒ‡å°è€…ãƒ­ã‚°ã‚¤ãƒ³ â†’ ç”Ÿå¾’è©³ç´° â†’ ãƒ†ã‚¹ãƒˆçµæœ | æ‹…å½“ç”Ÿå¾’ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º |
| 10 | **èªå¯: ä»–äººã®ãƒ‡ãƒ¼ã‚¿** | ä¿è­·è€…ãŒç´ã¥ã‘ãªã—ç”Ÿå¾’ã® `studentId` ã‚’æŒ‡å®š | ã‚¨ãƒ©ãƒ¼ or ç©ºãƒ‡ãƒ¼ã‚¿ |

### 13-6. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

1. `git revert <merge-commit>` ã§ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
2. DB: æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`question_sets`, `questions`, `answer_sessions`, `student_answers`ï¼‰ã¯æ®‹ã£ã¦ã‚‚æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿ãªã—
3. å¿…è¦ã«å¿œã˜ã¦ `DROP TABLE` ã§å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿æå¤±ã‚’ä¼´ã†ãŸã‚è¦ç¢ºèªï¼‰
