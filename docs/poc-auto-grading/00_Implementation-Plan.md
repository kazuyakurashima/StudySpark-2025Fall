# PoC è‡ªå‹•æ¡ç‚¹ãƒ»ç†ç§‘æŒ¯ã‚Šè¿”ã‚Š å®Ÿè£…è¨ˆç”»

## 0. æ¦‚è¦

### ç›®çš„
1. **ç†ç§‘**: é¸æŠå¼è§£ç­”å…¥åŠ› â†’ è‡ªå‹•æ¡ç‚¹ â†’ çµæœè¡¨ç¤º
2. **ç®—æ•°**: æ•°å€¤å…¥åŠ›ï¼ˆåˆ†æ•°å¯¾å¿œï¼‰ â†’ è‡ªå‹•æ¡ç‚¹ â†’ çµæœè¡¨ç¤º
3. **ç†ç§‘**: AIå­¦ç¿’æŒ¯ã‚Šè¿”ã‚Šå¯¾è©±ï¼ˆæ—¢å­˜ãƒªãƒ•ãƒ¬ã‚¯ãƒˆåŸºç›¤ã‚’è»¢ç”¨ï¼‰

### å‰ææ¡ä»¶
- **ç®—æ•°**: å•é¡Œã¯ç´™ï¼ˆã‚¢ãƒŠãƒ­ã‚°ï¼‰ã§é…å¸ƒã€‚ç”Ÿå¾’ã¯Webã«**è§£ç­”ã®ã¿**æ•°å€¤å…¥åŠ›ã€‚åˆ†æ•°ã¯æ—¢ç´„åˆ†æ•°/ä»®åˆ†æ•°ã®ã¾ã¾å®Œå…¨ä¸€è‡´åˆ¤å®šï¼ˆé€šåˆ†ãƒ»ç´„åˆ†ã®åŒå€¤åˆ¤å®šã¯ã—ãªã„ï¼‰
- **ç†ç§‘**: å•é¡Œï¼‹è§£ç­”ã‚»ãƒƒãƒˆã‚’è¬›å¸«ãŒWebç®¡ç†ç”»é¢ã‹ã‚‰ç™»éŒ²ã—ã€ç”Ÿå¾’ã¯Webã§é¸æŠå¼ã«è§£ç­”ï¼ˆPhase 1ã¯ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã€‚CSVä¸€æ‹¬å–è¾¼ã¯å°†æ¥æ¤œè¨ï¼‰
- å•é¡Œãƒ‡ãƒ¼ã‚¿ã¯è¬›å¸«/ç®¡ç†è€…ãŒç®¡ç†ç”»é¢ã‹ã‚‰ç™»éŒ²

### é‹ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆå®Ÿæ…‹ãƒ™ãƒ¼ã‚¹ï¼‰

| | ç®—æ•° | ç†ç§‘ |
|--|------|------|
| **æˆæ¥­é »åº¦** | é€±3å›æˆæ¥­ã€å•é¡Œãƒ—ãƒªãƒ³ãƒˆ2ã‚»ãƒƒãƒˆ/é€± | é€±2å›Webãƒ†ã‚¹ãƒˆ |
| **å•é¡Œæä¾›æ–¹æ³•** | ç´™ã§é…å¸ƒæ¸ˆã¿ã€‚è¬›å¸«ã¯ã‚·ã‚¹ãƒ†ãƒ ã«**è§£ç­”ãƒ‡ãƒ¼ã‚¿ã®ã¿**ç™»éŒ²<br>ä¾‹: `(1) 4, (2) 0.23, (3) 3/4` | è¬›å¸«ãŒ**å•é¡Œï¼‹è§£ç­”ã‚»ãƒƒãƒˆ**ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ² |
| **ç”Ÿå¾’ã®è§£ç­”ãƒšãƒ¼ã‚¹** | é€±2ã€œ3å›ã«åˆ†ã‘ã¦æ¼¸æ¬¡å…¥åŠ›ï¼ˆé€”ä¸­ä¿å­˜ã‚ã‚Šï¼‰ | 1å›ã®ãƒ†ã‚¹ãƒˆã¨ã—ã¦ä¸€æ‹¬è§£ç­” |
| **å•é¡Œä½œæˆé »åº¦** | 2ã€œ3ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†ã‚’ã¾ã¨ã‚ã¦ç™»éŒ² | ãƒ†ã‚¹ãƒˆã®ãŸã³ã«éƒ½åº¦ç™»éŒ²ï¼ˆjust-in-timeï¼‰ |
| **question_set ç²’åº¦** | 1å•é¡Œãƒ—ãƒªãƒ³ãƒˆ = 1 question_set | 1Webãƒ†ã‚¹ãƒˆ = 1 question_set |

### ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆ

| Phase | å†…å®¹ | ä¸»ãªæˆæœç‰© |
|-------|------|-----------|
| **1** | DBåŸºç›¤ + ç†ç§‘ã®é¸æŠå¼è‡ªå‹•æ¡ç‚¹ | å•é¡Œãƒ†ãƒ¼ãƒ–ãƒ«ç¾¤ã€å•é¡Œç®¡ç†UIï¼ˆç†ç§‘ãƒ•ãƒ«å…¥åŠ›ï¼‹ç®—æ•°è§£ç­”ã®ã¿å…¥åŠ›ï¼‰ã€è§£ç­”å…¥åŠ›UIã€è‡ªå‹•æ¡ç‚¹ã€çµæœè¡¨ç¤º |
| **2** | ç®—æ•°ã®æ•°å€¤å…¥åŠ›è‡ªå‹•æ¡ç‚¹ + é€”ä¸­ä¿å­˜ | æ•°å€¤/åˆ†æ•°å…¥åŠ›UIã€ç®—æ•°ç”¨æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€æ¼¸æ¬¡å…¥åŠ›ï¼ˆé€”ä¸­ä¿å­˜ï¼‰æ©Ÿèƒ½ |
| **3** | ç†ç§‘AIæŒ¯ã‚Šè¿”ã‚Šå¯¾è©± | æ—¢å­˜ãƒªãƒ•ãƒ¬ã‚¯ãƒˆåŸºç›¤ã®ç†ç§‘ç‰¹åŒ–ç‰ˆ |

> **ã‚¹ã‚³ãƒ¼ãƒ—å¤–ï¼ˆå°†æ¥Phaseï¼‰**:
> - AIé¸æŠè‚¢è‡ªå‹•ç”Ÿæˆâ†’æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€‚Phase 1-3 ã§ã¯å•é¡Œãƒ»é¸æŠè‚¢ã¯è¬›å¸«ãŒæ‰‹å‹•ç™»éŒ²ã™ã‚‹ã€‚
>   ãŸã ã— `question_options.error_type` ã‚«ãƒ©ãƒ ã¯ Phase 1 ã§å…ˆè¡ŒæŠ•å…¥ã—ã€å°†æ¥ã®AIç”Ÿæˆãƒ»å¼±ç‚¹åˆ†æã«å‚™ãˆã‚‹ã€‚
> - ç®—æ•°ã®å˜ä½ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³/ã‚µã‚¸ã‚§ã‚¹ãƒˆUIã‚‚æœ¬PoCã®ã‚¹ã‚³ãƒ¼ãƒ—å¤–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ–¹é‡: æ•°å€¤å…¥åŠ›ã®ã¿ï¼‰ã€‚
> - ç†ç§‘ã®å•é¡Œãƒ‡ãƒ¼ã‚¿CSV/TSVä¸€æ‹¬å–è¾¼ã€‚Phase 1 ã§ã¯ãƒ•ã‚©ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ã®æ‰‹å…¥åŠ›ã§é‹ç”¨ã—ã€
>   ç™»éŒ²è² è·ãŒé«˜ã„å ´åˆã¯ Phase 1 å¾ŒåŠä»¥é™ã§CSVå–è¾¼æ©Ÿèƒ½ã‚’è¿½åŠ æ¤œè¨ã™ã‚‹ã€‚
>
> **PoCæˆåŠŸåˆ¤æ–­**: Phase 1-3 ã®å®Œäº†æ¡ä»¶ã‚’æº€ãŸã™ã“ã¨ã§ PoC æˆåŠŸã¨ã™ã‚‹ã€‚
> å°†æ¥Phaseï¼ˆAIé¸æŠè‚¢ç”Ÿæˆç­‰ï¼‰ã®è¦å¦ã¯ PoC æˆæœã‚’è¸ã¾ãˆã¦åˆ¤æ–­ã™ã‚‹ã€‚

---

## 1. å…±é€šDBè¨­è¨ˆ

### 1-1. æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ============================================================
-- å•é¡Œã‚»ãƒƒãƒˆ: ã‚»ãƒƒã‚·ãƒ§ãƒ³Ã—ç§‘ç›®Ã—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å•é¡Œã‚°ãƒ«ãƒ¼ãƒ—
-- ============================================================
CREATE TABLE question_sets (
  id            BIGSERIAL PRIMARY KEY,
  session_id    BIGINT NOT NULL REFERENCES study_sessions(id),
  subject_id    BIGINT NOT NULL REFERENCES subjects(id),
  -- study_content_type_id ã¯ NULLè¨±å¯ï¼ˆã‚»ãƒƒãƒˆå…¨ä½“ãŒç‰¹å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ç´ã¥ã‹ãªã„å ´åˆï¼‰
  study_content_type_id BIGINT REFERENCES study_content_types(id),
  grade         SMALLINT NOT NULL CHECK (grade IN (5, 6)),
  title         VARCHAR(255),          -- è¡¨ç¤ºç”¨ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: "ç¬¬3å› ç†ç§‘ åŸºæœ¬æ¼”ç¿’"ï¼‰
  status        VARCHAR(20) NOT NULL DEFAULT 'draft'
                CHECK (status IN ('draft', 'approved')),
  created_by    UUID NOT NULL REFERENCES auth.users(id),
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ============================================================
-- å•é¡Œ: å€‹åˆ¥ã®è¨­å•
-- ============================================================
CREATE TABLE questions (
  id              BIGSERIAL PRIMARY KEY,
  question_set_id BIGINT NOT NULL REFERENCES question_sets(id) ON DELETE CASCADE,
  question_number VARCHAR(20) NOT NULL,  -- "å•1", "å•2(1)", "3-(2)" ãªã©
  answer_type     VARCHAR(20) NOT NULL
                  CHECK (answer_type IN ('choice', 'numeric', 'fraction')),
  correct_answer  VARCHAR(255) NOT NULL, -- æ­£ç­”å€¤ï¼ˆå¾Œè¿°ã®å½¢å¼ãƒ«ãƒ¼ãƒ«å‚ç…§ï¼‰
  points          SMALLINT NOT NULL DEFAULT 1 CHECK (points > 0),
  display_order   SMALLINT NOT NULL,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE (question_set_id, display_order)
);

-- ============================================================
-- é¸æŠè‚¢: choice å‹ã®å•é¡Œã«ã®ã¿ä½¿ç”¨
-- ============================================================
CREATE TABLE question_options (
  id              BIGSERIAL PRIMARY KEY,
  question_id     BIGINT NOT NULL REFERENCES questions(id) ON DELETE CASCADE,
  option_label    VARCHAR(10) NOT NULL,  -- "ã‚¢", "ã‚¤", "ã‚¦", "ã‚¨" or "A","B","C","D"
  option_text     VARCHAR(500) NOT NULL, -- é¸æŠè‚¢ã®æœ¬æ–‡
  is_correct      BOOLEAN NOT NULL DEFAULT false,
  error_type      VARCHAR(50),           -- èª¤ç­”ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: "æ¡ä»¶èª­ã¿è½ã¨ã—", "å˜ä½ãƒŸã‚¹", "æ¦‚å¿µèª¤ã‚Š"ï¼‰
                                         -- Phase 1 ã§ã¯ä»»æ„å…¥åŠ›ã€‚å°†æ¥ã®å¼±ç‚¹åˆ†æãƒ»AIé¸æŠè‚¢ç”Ÿæˆã§æ´»ç”¨
  display_order   SMALLINT NOT NULL,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE (question_id, option_label),
  UNIQUE (question_id, display_order)
);

-- ============================================================
-- è§£ç­”ã‚»ãƒƒã‚·ãƒ§ãƒ³: ç”Ÿå¾’ã®1å›ã®è§£ç­”æå‡ºã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
-- ============================================================
CREATE TABLE answer_sessions (
  id              BIGSERIAL PRIMARY KEY,
  student_id      BIGINT NOT NULL REFERENCES students(id),
  question_set_id BIGINT NOT NULL REFERENCES question_sets(id),
  attempt_number  SMALLINT NOT NULL DEFAULT 1 CHECK (attempt_number > 0),
  is_latest       BOOLEAN NOT NULL DEFAULT true,
  status          VARCHAR(20) NOT NULL DEFAULT 'in_progress'
                  CHECK (status IN ('in_progress', 'completed', 'graded')),
  total_score     SMALLINT,             -- è‡ªå‹•æ¡ç‚¹å¾Œã«ã‚»ãƒƒãƒˆ
  max_score       SMALLINT,             -- è‡ªå‹•æ¡ç‚¹å¾Œã«ã‚»ãƒƒãƒˆ
  started_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  completed_at    TIMESTAMPTZ,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- åŒä¸€ç”Ÿå¾’Ã—å•é¡Œã‚»ãƒƒãƒˆÃ—è©¦è¡Œç•ªå·ã§ä¸€æ„
  UNIQUE (student_id, question_set_id, attempt_number),

  -- æ•´åˆæ€§ä¿è¨¼: graded æ™‚ã¯ completed_at/total_score/max_score ãŒå¿…é ˆ
  CHECK (status != 'graded' OR (completed_at IS NOT NULL AND total_score IS NOT NULL AND max_score IS NOT NULL))
);

-- is_latest ã®æ•´åˆæ€§: åŒä¸€ (student_id, question_set_id) ã§ is_latest=true ã¯æœ€å¤§1è¡Œ
CREATE UNIQUE INDEX idx_answer_sessions_latest
  ON answer_sessions (student_id, question_set_id)
  WHERE is_latest = true;

-- ============================================================
-- ç”Ÿå¾’è§£ç­”: å•é¡Œã”ã¨ã®è§£ç­”ãƒ¬ã‚³ãƒ¼ãƒ‰
-- ============================================================
CREATE TABLE student_answers (
  id                BIGSERIAL PRIMARY KEY,
  answer_session_id BIGINT NOT NULL REFERENCES answer_sessions(id) ON DELETE CASCADE,
  question_id       BIGINT NOT NULL REFERENCES questions(id),
  raw_input         VARCHAR(255),        -- ç”Ÿå¾’ã®å…¥åŠ›å€¤ãã®ã¾ã¾ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ»ç›£æŸ»ç”¨ï¼‰
  answer_value      VARCHAR(255),        -- æ¡ç‚¹ã«ä½¿ç”¨ã—ãŸæ­£è¦åŒ–æ¸ˆã¿å€¤ï¼ˆNULL = æœªå›ç­”ï¼‰
  is_correct        BOOLEAN,             -- è‡ªå‹•æ¡ç‚¹çµæœï¼ˆNULL = æœªæ¡ç‚¹ï¼‰
  scored_at         TIMESTAMPTZ,         -- æ¡ç‚¹å®Ÿè¡Œæ™‚åˆ»
  answered_at       TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE (answer_session_id, question_id)
);
```

### 1-2. correct_answer ã®å½¢å¼ãƒ«ãƒ¼ãƒ«ã¨æ­£è¦åŒ–

| answer_type | correct_answer ã®å½¢å¼ | ä¾‹ | åˆ¤å®šãƒ«ãƒ¼ãƒ« |
|-------------|----------------------|-----|-----------|
| `choice` | option_label ã®å€¤ | `"ã‚¢"` | trimå¾Œã«å®Œå…¨ä¸€è‡´ |
| `numeric` | æ­£è¦åŒ–æ¸ˆã¿æ•°å€¤æ–‡å­—åˆ— | `"42"`, `"-3.5"` | æ­£è¦åŒ–å¾Œã«å®Œå…¨ä¸€è‡´ï¼ˆä¸‹è¨˜å‚ç…§ï¼‰ |
| `fraction` | `"åˆ†å­/åˆ†æ¯"` å½¢å¼ | `"3/4"`, `"7/3"` | trimå¾Œã«å®Œå…¨ä¸€è‡´ï¼ˆé€šåˆ†ãƒ»ç´„åˆ†ã—ãªã„ï¼‰ |

**numeric ã®æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«**ï¼ˆ`raw_input` â†’ `answer_value` å¤‰æ›æ™‚ã«é©ç”¨ï¼‰:

```typescript
// è¨±å¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: æ•´æ•°ãƒ»å°æ•°ãƒ»è² æ•°ã®ã¿ï¼ˆç§‘å­¦è¨˜æ•°æ³• 1e2 ç­‰ã¯æ‹’å¦ï¼‰
const NUMERIC_FORMAT = /^-?(\d+\.?\d*|\d*\.?\d+)$/

function normalizeNumeric(raw: string): string | null {
  const trimmed = raw.trim()
  if (!NUMERIC_FORMAT.test(trimmed)) return null  // "1e2", "abc" ç­‰ã‚’æ‹’å¦
  const num = Number(trimmed)
  if (!Number.isFinite(num)) return null  // å®‰å…¨å¼ï¼ˆé€šå¸¸ã¯ä¸Šã®æ­£è¦è¡¨ç¾ã§å¼¾ã‹ã‚Œã‚‹ï¼‰
  // æ•´æ•°ã¯æ•´æ•°è¡¨è¨˜ã«çµ±ä¸€: "42.0" â†’ "42", "042" â†’ "42"
  // å°æ•°ã¯ãã®ã¾ã¾: "-3.5" â†’ "-3.5"
  return String(num)
}
// "42" â†’ "42", "42.0" â†’ "42", "042" â†’ "42", "-3.5" â†’ "-3.5"
// "1e2" â†’ nullï¼ˆæ‹’å¦ï¼‰, "abc" â†’ nullï¼ˆæ‹’å¦ï¼‰
// æ­£ç­”ç™»éŒ²æ™‚ã«ã‚‚åŒã˜æ­£è¦åŒ–ã‚’é©ç”¨ã—ã€correct_answer ã«æ­£è¦åŒ–æ¸ˆã¿å€¤ã‚’ä¿å­˜
```

> **è¨­è¨ˆåˆ¤æ–­**: å°å­¦ç®—æ•°ã®å•é¡Œç¯„å›²ï¼ˆæ•´æ•°ã€1ã€œ2æ¡ã®å°æ•°ã€å˜ç´”åˆ†æ•°ï¼‰ã§ã¯æµ®å‹•å°æ•°ç‚¹ç²¾åº¦ã®å•é¡Œã¯ç™ºç”Ÿã—ãªã„ã€‚
> `parseFloat(a) === parseFloat(b)` ã®ä»£ã‚ã‚Šã« `normalizeNumeric(a) === normalizeNumeric(b)` ã¨ã™ã‚‹ã“ã¨ã§ã€
> è¡¨è¨˜ã‚†ã‚Œï¼ˆå…ˆé ­ã‚¼ãƒ­ã€æœ«å°¾ã‚¼ãƒ­ï¼‰ã‚’å¸åã—ã¤ã¤æ–‡å­—åˆ—æ¯”è¼ƒã§å®‰å…¨ã«åˆ¤å®šã™ã‚‹ã€‚
> `raw_input` ã«å…ƒå…¥åŠ›ã‚’ä¿æŒã™ã‚‹ãŸã‚ã€åˆ¤å®šãƒ«ãƒ¼ãƒ«å¤‰æ›´æ™‚ã®å†æ¡ç‚¹ã‚‚å¯èƒ½ã€‚
> æ­£è¦è¡¨ç¾ã§è¨±å¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’åˆ¶é™ã—ã€`1e2` ç­‰ã®æ•™è‚²ä¸Šæƒ³å®šå¤–ã®å…¥åŠ›ã¯æ‹’å¦ã™ã‚‹ã€‚

### 1-3. RLSãƒãƒªã‚·ãƒ¼å®šç¾©

å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§ `ALTER TABLE ... ENABLE ROW LEVEL SECURITY` ã‚’é©ç”¨ã€‚

```sql
-- ============================================================
-- question_sets: ç”Ÿå¾’ã¯ approved ã‹ã¤è‡ªå­¦å¹´ã®ã¿é–²è¦§
-- ============================================================
CREATE POLICY "students_select_approved_question_sets" ON question_sets
  FOR SELECT TO authenticated
  USING (
    status = 'approved'
    AND grade = (
      SELECT s.grade FROM students s
      JOIN profiles p ON p.id = s.user_id
      WHERE p.id = auth.uid() AND p.role = 'student'
    )
  );

CREATE POLICY "coaches_manage_question_sets" ON question_sets
  FOR ALL TO authenticated
  USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('coach', 'admin'))
  );

-- ä¿è­·è€…ã¯å­ã©ã‚‚ãŒå®Ÿéš›ã«å—é¨“ã—ãŸå•é¡Œã‚»ãƒƒãƒˆã®ã¿é–²è¦§å¯èƒ½
-- ï¼ˆçµæœè¡¨ç¤ºã§å•é¡Œã‚¿ã‚¤ãƒˆãƒ«ãƒ»è¨­å•è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
-- æœªå—é¨“ã®ã‚»ãƒƒãƒˆã¯éè¡¨ç¤ºã¨ã—ã€å°†æ¥ã®ãƒ†ã‚¹ãƒˆå†…å®¹ãŒäº‹å‰ã«è¦‹ãˆã‚‹ã“ã¨ã‚’é˜²ã
CREATE POLICY "parents_select_child_attempted_question_sets" ON question_sets
  FOR SELECT TO authenticated
  USING (
    status = 'approved'
    AND EXISTS (
      SELECT 1 FROM answer_sessions ans
      JOIN parent_child_relations pcr ON pcr.student_id = ans.student_id
      JOIN parents p ON p.id = pcr.parent_id
      WHERE p.user_id = auth.uid()
        AND ans.question_set_id = question_sets.id
        AND ans.is_latest = true  -- éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ idx_answer_sessions_latest ã‚’æ´»ç”¨
    )
  );

-- ============================================================
-- questions / question_options: question_sets ã®RLSã«å§”è­²
-- ============================================================
CREATE POLICY "select_questions_via_set" ON questions
  FOR SELECT TO authenticated
  USING (
    EXISTS (SELECT 1 FROM question_sets qs WHERE qs.id = question_set_id)
  );

CREATE POLICY "coaches_manage_questions" ON questions
  FOR ALL TO authenticated
  USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('coach', 'admin'))
  );

-- question_options ã‚‚åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆquestion_id â†’ questions â†’ question_setsï¼‰

-- ============================================================
-- answer_sessions: ç”Ÿå¾’ã¯è‡ªåˆ†ã®ã¿ã€è¬›å¸«ã¯æ‹…å½“ç”Ÿå¾’ã®ã¿
-- ============================================================
CREATE POLICY "students_own_answer_sessions" ON answer_sessions
  FOR ALL TO authenticated
  USING (
    student_id = (
      SELECT s.id FROM students s WHERE s.user_id = auth.uid()
    )
  );

CREATE POLICY "coaches_view_assigned_answer_sessions" ON answer_sessions
  FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM coach_student_relations csr
      JOIN coaches c ON c.id = csr.coach_id
      WHERE c.user_id = auth.uid() AND csr.student_id = answer_sessions.student_id
    )
  );

CREATE POLICY "parents_view_child_answer_sessions" ON answer_sessions
  FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM parent_child_relations pcr
      JOIN parents p ON p.id = pcr.parent_id
      WHERE p.user_id = auth.uid() AND pcr.student_id = answer_sessions.student_id
    )
  );

CREATE POLICY "admins_all_answer_sessions" ON answer_sessions
  FOR ALL TO authenticated
  USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
  );

-- ============================================================
-- student_answers: SELECT ã¯ answer_sessions ã®RLSã«å§”è­²ã€
--                  æ›¸ãè¾¼ã¿ã¯ studentæœ¬äºº + admin ã«é™å®š
-- ============================================================
CREATE POLICY "select_student_answers_via_session" ON student_answers
  FOR SELECT TO authenticated
  USING (
    EXISTS (SELECT 1 FROM answer_sessions a WHERE a.id = answer_session_id)
  );

CREATE POLICY "students_write_own_answers" ON student_answers
  FOR INSERT TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM answer_sessions a
      JOIN students s ON s.id = a.student_id
      WHERE a.id = answer_session_id AND s.user_id = auth.uid()
        AND a.status = 'in_progress'  -- æ¡ç‚¹å¾Œ(graded)ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ã®è¿½åŠ å…¥åŠ›ã‚’é˜²æ­¢
    )
  );

CREATE POLICY "students_update_own_answers" ON student_answers
  FOR UPDATE TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM answer_sessions a
      JOIN students s ON s.id = a.student_id
      WHERE a.id = answer_session_id AND s.user_id = auth.uid()
        AND a.status = 'in_progress'  -- æ¡ç‚¹å¾Œ(graded)ã®æ”¹ç«„ã‚’é˜²æ­¢
    )
  );

CREATE POLICY "admins_write_student_answers" ON student_answers
  FOR ALL TO authenticated
  USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
  );
```

> **è¨­è¨ˆåˆ¤æ–­**: `questions`/`question_options` ã¯ `question_sets` ã®RLSã§é–“æ¥çš„ã«åˆ¶å¾¡ã€‚
> `student_answers` ã® **SELECT** ã¯ `answer_sessions` ã®RLSã§é–“æ¥çš„ã«åˆ¶å¾¡ï¼ˆä¿è­·è€…ãƒ»è¬›å¸«ã‚‚é–²è¦§å¯èƒ½ï¼‰ã€‚
> `student_answers` ã® **æ›¸ãè¾¼ã¿**ï¼ˆINSERT/UPDATEï¼‰ã¯ student æœ¬äºº + admin ã«é™å®šã—ã€
> ä¿è­·è€…ãƒ»è¬›å¸«ãŒé–²è¦§æ¨©é™ã‚’æŒã£ã¦ã„ã¦ã‚‚è§£ç­”ãƒ‡ãƒ¼ã‚¿ã‚’æ”¹å¤‰ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
> ã•ã‚‰ã« **INSERT/UPDATE** ã¯ `answer_sessions.status = 'in_progress'` ã®å ´åˆã®ã¿è¨±å¯ã—ã€
> æ¡ç‚¹å®Œäº†ï¼ˆ`graded`ï¼‰å¾Œã®è§£ç­”è¿½åŠ ãƒ»æ”¹ç«„ã‚’RLSãƒ¬ãƒ™ãƒ«ã§é˜²æ­¢ã™ã‚‹ã€‚
> ä¿è­·è€…ã® `question_sets` é–²è¦§ã¯å­ã©ã‚‚ãŒå®Ÿéš›ã«å—é¨“ã—ãŸã‚»ãƒƒãƒˆï¼ˆ`answer_sessions` çµŒç”±ï¼‰ã«é™å®šã—ã€
> æœªå—é¨“ã®ãƒ†ã‚¹ãƒˆå†…å®¹ãŒäº‹å‰ã«è¦‹ãˆã‚‹ã“ã¨ã‚’é˜²ãã€‚

### 1-4. æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢ä¿‚

```
study_sessions â”€â”€â”€â”€â”€â”
subjects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
study_content_types â”¤
                    â”œâ”€â†’ question_sets â”€â”€â†’ questions â”€â”€â†’ question_options
                    â”‚                         â”‚
students â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
                    â””â”€â†’ answer_sessions â”€â”€â†’ student_answers
```

### 1-5. answer_sessions ã®çŠ¶æ…‹é·ç§»

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  saveDraftAnswers  â”‚ in_progress  â”‚  â† é€”ä¸­ä¿å­˜ä¸­ï¼ˆç®—æ•°ã®æ¼¸æ¬¡å…¥åŠ›ã§ä½¿ç”¨ï¼‰
  (UPSERT)          â”‚              â”‚     student_answers: is_correct=NULL, scored_at=NULL
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ submitAndGradeAnswers
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   graded     â”‚  â† æ¡ç‚¹å®Œäº†
                    â”‚              â”‚     student_answers: is_correct/scored_at ã‚»ãƒƒãƒˆæ¸ˆã¿
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **ç†ç§‘**: `in_progress` â†’ `graded` ã‚’1å›ã®æå‡ºã§é·ç§»ï¼ˆä¸€æ‹¬è§£ç­”ï¼‰
- **ç®—æ•°**: `in_progress` ã§è¤‡æ•°å› `saveDraftAnswers` â†’ æœ€çµ‚çš„ã« `submitAndGradeAnswers` ã§ `graded` ã«é·ç§»
- `completed` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯äºˆç´„ï¼ˆå°†æ¥ã®æ‰‹å‹•æ¡ç‚¹ãƒ•ãƒ­ãƒ¼ç­‰ï¼‰ã€‚ç¾æ™‚ç‚¹ã§ã¯ `in_progress` â†’ `graded` ã®2çŠ¶æ…‹ã®ã¿ä½¿ç”¨

**student_answers ã® UPSERT å‹•ä½œ**ï¼ˆé€”ä¸­ä¿å­˜æ™‚ï¼‰:
```sql
INSERT INTO student_answers (answer_session_id, question_id, raw_input, answer_value)
VALUES ($1, $2, $3, $4)
ON CONFLICT (answer_session_id, question_id) DO UPDATE SET
  raw_input = EXCLUDED.raw_input,
  answer_value = EXCLUDED.answer_value,
  answered_at = now();
-- is_correct, scored_at ã¯é€”ä¸­ä¿å­˜æ™‚ã¯ NULL ã®ã¾ã¾
```

**`study_logs`ï¼ˆæ—¢å­˜ï¼‰ã¨ `answer_sessions`ï¼ˆæ–°è¦ï¼‰ã®è²¬å‹™åˆ†é›¢:**

| è²¬å‹™ | study_logs | answer_sessions + student_answers |
|------|-----------|----------------------------------|
| ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ | ã‚¹ãƒ‘ãƒ¼ã‚¯ç”»é¢ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰ | è§£ç­”å…¥åŠ›ç”»é¢ï¼ˆè‡ªå‹•æ¡ç‚¹ï¼‰ |
| è¡¨ç¤ºå…ˆ | æ—¢å­˜ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»é€²æ—ãƒãƒ¼ï¼‰ | **å°‚ç”¨ã‚«ãƒ¼ãƒ‰**ï¼ˆè‡ªå‹•æ¡ç‚¹çµæœï¼‰ |
| é›†è¨ˆæŒ‡æ¨™ | æ­£ç­”ç‡ï¼ˆcorrect_count / total_problemsï¼‰ | å¾—ç‚¹ç‡ï¼ˆtotal_score / max_scoreï¼‰ |
| ã‚°ãƒ©ãƒ• | æ—¢å­˜ã®é€±æ¬¡æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ | å°‚ç”¨ã®å¾—ç‚¹æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆï¼ˆPhase 2ä»¥é™ï¼‰ |

- PoCæœŸé–“ä¸­ã¯**å®Œå…¨åˆ†é›¢**ã€‚`study_logs` ã¸ã®æ›¸ãæˆ»ã—ãƒ»æ··åœ¨ã¯è¡Œã‚ãªã„
- ä¿è­·è€…/è¬›å¸«ç”»é¢ã§ã¯`study_logs`ã®æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã¨ã¯**åˆ¥ã®å°‚ç”¨ã‚«ãƒ¼ãƒ‰**ã¨ã—ã¦è‡ªå‹•æ¡ç‚¹çµæœã‚’è¡¨ç¤º
- çµ±åˆï¼ˆä¾‹: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è‡ªå‹•æ¡ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚‚åæ˜ ï¼‰ã¯PoCæ¤œè¨¼å¾Œã«åˆ¤æ–­

---

## 2. Phase 1: ç†ç§‘ã®é¸æŠå¼è‡ªå‹•æ¡ç‚¹

### 2-0. ã‚¹ã‚³ãƒ¼ãƒ—

- å¯¾è±¡: ç†ç§‘ã®ã¿ï¼ˆsubject_id = 3ï¼‰
- è§£ç­”å½¢å¼: é¸æŠå¼ï¼ˆchoiceï¼‰ã®ã¿
- å¯¾è±¡å›æ•°: ã¾ãš 2ã€œ3 ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†ã§æ¤œè¨¼
- å¿…è¦ãªç”»é¢: å•é¡Œç®¡ç†ï¼ˆcoach/adminï¼‰ã€è§£ç­”å…¥åŠ›ï¼ˆstudentï¼‰ã€çµæœè¡¨ç¤ºï¼ˆstudent/parentï¼‰

### 2-1. å•é¡Œç®¡ç†ç”»é¢ï¼ˆCoach/Adminï¼‰

**ãƒ«ãƒ¼ãƒˆ**: `/coach/questions/` (ä¸€è¦§) / `/coach/questions/new` (æ–°è¦ä½œæˆ) / `/coach/questions/[id]` (ç·¨é›†)

**ä¸€è¦§ç”»é¢**:
- ãƒ•ã‚£ãƒ«ã‚¿: å­¦å¹´ã€ç§‘ç›®ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆdraft/approvedï¼‰
- è¡¨ç¤º: ã‚¿ã‚¤ãƒˆãƒ«ã€å•é¡Œæ•°ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ä½œæˆæ—¥
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: æ–°è¦ä½œæˆã€ç·¨é›†ã€æ‰¿èª
- **ä½œæˆé »åº¦ã«æœ€é©åŒ–**: 2ã€œ3ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†ã‚’ã¾ã¨ã‚ã¦ç™»éŒ²ã§ãã‚‹ãƒ•ãƒ­ãƒ¼

#### ç†ç§‘: ãƒ•ãƒ«å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼ˆå•é¡Œï¼‹é¸æŠè‚¢ï¼‹æ­£ç­”ï¼‰

è¬›å¸«ãŒå•é¡Œæ–‡ãƒ»é¸æŠè‚¢ãƒ»æ­£ç­”ã‚’ä¸€å¼ç™»éŒ²ã™ã‚‹ã€‚é€±2å›ã®Webãƒ†ã‚¹ãƒˆã«åˆã‚ã›ã¦éƒ½åº¦ä½œæˆã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•é¡Œã‚»ãƒƒãƒˆä½œæˆ [ç†ç§‘]                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­¦å¹´: [5å¹´ â–¼]  ç§‘ç›®: [ç†ç§‘ â–¼]           â”‚
â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³: [ç¬¬3å› â–¼]                    â”‚
â”‚ ã‚¿ã‚¤ãƒˆãƒ«: [ç¬¬3å› ç†ç§‘ åŸºæœ¬æ¼”ç¿’________]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•1  è§£ç­”å½¢å¼: [é¸æŠå¼ â–¼]  é…ç‚¹: [1]     â”‚
â”‚   ã‚¢: [åœ°çƒã®è‡ªè»¢___________] â—‹æ­£è§£      â”‚
â”‚   ã‚¤: [åœ°çƒã®å…¬è»¢___________]            â”‚
â”‚   ã‚¦: [æœˆã®è‡ªè»¢_____________]            â”‚
â”‚   ã‚¨: [æœˆã®å…¬è»¢_____________]            â”‚
â”‚                          [ï¼‹é¸æŠè‚¢è¿½åŠ ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•2  è§£ç­”å½¢å¼: [é¸æŠå¼ â–¼]  é…ç‚¹: [1]     â”‚
â”‚   ã‚¢: [...] ã‚¤: [...] ã‚¦: [...] ã‚¨: [...] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ï¼‹å•é¡Œã‚’è¿½åŠ ]                           â”‚
â”‚                                         â”‚
â”‚ [ä¸‹æ›¸ãä¿å­˜]  [æ‰¿èªã—ã¦å…¬é–‹]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç®—æ•°: è§£ç­”ã®ã¿ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰

ç®—æ•°ã®å•é¡Œã¯ç´™ãƒ—ãƒªãƒ³ãƒˆã§æ—¢ã«é…å¸ƒæ¸ˆã¿ã®ãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ ã«ã¯**æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã®ã¿**ã‚’ç™»éŒ²ã™ã‚‹ã€‚
è¬›å¸«ã¯ `(1) 4, (2) 0.23, (3) 3/4` ã®ã‚ˆã†ãªãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã€ã‚·ã‚¹ãƒ†ãƒ ãŒãƒ‘ãƒ¼ã‚¹ã—ã¦å•é¡Œã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•é¡Œã‚»ãƒƒãƒˆä½œæˆ [ç®—æ•° - è§£ç­”ã®ã¿]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­¦å¹´: [6å¹´ â–¼]  ç§‘ç›®: [ç®—æ•° â–¼]           â”‚
â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³: [ç¬¬3å› â–¼]                    â”‚
â”‚ ã‚¿ã‚¤ãƒˆãƒ«: [ç¬¬3å› ç®—æ•° åŸºæœ¬æ¼”ç¿’________]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ï¼ˆ1è¡Œ1å• or ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ (1) 4                               â”‚ â”‚
â”‚ â”‚ (2) 0.23                            â”‚ â”‚
â”‚ â”‚ (3) 3/4                             â”‚ â”‚
â”‚ â”‚ (4) -12                             â”‚ â”‚
â”‚ â”‚ (5) 100                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ [ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ‘ãƒ¼ã‚¹çµæœ:                             â”‚
â”‚ å•(1)  ç­”: 4      å‹: numeric   âœ…      â”‚
â”‚ å•(2)  ç­”: 0.23   å‹: numeric   âœ…      â”‚
â”‚ å•(3)  ç­”: 3/4    å‹: fraction  âœ…      â”‚
â”‚ å•(4)  ç­”: -12    å‹: numeric   âœ…      â”‚
â”‚ å•(5)  ç­”: 100    å‹: numeric   âœ…      â”‚
â”‚                                         â”‚
â”‚ [ä¸‹æ›¸ãä¿å­˜]  [æ‰¿èªã—ã¦å…¬é–‹]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãƒ‘ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ«**ï¼ˆ`parseMathAnswerText()` â€” ç´”ç²‹é–¢æ•°ã€DBã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰:
```typescript
// "(1) 4" â†’ { questionNumber: "(1)", correctAnswer: "4", answerType: "numeric" }
// "(3) 3/4" â†’ { questionNumber: "(3)", correctAnswer: "3/4", answerType: "fraction" }
function parseMathAnswerText(text: string): { questions: ParsedQuestion[]; errors: string[] } {
  // æ­£è¦è¡¨ç¾ã§ (ç•ªå·) å€¤ ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
  // "/" ã‚’å«ã‚€ â†’ fractionã€ãã‚Œä»¥å¤–ã§æ•°å€¤å¤‰æ›å¯èƒ½ â†’ numeric
  // fraction ã®å ´åˆ: åˆ†æ¯ãŒ 0 ãªã‚‰ errors ã«è¨˜éŒ²ã—ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ"3/0" ã¯ä¸æ­£ï¼‰
  // numeric ã®å ´åˆ: NUMERIC_FORMAT æ­£è¦è¡¨ç¾ã§æ¤œè¨¼ï¼ˆ"1e2" ç­‰ã¯æ‹’å¦ï¼‰
  // é…ç‚¹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1ï¼ˆå¾Œã‹ã‚‰å€‹åˆ¥ç·¨é›†å¯èƒ½ï¼‰
  // ã‚¨ãƒ©ãƒ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ã— errors ã«è¨˜éŒ²
}
// UIå´ã§ [ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼] â†’ parseMathAnswerText() â†’ çµæœè¡¨ç¤º
//         [ä¸‹æ›¸ãä¿å­˜/æ‰¿èªã—ã¦å…¬é–‹] â†’ createMathQuestionsFromParsed() â†’ DBæ›¸ãè¾¼ã¿
```

> **è¨­è¨ˆåˆ¤æ–­**: ç®—æ•°ã¯å•é¡Œæ–‡ãŒã‚·ã‚¹ãƒ†ãƒ ã«ä¸è¦ï¼ˆç´™ã«å°åˆ·æ¸ˆã¿ï¼‰ãªã®ã§ã€
> è¬›å¸«ã®ç™»éŒ²è² è·ã‚’æœ€å°åŒ–ã™ã‚‹ãŸã‚ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’æ¡ç”¨ã€‚
> 1ã‚»ãƒƒãƒˆ5ã€œ20å•ç¨‹åº¦ã®æ­£ç­”ãƒ‡ãƒ¼ã‚¿ã‚’1åˆ†ä»¥å†…ã«ç™»éŒ²å¯èƒ½ã«ã™ã‚‹ã€‚
> ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã¨ç¢ºå®šç™»éŒ²ã‚’åˆ†é›¢ã—ã€ç¢ºå®šå‰ã«DBæ›¸ãè¾¼ã¿ã—ãªã„ã“ã¨ã§èª¤ç™»éŒ²ã‚’é˜²æ­¢ã™ã‚‹ã€‚

**Server Actions** (`app/actions/question-management.ts`):
```typescript
// å•é¡Œã‚»ãƒƒãƒˆ CRUD
export async function createQuestionSet(input: CreateQuestionSetInput)
export async function updateQuestionSet(id: number, input: UpdateQuestionSetInput)
export async function getQuestionSets(filters: QuestionSetFilters)
export async function getQuestionSetDetail(id: number)
export async function approveQuestionSet(id: number)

// å•é¡Œ CRUDï¼ˆå•é¡Œã‚»ãƒƒãƒˆå†…ï¼‰
export async function addQuestion(questionSetId: number, input: CreateQuestionInput)
export async function updateQuestion(id: number, input: UpdateQuestionInput)
export async function deleteQuestion(id: number)

// é¸æŠè‚¢ CRUDï¼ˆå•é¡Œå†…ï¼‰
export async function setQuestionOptions(questionId: number, options: OptionInput[])

// ç®—æ•°ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ› - Step 1: ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆDBæ›¸ãè¾¼ã¿ãªã—ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
export function parseMathAnswerText(
  answerText: string   // "(1) 4\n(2) 0.23\n(3) 3/4"
): { questions: ParsedQuestion[]; errors: string[] }

// ç®—æ•°ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ› - Step 2: ãƒ‘ãƒ¼ã‚¹çµæœã‚’ç¢ºå®šã—ã¦DBç™»éŒ²
export async function createMathQuestionsFromParsed(
  questionSetId: number,
  parsedQuestions: ParsedQuestion[]
): Promise<{ createdCount: number }>
```

### 2-2. ç”Ÿå¾’ã®è§£ç­”å…¥åŠ›ç”»é¢

**ãƒ«ãƒ¼ãƒˆ**: `/student/answer/[questionSetId]`

**å…¥å£**: ã‚¹ãƒ‘ãƒ¼ã‚¯ç”»é¢ï¼ˆæ—¢å­˜ï¼‰ã¾ãŸã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã€Œè§£ç­”å…¥åŠ›ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 

**ç”»é¢æ§‹æˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å› ç†ç§‘ åŸºæœ¬æ¼”ç¿’          3/10å•å®Œäº†   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ å•1                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ã‚¢  åœ°çƒã®è‡ªè»¢                â—‹    â”‚ â”‚
â”‚ â”‚ ã‚¤  åœ°çƒã®å…¬è»¢                â—‹    â”‚ â”‚
â”‚ â”‚ ã‚¦  æœˆã®è‡ªè»¢                  â—    â”‚ â”‚ â† é¸æŠæ¸ˆã¿
â”‚ â”‚ ã‚¨  æœˆã®å…¬è»¢                  â—‹    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ å•2                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ã‚¢  ...                       â—‹    â”‚ â”‚
â”‚ â”‚ ã‚¤  ...                       â—‹    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ ...                                     â”‚
â”‚                                         â”‚
â”‚ [æå‡ºã™ã‚‹]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**UXè¦ä»¶**:
- å…¨å•ä¸€è¦§è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰â€” å•é¡Œæ•°ãŒå°‘ãªã„ï¼ˆ10ã€œ20å•ç¨‹åº¦ï¼‰å‰æ
- æœªå›ç­”ã®å•é¡Œã«ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
- ã€Œæå‡ºã™ã‚‹ã€æŠ¼ä¸‹æ™‚ã«æœªå›ç­”ãŒã‚ã‚Œã°ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- iPadæœ€é©åŒ–: ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„é¸æŠè‚¢ã‚µã‚¤ã‚ºï¼ˆmin-height: 48pxï¼‰

**Server Actions** (`app/actions/student-answer.ts`):
```typescript
// è§£ç­”å¯èƒ½ãªå•é¡Œã‚»ãƒƒãƒˆä¸€è¦§ï¼ˆç”Ÿå¾’ã®å­¦å¹´ãƒ»approved ã®ã¿ï¼‰
export async function getAvailableQuestionSets(studentId: number)

// å•é¡Œã‚»ãƒƒãƒˆã®å…¨å•é¡Œï¼‹é¸æŠè‚¢ã‚’å–å¾—ï¼ˆè§£ç­”å…¥åŠ›ç”¨ï¼‰
export async function getQuestionsForAnswering(questionSetId: number)

// è§£ç­”æå‡ºï¼‹è‡ªå‹•æ¡ç‚¹
export async function submitAnswers(input: SubmitAnswersInput)
```

### 2-3. è‡ªå‹•æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯

`submitAnswers()` å†…ã§åŒæœŸçš„ã«å®Ÿè¡Œ:

```typescript
async function submitAnswers(input: {
  questionSetId: number
  answers: { questionId: number; rawInput: string | null }[]
}) {
  // 1. æ—¢å­˜ã® answer_session ã‚’ç¢ºèªï¼ˆå†ªç­‰æ€§ä¿è¨¼ï¼‰
  //    - graded â†’ æ—¢å­˜ã®æ¡ç‚¹çµæœã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆäºŒé‡é€ä¿¡ã«å¯¾ã—ã¦å†ªç­‰ï¼‰
  //    - in_progress â†’ é€šå¸¸ã®æ¡ç‚¹ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œï¼ˆä¸‹è¨˜ 2ã€œ5ï¼‰
  //    - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã— â†’ attempt_number=1, is_latest=true ã§æ–°è¦ä½œæˆã—æ¡ç‚¹
  //    â€» æ–°ã—ã„ attempt ã¯çµ¶å¯¾ã«ä½œæˆã—ãªã„ï¼ˆå†å—é¨“ã¯ startNewAttempt() ã‹ã‚‰ã®ã¿ï¼‰
  // 2. questions ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ correct_answer, answer_type ã‚’ä¸€æ‹¬å–å¾—
  // 3. å„è§£ç­”ã‚’ gradeAnswer() ã§æ­£è¦åŒ–ï¼‹åˆ¤å®š
  // 4. student_answers ã‚’ä¸€æ‹¬ INSERT/UPDATEï¼ˆraw_input, answer_value, is_correct, scored_atï¼‰
  // 5. total_score / max_score ã‚’è¨ˆç®—ã—ã¦ answer_sessions ã‚’ UPDATEï¼ˆstatus: 'graded'ï¼‰
  // 6. çµæœã‚’è¿”å´
  return {
    answerSessionId: number,
    attemptNumber: number,
    totalScore: number,
    maxScore: number,
    percentage: number,
    details: { questionId, isCorrect, correctAnswer, rawInput, answerValue }[]
  }
}
```

**å†å—é¨“ãƒ•ãƒ­ãƒ¼**:
- ç”Ÿå¾’ã¯åŒã˜å•é¡Œã‚»ãƒƒãƒˆã«ä½•åº¦ã§ã‚‚è§£ç­”å¯èƒ½
- å‰å›ã® `is_latest` ã‚’ `false` ã«æ›´æ–°ã—ã€æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ `is_latest=true` ã§ä½œæˆ
- çµæœè¡¨ç¤ºãƒ»ä¿è­·è€…ç”»é¢ã§ã¯ `is_latest=true` ã®ã¿è¡¨ç¤ºï¼ˆéå»ã®è©¦è¡Œã¯å±¥æ­´ã¨ã—ã¦ä¿æŒï¼‰
- è¬›å¸«ç”»é¢ã§ã¯å…¨è©¦è¡Œã‚’é–²è¦§å¯èƒ½ï¼ˆæˆé•·ã®å¯è¦–åŒ–ï¼‰

**ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¿è¨¼**:

å…±é€šæ–¹é‡: Supabase `.rpc()` ã§ PostgreSQL é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€åŸå­æ€§ã‚’ä¿è¨¼ã€‚

- **`submitAnswers()`**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆåˆå›ã®ã¿ï¼‰+ è§£ç­”INSERT + æ¡ç‚¹UPDATE + ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚’å˜ä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œã€‚
  `is_latest` ã®æ›´æ–°ã¯è¡Œã‚ãªã„ï¼ˆæ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ `in_progress` â†’ `graded` ã«å¤‰æ›´ã™ã‚‹ã®ã¿ï¼‰ã€‚
  åˆå›ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ï¼‰ã®å ´åˆã®ã¿ `attempt_number=1, is_latest=true` ã§æ–°è¦ä½œæˆã™ã‚‹ã€‚
- **`startNewAttempt()`**: `is_latest` åˆ‡æ›¿ + æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚’å˜ä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œï¼ˆä¸‹è¨˜å‚ç…§ï¼‰ã€‚
  `attempt_number` ã®æ¡ç•ªã¯ `SELECT MAX(attempt_number) + 1 ... FOR UPDATE` ã§ç«¶åˆå›é¿ã€‚
  ä¸€æ„åˆ¶ç´„è¡çªæ™‚ï¼ˆ23505ï¼‰ã¯ `attempt_number` ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ã€‚

**`startNewAttempt(questionSetId)` ã®ä»•æ§˜**:
```typescript
// Server Action: å†å—é¨“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆæ¡ç‚¹ã¯è¡Œã‚ãªã„ï¼‰
export async function startNewAttempt(questionSetId: number): Promise<{ answerSessionId: number; attemptNumber: number }> {
  // å˜ä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ.rpc()ï¼‰ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
  //   1. ç¾åœ¨ã® is_latest=true ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ FOR UPDATE ã§ãƒ­ãƒƒã‚¯
  //   2. å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® is_latest ã‚’ false ã«æ›´æ–°
  //   3. attempt_number = MAX(attempt_number) + 1 ã§æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆis_latest=true, status='in_progress'ï¼‰
  //   4. ä¸€æ„åˆ¶ç´„è¡çª(23505) â†’ ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§3å›ï¼‰
  // å‰ææ¡ä»¶: å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ graded ã§ã‚ã‚‹ã“ã¨ï¼ˆin_progress â†’ ã‚¨ãƒ©ãƒ¼è¿”å´: é€”ä¸­ä¿å­˜ãŒã‚ã‚‹æ—¨ã‚’é€šçŸ¥ï¼‰
}
```

**äºŒé‡é€ä¿¡é˜²æ­¢**:
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´**: ã€Œæå‡ºã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ `isSubmitting` state ã§å³åº§ã«ç„¡åŠ¹åŒ–
- **ã‚µãƒ¼ãƒãƒ¼å´**: `submitAnswers()` ã¯**æ¡ç‚¹ã®ã¿**ã‚’è¡Œã„ã€æ–°ã—ã„attemptã¯ä½œæˆã—ãªã„
  - `graded` â†’ æ—¢å­˜ã®æ¡ç‚¹çµæœã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆå†ªç­‰ã€‚æ™‚é–“çª“ã«ä¾å­˜ã—ãªã„ï¼‰
  - `in_progress` â†’ é€šå¸¸ã®æ¡ç‚¹ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã— â†’ `attempt_number=1` ã§æ–°è¦ä½œæˆï¼‹æ¡ç‚¹
- **å†å—é¨“ã®åˆ†é›¢**: å†å—é¨“ã¯ `startNewAttempt(questionSetId)` ã¨ã„ã†**åˆ¥ã®Server Action**ã‹ã‚‰ã®ã¿é–‹å§‹ã€‚
  `submitAnswers()` ã®äºŒé‡é€ä¿¡ã§ã¯çµ¶å¯¾ã«æ–°ã—ã„attemptã‚’ä½œæˆã—ãªã„

> **ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå°†æ¥æ¤œè¨ï¼‰**: `submission_token`ï¼ˆ1æå‡º1ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ç”Ÿæˆã—ã€ã‚µãƒ¼ãƒãƒ¼å´ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ–¹å¼ã€‚
> PoCæ®µéšã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ– + ã‚µãƒ¼ãƒãƒ¼å´ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¬ãƒ¼ãƒ‰ã§ååˆ†ã¨åˆ¤æ–­ã€‚

### 2-4. çµæœè¡¨ç¤ºç”»é¢

**ãƒ«ãƒ¼ãƒˆ**: `/student/answer/[questionSetId]/result`

**ç”»é¢æ§‹æˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å› ç†ç§‘ åŸºæœ¬æ¼”ç¿’  çµæœ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚         ğŸ¯ 8 / 10 å•æ­£è§£               â”‚
â”‚            80ç‚¹ / 100ç‚¹                 â”‚
â”‚                                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ å•1  âœ… æ­£è§£  ã‚ãªãŸã®è§£ç­”: ã‚¢          â”‚
â”‚ å•2  âŒ ä¸æ­£è§£  ã‚ãªãŸ: ã‚¦ â†’ æ­£è§£: ã‚¤   â”‚
â”‚ å•3  âœ… æ­£è§£  ã‚ãªãŸã®è§£ç­”: ã‚¨          â”‚
â”‚ ...                                     â”‚
â”‚                                         â”‚
â”‚ [ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¿è­·è€…ç”»é¢ã¸ã®åæ˜ **ï¼ˆstudy_logs ã¨ã¯å®Œå…¨åˆ†é›¢ã®å°‚ç”¨ã‚«ãƒ¼ãƒ‰ï¼‰:
- æ—¢å­˜ã®ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«**å°‚ç”¨ã‚«ãƒ¼ãƒ‰ã€Œè‡ªå‹•æ¡ç‚¹çµæœã€**ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«é…ç½®ï¼‰
- `study_logs` ã®æ—¢å­˜ã‚°ãƒ©ãƒ•ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã¯æ··åœ¨ã•ã›ãªã„
- è¡¨ç¤º: å•é¡Œã‚»ãƒƒãƒˆåã€å¾—ç‚¹/æº€ç‚¹ã€æ­£ç­”ç‡ã€å—é¨“æ—¥æ™‚ã€è©¦è¡Œå›æ•°
- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: `answer_sessions WHERE is_latest=true`ï¼ˆæœ€æ–°ã®è©¦è¡Œã®ã¿ï¼‰

### 2-5. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
app/
  actions/
    question-management.ts   # å•é¡Œç®¡ç† Server Actions
    student-answer.ts        # è§£ç­”æå‡ºãƒ»æ¡ç‚¹ Server Actions
  coach/
    questions/
      page.tsx               # å•é¡Œã‚»ãƒƒãƒˆä¸€è¦§
      new/
        page.tsx             # æ–°è¦ä½œæˆ
      [id]/
        page.tsx             # ç·¨é›†
        question-set-editor.tsx  # ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆClient Componentï¼‰
  student/
    answer/
      page.tsx               # è§£ç­”å¯èƒ½ãªå•é¡Œã‚»ãƒƒãƒˆä¸€è¦§
      [questionSetId]/
        page.tsx             # è§£ç­”å…¥åŠ›ç”»é¢ï¼ˆServer Componentï¼‰
        answer-form.tsx      # è§£ç­”ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆClient Componentï¼‰
        result/
          page.tsx           # çµæœè¡¨ç¤º
supabase/
  migrations/
    YYYYMMDD_create_question_tables.sql
```

### 2-6. Phase 1 å®Œäº†æ¡ä»¶

- [ ] DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆ5ãƒ†ãƒ¼ãƒ–ãƒ« + RLSï¼‰
- [ ] è¬›å¸«ãŒå•é¡Œã‚»ãƒƒãƒˆã‚’ä½œæˆãƒ»æ‰¿èªã§ãã‚‹
- [ ] ç”Ÿå¾’ãŒç†ç§‘ã®å•é¡Œã«é¸æŠå¼ã§è§£ç­”ã§ãã‚‹
- [ ] è‡ªå‹•æ¡ç‚¹ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] çµæœãŒç”Ÿå¾’ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] çµæœãŒä¿è­·è€…ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `pnpm run build` æˆåŠŸ

---

## 3. Phase 2: ç®—æ•°ã®æ•°å€¤å…¥åŠ›è‡ªå‹•æ¡ç‚¹ + é€”ä¸­ä¿å­˜

### 3-0. ã‚¹ã‚³ãƒ¼ãƒ—

- å¯¾è±¡: ç®—æ•°ï¼ˆsubject_id = 1ï¼‰
- è§£ç­”å½¢å¼: `numeric`ï¼ˆæ•´æ•°ãƒ»å°æ•°ï¼‰+ `fraction`ï¼ˆåˆ†æ•°ï¼‰
- Phase 1 ã®åŸºç›¤ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ»çµæœè¡¨ç¤ºï¼‰ã‚’å†åˆ©ç”¨
- **æ–°è¦**: æ¼¸æ¬¡å…¥åŠ›ï¼ˆé€”ä¸­ä¿å­˜ï¼‰å¯¾å¿œ â€” ç”Ÿå¾’ã¯1é€±é–“ã§2ã€œ3å›ã«åˆ†ã‘ã¦è§£ç­”ã‚’å…¥åŠ›

### 3-1. ç®—æ•°ã®é‹ç”¨ãƒ•ãƒ­ãƒ¼

```
[è¬›å¸«] è§£ç­”ãƒ‡ãƒ¼ã‚¿ç™»éŒ²            [ç”Ÿå¾’] æ¼¸æ¬¡å…¥åŠ›
  "(1) 4, (2) 0.23, ..."           ç´™ã§å•é¡Œã‚’è§£ã
         â†“                              â†“
  question_set + questions ä½œæˆ     Day 1: (1)ã€œ(5) ã‚’å…¥åŠ› â†’ é€”ä¸­ä¿å­˜
                                        â†“
                                    Day 2: (6)ã€œ(10) ã‚’è¿½åŠ å…¥åŠ› â†’ é€”ä¸­ä¿å­˜
                                        â†“
                                    Day 3: (11)ã€œ(15) ã‚’è¿½åŠ  â†’ å…¨å•æå‡º â†’ è‡ªå‹•æ¡ç‚¹
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- ç”Ÿå¾’ã¯å•é¡Œã‚’ç´™ã§è§£ãã€è§£ç­”ã ã‘ã‚’Webã«å…¥åŠ›ï¼ˆå•é¡Œæ–‡ã¯ã‚·ã‚¹ãƒ†ãƒ ã«è¡¨ç¤ºã•ã‚Œãªã„ï¼‰
- 1å›ã§å…¨å•å…¥åŠ›ã™ã‚‹å¿…è¦ã¯ãªãã€è§£ã„ãŸåˆ†ã ã‘éƒ½åº¦å…¥åŠ›ã—ã¦é€”ä¸­ä¿å­˜ã§ãã‚‹
- å…¨å•å…¥åŠ›å¾Œï¼ˆã¾ãŸã¯ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ï¼‰ã€Œæå‡ºã—ã¦æ¡ç‚¹ã€ã‚’é¸æŠ

### 3-2. ç®—æ•°ç”¨ã®å…¥åŠ›UI

**æ•°å€¤å…¥åŠ›**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å› ç®—æ•° åŸºæœ¬æ¼”ç¿’       5/15å• å…¥åŠ›æ¸ˆã¿ â”‚
â”‚                          [é€”ä¸­ä¿å­˜æ¸ˆã¿ âœ“] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ (1)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚      â”‚  4           â”‚  â† å…¥åŠ›æ¸ˆã¿       â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                         â”‚
â”‚ (2)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚      â”‚  0.23        â”‚  â† å…¥åŠ›æ¸ˆã¿       â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                         â”‚
â”‚ (3)  â”Œâ”€â”€â”€â”€â”€â”                            â”‚
â”‚      â”‚  3  â”‚ â† åˆ†å­  ï¼ˆåˆ†æ•°å…¥åŠ›ï¼‰       â”‚
â”‚      â”œâ”€â”€â”€â”€â”€â”¤                            â”‚
â”‚      â”‚  4  â”‚ â† åˆ†æ¯                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                         â”‚
â”‚ (4)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚      â”‚              â”‚  â† æœªå…¥åŠ›         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚ ...                                     â”‚
â”‚                                         â”‚
â”‚ [é€”ä¸­ä¿å­˜]          [æå‡ºã—ã¦æ¡ç‚¹ã™ã‚‹]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**UXè¦ä»¶**:
- å•é¡Œç•ªå·ã®ã¿è¡¨ç¤ºï¼ˆå•é¡Œæ–‡ãªã— â€” ç´™ã«å°åˆ·æ¸ˆã¿ï¼‰
- `answer_type` ã«å¿œã˜ã¦å…¥åŠ›UIã‚’è‡ªå‹•åˆ‡æ›¿ï¼ˆnumeric â†’ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã€fraction â†’ åˆ†å­/åˆ†æ¯2æ¬„ï¼‰
- ã€Œé€”ä¸­ä¿å­˜ã€: å…¥åŠ›æ¸ˆã¿ã®è§£ç­”ã‚’ä¿å­˜ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ `in_progress` ã®ã¾ã¾
- ã€Œæå‡ºã—ã¦æ¡ç‚¹ã™ã‚‹ã€: å…¨è§£ç­”ã‚’ç¢ºå®šã—ã€è‡ªå‹•æ¡ç‚¹ã‚’å®Ÿè¡Œ
- å‰å›ä¿å­˜ã—ãŸè§£ç­”ã¯æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«è‡ªå‹•å¾©å…ƒ
- æœªå…¥åŠ›ã®å•é¡ŒãŒã‚ã£ã¦ã‚‚æå‡ºå¯èƒ½ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰

**åˆ†æ•°å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ** (`components/fraction-input.tsx`):
- åˆ†å­/åˆ†æ¯ã®2ã¤ã®æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
- è¦–è¦šçš„ã«åˆ†æ•°ç·šã‚’è¡¨ç¤º
- å‡ºåŠ›å€¤: `"3/4"` å½¢å¼ã®æ–‡å­—åˆ—
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: åˆ†æ¯ â‰  0

**æ•°å€¤å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**:
- `<input type="text" inputMode="decimal">` ã‚’ä½¿ç”¨
- iPad ã®ãƒ†ãƒ³ã‚­ãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹
- ãƒã‚¤ãƒŠã‚¹å€¤ãƒ»å°æ•°å¯¾å¿œ

### 3-3. é€”ä¸­ä¿å­˜ï¼ˆæ¼¸æ¬¡å…¥åŠ›ï¼‰ã®å®Ÿè£…

**çŠ¶æ…‹é·ç§»**:
```
[åˆå›ã‚¢ã‚¯ã‚»ã‚¹] â†’ answer_session (status: 'in_progress') ä½œæˆ
                  â†“
[é€”ä¸­ä¿å­˜] Ã—N â†’ student_answers ã‚’ UPSERTï¼ˆanswer_session ã¯ 'in_progress' ã®ã¾ã¾ï¼‰
                  â†“
[æå‡ºã—ã¦æ¡ç‚¹] â†’ å…¨ student_answers ã‚’æ¡ç‚¹ â†’ answer_session (status: 'graded')
```

**Server Actions** (`app/actions/student-answer.ts` ã«è¿½åŠ ):
```typescript
// é€”ä¸­ä¿å­˜: å…¥åŠ›æ¸ˆã¿ã®è§£ç­”ã®ã¿ä¿å­˜ï¼ˆæœªæ¡ç‚¹ï¼‰
export async function saveDraftAnswers(input: {
  questionSetId: number
  answers: { questionId: number; rawInput: string | null }[]
}): Promise<{ answerSessionId: number; savedCount: number }> {
  // 1. æ—¢å­˜ã® in_progress ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾— or æ–°è¦ä½œæˆ
  // 2. student_answers ã‚’ UPSERTï¼ˆON CONFLICT (answer_session_id, question_id) DO UPDATEï¼‰
  //    - raw_input, answer_value ã‚’æ›´æ–°
  //    - is_correct = NULL, scored_at = NULL ã®ã¾ã¾ï¼ˆæœªæ¡ç‚¹ï¼‰
  // 3. savedCount ã‚’è¿”å´
}

// æœ€çµ‚æå‡º: å…¨è§£ç­”ã‚’æ¡ç‚¹ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œäº†
export async function submitAndGradeAnswers(input: {
  answerSessionId: number
}): Promise<GradeResult> {
  // 1. answer_session ã® status ãŒ 'in_progress' ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
  // 2. å…¨ student_answers ã‚’å–å¾—
  // 3. gradeAnswer() ã§å„å•ã‚’æ¡ç‚¹ â†’ is_correct, scored_at ã‚’ UPDATE
  // 4. total_score / max_score ã‚’è¨ˆç®—
  // 5. answer_session ã‚’ 'graded' ã«æ›´æ–°
  // 6. çµæœã‚’è¿”å´
}

// é€”ä¸­ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
export async function getDraftAnswers(
  questionSetId: number
): Promise<{ answerSessionId: number; answers: DraftAnswer[] } | null> {
  // in_progress ã‹ã¤ is_latest=true ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ä¿å­˜æ¸ˆã¿è§£ç­”ã‚’å–å¾—
}
```

**å†å—é¨“æ™‚ã®é€”ä¸­ä¿å­˜**:
- å‰å› `graded` ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆ â†’ æ–°ã—ã„ `in_progress` ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆ`attempt_number + 1`ï¼‰
- å‰å› `in_progress` ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆ â†’ ãã®ã¾ã¾ç¶šãã‚’å…¥åŠ›
- å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® `is_latest` ã¯æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã« `false` ã«æ›´æ–°

**ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ»å†ªç­‰æ€§**:
- `saveDraftAnswers`: UPSERT ã¯å†ªç­‰ã€‚åŒä¸€è§£ç­”ã®å†ä¿å­˜ã¯å®‰å…¨ï¼ˆ`ON CONFLICT DO UPDATE`ï¼‰
- `submitAndGradeAnswers`: å†’é ­ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
  - `graded` â†’ æ—¢å­˜çµæœã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆå†ªç­‰ã€‚æ™‚é–“çª“ã«ä¾å­˜ã—ãªã„ï¼‰
  - `in_progress` â†’ æ¡ç‚¹ã€œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚’å˜ä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ
  - å†å—é¨“ã¯ `startNewAttempt()` ã‹ã‚‰ã®ã¿é–‹å§‹ï¼ˆæ¡ç‚¹APIã‹ã‚‰ã¯æ–°attemptã‚’ä½œæˆã—ãªã„ï¼‰
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´: ã€Œé€”ä¸­ä¿å­˜ã€ã€Œæå‡ºã—ã¦æ¡ç‚¹ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ `isSubmitting` ã§å³åº§ã«ç„¡åŠ¹åŒ–

### 3-4. ç®—æ•°ç”¨ã®æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯æ‹¡å¼µ

`gradeAnswer()` é–¢æ•°ã‚’Phase 1ã® `submitAnswers()` ã‹ã‚‰æŠ½å‡ºã—ã¦å…±æœ‰åŒ–:

```typescript
// raw_input â†’ answer_value ã®æ­£è¦åŒ– + æ¡ç‚¹ã‚’ä¸€æ‹¬å®Ÿè¡Œ
function gradeAnswer(
  answerType: 'choice' | 'numeric' | 'fraction',
  rawInput: string | null,
  correctAnswer: string   // ç™»éŒ²æ™‚ã«æ­£è¦åŒ–æ¸ˆã¿
): { answerValue: string | null; isCorrect: boolean } {
  if (rawInput === null || rawInput.trim() === '') {
    return { answerValue: null, isCorrect: false }
  }

  switch (answerType) {
    case 'choice': {
      const normalized = rawInput.trim()
      return { answerValue: normalized, isCorrect: normalized === correctAnswer.trim() }
    }

    case 'numeric': {
      // normalizeNumeric: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 1-2 ã§å®šç¾©ã—ãŸæ­£è¦åŒ–é–¢æ•°
      const normalized = normalizeNumeric(rawInput)
      if (normalized === null) return { answerValue: rawInput.trim(), isCorrect: false }
      return { answerValue: normalized, isCorrect: normalized === correctAnswer }
    }

    case 'fraction': {
      // "åˆ†å­/åˆ†æ¯" å½¢å¼ã€‚trim ã®ã¿ã§å®Œå…¨ä¸€è‡´åˆ¤å®š
      const normalized = rawInput.trim()
      // é˜²å¾¡çš„æ¤œè¨¼: åˆ†æ¯0ã®å…¥åŠ›ã¯ä¸æ­£è§£æ‰±ã„ï¼ˆãƒ‘ãƒ¼ã‚µã§å¼¾ããŒäºŒé‡é˜²å¾¡ï¼‰
      const parts = normalized.split('/')
      if (parts.length === 2 && Number(parts[1]) === 0) {
        return { answerValue: normalized, isCorrect: false }
      }
      return { answerValue: normalized, isCorrect: normalized === correctAnswer.trim() }
    }
  }
}

// student_answers ã«ä¿å­˜ã™ã‚‹å€¤:
//   raw_input: rawInputï¼ˆç”Ÿå¾’ã®å…¥åŠ›ãã®ã¾ã¾ï¼‰
//   answer_value: gradeAnswer().answerValueï¼ˆæ­£è¦åŒ–æ¸ˆã¿ï¼‰
//   is_correct: gradeAnswer().isCorrect
//   scored_at: now()
```

### 3-5. Phase 2 å®Œäº†æ¡ä»¶

- [ ] æ•°å€¤å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒ iPad ã§å¿«é©ã«å‹•ä½œã™ã‚‹
- [ ] åˆ†æ•°å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£ã—ã `"åˆ†å­/åˆ†æ¯"` å½¢å¼ã‚’å‡ºåŠ›ã™ã‚‹
- [ ] é€”ä¸­ä¿å­˜ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ï¼ˆä¿å­˜â†’å¾©å…ƒâ†’è¿½åŠ å…¥åŠ›â†’å†ä¿å­˜ï¼‰
- [ ] ã€Œæå‡ºã—ã¦æ¡ç‚¹ã™ã‚‹ã€ã§å…¨å•ãŒæ­£ã—ãè‡ªå‹•æ¡ç‚¹ã•ã‚Œã‚‹ï¼ˆæ•´æ•°ã€å°æ•°ã€åˆ†æ•°ï¼‰
- [ ] å•é¡Œç®¡ç†ç”»é¢ã®è§£ç­”ã®ã¿ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã§ç®—æ•°å•é¡Œã‚’ä½œæˆã§ãã‚‹
- [ ] çµæœè¡¨ç¤ºãŒç†ç§‘ã¨åŒã˜UXã§å‹•ä½œã™ã‚‹
- [ ] å†å—é¨“æ™‚ã«å‰å›ã®é€”ä¸­ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
- [ ] `pnpm run build` æˆåŠŸ

---

## 4. Phase 3: ç†ç§‘AIæŒ¯ã‚Šè¿”ã‚Šå¯¾è©±

### 4-0. ã‚¹ã‚³ãƒ¼ãƒ—

- Phase 1 ã®è‡ªå‹•æ¡ç‚¹çµæœã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä½¿ç”¨
- æ—¢å­˜ã®é€±æ¬¡ãƒªãƒ•ãƒ¬ã‚¯ãƒˆåŸºç›¤ï¼ˆ`reflect-chat.tsx`, `reflect-coaching.ts`ï¼‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è»¢ç”¨
- ãŸã ã—**å˜å…ƒå˜ä½**ã®æŒ¯ã‚Šè¿”ã‚Šï¼ˆé€±æ¬¡ã§ã¯ãªãã€å•é¡Œã‚»ãƒƒãƒˆå®Œäº†å¾Œã«å®Ÿæ–½ï¼‰

### 4-1. æŒ¯ã‚Šè¿”ã‚Šã®ä½ç½®ã¥ã‘

```
[è§£ç­”æå‡º] â†’ [è‡ªå‹•æ¡ç‚¹ãƒ»çµæœè¡¨ç¤º] â†’ [æŒ¯ã‚Šè¿”ã‚Šå¯¾è©±ï¼ˆä»»æ„ï¼‰]
```

- çµæœç”»é¢ã«ã€ŒæŒ¯ã‚Šè¿”ã‚Šã‚’ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’é…ç½®
- å…¨å•æ­£è§£ã§ã‚‚æŒ¯ã‚Šè¿”ã‚Šå¯èƒ½ï¼ˆç†è§£ã®è¨€èªåŒ–ãŒç›®çš„ï¼‰
- æŒ¯ã‚Šè¿”ã‚Šçµæœã¯è¨˜éŒ²ãƒ»ä¿è­·è€…/è¬›å¸«ç”»é¢ã§é–²è¦§å¯èƒ½

### 4-2. å¯¾è©±ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬å‹ï¼‰

æ—¢å­˜ã®ãƒªãƒ•ãƒ¬ã‚¯ãƒˆãŒ GROW ãƒ¢ãƒ‡ãƒ«ï¼ˆ3ã€œ6ã‚¿ãƒ¼ãƒ³ï¼‰ã‚’ä½¿ã†ã®ã«å¯¾ã—ã€
ç†ç§‘æŒ¯ã‚Šè¿”ã‚Šã¯**3ã‚¿ãƒ¼ãƒ³å›ºå®š**ã®çŸ­ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§é‹ç”¨å®‰å®šåŒ–:

```
Turn 1 (AI): æ¡ç‚¹çµæœã‚’è¸ã¾ãˆãŸå°å…¥
  ã€Œ10å•ä¸­8å•æ­£è§£ã ã£ãŸã­ï¼é–“é•ãˆãŸå•é¡Œã«ã¤ã„ã¦ä¸€ç·’ã«æŒ¯ã‚Šè¿”ã‚ã†ã€‚
   å•2ã¯ã€Œåœ°çƒã®å…¬è»¢ã€ãŒæ­£è§£ã ã£ãŸã‘ã©ã€ã©ã†è€ƒãˆã¦ã‚¦ã‚’é¸ã‚“ã ï¼Ÿã€
  â†’ ç”Ÿå¾’: è‡ªç”±å…¥åŠ› or ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠ
    - ã€Œå•é¡Œã‚’ã‚ˆãèª­ã‚“ã§ã„ãªã‹ã£ãŸã€
    - ã€Œ2ã¤ã§è¿·ã£ãŸã€
    - ã€Œã‚ã‹ã‚‰ãªã‹ã£ãŸã€
    - ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰

Turn 2 (AI): ç†è§£ã®æ·±æ˜ã‚Š
  ã€Œãªã‚‹ã»ã©ã€è¿·ã£ãŸã‚“ã ã­ã€‚è‡ªè»¢ã¨å…¬è»¢ã®é•ã„ã‚’è‡ªåˆ†ã®è¨€è‘‰ã§èª¬æ˜ã§ãã‚‹ï¼Ÿã€
  â†’ ç”Ÿå¾’: è‡ªç”±å…¥åŠ› or ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠ
    - ã€Œè‡ªè»¢ã¯è‡ªåˆ†ã§å›ã‚‹ã“ã¨ã€å…¬è»¢ã¯å¤ªé™½ã®ã¾ã‚ã‚Šã‚’å›ã‚‹ã“ã¨ã€
    - ã€Œã†ã¾ãèª¬æ˜ã§ããªã„ã€
    - ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰

Turn 3 (AI): ã¾ã¨ã‚ï¼‹æ¿€åŠ±
  ã€Œã„ã„èª¬æ˜ã ã­ï¼ãƒã‚¤ãƒ³ãƒˆã¯ã€‡ã€‡ã€‚æ¬¡ã«åŒã˜å•é¡ŒãŒå‡ºãŸã‚‰è‡ªä¿¡ã‚’æŒã£ã¦è§£ã‘ã‚‹ã‚ˆã€‚ã€
```

### 4-3. æŠ€è¡“å®Ÿè£…

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
```
app/
  student/
    answer/
      [questionSetId]/
        reflect/
          page.tsx                    # æŒ¯ã‚Šè¿”ã‚Šç”»é¢ï¼ˆServer Componentï¼‰
          science-reflect-chat.tsx    # ãƒãƒ£ãƒƒãƒˆUIï¼ˆClient Componentï¼‰
lib/
  openai/
    science-reflection.ts            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
```

**DB**: æ—¢å­˜ã® `coaching_sessions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µã™ã‚‹ã‹ã€æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 

```sql
-- æ—¢å­˜ coaching_sessions ã« session_type ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE coaching_sessions
  ADD COLUMN session_type VARCHAR(20) NOT NULL DEFAULT 'weekly_reflect'
    CHECK (session_type IN ('weekly_reflect', 'science_reflect'));

-- ç†ç§‘æŒ¯ã‚Šè¿”ã‚Šã®å ´åˆã€answer_session_id ã§ç´ã¥ã‘
ALTER TABLE coaching_sessions
  ADD COLUMN answer_session_id BIGINT REFERENCES answer_sessions(id);
```

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ** (`lib/openai/science-reflection.ts`):

```typescript
// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†: å®šæ•°ã§ç®¡ç†ã—ã€coaching_sessions.metadata ã«è¨˜éŒ²
const SCIENCE_REFLECT_PROMPT_VERSION = 'v1.0'

export function getScienceReflectPrompt(context: {
  studentName: string
  questionSetTitle: string
  totalScore: number
  maxScore: number
  incorrectQuestions: {
    questionNumber: string
    studentAnswer: string
    correctAnswer: string
    correctOptionText: string  // é¸æŠè‚¢ã®æœ¬æ–‡
    errorType?: string         // question_options.error_typeï¼ˆã‚ã‚Œã°ï¼‰
  }[]
  turnNumber: 1 | 2 | 3
  conversationHistory: Message[]
}): string {
  // Turn 1: çµæœæ¦‚è¦ + é–“é•ãˆãŸå•é¡Œã®ä¸­ã‹ã‚‰1ã¤é¸ã‚“ã§è³ªå•
  // Turn 2: ç”Ÿå¾’ã®å›ç­”ã‚’å—ã‘ã¦ç†è§£ã‚’æ·±æ˜ã‚Š
  // Turn 3: ã¾ã¨ã‚ + æ¬¡å›ã¸ã®æ¿€åŠ±
}
```

**å …ç‰¢æ€§è¨­è¨ˆ**ï¼ˆæ—¢å­˜ `coach-feedback.ts` ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è»¢ç”¨ï¼‰:

```typescript
// 1. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆAPIéšœå®³æ™‚ï¼‰
const FALLBACK_MESSAGES = {
  turn1: 'ä»Šå›ã®çµæœã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã‚ˆã†ã€‚é–“é•ãˆãŸå•é¡Œã«ã¤ã„ã¦ã€ã©ã†æ€ã£ãŸï¼Ÿ',
  turn2: 'ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿ',
  turn3: 'ã‚ˆãé ‘å¼µã£ãŸã­ï¼æ¬¡ã‚‚ä¸€ç·’ã«ãŒã‚“ã°ã‚ã†ï¼',
}

// 2. APIå‘¼ã³å‡ºã— with ãƒªãƒˆãƒ©ã‚¤ + ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
async function generateReflectMessage(context, turnNumber) {
  try {
    const response = await openai.chat.completions.create({
      // ...
    }, { timeout: 8000 })  // 8ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    return response.choices[0].message.content
  } catch (error) {
    console.error('[ScienceReflect] API error:', error)
    // Langfuse ã«ã‚¨ãƒ©ãƒ¼è¨˜éŒ²
    return FALLBACK_MESSAGES[`turn${turnNumber}`]
  }
}

// 3. ä¿å­˜å¤±æ•—æ™‚ã®å†é€
// coaching_messages ã®ä¿å­˜ã¯ fire-and-forget ã§ã¯ãªãã€
// å¤±æ•—æ™‚ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æœ€å¤§2å›ãƒªãƒˆãƒ©ã‚¤ï¼ˆæ—¢å­˜ reflect-chat ã¨åŒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

// 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²
// coaching_sessions ä½œæˆæ™‚ã« metadata: { prompt_version: SCIENCE_REFLECT_PROMPT_VERSION } ã‚’ä¿å­˜
// å°†æ¥ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„æ™‚ã«ã€ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ç”Ÿæˆã—ãŸã‹è¿½è·¡å¯èƒ½
```

**ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠè‚¢ã®ç”Ÿæˆ**:
- Turn 1: å›ºå®šé¸æŠè‚¢ï¼ˆã€Œå•é¡Œã‚’ã‚ˆãèª­ã‚“ã§ã„ãªã‹ã£ãŸã€ã€Œè¿·ã£ãŸã€ã€Œã‚ã‹ã‚‰ãªã‹ã£ãŸã€ï¼‰
- Turn 2: AIãŒç”Ÿæˆã™ã‚‹é¸æŠè‚¢ + è‡ªç”±å…¥åŠ›
  - ãŸã ã—é¸æŠè‚¢ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç”Ÿæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¸¡ã™
  - ç”Ÿå¾’ã¯é¸æŠ or è‡ªç”±å…¥åŠ›ã®ã©ã¡ã‚‰ã§ã‚‚å¯

### 4-4. ä¿è­·è€…/è¬›å¸«ã¸ã®æŒ¯ã‚Šè¿”ã‚Šå…±æœ‰

- æŒ¯ã‚Šè¿”ã‚Šã®è¦ç´„ï¼ˆAIç”Ÿæˆã€100ã€œ150æ–‡å­—ï¼‰ã‚’ `coaching_sessions.summary` ã«ä¿å­˜
- ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: ã€Œç†ç§‘æŒ¯ã‚Šè¿”ã‚Šã€ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤º
- è¬›å¸«ç”»é¢: ç”Ÿå¾’è©³ç´°ãƒšãƒ¼ã‚¸ã®å­¦ç¿’ã‚¿ãƒ–ã«è¡¨ç¤º

### 4-5. Phase 3 å®Œäº†æ¡ä»¶

- [ ] çµæœç”»é¢ã‹ã‚‰æŒ¯ã‚Šè¿”ã‚Šå¯¾è©±ã‚’é–‹å§‹ã§ãã‚‹
- [ ] 3ã‚¿ãƒ¼ãƒ³ã®å¯¾è©±ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠè‚¢ + è‡ªç”±å…¥åŠ›ã®ä¸¡æ–¹ãŒä½¿ãˆã‚‹
- [ ] æŒ¯ã‚Šè¿”ã‚Šè¦ç´„ãŒç”Ÿæˆãƒ»ä¿å­˜ã•ã‚Œã‚‹
- [ ] ä¿è­·è€…ç”»é¢ã§æŒ¯ã‚Šè¿”ã‚Šçµæœã‚’é–²è¦§ã§ãã‚‹
- [ ] `pnpm run build` æˆåŠŸ

---

## 5. æŠ€è¡“çš„ãªè¨­è¨ˆåˆ¤æ–­

### 5-1. æ—¢å­˜ study_logs ã¨ã®è²¬å‹™åˆ†é›¢

| é …ç›® | study_logsï¼ˆæ—¢å­˜ï¼‰ | answer_sessions + student_answersï¼ˆæ–°è¦ï¼‰ |
|------|-------------------|------------------------------------------|
| ç²’åº¦ | ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¨®åˆ¥ã”ã¨ã®é›†è¨ˆ | å•é¡Œã”ã¨ã®æ­£èª¤ |
| å…¥åŠ›è€… | ç”Ÿå¾’ï¼ˆæ‰‹å‹•ï¼‰ | ç”Ÿå¾’ï¼ˆè§£ç­”ï¼‰â†’ ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ¡ç‚¹ï¼‰ |
| ç”¨é€” | é€±æ¬¡é€²æ—ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ | è‡ªå‹•æ¡ç‚¹ãƒ»å¼±ç‚¹åˆ†æ |
| è¡¨ç¤ºå ´æ‰€ | æ—¢å­˜ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ç¾¤ | **å°‚ç”¨ã‚«ãƒ¼ãƒ‰**ï¼ˆåˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ |
| API | `app/actions/study-log.ts` | `app/actions/student-answer.ts` |

**PoCæœŸé–“ä¸­ã®ãƒ«ãƒ¼ãƒ«**:
1. `study_logs` ã¸ã®æ›¸ãæˆ»ã—ã¯**è¡Œã‚ãªã„**ï¼ˆé›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯åŠ£åŒ–ãƒªã‚¹ã‚¯å›é¿ï¼‰
2. æ—¢å­˜ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»é€²æ—ãƒãƒ¼ã¯**å¤‰æ›´ã—ãªã„**
3. è‡ªå‹•æ¡ç‚¹çµæœã¯å°‚ç”¨ã‚«ãƒ¼ãƒ‰ãƒ»å°‚ç”¨APIã§å®Œå…¨åˆ†é›¢
4. ã‚¹ãƒ‘ãƒ¼ã‚¯å…¥åŠ›ï¼ˆæ—¢å­˜ï¼‰ã¨è§£ç­”å…¥åŠ›ï¼ˆæ–°è¦ï¼‰ã¯ç‹¬ç«‹ã—ã¦å‹•ä½œ

çµ±åˆåˆ¤æ–­ã¯PoCæ¤œè¨¼å¾Œï¼ˆä¿è­·è€…ãƒ»è¬›å¸«ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¸ã¾ãˆã¦ï¼‰ã€‚

### 5-2. iPad æœ€é©åŒ–

- ã‚¿ãƒƒãƒ—é ˜åŸŸ: æœ€ä½ 48px Ã— 48pxï¼ˆApple HIGæº–æ‹ ï¼‰
- é¸æŠè‚¢: `RadioGroup` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆRadix UIï¼‰ã‚’ã‚«ã‚¹ã‚¿ãƒ 
- æ•°å€¤å…¥åŠ›: `inputMode="decimal"` ã§ iOS ãƒ†ãƒ³ã‚­ãƒ¼è¡¨ç¤º
- åˆ†æ•°å…¥åŠ›: åˆ†å­â†’åˆ†æ¯ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è‡ªå‹•ç§»å‹•

### 5-3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- å•é¡Œãƒ‡ãƒ¼ã‚¿ã¯ Server Component ã§ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ â†’ Client Component ã«æ¸¡ã™
- ç†ç§‘: è§£ç­”æå‡ºã¯1å›ã® Server Action å‘¼ã³å‡ºã—ã§å…¨å•ä¸€æ‹¬é€ä¿¡
- ç®—æ•°: é€”ä¸­ä¿å­˜ã¯ UPSERT ã§å†ªç­‰ï¼ˆåŒã˜å•é¡Œã®å†ä¿å­˜ã¯ UPDATEï¼‰ã€‚æ¡ç‚¹ã¯æœ€çµ‚æå‡ºæ™‚ã«1å›
- é€”ä¸­ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ: `getDraftAnswers()` ã§ in_progress ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ä¸€æ‹¬å–å¾—ï¼ˆN+1 ãªã—ï¼‰
- æ¡ç‚¹ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§åŒæœŸå®Ÿè¡Œï¼ˆå•é¡Œæ•°ãŒå°‘ãªã„ãŸã‚éåŒæœŸä¸è¦ï¼‰

### 5-4. èªå¯ãƒ¢ãƒ‡ãƒ«

| æ“ä½œ | student | coach | admin |
|------|---------|-------|-------|
| å•é¡Œã‚»ãƒƒãƒˆä½œæˆ | - | âœ… | âœ… |
| å•é¡Œã‚»ãƒƒãƒˆæ‰¿èª | - | âœ… | âœ… |
| è§£ç­”æå‡º | âœ…ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰ | - | - |
| æ¡ç‚¹çµæœé–²è¦§ | âœ…ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰ | âœ…ï¼ˆæ‹…å½“ç”Ÿå¾’ï¼‰ | âœ…ï¼ˆå…¨å“¡ï¼‰ |
| æŒ¯ã‚Šè¿”ã‚Šå®Ÿæ–½ | âœ… | - | - |
| æŒ¯ã‚Šè¿”ã‚Šé–²è¦§ | âœ…ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰ | âœ…ï¼ˆæ‹…å½“ç”Ÿå¾’ï¼‰ | âœ…ï¼ˆå…¨å“¡ï¼‰ |

---

## 6. ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å½±éŸ¿ | å¯¾ç­– |
|--------|------|------|
| å•é¡Œãƒ‡ãƒ¼ã‚¿ã®åˆæœŸç™»éŒ²ãŒé‡ã„ | é‹ç”¨é–‹å§‹ãŒé…ã‚Œã‚‹ | ç®—æ•°: è§£ç­”ã®ã¿ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã§1åˆ†ä»¥å†…ã«1ã‚»ãƒƒãƒˆç™»éŒ²å¯èƒ½ã€‚ç†ç§‘: 2ã€œ3ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†ã‚’ã¾ã¨ã‚ã¦éƒ½åº¦ç™»éŒ² |
| ç®—æ•°ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ | æ­£ç­”ãŒèª¤ç™»éŒ²ã•ã‚Œã‚‹ | ãƒ‘ãƒ¼ã‚¹çµæœã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§è¬›å¸«ãŒç¢ºèªã€‚æ‰¿èªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆdraftâ†’approvedï¼‰ã§äºŒé‡ãƒã‚§ãƒƒã‚¯ |
| iPad ã§ã®å…¥åŠ›ä½“é¨“ãŒæ‚ªã„ | ç”Ÿå¾’ã®åˆ©ç”¨ç‡ä½ä¸‹ | Phase 1 ã®ç†ç§‘ï¼ˆã‚¿ãƒƒãƒ—ã®ã¿ï¼‰ã§æ—©æœŸæ¤œè¨¼ã€‚ç®—æ•°ã®æ•°å€¤å…¥åŠ›ã¯ Phase 2 ã§æ”¹å–„ä½™åœ°ã‚ã‚Š |
| é€”ä¸­ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆ | ç”Ÿå¾’ã®å…¥åŠ›ãŒæ¶ˆãˆã‚‹ | UPSERT ã§å†ªç­‰æ€§ã‚’ä¿è¨¼ã€‚`in_progress` ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æ˜ç¤ºçš„ã«å‰Šé™¤ã—ãªã„é™ã‚Šä¿æŒ |
| åˆ†æ•°ã®å®Œå…¨ä¸€è‡´ãŒå³ã—ã™ãã‚‹ | æ­£è§£ãªã®ã«ä¸æ­£è§£åˆ¤å®š | è¬›å¸«ã«ã€Œå‡ºé¡Œæ™‚ã®å½¢å¼ã§è§£ç­”ã™ã‚‹ã€æ—¨ã‚’å‘¨çŸ¥ã€‚å•é¡Œç™»éŒ²æ™‚ã«æ­£ç­”å½¢å¼ã‚’æ˜è¨˜ |
| AIæŒ¯ã‚Šè¿”ã‚Šã®å“è³ª | ä¸è‡ªç„¶ãªå¯¾è©± | ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠè‚¢ã§å…¥åŠ›ã‚’æ§‹é€ åŒ–ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å…·ä½“ä¾‹ã‚’å¤šæ•°å«ã‚ã‚‹ |
| AI APIéšœå®³ã§æŒ¯ã‚Šè¿”ã‚ŠãŒæ­¢ã¾ã‚‹ | ç”Ÿå¾’ã®ä½“é¨“ä¸­æ–­ | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å¯¾è©±ç¶™ç¶šï¼ˆæ—¢å­˜coach-feedbackã¨åŒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ |
| æ•°å€¤æ­£è¦åŒ–ã®è¡¨è¨˜ã‚†ã‚Œ | æ­£è§£ãªã®ã«ä¸æ­£è§£åˆ¤å®š | `normalizeNumeric()` ã§çµ±ä¸€ã€‚`raw_input` ä¿æŒã§å†æ¡ç‚¹å¯èƒ½ |
| å†å—é¨“ãƒ‡ãƒ¼ã‚¿ã®è†¨å¼µ | DBå®¹é‡ãƒ»ã‚¯ã‚¨ãƒªæ€§èƒ½ | `is_latest` éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§æœ€æ–°ã®ã¿é«˜é€Ÿå–å¾—ã€‚å¤ã„è©¦è¡Œã¯è¡¨ç¤ºåˆ¶é™ |

---

## 7. ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

| Phase | ä¸»è¦ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ | æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ |
|-------|-------------------|-------------|
| **1** | ç†ç§‘ 2ã€œ3å›åˆ†ã®è‡ªå‹•æ¡ç‚¹ãŒå‹•ä½œ + ç®—æ•°ã®è§£ç­”ã®ã¿ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãŒå‹•ä½œ | ç”Ÿå¾’ãŒè¿·ã‚ãšæ“ä½œã§ãã‚‹ã‹ã€‚è¬›å¸«ã®å•é¡Œç™»éŒ²è² è·ã¯è¨±å®¹ç¯„å›²ã‹ï¼ˆç†ç§‘ãƒ•ãƒ«å…¥åŠ› / ç®—æ•°ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ï¼‰ |
| **2** | ç®—æ•°ã®é€”ä¸­ä¿å­˜ï¼‹æ•°å€¤/åˆ†æ•°å…¥åŠ›ï¼‹è‡ªå‹•æ¡ç‚¹ãŒå‹•ä½œ | iPad ã§ã®æ•°å€¤å…¥åŠ›ä½“é¨“ã€‚é€”ä¸­ä¿å­˜â†’å¾©å…ƒã®UXãŒç›´æ„Ÿçš„ã‹ã€‚åˆ†æ•°ã®å®Œå…¨ä¸€è‡´åˆ¤å®šã§å•é¡Œãªã„ã‹ |
| **3** | ç†ç§‘æŒ¯ã‚Šè¿”ã‚Šå¯¾è©±ãŒå‹•ä½œ | ç”Ÿå¾’ãŒã€Œã‚ã‹ã£ãŸã€ã‚’è¨€èªåŒ–ã§ãã‚‹ã‹ã€‚å¯¾è©±ã®è‡ªç„¶ã• |
