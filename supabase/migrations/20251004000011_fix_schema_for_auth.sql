-- ============================================================================
-- 11: 認証フロー用スキーマ修正
-- ============================================================================
-- 作成日: 2025-10-04
-- 説明: 認証・セットアップフロー実装に必要なカラム追加・制約変更

-- ----------------------------------------------------------------------------
-- profiles: セットアップ完了フラグ追加
-- ----------------------------------------------------------------------------
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS setup_completed BOOLEAN DEFAULT FALSE;

COMMENT ON COLUMN public.profiles.setup_completed IS 'セットアップフロー完了フラグ';

-- ----------------------------------------------------------------------------
-- coaches: invitation_code を NULL 許可に変更
-- ----------------------------------------------------------------------------
-- テストユーザー作成時に招待コードなしでも作成できるようにする
ALTER TABLE public.coaches
ALTER COLUMN invitation_code DROP NOT NULL;

COMMENT ON COLUMN public.coaches.invitation_code IS '招待コード（NULL許可、テストユーザー用）';

-- ----------------------------------------------------------------------------
-- 完了メッセージ
-- ----------------------------------------------------------------------------
DO $$
BEGIN
  RAISE NOTICE '認証フロー用スキーマ修正完了';
  RAISE NOTICE '- profiles.setup_completed 追加';
  RAISE NOTICE '- coaches.invitation_code NULL許可に変更';
END $$;
