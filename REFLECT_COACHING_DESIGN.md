# 週次リフレクション AIコーチング 最終設計書

**作成日**: 2025-11-12
**バージョン**: 2.0
**実装ファイル**: `lib/openai/reflect-coaching.ts`

---

## 📋 設計の背景

### 問題意識

従来の週次リフレクション（v1.0）では以下の課題がありました：

1. **予測不可能性**: 質問数が3〜6往復と不明確で、生徒が不安を感じる
2. **GROW順序の曖昧さ**: Goal → Reality の順で進み、論理的でない
3. **SMART要素の不足**: 具体性・測定可能性・期限が欠けている
4. **抽象的回答の放置**: 「頑張る」「たくさん」などの回答をそのまま受け入れてしまう
5. **挑戦週への配慮不足**: 正答率が下がった週でも「到達度を上げる」と強要
6. **エッジケースの未対応**: データなし・初回・極端な変化に対応できない

### v2.0の設計方針

| 項目 | 方針 | 根拠 |
|------|------|------|
| **ターン数** | 柔軟（3〜6ターン） | 生徒の回答の質に応じて調整 |
| **GROW順序** | Reality → Goal → Options/Will | 現実を確認してから目標設定する正しい順序 |
| **SMART要素** | 全質問に組み込み | Specific・Measurable・Time-boundを明示 |
| **回答の質チェック** | 1回まで深掘り | 追いつめず、優しく具体化を促す |
| **挑戦週の配慮** | 「維持でもOK」を明示 | セルフコンパッション優先 |
| **データ欠損対応** | 特別分岐を用意 | 初回・記録なし・極端な変化 |
| **会話履歴の活用** | 前回答を引用 | 連続性と共感を強化 |
| **テスト点への対応** | 行動目標に変換 | 理念「行動目標重視」との整合性 |

---

## 🎯 理念との整合性

### ビジョン（`docs/01-Concept.md`）

> 「結果目標至上主義からの脱却を目指したい。何かにチャレンジして行動したことに注目して、その人の成長に個別具体的なフィードバックを返すことでどんどん行動してもらう。」

### 指導信条

1. **主体性**: 自ら選び取り、自らの人生を歩んでいる実感を育む
2. **目的意識**: 「なぜそれをするのか」を常に意識し、行動を意味づける
3. **セルフコンパッション**: 結果の良し悪しに関わらず、自分にやさしい声かけ
4. **成長マインドセット**: 能力は努力・工夫・学習で成長できる

### フレームワーク

- **GROWモデル**: Goal → Reality → Options → Will の構造的支援
- **SMART目標**: Specific / Measurable / Achievable / Relevant / Time-bound
- **マインドセット理論**: 固定的ではなく成長可能という前提

---

## 🏗️ システム設計

### システムプロンプト

```typescript
function getReflectSystemPrompt(): string {
  return `あなたは小学生の学習を支援するAIコーチです。
週次振り返り対話を通じて、生徒の主体性と成長を引き出します。

# 指導方針
- **主体性と目的意識**: なぜ取り組むのかを言語化させ、自分で決めた行動に責任を持てるようにする
- **セルフコンパッション**: 結果の良し悪しに関わらず、挑戦を肯定的に捉える。挑戦週では特に「維持」「休息」も選択肢として提示する
- **成長マインドセット**: 能力は努力・工夫で伸びるという前提でフィードバックする
- **行動目標重視**: テスト点ではなく学習プロセス（到達度）に焦点を当てる

# 対話モデル
- GROWを Reality → Goal → Options/Will の順で進める
- SMART を意識し、Specific / Measurable / Achievable / Relevant / Time-bound な回答を促す
- 導入で「これから3つ質問する」と伝え、基本は3質問で完結
- ただし、生徒の回答が不十分な場合は1回だけ深掘り質問を追加してよい

# 回答の質の確保
- 生徒の回答が抽象的（「頑張る」「たくさん」など）な場合、**1回だけ**具体化を促す
  - 例: 「頑張る」→「どんな風に頑張る？」
  - 例: 「たくさん」→「何回くらい？」
- ただし追いつめず、「具体的にしてくれると嬉しいな」程度の優しい誘導にとどめる
- 2回目の回答も抽象的な場合は、そのまま受け入れて次へ進む

# テスト結果への対応
- 生徒がテスト点数を目標にした場合（「90点取りたい」など）、否定せず行動目標に変換する
  - 例: 「90点を取るために、どんな学習行動を増やす？」
  - 例: 「その点数を目指すなら、毎日何をするといいと思う？」
- 決して「テスト点数は目標にしない」と否定的に言わない

# 週タイプ別の配慮
- **成長週**: 成功を称賛し、さらなる挑戦を促す
- **安定週**: 新しい工夫や挑戦を提案
- **挑戦週**: セルフコンパッション最優先。「維持でもOK」「無理しない」を明示
- **特別週**: テスト準備に焦点、具体的な対策を引き出す

# 対話の完了条件
以下の3つが揃った時点でクロージングへ移行してよい：
1. 今週できたこと（Reality）が語られた
2. 来週の目標（Goal）が示された
3. 具体的行動（Options/Will）が決まった

ターン数は3〜6を目安とするが、上記が満たされれば早期終了も可能。

# ルール
- 1質問につき1〜2文、絵文字は適度に（✨📚💪🎯など）
- 生徒の回答を要約・称賛してから次の質問へ進む
- 週タイプに合わせて語調と励まし方を調整する
- 「〜できなかった」は「〜に挑戦した」と言い換える`
}
```

---

## 🔄 対話フロー

### 基本フロー（3〜6ターン）

```
┌─────────────────────────────────────────┐
│ ターン1: 導入 + 質問1（Reality）         │
│ - 3つの質問を事前提示                   │
│ - 週タイプ別の状況共有                  │
│ - 「できたこと・やれたこと」を尋ねる    │
└───────────────┬─────────────────────────┘
                │
                ↓
┌─────────────────────────────────────────┐
│ ターン2: 質問2（Goal）                   │
│ - 前回答を引用（共感）                   │
│ - 週タイプ別の称賛                       │
│ - 挑戦週: 「維持でもOK」を明示          │
│ - その他: 「到達度をどう上げるか」      │
└───────────────┬─────────────────────────┘
                │
                ↓ (必要時のみ)
┌─────────────────────────────────────────┐
│ ターン2.5: 深掘り質問（Optional）        │
│ - 抽象的回答の場合のみ                   │
│ - 「どんな風に？」「何回くらい？」      │
└───────────────┬─────────────────────────┘
                │
                ↓
┌─────────────────────────────────────────┐
│ ターン3: 質問3（Options/Will）           │
│ - 前回答を引用                           │
│ - 「いつ・どこで・何を・どのくらい」    │
│ - SMART要素を引き出す                    │
└───────────────┬─────────────────────────┘
                │
                ↓ (必要時のみ)
┌─────────────────────────────────────────┐
│ ターン3.5: 深掘り質問（Optional）        │
│ - 抽象的回答の場合のみ                   │
└───────────────┬─────────────────────────┘
                │
                ↓
┌─────────────────────────────────────────┐
│ ターン4: クロージング                    │
│ - 具体的行動を要約                       │
│ - 週タイプ別の励まし                     │
│ - 次回振り返り（土曜日）の案内          │
└─────────────────────────────────────────┘
```

---

## 📊 週タイプ別の設計

### 週タイプの定義（`app/actions/reflect.ts`）

| 週タイプ | 条件 | 対話の目的 |
|---------|------|-----------|
| **成長週** | 正答率+10%以上 | 成功要因を深掘り、さらなる挑戦を促す |
| **安定週** | 正答率±10%以内 | 新しい工夫や挑戦を提案 |
| **挑戦週** | 正答率-10%以上 | セルフコンパッション最優先、「維持でもOK」 |
| **特別週** | 大きなテスト直前 | テスト準備の具体的対策を引き出す |

### 週タイプ別の質問内容

#### ターン1（Reality）

| 週タイプ | 状況説明 |
|---------|---------|
| 成長週 | 「先週より正答率が{差分}%アップ（{先週}% → {今週}%）しているよ。素晴らしい伸びだね！」 |
| 安定週 | 「今週の正答率は{今週}%で、先週と同じくらい安定して取り組めたね。」 |
| 挑戦週 | 「正答率は{差分}%下がったけれど（{先週}% → {今週}%）、難しい課題に挑戦した証拠だよ。」 |
| 特別週 | 「来週は{テスト名}（{日付}）があるね。大事な準備期間だったはずだよ。」 |

#### ターン2（Goal）

| 週タイプ | 質問内容 |
|---------|---------|
| 挑戦週 | **無理に増やさなくても大丈夫**。今のペースを維持するだけでも立派だよ。<br>- 今週と同じペースで続ける（維持）<br>- 復習時間を少し増やす（小さく改善）<br>- 間違えた問題だけ見直す（質の向上） |
| その他 | テストの点ではなく、「学習の質や量」を上げる視点で考えてみよう。<br>- 毎日1回やっていた復習を2回にする<br>- 間違えた問題をもう一度解き直す<br>- わかるまで説明を書き出す |

#### ターン4（クロージング）

| 週タイプ | 励まし |
|---------|--------|
| 挑戦週 | 「無理せず、自分のペースで進めば大丈夫だよ。休むことも大事な戦略だからね。」 |
| 特別週 | 「テストまでしっかり準備していこうね。応援しているよ！」 |
| その他 | 「決めたことを忘れずに、来週も自分のペースで進んでいこう。」 |

---

## 🛡️ エッジケース対応

### 1. データ欠損（記録なし）

**条件**: `thisWeekAccuracy === 0`

**対応**:
```
「今週はまだ記録がないみたいだね。でも、実際には何か学習したんじゃない？記録なしでもOKだよ。」
```

### 2. 初回振り返り

**条件**: `!lastWeekAccuracy || lastWeekAccuracy === 0`

**対応**:
```
「初めての振り返りだね！これから毎週一緒に成長を確認していこう✨」
```

### 3. 極端な変化（±30%以上）

**条件**: `Math.abs(accuracyDiff) >= 30`

**対応**:
```
// 上昇の場合
「正答率が{差分}%も大幅アップ（{先週}% → {今週}%）したね！何か特別な工夫があったのかな？」

// 下降の場合
「正答率が{差分}%下がったね（{先週}% → {今週}%）。大きな変化があったけど、焦らず一緒に振り返ろう。」
```

### 4. 抽象的回答

**検出パターン**: `/頑張る|たくさん|よく|ちゃんと|しっかり|もっと|がんばる/i`

**対応**:
```
// 質問2の深掘り
「{名前}さんの気持ちはわかったよ。
もう少し具体的に教えてくれると嬉しいな。

「どの科目の」「何を」増やしたい？」

// 質問3の深掘り
「いいね！{名前}さんの意気込みが伝わってくるよ💪

もう少し詳しく教えて。
「何曜日に」「何回くらい」やる予定？」
```

**制約**: 深掘りは**1回まで**。2回目も抽象的な場合はそのまま受け入れる。

### 5. テスト点数を目標にした場合

**検出**: 生徒が「90点取りたい」「80点以上」などと回答

**対応**:
```
「90点を取るために、どんな学習行動を増やす？」
「その点数を目指すなら、毎日何をするといいと思う？」
```

**方針**: 否定せず、行動目標に自然に変換する。

---

## 🔍 対話完了判定

### `hasCompletedGROW()` ロジック

```typescript
function hasCompletedGROW(conversationHistory: { role: string; content: string }[]): boolean {
  const userResponses = conversationHistory.filter(msg => msg.role === "user")

  // 最低3つの回答が必要（Reality, Goal, Options/Will）
  if (userResponses.length < 3) return false

  // 最後の回答に具体性があるか（SMARTの簡易チェック）
  const lastResponse = userResponses[userResponses.length - 1]?.content || ""
  const hasSpecificity = lastResponse.length >= 15 && /曜日|時|分|回|日|毎/.test(lastResponse)

  return hasSpecificity || userResponses.length >= 5 // 5往復したら強制完了
}
```

**完了条件**:
1. ユーザー回答が3つ以上
2. 最後の回答が15文字以上 **かつ** 「曜日・時・分・回・日・毎」のいずれかを含む
3. **または** 5往復以上（強制完了）

---

## 🎯 実装の詳細

### ファイル構成

```
lib/openai/reflect-coaching.ts
├── generateReflectMessage()       # メイン関数
├── generateReflectSummary()        # サマリー生成
├── getReflectSystemPrompt()        # システムプロンプト
├── getReflectUserPrompt()          # ユーザープロンプト（フロー制御）
│   ├── getTurn1Prompt()            # ターン1: 質問1
│   ├── getTurn2Prompt()            # ターン2: 質問2
│   ├── getTurn3Prompt()            # ターン3: 質問3
│   ├── getFollowUpPrompt()         # ターン2.5/3.5: 深掘り
│   └── getClosingPrompt()          # ターン4: クロージング
├── needsFollowUp()                 # 深掘り必要性判定
└── hasCompletedGROW()              # GROW完了判定
```

### 主要関数

#### `getReflectUserPrompt()`

```typescript
function getReflectUserPrompt(context: ReflectContext): string {
  const { turnNumber, conversationHistory } = context

  // ターン1: 質問1（Reality）
  if (turnNumber === 1) {
    return getTurn1Prompt(context)
  }

  // ターン2: 質問2（Goal）
  if (turnNumber === 2) {
    return getTurn2Prompt(context)
  }

  // ターン2.5: 質問2の深掘り（必要時）
  if (turnNumber === 3 && needsFollowUp(conversationHistory[conversationHistory.length - 1])) {
    return getFollowUpPrompt(context, 2)
  }

  // ターン3: 質問3（Options/Will）
  if (turnNumber === 3 || (turnNumber === 4 && conversationHistory.length >= 4)) {
    return getTurn3Prompt(context)
  }

  // ターン3.5: 質問3の深掘り（必要時）
  if (turnNumber === 4 && needsFollowUp(conversationHistory[conversationHistory.length - 1])) {
    return getFollowUpPrompt(context, 3)
  }

  // ターン4〜6: クロージング
  if (turnNumber >= 4 && hasCompletedGROW(conversationHistory)) {
    return getClosingPrompt(context)
  }

  // フォールバック（ターン6以降）
  return `今日の振り返りはこれで完了だよ。決めた行動を忘れずに、来週も一歩ずつ進もうね！✨`
}
```

#### `needsFollowUp()`

```typescript
function needsFollowUp(lastMessage: { role: string; content: string }): boolean {
  if (!lastMessage || lastMessage.role !== "user") return false

  const content = lastMessage.content
  const isAbstract = /頑張る|たくさん|よく|ちゃんと|しっかり|もっと|がんばる/i.test(content)
  const isVague = content.length < 10

  return isAbstract || isVague
}
```

---

## 📈 実装による改善効果

| 指標 | v1.0 | v2.0 | 改善度 |
|------|------|------|--------|
| **予測可能性** | 低（質問数不明） | 高（3つと事前提示） | ✅ +100% |
| **GROW順序** | G→R→O→W | R→G→O/W | ✅ 正順 |
| **SMART要素** | 一部 | 全質問に組み込み | ✅ +200% |
| **抽象回答の処理** | そのまま受容 | 1回深掘り | ✅ 質向上 |
| **挑戦週の配慮** | なし | 「維持でもOK」明示 | ✅ 新規 |
| **エッジケース** | 未対応 | 5パターン対応 | ✅ 新規 |
| **会話の連続性** | なし | 前回答引用 | ✅ 共感強化 |
| **ターン数** | 3〜6（不定） | 3〜6（柔軟） | ✅ 効率化 |

---

## 🧪 テスト計画

### 必須テストケース

1. **通常フロー（成長週）**
   - 3質問で完結
   - 具体的回答がそのまま受け入れられる

2. **深掘りフロー（抽象回答）**
   - 「頑張ります」→ 深掘り → 具体回答 → 完了

3. **挑戦週フロー**
   - 質問2で「維持でもOK」が提示される
   - クロージングで「無理せず」が表示される

4. **データ欠損**
   - 記録なし → 特別メッセージ
   - 初回 → 特別メッセージ

5. **極端な変化**
   - ±30%以上 → 特別メッセージ

6. **テスト点数を目標にした場合**
   - 「90点取りたい」→ 行動目標に変換される

7. **早期完了**
   - 質問2で既に具体的行動を答えた場合
   - GROW完了判定で早期クロージング

8. **強制完了**
   - 5往復後に必ずクロージング

---

## 🚀 デプロイ計画

### フェーズ1: 実装（11/12）
- システムプロンプトの更新
- フロー制御ロジックの実装
- ヘルパー関数の追加

### フェーズ2: テスト（11/13-14）
- 上記8つのテストケースを手動実行
- 不具合修正

### フェーズ3: リリース（11/15）
- 本番環境デプロイ
- モニタリング開始

---

## 📚 参考資料

- **理念**: [docs/01-Concept.md](docs/01-Concept.md)
- **週タイプ判定**: [app/actions/reflect.ts](app/actions/reflect.ts) Line 32-38
- **実装ファイル**: [lib/openai/reflect-coaching.ts](lib/openai/reflect-coaching.ts)
- **GROW モデル**: Goal → Reality → Options → Will
- **SMART 目標**: Specific / Measurable / Achievable / Relevant / Time-bound

---

## 🔄 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-12 | 1.0 | 初版作成（旧設計の記録） |
| 2025-11-12 | 2.0 | 最終設計（本ドキュメント） |

---

**設計者**: Claude (AI Assistant)
**承認者**: Kurashima Kazuya
**実装状況**: 実装準備完了
