# 保護者UI改善の検証手順

## 前提条件
- 開発サーバーが起動していること（http://localhost:3002）
- ブラウザ: Chrome または Edge を推奨（開発者ツールを使用）

---

## 検証1: localStorage検証（無効なIDの自動クリア）

### 目的
DB リセット後など、localStorage に保存された子供IDが現在の子供リストに存在しない場合、自動的にクリアされて最初の子供が選択されることを確認します。

### 手順

1. **ブラウザで http://localhost:3002 を開く**

2. **開発者ツールを開く**
   - Windows/Linux: `F12` または `Ctrl + Shift + I`
   - Mac: `Cmd + Option + I`

3. **Console タブを開く**

4. **無効なIDをlocalStorageに設定**
   - Console に以下を入力して Enter:
   ```javascript
   localStorage.setItem('selectedChildId', '999')
   ```

5. **設定されたことを確認**
   - Console に以下を入力:
   ```javascript
   localStorage.getItem('selectedChildId')
   ```
   - 結果: `"999"` と表示されることを確認

6. **保護者でログイン**
   - メール: `demo-parent2@example.com`
   - パスワード: `<社内管理>`

7. **期待される動作**
   - Console に以下のようなログが表示される:
     ```
     [useUserProfile] Invalid savedChildId in localStorage, clearing: 999
     [useUserProfile] Selecting first child as default: 7
     ```
   - ダッシュボードに「星野 明」または「星野 光」のデータが表示される
   - 「子供が選択されていません」のメッセージが**表示されない**

8. **localStorageが更新されたことを確認**
   - Console に以下を入力:
   ```javascript
   localStorage.getItem('selectedChildId')
   ```
   - 結果: `"7"` または `"8"` などの有効なIDが表示される

### ✅ 検証成功の条件
- [ ] 無効なID (999) がlocalStorageから自動削除された
- [ ] 最初の子供が自動選択された
- [ ] ダッシュボードに子供のデータが即座に表示された
- [ ] Console にエラーが表示されていない

---

## 検証2: 応援履歴表示

### 目的
保護者のリフレクトページで応援履歴が正しく表示されることを確認します。

### 事前準備（応援メッセージがない場合）

応援履歴がない場合は、まず応援メッセージを送信してください:

1. **保護者でログイン済みの状態で、画面下部のナビゲーションから「応援」をタップ**

2. **学習記録カードの「クイック応援」ボタンをタップ**
   - 例: 「がんばったね！」「すごい！」など

3. **「送信しました」のメッセージが表示されることを確認**

### 検証手順

1. **画面下部のナビゲーションから「リフレクト」をタップ**

2. **「応援履歴」タブをタップ**
   - 画面上部に「学習記録」「応援履歴」の2つのタブがある

3. **期待される動作**
   - 送信した応援メッセージが一覧表示される
   - 各メッセージカードに以下の情報が表示される:
     - 学習回（例: 第12回）
     - 科目名（例: 算数）
     - 学習内容（例: 基本問題）
     - 正答率（例: 85%）
     - 応援メッセージ本文
     - 送信日時
   - メッセージがない場合は「該当する応援メッセージがありません」と表示される

4. **フィルター機能を確認**
   - 「期間」ドロップダウンで「1週間以内」を選択
   - 「科目」ドロップダウンで「算数」を選択
   - 選択した条件でフィルタリングされることを確認

5. **Console でエラーがないことを確認**
   - 開発者ツールの Console タブを確認
   - 赤いエラーメッセージが**表示されていない**ことを確認

### ✅ 検証成功の条件
- [ ] 応援履歴タブで応援メッセージが表示される
- [ ] メッセージカードに学習情報が正しく表示される
- [ ] フィルターが正常に機能する
- [ ] Console にエラーが表示されていない

---

## 検証3: ページ遷移時の子供選択維持

### 目的
保護者の各ページ間を遷移しても、選択した子供が維持されることを確認します。

### 手順

1. **保護者ダッシュボード（ホーム）にいることを確認**

2. **プロフィールアイコンをタップして子供を選択**
   - 「星野 光」を選択（2人目の子供）
   - ダッシュボードに「星野 光」のデータが表示されることを確認

3. **Console で選択されたIDを確認**
   ```javascript
   localStorage.getItem('selectedChildId')
   ```
   - 結果: 「星野 光」のID（例: `"8"`）が表示される

4. **「ゴール」ページに遷移**
   - 画面下部のナビゲーションから「ゴール」をタップ
   - 「星野 光」の目標が表示されることを確認

5. **「応援」ページに遷移**
   - 画面下部のナビゲーションから「応援」をタップ
   - プロフィールヘッダーに「星野 光」の名前が表示されることを確認
   - 「星野 光」の学習記録が表示されることを確認

6. **「リフレクト」ページに遷移**
   - 画面下部のナビゲーションから「リフレクト」をタップ
   - 「星野 光」の学習記録が表示されることを確認

7. **「ホーム」に戻る**
   - 画面下部のナビゲーションから「ホーム」をタップ
   - まだ「星野 光」のデータが表示されていることを確認

8. **ページをリロード**
   - ブラウザの更新ボタンをクリック、または `F5` / `Cmd + R`
   - リロード後も「星野 光」が選択されたままであることを確認

9. **Console でIDが維持されていることを確認**
   ```javascript
   localStorage.getItem('selectedChildId')
   ```
   - 結果: 「星野 光」のID（例: `"8"`）が維持されている

### ✅ 検証成功の条件
- [ ] 全ページで選択した子供のデータが表示される
- [ ] ページ遷移しても選択が維持される
- [ ] ページをリロードしても選択が維持される
- [ ] プロフィールヘッダーに常に正しい子供の名前が表示される

---

## トラブルシューティング

### 問題: ダッシュボードに「子供が選択されていません」と表示される

**原因**: UserProfileProvider の初期化が完了していない

**確認方法**:
1. Console で以下のログを確認:
   ```
   [useUserProfile] Fetching parent children...
   [useUserProfile] getParentChildren result: { children: [...], error: undefined }
   [useUserProfile] Setting children list: [...]
   ```

2. これらのログが表示されない場合、`app/parent/layout.tsx` が正しく修正されていない可能性があります。

**対処法**:
- ブラウザのキャッシュをクリア（`Ctrl + Shift + Del` / `Cmd + Shift + Del`）
- 開発サーバーを再起動

### 問題: 応援履歴が空のまま

**原因1**: 応援メッセージが送信されていない
- **対処法**: 「検証2: 事前準備」を実行して応援メッセージを送信

**原因2**: データベースのカラム名が不一致
- **確認方法**: Console で以下のようなエラーを確認:
  ```
  column "recipient_id" does not exist
  ```
- **対処法**: `app/actions/parent.ts:555` が `.eq("student_id", ...)` になっていることを確認

### 問題: 子供の選択が維持されない

**原因**: localStorage が正しく更新されていない

**確認方法**:
1. Console で localStorage の値を確認:
   ```javascript
   localStorage.getItem('selectedChildId')
   ```

2. 値が変更されない場合、`lib/hooks/use-user-profile.tsx` の `setSelectedChildId` 関数が正しく実装されていない可能性があります。

**対処法**:
- ブラウザのキャッシュをクリア
- プライベートモード/シークレットモードで再テスト

---

## 検証完了チェックリスト

- [ ] 検証1: localStorage検証が成功
- [ ] 検証2: 応援履歴表示が成功
- [ ] 検証3: ページ遷移時の子供選択維持が成功
- [ ] Console にエラーが表示されていない
- [ ] 全機能が期待通りに動作している

---

## 備考

- 検証中に問題が発生した場合は、上記のトラブルシューティングを参照してください
- Console のログは重要なデバッグ情報を含んでいるため、必ず確認してください
- 検証完了後、テストデータをクリーンアップする必要はありません（次回のテストで再利用可能）
